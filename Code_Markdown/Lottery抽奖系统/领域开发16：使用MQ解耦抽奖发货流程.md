-   åˆ†æ”¯ï¼š[211030_xfg_AsyncDistributionAward](https://gitcode.net/KnowledgePlanet/Lottery/-/tree/211030_xfg_AsyncDistributionAward)
-   æè¿°ï¼šä½¿ç”¨MQæ¶ˆæ¯çš„ç‰¹æ€§ï¼ŒæŠŠç”¨æˆ·æŠ½å¥–åˆ°å‘è´§åˆ°æµç¨‹è¿›è¡Œè§£è€¦ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­åŒ…æ‹¬äº†æ¶ˆæ¯çš„å‘é€ã€åº“è¡¨ä¸­çŠ¶æ€çš„æ›´æ–°ã€æ¶ˆæ¯çš„æ¥æ”¶æ¶ˆè´¹ã€å‘å¥–çŠ¶æ€çš„å¤„ç†ç­‰ã€‚

## [](https://gitcode.net/KnowledgePlanet/Lottery/-/wikis/%E7%AC%AC-2-%E9%83%A8%E5%88%86-%E9%A2%86%E5%9F%9F%E5%BC%80%E5%8F%91//%E7%AC%AC16%E8%8A%82%EF%BC%9A%E4%BD%BF%E7%94%A8MQ%E8%A7%A3%E8%80%A6%E6%8A%BD%E5%A5%96%E5%8F%91%E8%B4%A7%E6%B5%81%E7%A8%8B#%E4%B8%80%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97)ä¸€ã€å¼€å‘æ—¥å¿—

-   åœ¨æ•°æ®åº“è¡¨Â `user_strategy_export`Â æ·»åŠ å­—æ®µÂ `mq_state`Â è¿™ä¸ªå­—æ®µç”¨äºå‘é€ MQ æˆåŠŸæ›´æ–°åº“è¡¨çŠ¶æ€ï¼Œå¦‚æœ MQ æ¶ˆæ¯å‘é€å¤±è´¥åˆ™éœ€è¦é€šè¿‡å®šæ—¶ä»»åŠ¡è¡¥å¿ MQ æ¶ˆæ¯ã€‚PSï¼šä½ å¯ä»¥ä½¿ç”¨æœ¬ç« èŠ‚åˆ†æ”¯ä¸‹çš„ sql æ›´æ–°è‡ªå·±çš„åº“è¡¨ã€‚
-   å¯åŠ¨ kafka æ–°å¢ topicï¼šlottery_invoice ç”¨äºå‘è´§å•æ¶ˆæ¯ï¼Œå½“æŠ½å¥–å®Œæˆååˆ™å‘é€ä¸€ä¸ªå‘è´§å•ï¼Œå†å¼‚æ­¥å¤„ç†å‘è´§æµç¨‹ï¼Œè¿™ä¸ªéƒ¨åˆ†å°±æ˜¯MQçš„è§£è€¦æµç¨‹ä½¿ç”¨ã€‚
-   åœ¨Â `ActivityProcessImpl#doDrawProcess`Â æ´»åŠ¨æŠ½å¥–æµç¨‹ç¼–æ’ä¸­è¡¥å…¨ç”¨æˆ·æŠ½å¥–åï¼Œå‘é€MQè§¦è¾¾å¼‚æ­¥å¥–å“å‘é€çš„æµç¨‹ã€‚

## [](https://gitcode.net/KnowledgePlanet/Lottery/-/wikis/%E7%AC%AC-2-%E9%83%A8%E5%88%86-%E9%A2%86%E5%9F%9F%E5%BC%80%E5%8F%91//%E7%AC%AC16%E8%8A%82%EF%BC%9A%E4%BD%BF%E7%94%A8MQ%E8%A7%A3%E8%80%A6%E6%8A%BD%E5%A5%96%E5%8F%91%E8%B4%A7%E6%B5%81%E7%A8%8B#%E4%BA%8C%E5%88%9B%E5%BB%BA%E4%B8%BB%E9%A2%98topic)äºŒã€åˆ›å»ºä¸»é¢˜ï¼ˆTopicï¼‰

åœ¨å¼€å‘å‰æˆ‘ä»¬å…ˆå¯åŠ¨ Kafka å¹¶æ–°å¢åŠ ä¸€ä¸ª MQ çš„ Topicï¼Œå‘½ä»¤è¯­å¥å¦‚ä¸‹ï¼š

```
å¯åŠ¨zkï¼šbin/zookeeper-server-start.sh -daemon config/zookeeper.properties
å¯åŠ¨kafkaï¼šbin/kafka-server-start.sh -daemon config/server.properties
åˆ›å»ºtopicï¼šbin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic lottery_invoice
```

## [](https://gitcode.net/KnowledgePlanet/Lottery/-/wikis/%E7%AC%AC-2-%E9%83%A8%E5%88%86-%E9%A2%86%E5%9F%9F%E5%BC%80%E5%8F%91//%E7%AC%AC16%E8%8A%82%EF%BC%9A%E4%BD%BF%E7%94%A8MQ%E8%A7%A3%E8%80%A6%E6%8A%BD%E5%A5%96%E5%8F%91%E8%B4%A7%E6%B5%81%E7%A8%8B#%E4%B8%89%E6%B5%81%E7%A8%8B%E8%AF%B4%E6%98%8E)ä¸‰ã€æµç¨‹è¯´æ˜

**æœ¬ç« èŠ‚å¼€å‘çš„MQæµç¨‹ï¼š**

[![](https://gitcode.net/KnowledgePlanet/Lottery/-/raw/master/doc/assets/img/Part-2/16-01.png)](https://gitcode.net/KnowledgePlanet/Lottery/-/raw/master/doc/assets/img/Part-2/16-01.png)

-   ä»ç”¨æˆ·å‘èµ·æŠ½å¥–åˆ°ä¸­å¥–åå¼€å§‹ï¼Œå°±æ˜¯MQå¤„ç†å‘å¥–çš„æµç¨‹
-   å› ä¸º **MQ æ¶ˆæ¯çš„å‘é€æ˜¯ä¸å…·å¤‡äº‹åŠ¡æ€§çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ åœ¨å‘é€ MQ æ—¶å¯èƒ½ä¼šå¤±è´¥**ï¼Œå“ªæ€•æˆåŠŸç‡æ˜¯3ä¸ª9åˆ°4ä¸ª9ï¼Œä¹Ÿä¼šæœ‰ä¸€å®šçš„æ¦‚ç‡è§¦å‘å‘é€å¤±è´¥ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨ MQ å‘é€å®Œæˆåéœ€è¦çŸ¥é“æ˜¯å¦å‘é€æˆåŠŸï¼Œè¿›è¡Œåº“è¡¨çŠ¶æ€æ›´æ–°ï¼Œ**å¦‚æœå‘é€å¤±è´¥åˆ™éœ€è¦ä½¿ç”¨ worker æ¥è¡¥å¿ MQ å‘é€**ã€‚PSï¼šè¿™éƒ¨åˆ†å†…å®¹æˆ‘ä»¬ä¼šåœ¨åç»­ç« èŠ‚å®ç°ã€‚
-   æœ€å **MQ å‘é€å®Œæˆåˆ°æ¶ˆè´¹ï¼Œä¹Ÿæ˜¯å¯èƒ½æœ‰å¤±è´¥çš„**ï¼Œæ¯”å¦‚å¤„ç†å¤±è´¥ã€æ›´æ–°åº“è¡¨å¤±è´¥ç­‰ï¼Œä½†æ— è®ºæ˜¯ä»€ä¹ˆå¤±è´¥éƒ½éœ€è¦**ä¿è¯ MQ è¿›è¡Œé‡è¯•å¤„ç†**ã€‚è€Œä¿è¯ MQ æ¶ˆæ¯é‡è¯•çš„å‰æå°±æ˜¯**æœåŠ¡çš„å¹‚ç­‰æ€§**ï¼Œå¦åˆ™ä½ åœ¨é‡è¯•çš„è¿‡ç¨‹ä¸­å°±é€ æˆäº†æµç¨‹å¼‚å¸¸ï¼Œæ¯”å¦‚æ›´æ–°æ¬¡æ•°å¤šäº†ã€æ•°æ®åº“æ’å…¥å¤šäº†ã€ç»™ç”¨æˆ·å‘å¥–å¤šäº†ç­‰ç­‰ï¼Œå°¤å…¶æ˜¯å‘ç”Ÿèµ„æŸæ˜¯æ›´å¯æ€•çš„ã€‚

## [](https://gitcode.net/KnowledgePlanet/Lottery/-/wikis/%E7%AC%AC-2-%E9%83%A8%E5%88%86-%E9%A2%86%E5%9F%9F%E5%BC%80%E5%8F%91//%E7%AC%AC16%E8%8A%82%EF%BC%9A%E4%BD%BF%E7%94%A8MQ%E8%A7%A3%E8%80%A6%E6%8A%BD%E5%A5%96%E5%8F%91%E8%B4%A7%E6%B5%81%E7%A8%8B#%E5%9B%9Bmq-%E6%9C%8D%E5%8A%A1)å››ã€MQ æœåŠ¡

å…³äº MQ çš„ä½¿ç”¨ï¼Œæ— è®ºæ˜¯ Kafka è¿˜æ˜¯ RocketMQï¼ŒåŸºæœ¬æ–¹å¼éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œä¸€ä¸ªç”Ÿäº§æ¶ˆæ¯ï¼Œä¸€ä¸ªç›‘å¬æ¶ˆæ¯ï¼Œåªä¸è¿‡åœ¨ä¸€äº›ç¬¦åˆå„è‡ªä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œåšäº†ç»†åˆ†çš„ä¼˜åŒ–ï¼Œä½†è¿™å¹¶ä¸ä¼šå½±å“ä½ çš„ä½¿ç”¨ã€‚

### [](https://gitcode.net/KnowledgePlanet/Lottery/-/wikis/%E7%AC%AC-2-%E9%83%A8%E5%88%86-%E9%A2%86%E5%9F%9F%E5%BC%80%E5%8F%91//%E7%AC%AC16%E8%8A%82%EF%BC%9A%E4%BD%BF%E7%94%A8MQ%E8%A7%A3%E8%80%A6%E6%8A%BD%E5%A5%96%E5%8F%91%E8%B4%A7%E6%B5%81%E7%A8%8B#1-%E7%94%9F%E4%BA%A7%E6%B6%88%E6%81%AF)1. ç”Ÿäº§æ¶ˆæ¯

```
@Component
public class KafkaProducer {

    private Logger logger = LoggerFactory.getLogger(KafkaProducer.class);

    @Resource
    private KafkaTemplate<String, Object> kafkaTemplate;

    /**
     * MQä¸»é¢˜ï¼šä¸­å¥–å‘è´§å•
     */
    public static final String TOPIC_INVOICE = "lottery_invoice";

    /**
     * å‘é€ä¸­å¥–ç‰©å“å‘è´§å•æ¶ˆæ¯
     *
     * @param invoice å‘è´§å•
     */
    public ListenableFuture<SendResult<String, Object>> sendLotteryInvoice(InvoiceVO invoice) {
        String objJson = JSON.toJSONString(invoice);
        logger.info("å‘é€MQæ¶ˆæ¯ topicï¼š{} bizIdï¼š{} messageï¼š{}", TOPIC_INVOICE, invoice.getuId(), objJson);
        return kafkaTemplate.send(TOPIC_INVOICE, objJson);
    }

}
```

-   æˆ‘ä»¬ä¼šæŠŠæ‰€æœ‰çš„ç”Ÿäº§æ¶ˆæ¯éƒ½æ”¾åˆ° KafkaProducer ä¸­ï¼Œå¹¶å¯¹å¤–æä¾›ä¸€ä¸ªå¯ä»¥å‘é€ MQ æ¶ˆæ¯çš„æ–¹æ³•ã€‚
-   å› ä¸ºæˆ‘ä»¬é…ç½®çš„ç±»å‹è½¬æ¢ä¸º StringDeserializer æ‰€ä»¥å‘é€æ¶ˆæ¯çš„æ–¹å¼æ˜¯ JSON å­—ç¬¦ä¸²ï¼Œå½“ç„¶è¿™ä¸ªç¼–è§£ç å™¨æ˜¯å¯ä»¥é‡å†™çš„ï¼Œæ»¡è¶³ä½ å‘é€å…¶ä»–ç±»å‹çš„æ•°æ®ã€‚

### [](https://gitcode.net/KnowledgePlanet/Lottery/-/wikis/%E7%AC%AC-2-%E9%83%A8%E5%88%86-%E9%A2%86%E5%9F%9F%E5%BC%80%E5%8F%91//%E7%AC%AC16%E8%8A%82%EF%BC%9A%E4%BD%BF%E7%94%A8MQ%E8%A7%A3%E8%80%A6%E6%8A%BD%E5%A5%96%E5%8F%91%E8%B4%A7%E6%B5%81%E7%A8%8B#2-%E6%B6%88%E8%B4%B9%E6%B6%88%E6%81%AF)2. æ¶ˆè´¹æ¶ˆæ¯

```
@Component
public class LotteryInvoiceListener {

    private Logger logger = LoggerFactory.getLogger(LotteryInvoiceListener.class);

    @Resource
    private DistributionGoodsFactory distributionGoodsFactory;

    @KafkaListener(topics = "lottery_invoice", groupId = "lottery")
    public void onMessage(ConsumerRecord<?, ?> record, Acknowledgment ack, @Header(KafkaHeaders.RECEIVED_TOPIC) String topic) {
        Optional<?> message = Optional.ofNullable(record.value());

        // 1. åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦å­˜åœ¨
        if (!message.isPresent()) {
            return;
        }

        // 2. å¤„ç† MQ æ¶ˆæ¯
        try {
            // 1. è½¬åŒ–å¯¹è±¡ï¼ˆæˆ–è€…ä½ ä¹Ÿå¯ä»¥é‡å†™Serializer<T>ï¼‰
            InvoiceVO invoiceVO = JSON.parseObject((String) message.get(), InvoiceVO.class);

            // 2. è·å–å‘é€å¥–å“å·¥å‚ï¼Œæ‰§è¡Œå‘å¥–
            IDistributionGoods distributionGoodsService = distributionGoodsFactory.getDistributionGoodsService(invoiceVO.getAwardType());
            DistributionRes distributionRes = distributionGoodsService.doDistribution(new GoodsReq(invoiceVO.getuId(), invoiceVO.getOrderId(), invoiceVO.getAwardId(), invoiceVO.getAwardName(), invoiceVO.getAwardContent()));

            Assert.isTrue(Constants.AwardState.SUCCESS.getCode().equals(distributionRes.getCode()), distributionRes.getInfo());

            // 3. æ‰“å°æ—¥å¿—
            logger.info("æ¶ˆè´¹MQæ¶ˆæ¯ï¼Œå®Œæˆ topicï¼š{} bizIdï¼š{} å‘å¥–ç»“æœï¼š{}", topic, invoiceVO.getuId(), JSON.toJSONString(distributionRes));

            // 4. æ¶ˆæ¯æ¶ˆè´¹å®Œæˆ
            ack.acknowledge();
        } catch (Exception e) {
            // å‘å¥–ç¯èŠ‚å¤±è´¥ï¼Œæ¶ˆæ¯é‡è¯•ã€‚æ‰€æœ‰åˆ°ç¯èŠ‚ï¼Œå‘è´§ã€æ›´æ–°åº“ï¼Œéƒ½éœ€è¦ä¿è¯å¹‚ç­‰ã€‚
            logger.error("æ¶ˆè´¹MQæ¶ˆæ¯ï¼Œå¤±è´¥ topicï¼š{} messageï¼š{}", topic, message.get());
            throw e;
        }
    }

}
```

-   æ¯ä¸€ä¸ª MQ æ¶ˆæ¯çš„æ¶ˆè´¹éƒ½ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„ XxxListener æ¥å¤„ç†æ¶ˆæ¯ä½“ï¼Œå¦‚æœä½ ä½¿ç”¨ä¸€äº›å…¶ä»–çš„ MQ å¯èƒ½è¿˜ä¼šçœ‹åˆ°ä¸€äº›æŠ½è±¡ç±»æ¥å¤„ç† MQ æ¶ˆæ¯é›†åˆã€‚
-   åœ¨è¿™ä¸ª LotteryInvoiceListener æ¶ˆæ¯ç›‘å¬ç±»ä¸­ï¼Œä¸»è¦å°±æ˜¯é€šè¿‡æ¶ˆæ¯ä¸­çš„å‘å¥–ç±»å‹è·å–åˆ°å¯¹åº”çš„å¥–å“å‘è´§å·¥å‚ï¼Œå¤„ç†å¥–å“çš„å‘é€æ“ä½œã€‚
-   åœ¨å¥–å“å‘é€æ“ä½œä¸­ï¼Œå·²ç»è¡¥å…¨äº†Â `DistributionBase#updateUserAwardState`Â æ›´æ–°å¥–å“å‘é€çŠ¶æ€çš„æ“ä½œã€‚

## [](https://gitcode.net/KnowledgePlanet/Lottery/-/wikis/%E7%AC%AC-2-%E9%83%A8%E5%88%86-%E9%A2%86%E5%9F%9F%E5%BC%80%E5%8F%91//%E7%AC%AC16%E8%8A%82%EF%BC%9A%E4%BD%BF%E7%94%A8MQ%E8%A7%A3%E8%80%A6%E6%8A%BD%E5%A5%96%E5%8F%91%E8%B4%A7%E6%B5%81%E7%A8%8B#%E4%BA%94%E6%8A%BD%E5%A5%96%E6%B5%81%E7%A8%8B%E8%A7%A3%E8%80%A6)äº”ã€æŠ½å¥–æµç¨‹è§£è€¦

```
public DrawProcessResult doDrawProcess(DrawProcessReq req) {
    // 1. é¢†å–æ´»åŠ¨
    
    // 2. æ‰§è¡ŒæŠ½å¥–

    // 3. ç»“æœè½åº“

    // 4. å‘é€MQï¼Œè§¦å‘å‘å¥–æµç¨‹
    InvoiceVO invoiceVO = buildInvoiceVO(drawOrderVO);
    ListenableFuture<SendResult<String, Object>> future = kafkaProducer.sendLotteryInvoice(invoiceVO);
    future.addCallback(new ListenableFutureCallback<SendResult<String, Object>>() {
        @Override
        public void onSuccess(SendResult<String, Object> stringObjectSendResult) {
            // 4.1 MQ æ¶ˆæ¯å‘é€å®Œæˆï¼Œæ›´æ–°æ•°æ®åº“è¡¨ user_strategy_export.mq_state = 1
            activityPartake.updateInvoiceMqState(invoiceVO.getuId(), invoiceVO.getOrderId(), Constants.MQState.COMPLETE.getCode());
        }
        @Override
        public void onFailure(Throwable throwable) {
            // 4.2 MQ æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œæ›´æ–°æ•°æ®åº“è¡¨ user_strategy_export.mq_state = 2 ã€ç­‰å¾…å®šæ—¶ä»»åŠ¡æ‰«ç è¡¥å¿MQæ¶ˆæ¯ã€‘
            activityPartake.updateInvoiceMqState(invoiceVO.getuId(), invoiceVO.getOrderId(), Constants.MQState.FAIL.getCode());
        }
    });

    // 5. è¿”å›ç»“æœ
    return new DrawProcessResult(Constants.ResponseCode.SUCCESS.getCode(), Constants.ResponseCode.SUCCESS.getInfo(), drawAwardVO);
}
```

-   åœ¨ ActivityProcessImpl#doDrawProcess æ–¹æ³•ä¸­ï¼Œä¸»è¦è¡¥å…¨çš„å°±æ˜¯å…³äº MQ çš„å¤„ç†ï¼Œè¿™é‡Œæˆ‘ä»¬ä¼šè°ƒåŠ¨ kafkaProducer.sendLotteryInvoice å‘é€ä¸€ä¸ªä¸­å¥–ç»“æœçš„å‘è´§å•ã€‚
-   æ¶ˆæ¯å‘é€å®Œæ¯•åè¿›è¡Œå›è°ƒå¤„ç†ï¼Œæ›´æ–°æ•°æ®åº“ä¸­ MQ å‘é€çš„çŠ¶æ€ï¼Œå¦‚æœæœ‰ MQ å‘é€å¤±è´¥åˆ™æ›´æ–°æ•°æ®åº“ mq_state = 2Â **è¿™é‡Œè¿˜æœ‰å¯èƒ½åœ¨æ›´æ–°åº“è¡¨çŠ¶æ€çš„æ—¶å€™å¤±è´¥**ï¼Œä½†==æ²¡å…³ç³»è¿™äº›éƒ½ä¼šè¢« worker è¡¥å¿å¤„ç†æ‰ï¼Œä¸€ç§æ˜¯å‘é€ MQ å¤±è´¥ï¼Œå¦å¤–ä¸€ç§æ˜¯ MQ çŠ¶æ€ä¸º 0 ä½†å¾ˆä¹…éƒ½æ²¡æœ‰å‘é€ MQ é‚£ä¹ˆä¹Ÿå¯ä»¥è§¦å‘å‘é€==ã€‚
-   ç°åœ¨ä»ç”¨æˆ·é¢†å–æ´»åŠ¨ã€æ‰§è¡ŒæŠ½å¥–ã€ç»“æœè½åº“ï¼Œåˆ° å‘é€MQå¤„ç†åç»­å‘å¥–çš„æµç¨‹å°±è§£è€¦äº†ï¼Œå› ä¸ºç”¨æˆ·åªéœ€è¦çŸ¥é“è‡ªå·±ä¸­å¥–äº†ï¼Œä½†å‘å¥–åˆ°è´§æ˜¯å¯ä»¥ç­‰å¾…çš„ï¼Œæ¯•ç«Ÿå‘é€è™šæ‹Ÿå•†å“çš„ç­‰å¾…æ—¶é—´å¹¶ä¸ä¼šå¾ˆé•¿ï¼Œè€Œå®ç‰©å•†å“èµ°ç‰©æµå°±æ›´å¯ä»¥æ¥æ”¶äº†ã€‚==æ‰€ä»¥å¯¹äºè¿™æ ·çš„æµç¨‹è¿›è¡Œè§£è€¦æ˜¯éå¸¸æœ‰å¿…è¦çš„ï¼Œå¦åˆ™ä½ çš„ç¨‹åºé€»è¾‘ä¼šè®©ç”¨æˆ·åœ¨ç•Œé¢ç­‰å¾…æ›´ä¹…çš„æ—¶é—´==ã€‚

## [](https://gitcode.net/KnowledgePlanet/Lottery/-/wikis/%E7%AC%AC-2-%E9%83%A8%E5%88%86-%E9%A2%86%E5%9F%9F%E5%BC%80%E5%8F%91//%E7%AC%AC16%E8%8A%82%EF%BC%9A%E4%BD%BF%E7%94%A8MQ%E8%A7%A3%E8%80%A6%E6%8A%BD%E5%A5%96%E5%8F%91%E8%B4%A7%E6%B5%81%E7%A8%8B#%E5%85%AD%E6%B5%8B%E8%AF%95%E9%AA%8C%E8%AF%81)å…­ã€æµ‹è¯•éªŒè¯

æµ‹è¯•ä¹‹å‰éœ€è¦å¼€å¯ Kafka æœåŠ¡

-   å¯åŠ¨ Zookeeperï¼š`bin/zookeeper-server-start.sh -daemon config/zookeeper.properties`
-   å¯åŠ¨ Kafkaï¼š`bin/kafka-server-start.sh -daemon config/server.properties`

**å•å…ƒæµ‹è¯•(å‘é€æ¶ˆæ¯)**

**cn.itedus.lottery.test.application.KafkaProducerTest**

```
@Test
public void test_send() throws InterruptedException {
    InvoiceVO invoice = new InvoiceVO();
    invoice.setuId("fustack");
    invoice.setOrderId(1444540456057864192L);
    invoice.setAwardId("3");
    invoice.setAwardType(Constants.AwardType.DESC.getCode());
    invoice.setAwardName("Code");
    invoice.setAwardContent("è‹¹æœç”µè„‘");
    invoice.setShippingAddress(null);
    invoice.setExtInfo(null);
    kafkaProducer.sendLotteryInvoice(invoice);

    while (true){
        Thread.sleep(10000);
    }
}
```

-   ä½ å¯ä»¥è‡ªå·±ä¸»åŠ¨å‘é€æ¶ˆæ¯çš„æ–¹å¼è¿›è¡Œæµ‹è¯• MQ çš„æ¥æ”¶å’Œå¤„ç†è¿‡ç¨‹

**å•å…ƒæµ‹è¯•(æµç¨‹æµ‹è¯•)**

**cn.itedus.lottery.test.application.ActivityProcessTest**

```
@Test
public void test_doDrawProcess() {
    DrawProcessReq req = new DrawProcessReq();
    req.setuId("xiaofuge");
    req.setActivityId(100001L);
    DrawProcessResult drawProcessResult = activityProcess.doDrawProcess(req);
    logger.info("è¯·æ±‚å…¥å‚ï¼š{}", JSON.toJSONString(req));
    logger.info("æµ‹è¯•ç»“æœï¼š{}", JSON.toJSONString(drawProcessResult));
}
```

-   å…¨æµç¨‹æµ‹è¯•æ˜¯ä¸šåŠ¡æœåŠ¡è‡ªå·±å‘é€MQï¼Œå†ç”±æ¶ˆè´¹æ–¹æ¥å¤„ç† MQ æ¶ˆæ¯

**æµ‹è¯•ç»“æœ**

[![](https://gitcode.net/KnowledgePlanet/Lottery/-/raw/master/doc/assets/img/Part-2/16-02.png)](https://gitcode.net/KnowledgePlanet/Lottery/-/raw/master/doc/assets/img/Part-2/16-02.png)

```
2021-10-30 15:19:43.002  INFO 57827 --- [           main] c.b.m.db.router.DBRouterJoinPoint        : æ•°æ®åº“è·¯ç”± dbIdxï¼š1 tbIdxï¼š1
2021-10-30 15:19:43.019  INFO 57827 --- [           main] c.b.m.db.router.DBRouterJoinPoint        : æ•°æ®åº“è·¯ç”± dbIdxï¼š1 tbIdxï¼š1
2021-10-30 15:19:43.180  INFO 57827 --- [           main] c.i.l.d.s.s.draw.impl.DrawExecImpl       : æ‰§è¡ŒæŠ½å¥–ç­–ç•¥ strategyIdï¼š10001ï¼Œæ— åº“å­˜æ’é™¤å¥–å“åˆ—è¡¨IDé›†åˆ awardListï¼š["1"]
2021-10-30 15:19:43.193  INFO 57827 --- [           main] c.i.l.d.s.service.draw.AbstractDrawBase  : æ‰§è¡Œç­–ç•¥æŠ½å¥–å®Œæˆã€å·²ä¸­å¥–ã€‘ï¼Œç”¨æˆ·ï¼šxiaofuge ç­–ç•¥IDï¼š10001 å¥–å“IDï¼š3 å¥–å“åç§°ï¼šipad
2021-10-30 15:19:43.195  INFO 57827 --- [           main] c.b.m.db.router.DBRouterJoinPoint        : æ•°æ®åº“è·¯ç”± dbIdxï¼š1 tbIdxï¼š1
2021-10-30 15:19:43.204  INFO 57827 --- [           main] c.b.m.db.router.DBRouterJoinPoint        : æ•°æ®åº“è·¯ç”± dbIdxï¼š1 tbIdxï¼š1
2021-10-30 15:19:43.242  INFO 57827 --- [           main] c.i.l.a.mq.producer.KafkaProducer        : å‘é€MQæ¶ˆæ¯ topicï¼šlottery_invoice bizIdï¼šxiaofuge messageï¼š{"awardContent":"Code","awardId":"3","awardName":"ipad","awardType":1,"orderId":1454347265400504320,"uId":"xiaofuge"}
2021-10-30 15:19:43.326  INFO 57827 --- [           main] c.i.l.t.application.ActivityProcessTest  : è¯·æ±‚å…¥å‚ï¼š{"activityId":100001,"uId":"xiaofuge"}
2021-10-30 15:19:43.335  INFO 57827 --- [           main] c.i.l.t.application.ActivityProcessTest  : æµ‹è¯•ç»“æœï¼š{"code":"0000","drawAwardVO":{"awardContent":"Code","awardId":"3","awardName":"ipad","awardType":1,"grantType":1,"strategyMode":2,"uId":"xiaofuge"},"info":"æˆåŠŸ"}
2021-10-30 15:19:43.338  INFO 57827 --- [ad | producer-1] c.b.m.db.router.DBRouterJoinPoint        : æ•°æ®åº“è·¯ç”± dbIdxï¼š1 tbIdxï¼š1
```

-   ä»æµ‹è¯•ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œç”¨æˆ· xiaofuge æ‰§è¡ŒæŠ½å¥–ä¸­å¥–åï¼Œå·²ç»è§¦å‘äº† MQ æ¶ˆæ¯çš„å‘é€ï¼Œå¹¶è¿›è¡Œäº†æ¶ˆè´¹ï¼Œæœ€ç»ˆå¥–å“å‘æ”¾å®Œæˆã€‚
-   åœ¨å¤§å®¶è‡ªå·±æµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥ debug è·Ÿè¿›ä»£ç ï¼Œçœ‹çœ‹æ¯ä¸€å—æµç¨‹æ˜¯å¦‚ä½•å¤„ç†çš„ï¼Œè¿™æ ·å¯ä»¥æ›´å¥½çš„ç†è§£è¿™æ®µä»£ç çš„æ“ä½œæ­¥éª¤ã€‚

---

1.  å­¦ä¹  MQ è§£è€¦çš„è¿‡ç¨‹ä»¥åŠåœ¨å¤„ç†è§£è€¦ä¸­æ€ä¹ˆä¿è¯æµç¨‹é“¾è·¯çš„å¯é æ€§ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç† MQ æ¶ˆæ¯çš„æ—¶å€™ï¼Œå‘é€å¤±è´¥äº†æ€ä¹ˆåŠã€æ¶ˆè´¹å¤±è´¥äº†æ€ä¹ˆåŠ
2.  å°è¯•ä»æµç¨‹å›¾ã€ä»£ç å¼€å‘ã€å•å…ƒæµ‹è¯•éªŒè¯ä¸­ç†è§£ç¨‹åºçš„è®¾è®¡ï¼Œå†™ä»£ç æ˜¯æ•´ä¸ªå¼€å‘é˜¶æ®µæœ€ä¸ºåé¢çš„äº‹æƒ…ï¼Œæœ€å…ˆä¸»è¦åšçš„æ˜¯ğŸ¤”æ€è€ƒå¦‚ä½•è®¾è®¡ï¼Œä¼šé‡åˆ°å“ªäº›é—®é¢˜ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯ä»€ä¹ˆã€‚