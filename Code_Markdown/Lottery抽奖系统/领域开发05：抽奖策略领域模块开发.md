-   åˆ†æ”¯ï¼š[210814_xfg_strategy](https://gitcode.net/KnowledgePlanet/Lottery/-/tree/210814_xfg_strategy)
-   æè¿°ï¼šåœ¨domainæŠ½å¥–é¢†åŸŸæ¨¡å—å®ç°ä¸¤ç§æŠ½å¥–ç­–ç•¥ç®—æ³•ï¼ŒåŒ…æ‹¬ï¼šå•é¡¹æ¦‚ç‡æŠ½å¥–å’Œæ•´ä½“æ¦‚ç‡æŠ½å¥–ï¼Œå¹¶æä¾›ç»Ÿä¸€çš„è°ƒç”¨æ–¹å¼
-   å®Œå–„ï¼šğŸ“¢ å¯ä»¥éƒ½å­¦å®Œåå†å›æ¥çœ‹è¿™ä¸ªåˆ†æ”¯ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå…¨é‡ä»£ç åˆ†æ”¯ä¸‹çš„åŠŸèƒ½å®Œå–„ [220111_xfg_config_strategy](https://gitcode.net/KnowledgePlanet/Lottery/-/commits/220111_xfg_config_strategy) - `å¯¹äºæŠ½å¥–ç­–ç•¥é…ç½®æ³¨å…¥ä½¿ç”¨ list + æšä¸¾ çš„æ–¹å¼è¿›è¡Œä¼˜åŒ–ï¼Œå‚è€ƒissueï¼š` [DrawConfig.java](https://gitcode.net/KnowledgePlanet/Lottery/-/blob/220111_xfg_config_strategy/lottery-domain/src/main/java/cn/itedus/lottery/domain/strategy/service/draw/DrawConfig.java) -> [#54](https://gitcode.net/KnowledgePlanet/Lottery/-/issues/54 "å…³äºä½¿ç”¨æ‰«ææ–¹å¼æ³¨å†ŒæŠ½å¥–ç­–ç•¥æ–¹æ¡ˆ")

## ä¸€ã€éœ€æ±‚å¼•å‡ºè®¾è®¡

**éœ€æ±‚**ï¼šåœ¨ä¸€åœºè¥é”€æŠ½å¥–æ´»åŠ¨ç©æ³•ä¸­ï¼Œè¿è¥äººå‘˜é€šå¸¸ä¼šé…ç½®ä»¥è½¬ç›˜ã€ç›²ç›’ç­‰å±•ç°å½¢å¼çš„æŠ½å¥–ç©æ³•ã€‚ä¾‹å¦‚åœ¨è½¬ç›˜ä¸­é…ç½®12ä¸ªå¥–å“ï¼Œæ¯ä¸ªå¥–å“é…ç½®ä¸åŒçš„ä¸­å¥–æ¦‚ç‡ï¼Œå½“1ä¸ªå¥–å“è¢«æŠ½ç©ºäº†ä»¥åï¼Œé‚£ä¹ˆå†æŠ½å¥–æ—¶ï¼š
- æ˜¯å‰©ä½™çš„å¥–å“æ€»æ¦‚ç‡å‡åŒ€åˆ†é…åœ¨11ä¸ªå¥–å“ä¸Š
- è¿˜æ˜¯ä¿æŒå‰©ä½™11ä¸ªå¥–å“çš„ä¸­å¥–æ¦‚ç‡ï¼Œå¦‚æœæŠ½åˆ°ä¸ºç©ºçš„å¥–å“åˆ™è¡¨ç¤ºæœªä¸­å¥–ã€‚

å…¶å®è¿™ä¸¤ç§æ–¹å¼åœ¨å®é™…çš„è¿è¥è¿‡ç¨‹ä¸­éƒ½ä¼šæœ‰æ‰€é€‰å–ï¼Œä¸»è¦æ˜¯**ä¸ºäº†é…åˆä¸åŒçš„ç©æ³•**ã€‚
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202305232228470.png)
**è®¾è®¡**ï¼šé‚£ä¹ˆæˆ‘ä»¬åœ¨åšè¿™æ ·çš„æŠ½å¥–é¢†åŸŸæ¨¡å—è®¾è®¡æ—¶ï¼Œå°±è¦è€ƒè™‘åˆ°**åº“è¡¨ä¸­è¦æœ‰å¯¹åº”çš„å­—æ®µï¼Œæ¥åŒºåˆ†å½“å‰è¿è¥é€‰æ‹©çš„æ˜¯ä»€ä¹ˆæ ·çš„æŠ½å¥–ç­–ç•¥**ã€‚é‚£ä¹ˆåœ¨å¼€å‘å®ç°ä¸Š**ä¹Ÿä¼šç”¨åˆ°å¯¹åº”çš„ `ç­–ç•¥æ¨¡å¼` çš„ä½¿ç”¨**ï¼Œä¸¤ç§æŠ½å¥–ç®—æ³•å¯ä»¥ç®—æ˜¯ä¸åŒçš„æŠ½å¥–ç­–ç•¥ï¼Œæœ€ç»ˆ**æä¾›ç»Ÿä¸€çš„æ¥å£åŒ…è£…**ï¼Œæ»¡è¶³ä¸åŒçš„æŠ½å¥–åŠŸèƒ½è°ƒç”¨ã€‚
-   åœ¨åº“è¡¨è®¾è®¡ä¸Šæˆ‘ä»¬æŠŠæŠ½å¥–éœ€è¦çš„ç­–ç•¥é…ç½®å’Œç­–ç•¥æ˜ç»†ï¼Œå®ƒä»¬çš„å…³ç³»æ˜¯ `1vn` ã€‚
-   å¦å¤–ï¼Œ**ä¸ºäº†è®©æŠ½å¥–ç­–ç•¥æˆä¸ºå¯ç‹¬ç«‹é…ç½®å’Œä½¿ç”¨çš„é¢†åŸŸæ¨¡å—**ï¼Œåœ¨ç­–ç•¥è¡¨ä¸å¼•å…¥æ´»åŠ¨IDä¿¡æ¯çš„é…ç½®ã€‚å› ä¸ºåœ¨å»ºè®¾é¢†åŸŸæ¨¡å—æ—¶ï¼Œæˆ‘ä»¬éœ€è¦==è®©è¿™éƒ¨åˆ†çš„é¢†åŸŸå®ç°å…·æœ‰å¯ç‹¬ç«‹è¿è¡Œçš„ç‰¹æ€§ï¼Œä¸è®©å®ƒè¢«ä¸šåŠ¡é€»è¾‘æ±¡æŸ“ï¼Œå®ƒåªæ˜¯ä¸€ç§æ— ä¸šåŠ¡é€»è¾‘çš„ã€é€šç”¨å…±æ€§çš„åŠŸèƒ½é¢†åŸŸæ¨¡å—==ï¼Œåœ¨ä¸šåŠ¡ç»„åˆçš„è¿‡ç¨‹ä¸­**å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½é¢†åŸŸæä¾›çš„æ ‡å‡†æ¥å£**ã€‚
-   **é€šè¿‡è¿™æ ·çš„è®¾è®¡å®ç°ï¼Œå°±å¯ä»¥æ»¡è¶³äºä¸åŒä¸šåŠ¡åœºæ™¯çš„çµæ´»è°ƒç”¨**ï¼Œä¾‹å¦‚ï¼šæœ‰äº›ä¸šåŠ¡åœºæ™¯éœ€è¦ä½ ç›´æ¥æ¥è¿›è¡ŒæŠ½å¥–ï¼Œåé¦ˆä¸­å¥–ä¿¡æ¯å‘é€ç»™ç”¨æˆ·ï¼›ä½†è¿˜æœ‰ä¸€äº›å› ä¸ºç”¨æˆ·ä¸‹å•æ”¯ä»˜ã€æ‰æ»¡è¶³æŠ½å¥–æ¡ä»¶çš„åœºæ™¯ã€‚å¯¹åº”çš„å¥–å“æ˜¯éœ€è¦å»¶æ—¶åˆ°è´¦çš„ï¼Œé¿å…ç”¨æˆ·åœ¨ä¸‹å•ååˆè¿›è¡Œé€€å•ï¼Œè¿™æ ·é€ æˆäº†åˆ·å•çš„é£é™©ã€‚`æ‰€ä»¥æœ‰æ—¶å€™ä½ çš„è®¾è®¡æ˜¯ä¸ä¸šåŠ¡åœºæ™¯æ¯æ¯ç›¸å…³çš„`

åœ¨å®ç°é¢†åŸŸåŠŸèƒ½å‰ï¼Œå…ˆè¦æ·»åŠ å®Œå–„infrastructureçš„daoå’Œpoï¼Œå’Œinterfacesä¸­çš„Mapper.xmlï¼š
```xml
// Award_Mapper.xml
<?xml version="1.0" encoding="UTF-8"?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
<mapper namespace="com.memcpy0.lottery.infrastructure.dao.IActivityDao">  
  
    <insert id="insert" parameterType="com.memcpy0.lottery.infrastructure.po.Activity">  
        INSERT INTO activity  
        (activityId, activityName, activityDesc,beginDateTime, endDateTime,        stockCount, takeCount, state, creator, createTime, updateTime)        VALUES        (#{activityId}, #{activityName}, #{activityDesc},#{beginDateTime}, #{endDateTime},         #{stockCount}, #{takeCount}, #{state}, #{creator}, now(), now())    </insert>  
  
    <select id="queryActivityById" parameterType="java.lang.Long" resultType="com.memcpy0.lottery.infrastructure.po.Activity">  
        SELECT activityId, activityName, activityDesc,beginDateTime, endDateTime,  
        stockCount, takeCount, state, creator, createTime, updateTime        FROM activity        WHERE activityId = #{activityId}    </select>  
  
</mapper>

// Activity_Mapper.xml
<?xml version="1.0" encoding="UTF-8"?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
<mapper namespace="com.memcpy0.lottery.infrastructure.dao.IActivityDao">  
  
    <insert id="insert" parameterType="com.memcpy0.lottery.infrastructure.po.Activity">  
        INSERT INTO activity  
        (activityId, activityName, activityDesc,beginDateTime, endDateTime,        stockCount, takeCount, state, creator, createTime, updateTime)        VALUES        (#{activityId}, #{activityName}, #{activityDesc},#{beginDateTime}, #{endDateTime},         #{stockCount}, #{takeCount}, #{state}, #{creator}, now(), now())    </insert>  
  
    <select id="queryActivityById" parameterType="java.lang.Long" resultType="com.memcpy0.lottery.infrastructure.po.Activity">  
        SELECT activityId, activityName, activityDesc,beginDateTime, endDateTime,  
        stockCount, takeCount, state, creator, createTime, updateTime        FROM activity        WHERE activityId = #{activityId}    </select>  
  
</mapper>

// Strategy_Mapper.xml
<?xml version="1.0" encoding="UTF-8"?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
<mapper namespace="com.memcpy0.lottery.infrastructure.dao.IStrategyDao">  
  
    <select id="queryStrategy" parameterType="java.lang.Long" resultType="com.memcpy0.lottery.infrastructure.po.Strategy">  
        SELECT  
        id, strategyId, strategyDesc, strategyMode, grantType,        grantDate, extInfo , createTime, updateTime        FROM strategy        WHERE strategyId = #{strategyId}    </select>  
  
</mapper>

// StrategyDetail_Mapper.xml
<?xml version="1.0" encoding="UTF-8"?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
<mapper namespace="com.memcpy0.lottery.infrastructure.dao.IStrategyDetailDao">  
  
    <select id="queryStrategyDetailList" parameterType="java.lang.Long" resultType="com.memcpy0.lottery.infrastructure.po.StrategyDetail">  
        SELECT id, strategyId, awardId, awardCount, awardRate, createTime, updateTime  
        FROM strategy_detail        WHERE strategyId = #{strategyId}    </select>  
  
</mapper>
```
ç­–ç•¥æ˜ç»†è¡¨ï¼Œé‡Œé¢ç°åœ¨å«æœ‰å¥–å“IDå’Œå¥–å“æ•°é‡ï¼Ÿï¼š
```java
package com.memcpy0.lottery.infrastructure.po;  
  
import java.util.Date;  
  
/**  
 * ç­–ç•¥é…ç½®è¡¨  
 */  
public class Strategy {  
  
    // è‡ªå¢ID  
    private Long id;  
  
    // ç­–ç•¥ID  
    private Long strategyId;  
  
    // ç­–ç•¥æè¿°  
    private String strategyDesc;  
  
    // ç­–ç•¥æ–¹å¼ã€Œ1:å•é¡¹æ¦‚ç‡ã€2:æ€»ä½“æ¦‚ç‡ã€  
    private Integer strategyMode;  
  
    // å‘æ”¾å¥–å“æ–¹å¼ã€Œ1:å³æ—¶ã€2:å®šæ—¶[å«æ´»åŠ¨ç»“æŸ]ã€3:äººå·¥ã€  
    private Integer grantType;  
  
    // å‘æ”¾å¥–å“æ—¶é—´  
    private Date grantDate;  
  
    // æ‰©å±•ä¿¡æ¯  
    private String extInfo;  
  
    // åˆ›å»ºæ—¶é—´  
    private Date createTime;  
  
    // ä¿®æ”¹æ—¶é—´  
    private Date updateTime;  
  
    public Long getId() {  
        return id;  
    }  
  
    public void setId(Long id) {  
        this.id = id;  
    }  
  
    public Long getStrategyId() {  
        return strategyId;  
    }  
  
    public void setStrategyId(Long strategyId) {  
        this.strategyId = strategyId;  
    }  
  
    public String getStrategyDesc() {  
        return strategyDesc;  
    }  
  
    public void setStrategyDesc(String strategyDesc) {  
        this.strategyDesc = strategyDesc;  
    }  
  
    public Integer getStrategyMode() {  
        return strategyMode;  
    }  
  
    public void setStrategyMode(Integer strategyMode) {  
        this.strategyMode = strategyMode;  
    }  
  
    public Integer getGrantType() {  
        return grantType;  
    }  
  
    public void setGrantType(Integer grantType) {  
        this.grantType = grantType;  
    }  
  
    public Date getGrantDate() {  
        return grantDate;  
    }  
  
    public void setGrantDate(Date grantDate) {  
        this.grantDate = grantDate;  
    }  
  
    public String getExtInfo() {  
        return extInfo;  
    }  
  
    public void setExtInfo(String extInfo) {  
        this.extInfo = extInfo;  
    }  
  
    public Date getCreateTime() {  
        return createTime;  
    }  
  
    public void setCreateTime(Date createTime) {  
        this.createTime = createTime;  
    }  
  
    public Date getUpdateTime() {  
        return updateTime;  
    }  
  
    public void setUpdateTime(Date updateTime) {  
        this.updateTime = updateTime;  
    }  
}

//////////////////////
package com.memcpy0.lottery.infrastructure.po;  
  
import java.math.BigDecimal;  
  
/**  
 * ç­–ç•¥æ˜ç»†  
 */  
public class StrategyDetail {  
  
    // è‡ªå¢ID  
    private String id;  
  
    // ç­–ç•¥ID  
    private Long strategyId;  
  
    // å¥–å“ID  
    private String awardId;  
  
    // å¥–å“æ•°é‡  
    private String awardCount;  
  
    // ä¸­å¥–æ¦‚ç‡  
    private BigDecimal awardRate;  
  
    // åˆ›å»ºæ—¶é—´  
    private String createTime;  
  
    // ä¿®æ”¹æ—¶é—´  
    private String updateTime;  
  
    public String getId() {  
        return id;  
    }  
  
    public void setId(String id) {  
        this.id = id;  
    }  
  
    public Long getStrategyId() {  
        return strategyId;  
    }  
  
    public void setStrategyId(Long strategyId) {  
        this.strategyId = strategyId;  
    }  
  
    public String getAwardId() {  
        return awardId;  
    }  
  
    public void setAwardId(String awardId) {  
        this.awardId = awardId;  
    }  
  
    public String getAwardCount() {  
        return awardCount;  
    }  
  
    public void setAwardCount(String awardCount) {  
        this.awardCount = awardCount;  
    }  
  
    public BigDecimal getAwardRate() {  
        return awardRate;  
    }  
  
    public void setAwardRate(BigDecimal awardRate) {  
        this.awardRate = awardRate;  
    }  
  
    public String getCreateTime() {  
        return createTime;  
    }  
  
    public void setCreateTime(String createTime) {  
        this.createTime = createTime;  
    }  
  
    public String getUpdateTime() {  
        return updateTime;  
    }  
  
    public void setUpdateTime(String updateTime) {  
        this.updateTime = updateTime;  
    }  
}
```
è€Œinfrastructureä¸‹çš„DAOåŒ…ä¸­ï¼Œå¯¹äºç­–ç•¥éƒ½æ˜¯æŒ‰ç…§IDæŸ¥è¯¢ï¼š
```java
package com.memcpy0.lottery.infrastructure.dao;  
  
import com.memcpy0.lottery.infrastructure.po.Strategy;  
import org.apache.ibatis.annotations.Mapper;  
  
@Mapper  
public interface IStrategyDao {  
    Strategy queryStrategy(Long strategyId); 
}
////////////////////
package com.memcpy0.lottery.infrastructure.dao;  
  
import com.memcpy0.lottery.infrastructure.po.StrategyDetail;  
import org.apache.ibatis.annotations.Mapper;  
  
import java.util.List;  
  
@Mapper  
public interface IStrategyDetailDao {  
    List<StrategyDetail> queryStrategyDetailList(Long strategyId);  
}
////////////////////
package com.memcpy0.lottery.infrastructure.dao;  
  
import com.memcpy0.lottery.infrastructure.po.Award;  
import org.apache.ibatis.annotations.Mapper;  
  
@Mapper  
public interface IAwardDao {  
    Award queryAwardInfo(String awardId);  
}
////////////////////
package com.memcpy0.lottery.infrastructure.dao;  
  
import com.memcpy0.lottery.infrastructure.po.Activity;  
import org.apache.ibatis.annotations.Mapper;  
  
@Mapper  
public interface IActivityDao {  
   void insert(Activity req);  
   Activity queryActivityById(Long activityId);  
}
```
## 0. æµ‹è¯•
ä¸‹é¢å…ˆæ˜¯æµ‹è¯•ï¼š
æŠ½å¥–ç­–ç•¥æµ‹è¯•  
https://www.jugong.wang/random-portal/my/qa  
https://csrc.nist.gov/Projects/Random-Bit-Generation/Documentation-and-Software  
Java éšæœºæ•°ç”Ÿæˆå™¨ Random & SecureRandom åŸç†åˆ†æ https://blog.csdn.net/hustspy1990/article/details/93364805  
ä½¿ç”¨ SecureRandom äº§ç”Ÿéšæœºæ•°é‡‡å‘è®°å½• https://blog.csdn.net/weixin_41385912/article/details/103267277  
```java
package com.memcpy0.lottery.domain.strategy.service;  
  
import java.util.List;  
import java.util.Map;  
  
/**  
 * å®éªŒç±»  
 */  
@Deprecated  
public class DrawStrategy {  
    private final int HASH_INCREMENT = 0x61c88647;  
    private String[] rateTuple = new String[128];  
    /**  
     * åˆå§‹åŒ–æ¦‚ç‡ç´¢å¼•æ•°ç»„  
     * @param drawConfig  
     */  
    public void initRateTuple(List<Map<String, String>> drawConfig) {  
        int cursorVal = 0;  
        for (Map<String, String> drawMap : drawConfig) {  
            int rateVal = Integer.parseInt(drawMap.get("awardRate"));  
            // 5%(è®°å½•çš„æ˜¯5) -> [1, 5]  
            for (int i = cursorVal + 1; i <= (rateVal + cursorVal); ++i) {  
                // è®¡ç®—æ•°ç»„ç´¢å¼•å¹¶å¡«å……æ•°æ®  
                int hashCode = i * HASH_INCREMENT + HASH_INCREMENT;  
                int idx = hashCode & (rateTuple.length - 1);  
                rateTuple[idx] = drawMap.get("awardDesc");  
            }  
            cursorVal += rateVal;  
        }  
    }  
  
    public String randomDraw(int rate) {  
        int hashCode = rate * HASH_INCREMENT + HASH_INCREMENT;  
        int idx = hashCode & (rateTuple.length - 1);  
        return rateTuple[idx];  
    }  
}
///////////////////////////////////////////////////////////////
package com.memcpy0.lottery.test;  
  
import com.memcpy0.lottery.domain.strategy.service.DrawStrategy;  
import org.junit.Test;  
import org.junit.runner.RunWith;  
import org.springframework.boot.test.context.SpringBootTest;  
import org.springframework.test.context.junit4.SpringRunner;  
import java.security.SecureRandom;  
import java.util.*;  
  
@RunWith(SpringRunner.class)  
@SpringBootTest  
public class ApiTest {  
    /**  
     * æŠ½å¥–ç­–ç•¥æµ‹è¯•  
     * <p>  
     * https://www.jugong.wang/random-portal/my/qa  
     * https://csrc.nist.gov/Projects/Random-Bit-Generation/Documentation-and-Software     
     * Java éšæœºæ•°ç”Ÿæˆå™¨ Random & SecureRandom åŸç†åˆ†æ https://blog.csdn.net/hustspy1990/article/details/93364805  
     * ä½¿ç”¨ SecureRandom äº§ç”Ÿéšæœºæ•°é‡‡å‘è®°å½• https://blog.csdn.net/weixin_41385912/article/details/103267277  
     */    @Test  
    public void test_strategy() {  
        SecureRandom random = new SecureRandom();  
        int rate = random.nextInt(100);  
        System.out.println("æ¦‚ç‡ï¼š" + rate);  
    }  
  
    @Test  
    public void test_idx() {  
        Map<Integer, Integer> map = new HashMap<>();  
  
        int HASH_INCREMENT = 0x61c88647;  
        int hashCode = 0;  
        for (int i = 1; i <= 100; i++) {  
            hashCode = i * HASH_INCREMENT + HASH_INCREMENT;  
            int idx = hashCode & (128 - 1);  
            map.merge(idx, 1, Integer::sum);  
            System.out.println("æ–æ³¢é‚£å¥‘æ•£åˆ—ï¼š" + idx + " æ™®é€šæ•£åˆ—ï¼š" + (String.valueOf(i).hashCode() & (128 - 1)));  
        }  
        System.out.println(map);  
    }  
  
    @Test  
    public void test_DrawStrategy() {  
        List<Map<String, String>> strategyList = new ArrayList<>();  
        strategyList.add(new HashMap<String, String>() {{  
            put("awardDesc", "ä¸€ç­‰å¥–ï¼šå½©ç”µ");  
            put("awardId", "10001");  
            put("awardCount", "3");  
            put("awardRate", "20");  
        }});  
        strategyList.add(new HashMap<String, String>() {{  
            put("awardDesc", "äºŒç­‰å¥–ï¼šå†°ç®±");  
            put("awardId", "10002");  
            put("awardCount", "5");  
            put("awardRate", "30");  
        }});  
        strategyList.add(new HashMap<String, String>() {{  
            put("awardDesc", "ä¸‰ç­‰å¥–ï¼šæ´—è¡£æœº");  
            put("awardId", "10003");  
            put("awardCount", "10");  
            put("awardRate", "50");  
        }});  
        DrawStrategy drawStrategy = new DrawStrategy();  
        drawStrategy.initRateTuple(strategyList);  
  
        SecureRandom random = new SecureRandom();  
        for (int i = 0; i < 10; i++) {  
            System.out.println("ä¸­å¥–ç»“æœï¼š" + drawStrategy.randomDraw(random.nextInt(100) + 1));  
        }  
    }  
  
    @Test  
    public void test_random() {  
        SecureRandom random = new SecureRandom();  
        for (int i = 0; i < 10; i++) {  
            System.out.println(random.nextInt(1));  
        }  
    }  
    /*
    ä¸­å¥–ç»“æœï¼šäºŒç­‰å¥–ï¼šå†°ç®±
    ä¸­å¥–ç»“æœï¼šä¸€ç­‰å¥–ï¼šå½©ç”µ
    ä¸­å¥–ç»“æœï¼šä¸‰ç­‰å¥–ï¼šæ´—è¡£æœº
    ä¸­å¥–ç»“æœï¼šäºŒç­‰å¥–ï¼šå†°ç®±
    ä¸­å¥–ç»“æœï¼šä¸‰ç­‰å¥–ï¼šæ´—è¡£æœº
    ä¸­å¥–ç»“æœï¼šäºŒç­‰å¥–ï¼šå†°ç®±
    ä¸­å¥–ç»“æœï¼šä¸‰ç­‰å¥–ï¼šæ´—è¡£æœº
    ä¸­å¥–ç»“æœï¼šä¸‰ç­‰å¥–ï¼šæ´—è¡£æœº
    ä¸­å¥–ç»“æœï¼šä¸‰ç­‰å¥–ï¼šæ´—è¡£æœº
    ä¸­å¥–ç»“æœï¼šä¸‰ç­‰å¥–ï¼šæ´—è¡£æœº 
    */
}
```
ç®—æ³•é‡‡ç”¨æ–æ³¢é‚£å¥‘æ•£åˆ—ï¼š
- å¯¹ä¸€ä¸ªå¥–å“+æ•°é‡+æ¦‚ç‡+â€¦â€¦çš„æ•°ç»„ï¼Œä»å‰å¾€åéå†æ¯ç±»å¥–å“
- å¯¹æ¯ç±»å¥–å“åˆ†å¸ƒçš„æ¦‚ç‡åŒºé—´ï¼Œå¦‚å¥–å“1æ˜¯20ï¼Œå¥–å“2æ˜¯5ï¼Œåˆ™å¥–å“1çš„å“ˆå¸Œå€¼ä¸º[1çš„æ–æ³¢é‚£å¥‘æ•£åˆ—ç , 20çš„æ–æ³¢é‚£å¥‘æ•£åˆ—ç ]ï¼Œå¥–å“2çš„å“ˆå¸Œå€¼åŒºé—´ä¸º[21çš„æ–æ³¢é‚£å¥‘æ•£åˆ—ç ï¼Œ25çš„æ–æ³¢é‚£å¥‘æ•£åˆ—ç ]ã€‚
- ç„¶åæŒ‰ç…§å“ˆå¸Œå€¼ & æ¦‚ç‡ç´¢å¼•æ•°ç»„é•¿åº¦-1ï¼Œå°†å¥–å“çš„æè¿°ä¿¡æ¯åˆ†å¸ƒåœ¨æ¦‚ç‡ç´¢å¼•æ•°ç»„ä¸Šã€‚
- è·å–å¥–å“æ—¶ï¼Œç”Ÿæˆä¸€ä¸ª1-100çš„éšæœºæ•°ï¼Œä¼ å…¥randomDrawæ–¹æ³•ï¼Œæ–¹æ³•é‡Œé¢å¯¹å…¶è¿›è¡Œæ–æ³¢é‚£å¥‘æ•£åˆ—è·å–å…¶å“ˆå¸Œç ï¼Œç„¶åæŒ‰ç…§å“ˆå¸Œç  & æ•°ç»„é•¿åº¦-1è·å–å¥–å“æè¿°ã€‚


---
## äºŒã€é¢†åŸŸåŠŸèƒ½ç»“æ„
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202305232228208.png)
æŠ½å¥–ç³»ç»Ÿå·¥ç¨‹é‡‡ç”¨DDDæ¶æ„ + Moduleæ¨¡å—æ–¹å¼æ­å»ºï¼Œ**lottery-domain æ˜¯ä¸“é—¨ç”¨äºå¼€å‘é¢†åŸŸæœåŠ¡çš„æ¨¡å—**ï¼Œä¸é™äºç›®å‰çš„æŠ½å¥–ç­–ç•¥ï¼Œåœ¨æ­¤æ¨¡å—ä¸‹è¿˜æœ‰ä»¥åéœ€è¦å®ç°çš„æ´»åŠ¨é¢†åŸŸã€**è§„åˆ™å¼•æ“**ã€**ç”¨æˆ·æœåŠ¡**ç­‰ï¼Œéƒ½éœ€è¦åœ¨è¿™ä¸ªæ¨¡å—å®ç°å¯¹åº”çš„é¢†åŸŸåŠŸèƒ½ã€‚
 
**strategy æ˜¯ç¬¬1ä¸ªåœ¨ domain ä¸‹å®ç°çš„æŠ½å¥–ç­–ç•¥é¢†åŸŸ**ï¼Œåœ¨é¢†åŸŸåŠŸèƒ½å¼€å‘çš„æœåŠ¡ä¸‹ï¼Œä¸»è¦å«æœ‰modelã€repositoryã€serviceä¸‰å—åŒºåŸŸï¼Œæ¥ä¸‹æ¥åˆ†åˆ«ä»‹ç»åœ¨æŠ½å¥–é¢†åŸŸä¸­ï¼Œè¿™ä¸‰å—åŒºåŸŸéƒ½åšäº†å“ªäº›äº‹æƒ…ã€‚
-   **modelï¼Œç”¨äºæä¾›voã€reqã€res å’Œ aggregates èšåˆå¯¹è±¡**ã€‚
-   **repositoryï¼Œæä¾›ä»“å‚¨æœåŠ¡**ï¼Œå…¶å®ä¹Ÿå°±æ˜¯**å¯¹Mysqlã€Redisç­‰æ•°æ®çš„ç»Ÿä¸€åŒ…è£…**ã€‚
-   **serviceï¼Œæ˜¯å…·ä½“çš„ä¸šåŠ¡é¢†åŸŸé€»è¾‘å®ç°å±‚**ï¼Œåœ¨è¿™ä¸ªåŒ…ä¸‹å®šä¹‰äº†**algorithmæŠ½å¥–ç®—æ³•æ¥å£å’Œå®ç°**ï¼Œå’Œ**å…·ä½“çš„æŠ½å¥–ç­–ç•¥åŒ…è£… draw å±‚**ï¼Œå¯¹å¤–æä¾›**æŠ½å¥–æ¥å£** IDrawExec#doDrawExec
### 1. é¢†åŸŸä¸­modelåŒ…å®ç°
```java
package com.memcpy0.lottery.domain.strategy.model.req;  
  
/**  
 * è°ƒç”¨æŠ½å¥–ç­–ç•¥çš„è¯·æ±‚å‚æ•°  
 */  
public class DrawReq {  
    // ç”¨æˆ·ID  
    private String uId;   
    // ç­–ç•¥ID  
    private Long strategyId;   
    public DrawReq() { }   
    public DrawReq(String uId, Long strategyId) {  
        this.uId = uId;  
        this.strategyId = strategyId;  
    }   
    public String getuId() {  
        return uId;  
    }   
    public void setuId(String uId) {  
        this.uId = uId;  
    }   
    public Long getStrategyId() {  
        return strategyId;  
    }   
    public void setStrategyId(Long strategyId) {  
        this.strategyId = strategyId;  
    }   
}
```

```java
package com.memcpy0.lottery.domain.strategy.model.res;  
  
/**  
 * è°ƒç”¨æŠ½å¥–ç­–ç•¥çš„è¿”å›ç»“æœ  
 */  
public class DrawResult {  
    // ç”¨æˆ·ID  
    private String uId;  
    // ç­–ç•¥ID  
    private Long strategyId;  
    // å¥–å“ID  
    private String rewardId;  
    // å¥–å“åç§°  
    private String awardName;  
  
    public DrawResult() {  
    }  
  
    public DrawResult(String uId, Long strategyId, String rewardId, String awardName) {  
        this.uId = uId;  
        this.strategyId = strategyId;  
        this.rewardId = rewardId;  
        this.awardName = awardName;  
    }  
  
    public String getuId() {  
        return uId;  
    }  
  
    public void setuId(String uId) {  
        this.uId = uId;  
    }  
  
    public Long getStrategyId() {  
        return strategyId;  
    }  
  
    public void setStrategyId(Long strategyId) {  
        this.strategyId = strategyId;  
    }  
  
    public String getRewardId() {  
        return rewardId;  
    }  
  
    public void setRewardId(String rewardId) {  
        this.rewardId = rewardId;  
    }  
  
    public String getAwardName() {  
        return awardName;  
    }  
  
    public void setAwardName(String awardName) {  
        this.awardName = awardName;  
    }  
}
```

```java
package com.memcpy0.lottery.domain.strategy.model.vo;  
  
import java.math.BigDecimal;  
  
/**   
* å¥–å“æ¦‚ç‡ä¿¡æ¯ï¼Œå¥–å“ç¼–å·ã€åº“å­˜ã€æ¦‚ç‡  
 */  
public class AwardRateInfo {   
    // å¥–å“ID  
    private String awardId;   
    // ä¸­å¥–æ¦‚ç‡  
    private BigDecimal awardRate;  
  
    public AwardRateInfo() {  
    }  
  
    public AwardRateInfo(String awardId, BigDecimal awardRate) {  
        this.awardId = awardId;  
        this.awardRate = awardRate;  
    }  
  
    public String getAwardId() {  
        return awardId;  
    }  
  
    public void setAwardId(String awardId) {  
        this.awardId = awardId;  
    }  
  
    public BigDecimal getAwardRate() {  
        return awardRate;  
    }  
  
    public void setAwardRate(BigDecimal awardRate) {  
        this.awardRate = awardRate;  
    }  
}
```

```java
package com.memcpy0.lottery.domain.strategy.model.aggregates;  
  
import com.memcpy0.lottery.infrastructure.po.Strategy;  
import com.memcpy0.lottery.infrastructure.po.StrategyDetail;  
  
import java.util.List;  
  
/**  
 * å®Œæ•´çš„ç­–ç•¥ä¿¡æ¯ç±»ï¼ŒåŒ…æ‹¬ç­–ç•¥é…ç½®å’Œç­–ç•¥æ˜ç»†ï¼Œä¸€ä¸ªç­–ç•¥é…ç½®å¯ä»¥å¯¹åº”å¤šä¸ªæ˜ç»†  
 */  
public class StrategyRich {  
    // ç­–ç•¥ID  
    private Long strategyId;  
    // ç­–ç•¥é…ç½®  
    private Strategy strategy;  
    // ç­–ç•¥æ˜ç»†  
    private List<StrategyDetail> strategyDetailList;  
  
    public StrategyRich() {  
    }  
  
    public StrategyRich(Long strategyId, Strategy strategy, List<StrategyDetail> strategyDetailList) {  
        this.strategyId = strategyId;  
        this.strategy = strategy;  
        this.strategyDetailList = strategyDetailList;  
    }  
  
    public Long getStrategyId() {  
        return strategyId;  
    }  
  
    public void setStrategyId(Long strategyId) {  
        this.strategyId = strategyId;  
    }  
  
    public Strategy getStrategy() {  
        return strategy;  
    }  
  
    public void setStrategy(Strategy strategy) {  
        this.strategy = strategy;  
    }  
  
    public List<StrategyDetail> getStrategyDetailList() {  
        return strategyDetailList;  
    }  
  
    public void setStrategyDetailList(List<StrategyDetail> strategyDetailList) {  
        this.strategyDetailList = strategyDetailList;  
    }  
}
```
### 2. é¢†åŸŸä¸­repositoryåŒ…å®ç°
æ¥å£ï¼šæŸ¥è¯¢â€œå¯Œç­–ç•¥â€ã€å’Œå¥–å“ï¼š
```java
package com.memcpy0.lottery.domain.strategy.repository;  
  
import com.memcpy0.lottery.domain.strategy.model.aggregates.StrategyRich;  
import com.memcpy0.lottery.infrastructure.po.Award;  
  
public interface IStrategyRepository {  
    StrategyRich queryStrategyRich(Long strategyId);  
    Award queryAwardInfo(String awardId);  
}
```

```java
package com.memcpy0.lottery.domain.strategy.repository.impl;  
  
import com.memcpy0.lottery.domain.strategy.model.aggregates.StrategyRich;  
import com.memcpy0.lottery.domain.strategy.repository.IStrategyRepository;  
import com.memcpy0.lottery.infrastructure.dao.IAwardDao;  
import com.memcpy0.lottery.infrastructure.dao.IStrategyDao;  
import com.memcpy0.lottery.infrastructure.dao.IStrategyDetailDao;  
import com.memcpy0.lottery.infrastructure.po.Award;  
import com.memcpy0.lottery.infrastructure.po.Strategy;  
import com.memcpy0.lottery.infrastructure.po.StrategyDetail;  
import org.springframework.stereotype.Component;  
  
import javax.annotation.Resource;  
import java.util.List;  
  
@Component  
public class StrategyRepository implements IStrategyRepository {  
    @Resource  
    private IStrategyDao strategyDao;  
  
    @Resource  
    private IStrategyDetailDao strategyDetailDao;  
  
    @Resource  
    private IAwardDao awardDao;  
  
    @Override  
    public StrategyRich queryStrategyRich(Long strategyId) {  
        Strategy strategy = strategyDao.queryStrategy(strategyId);  
        List<StrategyDetail> strategyDetailList = strategyDetailDao.queryStrategyDetailList(strategyId);  
        return new StrategyRich(strategyId, strategy, strategyDetailList);  
    }  
  
    @Override  
    public Award queryAwardInfo(String awardId) {  
        return awardDao.queryAwardInfo(awardId);  
    }  
}
```

## ä¸‰ã€æŠ½å¥–ç®—æ³•å®ç°
ä¸¤ç§æŠ½å¥–ç®—æ³•æè¿°ï¼Œåœºæ™¯A20%ã€B30%ã€C50% 
-   **æ€»ä½“æ¦‚ç‡**ï¼šå¦‚æœAå¥–å“æŠ½ç©ºåï¼Œ**Bå’ŒCå¥–å“çš„æ¦‚ç‡æŒ‰ç…§ `3:5` å‡åˆ†ï¼Œç›¸å½“äºBå¥–å“ä¸­å¥–æ¦‚ç‡ç”± `0.3` å‡ä¸º `0.375=3/8`**
-   **å•é¡¹æ¦‚ç‡**ï¼šå¦‚æœAå¥–å“æŠ½ç©ºåï¼ŒBå’ŒCä¿æŒç›®å‰ä¸­å¥–æ¦‚ç‡ï¼Œç”¨æˆ·æŠ½å¥–æ‰”æœ‰20%ä¸­ä¸ºAï¼Œå› Aåº“å­˜æŠ½ç©ºåˆ™ç»“æœå±•ç¤ºä¸ºæœªä¸­å¥–ã€‚**_ä¸ºäº†è¿è¥æˆæœ¬ï¼Œé€šå¸¸è¿™ç§æƒ…å†µçš„ä½¿ç”¨çš„æ¯”è¾ƒå¤š_**

### 1. å®šä¹‰æ¥å£
è¿™ä¸ªæ¥å£å°±æ˜¯ä¸Šé¢DrawStrategyçš„æŠ½è±¡ï¼š
**cn.itedus.lottery.domain.strategy.service.algorithm.IDrawAlgorithm**
```java
package com.memcpy0.lottery.domain.strategy.service.algorithm;  
import com.memcpy0.lottery.domain.strategy.model.vo.AwardRateInfo;  
  
import java.util.List;  
/**  
 * æŠ½å¥–ç®—æ³•æ¥å£  
 */  
public interface IDrawAlgorithm {  
  
    /**  
     * ç¨‹åºå¯åŠ¨æ—¶åˆå§‹åŒ–æ¦‚ç‡å…ƒç¥–ï¼Œåœ¨åˆå§‹åŒ–å®Œæˆåä½¿ç”¨è¿‡ç¨‹ä¸­ä¸å…è®¸ä¿®æ”¹å…ƒç¥–æ•°æ®  
     * <p>  
     * å…ƒç¥–æ•°æ®ä½œç”¨åœ¨äºè®²ç™¾åˆ†æ¯”å†…(0.2ã€0.3ã€0.5)çš„æ•°æ®ï¼Œè½¬æ¢ä¸ºä¸€æ•´æ¡æ•°ç»„ä¸Šåˆ†åŒºæ•°æ®ï¼Œå¦‚ä¸‹ï¼›  
     * 0.2 = 0 ~ 0.2  
     * 0.3 = 0 + 0.2 ~ 0.2 + 0.3 = 0.2 ~ 0.5     
     * 0.5 = 0.5 ~ 1 ï¼ˆè®¡ç®—æ–¹å¼åŒä¸Šï¼‰  
     * <p>  
     * é€šè¿‡æ•°æ®æ‹†åˆ†ä¸ºæ•´æ¡åï¼Œå†æ ¹æ®1-100ä¸­å„ä¸ªåŒºé—´çš„å¥–å“ä¿¡æ¯ï¼Œä½¿ç”¨æ–æ³¢é‚£å¥‘æ•£åˆ—è®¡ç®—å‡ºç´¢å¼•ä½ç½®ï¼ŒæŠŠå¥–å“æ•°æ®å­˜æ”¾åˆ°å…ƒç¥–ä¸­ã€‚æ¯”å¦‚ï¼š  
     * <p>  
     * 1. æŠŠ 0.2 è½¬æ¢ä¸º 20  
     * 2. 20 å¯¹åº”çš„æ–æ³¢é‚£å¥‘å€¼å“ˆå¸Œå€¼ï¼šï¼ˆ20 * HASH_INCREMENT + HASH_INCREMENTï¼‰= -1549107828 HASH_INCREMENT = 0x61c88647  
     * 3. å†é€šè¿‡å“ˆå¸Œå€¼è®¡ç®—ç´¢å¼•ä½ç½®ï¼šhashCode & (rateTuple.length - 1) = 12  
     * 4. é‚£ä¹ˆtup[12] = 0.2ä¸­å¥–æ¦‚ç‡å¯¹åº”çš„å¥–å“  
     * 5. å½“åç»­é€šè¿‡éšæœºæ•°è·å–åˆ°1-100çš„å€¼åï¼Œå¯ä»¥ç›´æ¥å®šä½åˆ°å¯¹åº”çš„å¥–å“ä¿¡æ¯ï¼Œ
     * é€šè¿‡è¿™æ ·çš„æ–¹å¼æŠŠè½®è®­ç®—å¥–çš„æ—¶é—´å¤æ‚åº¦ä»O(n) é™ä½åˆ° 0(1)  
     *     
     * @param strategyId        ç­–ç•¥ID  
     * @param awardRateInfoList å¥–å“æ¦‚ç‡é…ç½®é›†åˆ ã€Œå€¼ç¤ºä¾‹ï¼šAwardRateInfo.awardRate = 0.04ã€  
     */  
    void initRateTuple(Long strategyId, List<AwardRateInfo> awardRateInfoList);  
  
    /**  
     * åˆ¤æ–­æ˜¯å¦å·²ç»ï¼Œåšäº†æ•°æ®åˆå§‹åŒ–  
     * @param strategyId  
     * @return  
     */  
    boolean isExistRateTuple(Long strategyId);  
  
    /**  
     * SecureRandom ç”Ÿæˆéšæœºæ•°ï¼Œç´¢å¼•åˆ°å¯¹åº”çš„å¥–å“ä¿¡æ¯è¿”å›ç»“æœ  
     *  
     * @param strategyId ç­–ç•¥ID  
     * @param excludeAwardIds æ’é™¤æ‰å·²ç»ä¸èƒ½ä½œä¸ºæŠ½å¥–çš„å¥–å“IDï¼Œç•™ç»™é£æ§å’Œç©ºåº“å­˜ä½¿ç”¨  
     * @return ä¸­å¥–ç»“æœ  
     */  
    String randomDraw(Long strategyId, List<String> excludeAwardIds);  
}
```
- æ— è®ºä»»ä½•ä¸€ç§æŠ½å¥–ç®—æ³•çš„ä½¿ç”¨ï¼Œéƒ½**ä»¥è¿™ä¸ªæ¥å£ä½œä¸ºæ ‡å‡†çš„æŠ½å¥–æ¥å£**è¿›è¡ŒæŠ½å¥–ã€‚strategyId æ˜¯æŠ½å¥–ç­–ç•¥ã€excludeAwardIds æ’é™¤æ‰å·²ç»ä¸èƒ½ä½œä¸ºæŠ½å¥–çš„å¥–å“IDï¼Œ**ç•™ç»™é£æ§ï¼ˆé»‘åå•ç”¨æˆ·ç­‰ï¼‰å’Œç©ºåº“å­˜ä½¿ç”¨**

### 2. å…±ç”¨çš„ç®—æ³•é€»è¾‘initRateTupleã€isExistRateTupleå’ŒhashIdx
```java
package com.memcpy0.lottery.domain.strategy.service.algorithm;  
  
import com.memcpy0.lottery.domain.strategy.model.vo.AwardRateInfo;  
  
import java.math.BigDecimal;  
import java.util.List;  
import java.util.Map;  
import java.util.concurrent.ConcurrentHashMap;  
  
/**  
 * å…±ç”¨çš„ç®—æ³•é€»è¾‘  
 */  
public abstract class BaseAlgorithm implements IDrawAlgorithm {  
  
    // æ–æ³¢é‚£å¥‘æ•£åˆ—å¢é‡ï¼Œé€»è¾‘ï¼šé»„é‡‘åˆ†å‰²ç‚¹ï¼š(âˆš5 - 1) / 2 = 0.6180339887ï¼ŒMath.pow(2, 32) * 0.6180339887 = 0x61c88647  
    private final int HASH_INCREMENT = 0x61c88647;  
  
    // æ•°ç»„åˆå§‹åŒ–é•¿åº¦  
    private final int RATE_TUPLE_LENGTH = 128;  
  
    // å­˜æ”¾æŸä¸€ç­–ç•¥ä¸‹(å„ç±»å¥–å“åŠå…¶æ¦‚ç‡)å¯¹åº”çš„æ•£åˆ—ç»“æœï¼ŒstrategyId -> rateTuple  
    protected Map<Long, String[]> rateTupleMap = new ConcurrentHashMap<>();  
  
    // å¥–å“åŒºé—´æ¦‚ç‡å€¼ï¼ŒstrategyId -> [awardId->beginã€awardId->end]  
    protected Map<Long, List<AwardRateInfo>> awardRateInfoMap = new ConcurrentHashMap<>();  
  
    @Override  
    public void initRateTuple(Long strategyId, List<AwardRateInfo> awardRateInfoList) {  
        // ä¿å­˜å¥–å“æ¦‚ç‡ä¿¡æ¯  
        awardRateInfoMap.put(strategyId, awardRateInfoList); // å¯¹åº”ç­–ç•¥ä¸‹çš„å¥–å“æ¦‚ç‡åˆ—è¡¨  
  
        String[] rateTuple = rateTupleMap.computeIfAbsent(strategyId, k -> new String[RATE_TUPLE_LENGTH]);  
  
        int cursorVal = 0;  
        for (AwardRateInfo awardRateInfo : awardRateInfoList) { // å¯¹æ¯ç§å¥–å“åŠå…¶æ¦‚ç‡  
            int rateVal = awardRateInfo.getAwardRate().multiply(new BigDecimal(100)).intValue(); // 0.25 -> 25  
            // å¾ªç¯å¡«å……æ¦‚ç‡èŒƒå›´å€¼  
            for (int i = cursorVal + 1; i <= (rateVal + cursorVal); i++) {  
                rateTuple[hashIdx(i)] = awardRateInfo.getAwardId(); // å°†å¥–å“IDå­˜æ”¾åˆ°å¯¹åº”å“ˆå¸Œç çš„ç´¢å¼•ä¸‹æ ‡å¤„  
            }  
            cursorVal += rateVal;  
        }  
    }  
  
    @Override  
    public boolean isExistRateTuple(Long strategyId) {  
        return rateTupleMap.containsKey(strategyId);  
    }  
  
    /**  
     * æ–æ³¢é‚£å¥‘ï¼ˆFibonacciï¼‰æ•£åˆ—æ³•ï¼Œè®¡ç®—å“ˆå¸Œç´¢å¼•ä¸‹æ ‡å€¼  
     *  
     * @param val å€¼  
     * @return ç´¢å¼•  
     */  
    protected int hashIdx(int val) {  
        int hashCode = val * HASH_INCREMENT + HASH_INCREMENT;  
        return hashCode & (RATE_TUPLE_LENGTH - 1);  
    }  
}
```
### 2. æ€»ä½“æ¦‚ç‡(ç®—æ³•)
**ç®—æ³•æè¿°**ï¼šåˆ†åˆ«**æŠŠAã€Bã€Cå¯¹åº”çš„æ¦‚ç‡å€¼è½¬æ¢æˆé˜¶æ¢¯èŒƒå›´å€¼**ï¼ŒA=(0~0.2ã€ã€B=(0.2-0.5ã€ã€C=(0.5-1.0ã€ï¼Œ**å½“ä½¿ç”¨éšæœºæ•°æ–¹æ³•ç”Ÿæˆä¸€ä¸ªéšæœºæ•°åï¼Œä¸é˜¶æ¢¯èŒƒå›´å€¼è¿›è¡Œå¾ªç¯æ¯”å¯¹æ‰¾åˆ°å¯¹åº”çš„åŒºåŸŸï¼ŒåŒ¹é…åˆ°ä¸­å¥–ç»“æœ**ã€‚
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202305241012023.png)

**éƒ¨åˆ†ä»£ç **
```java
package com.memcpy0.lottery.domain.strategy.service.algorithm.impl;  
  
import com.memcpy0.lottery.domain.strategy.model.vo.AwardRateInfo;  
import com.memcpy0.lottery.domain.strategy.service.algorithm.BaseAlgorithm;  
import org.springframework.stereotype.Component;  
  
import java.math.BigDecimal;  
import java.security.SecureRandom;  
import java.util.ArrayList;  
import java.util.List;  
/**  
 * å¿…ä¸­å¥–ç­–ç•¥æŠ½å¥–ï¼Œæ’æ‰å·²ç»ä¸­å¥–çš„å¥–å“å’Œæ¦‚ç‡ï¼Œé‡æ–°è®¡ç®—ä¸­å¥–èŒƒå›´  
 * @author memcpy0  
 */@Component("defaultRateRandomDrawAlgorithm")  
public class DefaultRateRandomDrawAlgorithm extends BaseAlgorithm {  
    @Override  
    public String randomDraw(Long strategyId, List<String> excludeAwardIds) {  
        BigDecimal differenceDenominator = BigDecimal.ZERO;  
  
        // ä»å¥–å“ä¸­æ’é™¤æ‰ä¸åœ¨æŠ½å¥–èŒƒå›´çš„å¥–å“IDé›†åˆ  
        List<AwardRateInfo> differenceAwardRateList = new ArrayList<>();  
        // å¥–å“æ¦‚ç‡å€¼åˆ—è¡¨  
        List<AwardRateInfo> awardRateIntervalValList = awardRateInfoMap.get(strategyId);  
        for (AwardRateInfo awardRateInfo : awardRateIntervalValList) {  
            String awardId = awardRateInfo.getAwardId();  
            if (excludeAwardIds.contains(awardId)) {  
                continue;  
            }  
            differenceAwardRateList.add(awardRateInfo);  
            // ç´¯åŠ åœ¨æŠ½å¥–èŒƒå›´çš„å¥–å“IDçš„æ¦‚ç‡  
            differenceDenominator = differenceDenominator.add(awardRateInfo.getAwardRate());   
}  
  
        // å‰ç½®åˆ¤æ–­  
        if (differenceAwardRateList.size() == 0) {  
            return "";  
        }  
        if (differenceAwardRateList.size() == 1) {  
            return differenceAwardRateList.get(0).getAwardId();  
        }  
        // è·å–éšæœºæ¦‚ç‡å€¼  
        SecureRandom secureRandom = new SecureRandom();  
        int randomVal = secureRandom.nextInt(100) + 1;  
        // å¾ªç¯è·å–å¥–å“  
        String awardId = "";  
        int cursorVal = 0;  
        // ç°åœ¨æ˜¯è¿˜å¯ä»¥æŠ½å‡ºæ¥çš„å¥–å“åˆ—è¡¨  
        for (AwardRateInfo awardRateInfo : differenceAwardRateList) {  
            // é‡æ–°è®¡ç®—æ¯ä¸ªå¥–å“çš„æ¦‚ç‡(<=1)*100çš„å€¼  
            int rateVal = awardRateInfo.getAwardRate().divide(differenceDenominator,   
2, BigDecimal.ROUND_UP).multiply(new BigDecimal(100)).intValue();   
if (randomVal <= (cursorVal + rateVal)) {  
                awardId = awardRateInfo.getAwardId();  
                break;            }  
            cursorVal += rateVal;  
        }  
        // è¿”å›ä¸­å¥–ç»“æœ  
        return awardId;  
    }  
}
```
-   ==é¦–å…ˆè¦ä»æ€»çš„ä¸­å¥–åˆ—è¡¨ä¸­æ’é™¤æ‰é‚£äº›è¢«æ’é™¤æ‰çš„å¥–å“ï¼Œ**è¿™äº›å¥–å“ä¼šæ¶‰åŠåˆ°æ¦‚ç‡çš„å€¼é‡æ–°è®¡ç®—**==ã€‚
-   **å¦‚æœæ’é™¤åå‰©ä¸‹çš„å¥–å“åˆ—è¡¨å°äºç­‰äº1ï¼Œåˆ™å¯ä»¥ç›´æ¥è¿”å›å¯¹åº”ä¿¡æ¯**
-   æ¥ä¸‹æ¥å°±**ä½¿ç”¨éšæœºæ•°å·¥å…·ç”Ÿäº§ä¸€ä¸ª100å†…çš„éšå€¼ï¼Œä¸ã€Œæ–°å¥–å“åˆ—è¡¨ã€ä¸­çš„å€¼è¿›è¡Œå¾ªç¯æ¯”å¯¹**ï¼Œç®—æ³•æ—¶é—´å¤æ‚åº¦O(n)

- æ˜¯å‰©ä½™çš„å¥–å“æ€»æ¦‚ç‡å‡åŒ€åˆ†é…åœ¨11ä¸ªå¥–å“ä¸Š
- è¿˜æ˜¯ä¿æŒå‰©ä½™11ä¸ªå¥–å“çš„ä¸­å¥–æ¦‚ç‡ï¼Œå¦‚æœæŠ½åˆ°ä¸ºç©ºçš„å¥–å“åˆ™è¡¨ç¤ºæœªä¸­å¥–ã€‚
### 3. å•é¡¹æ¦‚ç‡(ç®—æ³•)
**ç®—æ³•æè¿°**ï¼š==å•é¡¹æ¦‚ç‡ç®—æ³•ä¸æ¶‰åŠå¥–å“æ¦‚ç‡é‡æ–°è®¡ç®—çš„é—®é¢˜ï¼Œé‚£ä¹ˆä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åˆ†é…å¥½çš„æ¦‚ç‡ç»“æœæ˜¯å¯ä»¥å›ºå®šä¸‹æ¥çš„==ã€‚å¥½ï¼Œè¿™é‡Œå°±æœ‰ä¸€ä¸ªå¯ä»¥ä¼˜åŒ–çš„ç®—æ³•ï¼Œ**ä¸éœ€è¦åœ¨è½®è®­åŒ¹é…O(n)æ—¶é—´å¤æ‚åº¦æ¥å¤„ç†ä¸­å¥–ä¿¡æ¯**ï¼Œè€Œæ˜¯å¯ä»¥æ ¹æ®æ¦‚ç‡å€¼å­˜æ”¾åˆ°HashMapæˆ–è€…è‡ªå®šä¹‰æ•£åˆ—æ•°ç»„è¿›è¡Œå­˜æ”¾ç»“æœï¼Œè¿™æ ·å°±**å¯ä»¥æ ¹æ®æ¦‚ç‡å€¼ç›´æ¥å®šä¹‰ä¸­å¥–ç»“æœ**ï¼Œæ—¶é—´å¤æ‚åº¦ç”±O(n)é™ä½åˆ°O(1)ã€‚è¿™æ ·çš„è®¾è®¡åœ¨ä¸€èˆ¬ç”µå•†å¤§ä¿ƒå¹¶å‘è¾ƒé«˜çš„æƒ…å†µä¸‹ï¼Œè¾¾åˆ°ä¼˜åŒ–æ¥å£å“åº”æ—¶é—´çš„ç›®çš„ã€‚

**ç•™ä¸ªä½œä¸š**ï¼šè¿™é‡Œæˆ‘ç»™å¤§å®¶æä¾›ä¸€äº›å¯ä»¥å‚è€ƒçš„ä»£ç å®ç°ï¼Œåœ¨è¿™ä¸ªç®—æ³•æè¿°å’Œå‚è€ƒä¸Šï¼Œç•™ä¸ªä½œä¸šï¼Œå¤§å®¶å¯ä»¥åšä¸€ä¸ªè‡ªå·±çš„ç®—æ³•é€»è¾‘å®ç°ä»¥åŠæä¾›ç®—æ³•é€»è¾‘å›¾ç¨¿ã€‚

**éƒ¨åˆ†ä»£ç **ï¼šè¿™é‡Œåº”è¯¥è¿”å›""ï¼Œåœ¨æœªä¸­å¥–æ—¶ï¼ï¼ï¼
```java
package com.memcpy0.lottery.domain.strategy.service.algorithm.impl;  
  
import com.memcpy0.lottery.domain.strategy.service.algorithm.BaseAlgorithm;  
import org.springframework.stereotype.Component;  
  
import java.security.SecureRandom;  
import java.util.List;  
  
/**  
 * ã€æ¨èã€‘å•é¡¹éšæœºæ¦‚ç‡æŠ½å¥–ï¼ŒæŠ½åˆ°ä¸€ä¸ªå·²ç»æ’æ‰çš„å¥–å“åˆ™æœªä¸­å¥–  
 * @author memcpy0  
 */@Component("singleRateRandomDrawAlgorithm")  
public class SingleRateRandomDrawAlgorithm extends BaseAlgorithm {  
    @Override  
    public String randomDraw(Long strategyId, List<String> excludeAwardIds) {  
        // è·å–ç­–ç•¥å¯¹åº”çš„å…ƒç¥–  
        String[] rateTuple = super.rateTupleMap.get(strategyId);  
        assert rateTuple != null;  
  
        // éšæœºç´¢å¼•  
        int randomVal = new SecureRandom().nextInt(100) + 1;  
        int idx = super.hashIdx(randomVal);  
  
        // è¿”å›ç»“æœ  
        String awardId = rateTuple[idx];  
        if (excludeAwardIds.contains(awardId)) {  
            return "";  
        }  
        return awardId;  
    }  
}
```
## ä¸Šé¢æ˜¯æŠ½å¥–ç®—æ³•çš„ä¸åŒå®ç°
### ä¸‹é¢æ˜¯æŠ½å¥–æ¥å£ï¼ŒåŒ…è£…ä¸åŒçš„æŠ½å¥–ç­–ç•¥
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202305241419550.png)
// ç­–ç•¥ç±»å‹ä¸º1æ—¶ï¼Œä½¿ç”¨defaultRateRandomDrawAlgorithm å³ä¸éœ€è¦åˆå§‹åŒ–ï¼Œä¸º2æ—¶ä½¿ç”¨ singleRateRandomDrawAlgorithm éœ€è¦åˆå§‹åŒ–
```java
package com.memcpy0.lottery.domain.strategy.service.draw;  
  
import com.memcpy0.lottery.domain.strategy.service.algorithm.IDrawAlgorithm;  
  
import javax.annotation.PostConstruct;  
import javax.annotation.Resource;  
import java.util.Map;  
import java.util.concurrent.ConcurrentHashMap;  
  
/**  
 * æŠ½å¥–æ¥å£é…ç½®ç±»ï¼Œåœ¨è¿™é‡Œé…ç½®å„ç§ä¸åŒçš„æŠ½å¥–ç®—æ³•  
 */  
public class DrawConfig {  
    @Resource  
    private IDrawAlgorithm defaultRateRandomDrawAlgorithm;  
  
    @Resource  
    private IDrawAlgorithm singleRateRandomDrawAlgorithm;  
  
    protected static Map<Integer, IDrawAlgorithm> drawAlgorithmMap = new ConcurrentHashMap<>();  
  
    @PostConstruct  
    public void init() {  
        drawAlgorithmMap.put(1, defaultRateRandomDrawAlgorithm);  
        drawAlgorithmMap.put(2, singleRateRandomDrawAlgorithm);  
    }   
}
```

```java
package com.memcpy0.lottery.domain.strategy.service.draw;  
  
  
import com.memcpy0.lottery.domain.strategy.model.vo.AwardRateInfo;  
import com.memcpy0.lottery.domain.strategy.service.algorithm.IDrawAlgorithm;  
import com.memcpy0.lottery.infrastructure.po.StrategyDetail;  
  
import java.util.ArrayList;  
import java.util.List;  
  
public class DrawBase extends DrawConfig {  
    public void checkAndInitRateData(Long strategyId, Integer strategyMode, List<StrategyDetail> strategyDetailList) {  
        // å¦‚æœä½¿ç”¨æ¨¡å¼1çš„æŠ½å¥–ç®—æ³•å°±è¦è¿›è¡Œåç»­åˆå§‹åŒ–ï¼Œä½†å®é™…ä¸ŠæŠ½å¥–ç®—æ³•ä¸º1æ—¶ä¸éœ€è¦åç»­åˆå§‹åŒ–rateTupleæ•°ç»„  
//        if (1 != strategyMode) return;  
        if (1 == strategyMode) return;  
        IDrawAlgorithm drawAlgorithm = drawAlgorithmMap.get(strategyMode);  
  
        boolean existRateTuple = drawAlgorithm.isExistRateTuple(strategyId);  
        if (existRateTuple) return;  
  
        List<AwardRateInfo> awardRateInfoList = new ArrayList<>(strategyDetailList.size());  
        for (StrategyDetail strategyDetail : strategyDetailList) {  
            awardRateInfoList.add(new AwardRateInfo(strategyDetail.getAwardId(), strategyDetail.getAwardRate()));  
        }  
        // åˆå§‹åŒ–æ¦‚ç‡åŒºé—´æ•°ç»„  
        drawAlgorithm.initRateTuple(strategyId, awardRateInfoList);  
    }  
}
```

```java
package com.memcpy0.lottery.domain.strategy.service.draw;  
  
import com.memcpy0.lottery.domain.strategy.model.req.DrawReq;  
import com.memcpy0.lottery.domain.strategy.model.res.DrawResult;  
  
/**  
 * æŠ½å¥–æ¥å£  
 */  
public interface IDrawExec {  
    DrawResult doDrawExec(DrawReq req);  
}
```
å®ç°æŠ½å¥–æ¥å£ï¼šå‘ç°ä¸€ä¸ªæ˜¯å¯èƒ½æœªä¸­å¥–è¿™ä¸ªæ—¶å€™å°±è¦åˆ¤æ–­AwardIdæ˜¯ä¸æ˜¯ç©º
```java
package com.memcpy0.lottery.domain.strategy.service.draw.impl;  
  
import com.memcpy0.lottery.domain.strategy.model.aggregates.StrategyRich;  
import com.memcpy0.lottery.domain.strategy.model.req.DrawReq;  
import com.memcpy0.lottery.domain.strategy.model.res.DrawResult;  
import com.memcpy0.lottery.domain.strategy.repository.IStrategyRepository;  
import com.memcpy0.lottery.domain.strategy.service.algorithm.IDrawAlgorithm;  
import com.memcpy0.lottery.domain.strategy.service.draw.DrawBase;  
import com.memcpy0.lottery.domain.strategy.service.draw.IDrawExec;  
import com.memcpy0.lottery.infrastructure.po.Award;  
import com.memcpy0.lottery.infrastructure.po.Strategy;  
import com.memcpy0.lottery.infrastructure.po.StrategyDetail;  
import org.slf4j.Logger;  
import org.slf4j.LoggerFactory;  
import org.springframework.stereotype.Service;  
  
import javax.annotation.Resource;  
import java.util.ArrayList;  
import java.util.List;  
  
/**  
 * æŠ½å¥–æ¥å£çš„å®ç°  
 */  
@Service("drawExec")  
public class DrawExecImpl extends DrawBase implements IDrawExec {  
    private Logger logger = LoggerFactory.getLogger(DrawExecImpl.class);  
  
    @Resource  
    private IStrategyRepository strategyRepository;  
  
    @Override  
    public DrawResult doDrawExec(DrawReq req) {  
        logger.info("æ‰§è¡Œç­–ç•¥æŠ½å¥–å¼€å§‹ï¼ŒstrategyIdï¼š{}", req.getStrategyId());  
  
        // è·å–æŠ½å¥–ç­–ç•¥é…ç½®å’Œæ˜ç»†æ•°æ®  
        StrategyRich strategyRich = strategyRepository.queryStrategyRich(req.getStrategyId());  
        Strategy strategy = strategyRich.getStrategy();  
        List<StrategyDetail> strategyDetailList = strategyRich.getStrategyDetailList();  
  
        // æ ¡éªŒå’Œåˆå§‹åŒ–æ•°æ®ï¼Œä¼ é€’ç­–ç•¥æ–¹å¼  
        checkAndInitRateData(req.getStrategyId(), strategy.getStrategyMode(), strategyDetailList);  
  
        // æ ¹æ®ç­–ç•¥æ–¹å¼æŠ½å¥–  
        IDrawAlgorithm drawAlgorithm = drawAlgorithmMap.get(strategy.getStrategyMode());  
        String awardId = drawAlgorithm.randomDraw(req.getStrategyId(), new ArrayList<>());  
        if ("".equals(awardId) || awardId == null) {  
            logger.info("æ‰§è¡Œç­–ç•¥æŠ½å¥–å®Œæˆï¼Œå‚ä¸ç”¨æˆ·ï¼š{}æœªä¸­å¥–", req.getuId());  
            return new DrawResult(req.getuId(), req.getStrategyId(), awardId, "");  
        }  
        // è·å–å¥–å“ä¿¡æ¯  
        Award award = strategyRepository.queryAwardInfo(awardId);  
  
        logger.info("æ‰§è¡Œç­–ç•¥æŠ½å¥–å®Œæˆï¼Œä¸­å¥–ç”¨æˆ·ï¼š{} å¥–å“IDï¼š{} å¥–å“åç§°ï¼š{}", req.getuId(), awardId, award.getAwardName());  
  
        // å°è£…ç»“æœ  
        return new DrawResult(req.getuId(), req.getStrategyId(), awardId, award.getAwardName());  
    }    
}
```

### æµ‹è¯•
```java
package com.memcpy0.lottery.test;  
  
import com.memcpy0.lottery.domain.strategy.model.vo.AwardRateInfo;  
import com.memcpy0.lottery.domain.strategy.service.algorithm.IDrawAlgorithm;  
import org.junit.Before;  
import org.junit.Test;  
import org.junit.runner.RunWith;  
import org.springframework.boot.test.context.SpringBootTest;  
import org.springframework.test.context.junit4.SpringRunner;  
  
import javax.annotation.Resource;  
import java.math.BigDecimal;  
import java.util.ArrayList;  
import java.util.List;  
  
@RunWith(SpringRunner.class)  
@SpringBootTest  
public class DrawAlgorithmTest {  
  
//    @Resource(name = "defaultRateRandomDrawAlgorithm")  
    @Resource(name = "singleRateRandomDrawAlgorithm")  
    private IDrawAlgorithm randomDrawAlgorithm;  
  
    @Before  
    public void init() {  
        // å¥–å“ä¿¡æ¯  
        List<AwardRateInfo> awardRateInfoList = new ArrayList<>();  
        awardRateInfoList.add(new AwardRateInfo("ä¸€ç­‰å¥–ï¼šIMac", new BigDecimal("0.05")));  
        awardRateInfoList.add(new AwardRateInfo("äºŒç­‰å¥–ï¼šiphone", new BigDecimal("0.15")));  
        awardRateInfoList.add(new AwardRateInfo("ä¸‰ç­‰å¥–ï¼šipad", new BigDecimal("0.20")));  
        awardRateInfoList.add(new AwardRateInfo("å››ç­‰å¥–ï¼šAirPods", new BigDecimal("0.25")));  
        awardRateInfoList.add(new AwardRateInfo("äº”ç­‰å¥–ï¼šå……ç”µå®", new BigDecimal("0.35")));  
  
        // åˆå§‹æ•°æ®  
        randomDrawAlgorithm.initRateTuple(100001L, awardRateInfoList);  
    }  
  
    @Test  
    public void test_randomDrawAlgorithm() {  
        List<String> excludeAwardIds = new ArrayList<>();  
        excludeAwardIds.add("äºŒç­‰å¥–ï¼šiphone");  
        excludeAwardIds.add("å››ç­‰å¥–ï¼šAirPods");  
        for (int i = 0; i < 20; i++) {  
            System.out.println("ä¸­å¥–ç»“æœï¼š" + randomDrawAlgorithm.randomDraw(100001L, excludeAwardIds));  
        }  
    }  
}
```
è¿è¡Œç»“æœå¦‚ä¸‹ï¼Œå¾ˆç¬¦åˆè‡ªèº«ä½“æ„Ÿåˆ¤æ–­ï¼š
```java
ä¸­å¥–ç»“æœï¼šäº”ç­‰å¥–ï¼šå……ç”µå®
ä¸­å¥–ç»“æœï¼šæœªä¸­å¥–
ä¸­å¥–ç»“æœï¼šä¸€ç­‰å¥–ï¼šIMac
ä¸­å¥–ç»“æœï¼šæœªä¸­å¥–
ä¸­å¥–ç»“æœï¼šäº”ç­‰å¥–ï¼šå……ç”µå®
ä¸­å¥–ç»“æœï¼šä¸‰ç­‰å¥–ï¼šipad
ä¸­å¥–ç»“æœï¼šäº”ç­‰å¥–ï¼šå……ç”µå®
ä¸­å¥–ç»“æœï¼šäº”ç­‰å¥–ï¼šå……ç”µå®
ä¸­å¥–ç»“æœï¼šæœªä¸­å¥–
ä¸­å¥–ç»“æœï¼šäº”ç­‰å¥–ï¼šå……ç”µå®
ä¸­å¥–ç»“æœï¼šäº”ç­‰å¥–ï¼šå……ç”µå®
ä¸­å¥–ç»“æœï¼šäº”ç­‰å¥–ï¼šå……ç”µå®
ä¸­å¥–ç»“æœï¼šäº”ç­‰å¥–ï¼šå……ç”µå®
ä¸­å¥–ç»“æœï¼šäº”ç­‰å¥–ï¼šå……ç”µå®
ä¸­å¥–ç»“æœï¼šä¸‰ç­‰å¥–ï¼šipad
ä¸­å¥–ç»“æœï¼šæœªä¸­å¥–
ä¸­å¥–ç»“æœï¼šäº”ç­‰å¥–ï¼šå……ç”µå®
ä¸­å¥–ç»“æœï¼šæœªä¸­å¥–
ä¸­å¥–ç»“æœï¼šäº”ç­‰å¥–ï¼šå……ç”µå®
ä¸­å¥–ç»“æœï¼šä¸‰ç­‰å¥–ï¼šipad
```
ç–‘æƒ‘ï¼šæ–æ³¢é‚£å¥‘æ•£åˆ—ä¸ä¼šå†²çªå—ï¼Ÿä¸èƒ½ç›´æ¥å­˜åœ¨æ•°ç»„ä¸­å—ï¼Œè¿˜è¦æ•£åˆ—ä¸€ä¸‹+æ•£åˆ—ç &(é•¿åº¦-1)å†å­˜æ”¾ï¼Ÿ