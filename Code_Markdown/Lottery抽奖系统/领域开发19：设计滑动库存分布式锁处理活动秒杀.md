-   åˆ†æ”¯ï¼š[211120_xfg_redis](https://gitcode.net/KnowledgePlanet/Lottery/-/tree/211120_xfg_redis)
-   æè¿°ï¼šå¼•å…¥ Redis åˆ°æŠ½å¥–ç³»ç»Ÿï¼Œè®¾è®¡é¢—ç²’åº¦æ›´ç»†çš„æ»‘åŠ¨åº“å­˜ç¼–å·åˆ†å¸ƒå¼é”ï¼Œå¤„ç†æ´»åŠ¨ç§’æ€æµç¨‹

## ä¸€ã€å¼€å‘æ—¥å¿—

-   ç”±äºæœ¬ç« èŠ‚éœ€è¦ç”¨åˆ° Redis æ‰€ä»¥æˆ‘ä»¬åœ¨äº‘æœåŠ¡å™¨æ­å»º Redis æœåŠ¡ï¼Œè¿™æ ·å¯ä»¥æ›´åŠ æ–¹ä¾¿çš„ä½¿ç”¨ã€‚_å¦‚æœä½ æš‚æ—¶è¿˜æ²¡æœ‰äº‘æœåŠ¡å™¨ï¼Œé‚£ä¹ˆåœ¨æœ¬åœ°æ­å»º Redis ä¹Ÿå¯ä»¥ï¼Œåªæ˜¯å°‘äº†ä¸€äº›äº‘ç¯å¢ƒçš„é…ç½®ç»ƒä¹ _Â [äº‘æœåŠ¡å™¨åœ°å€](https://www.aliyun.com/minisite/goods?taskPkg=1111ydsrwb&pkgSid=11388&recordId=1033318&userCode=is4kfbdt)
-   åœ¨æŠ½å¥–ç³»ç»Ÿä¸­å¼•å…¥ Redis æ¨¡å—ï¼Œ**ä¼˜åŒ–ç”¨æˆ·å‚ä¸æŠ½å¥–æ´»åŠ¨**ã€‚å› ä¸ºåªè¦æœ‰å¤§é‡çš„ç”¨æˆ·å‚ä¸æŠ½å¥–ï¼Œé‚£ä¹ˆè¿™ä¸ªå°±å±äºç§’æ€åœºæ™¯ã€‚æ‰€ä»¥éœ€è¦ä½¿ç”¨ Redis åˆ†å¸ƒå¼é”çš„æ–¹å¼æ¥å¤„ç†é›†ä¸­åŒ–åº“å­˜æ‰£å‡çš„é—®é¢˜ï¼Œå¦åˆ™åœ¨ TPS è¾¾åˆ°1k-2kï¼Œå°±ä¼šæŠŠæ•°æ®åº“æ‹–å®ã€‚
-   **åœ¨è®¾è®¡ç§’æ€æµç¨‹æ—¶ï¼Œä¼˜åŒ–é”çš„é¢—ç²’åº¦åŠ›åº¦ï¼Œä¸è¦æŠŠé”ç›´æ¥æ”¾åˆ°æ´»åŠ¨ç¼–å·ä¸Šï¼Œè¿™æ ·åœ¨æç«¯ä¸´ç•Œæƒ…å†µä¸‹ä¼šå‡ºç°ç§’æ€è§£é”å¤±è´¥ï¼Œå¯¼è‡´åº“å­˜æœ‰å‰©ä½™ä½†ä¸èƒ½ä¸‹å•çš„æƒ…å†µ**ã€‚æ‰€ä»¥éœ€è¦å¢åŠ é”çš„é¢—ç²’åº¦ï¼Œä»¥æ»‘åŠ¨åº“å­˜å‰©ä½™ç¼–å·çš„æ–¹å¼è¿›è¡ŒåŠ é”ï¼Œä¾‹å¦‚ 100001_1ã€100001_2ã€100001_3ï¼Œä»¥æ­¤ç±»æ¨ï¼Œå…·ä½“çœ‹ä»£ç å®ç°ã€‚
-   å¢åŠ ç¼“å­˜æ‰£å‡åº“å­˜åï¼Œå‘é€ MQ æ¶ˆæ¯è¿›è¡Œå¼‚æ­¥æ›´æ–°æ•°æ®åº“ä¸­æ´»åŠ¨åº“å­˜ï¼Œåšæœ€ç»ˆæ•°æ®ä¸€è‡´æ€§å¤„ç†ã€‚_è¿™ä¸€éƒ¨åˆ†å¦‚æœä½ çš„ç³»ç»Ÿå¹¶å‘ä½“é‡è¾ƒå¤§ï¼Œè¿˜éœ€è¦æŠŠ MQ çš„æ•°æ®ä¸è¦ç›´æ¥å¯¹åº“æ›´æ–°ï¼Œè€Œæ˜¯æ›´æ–°åˆ°ç¼“å­˜ä¸­ï¼Œå†ç”±ä»»åŠ¡æœ€é˜¶æ®µåŒæ­¥ï¼Œä»¥æ­¤å‡å°‘å¯¹æ•°æ®åº“è¡¨çš„æ“ä½œ_

## äºŒã€æ‰£å‡æµç¨‹
-   ä¼˜åŒ–æ´»åŠ¨é¢†åŸŸï¼Œ**æ´»åŠ¨å‚ä¸æµç¨‹ä¸­çš„åº“å­˜æ‰£å‡æ“ä½œ**ï¼Œè¿™éƒ¨åˆ†æˆ‘ä»¬åŸæ¥æ˜¯ä½¿ç”¨**æ•°æ®åº“è¡Œçº§é”**ğŸ”Â å¤„ç†çš„åº“å­˜æ‰£å‡ï¼Œä½†å› ä¸º**ä¼šå­˜åœ¨å¹¶å‘é—®é¢˜**æ‰€ä»¥è¿™é‡Œä¼˜åŒ–ä¸º Redis åˆ†å¸ƒå¼é”è¿›è¡Œå¤„ç†ã€‚
-   æ´»åŠ¨é¢†å–å®Œæˆåï¼Œå…¶å®è¿™ä¸ªæ—¶å€™åªæ˜¯æŠŠç¼“å­˜çš„åº“å­˜æ‰£æ‰äº†ï¼Œä½†æ•°æ®åº“ä¸­çš„åº“å­˜å¹¶æ²¡æœ‰æ‰£å‡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å‘é€ä¸€ä¸ª MQ æ¶ˆæ¯ï¼Œæ¥å¯¹æ•°æ®åº“ä¸­çš„åº“å­˜è¿›è¡Œå¤„ç†ã€‚å› ä¸º MQ å¯ä»¥æ¶ˆå³°å› æ­¤åœ¨é™ä½ MQ åˆ†ç‰‡çš„æƒ…å†µä¸‹ï¼Œæ¶ˆè´¹æ•ˆç‡æœ‰æ‰€ä¸‹é™ï¼Œå¹¶ä¸ä¼šå¯¹æ•°æ®åº“é€ æˆå‹åŠ›ï¼Œä¿è¯æœ€ç»ˆæ•°æ®ä¸€è‡´æ€§å³å¯ã€‚_ä½†ä¹Ÿæœ‰ä¾‹å¤–ï¼Œæ‰€ä»¥æˆ‘ä»¬æåˆ°å¯ä»¥ä½¿ç”¨**å®šæ—¶ä»»åŠ¡æ¥æ›´æ–°æ•°æ®åº“åº“å­˜**_

## ä¸‰ã€é…ç½®Redisäº‘æœåŠ¡ç¯å¢ƒ
-   æœ¬ç« èŠ‚æˆ‘ä»¬æŠŠéœ€è¦ç”¨åˆ°çš„ Redis é…ç½®åˆ°äº‘æœåŠ¡ä¸Šï¼Œè¿™æ ·ä¹Ÿæ¯”è¾ƒæ–¹ä¾¿æˆ‘ä»¬è‡ªå·±æµ‹è¯•ä½¿ç”¨ï¼Œå¦åˆ™æ€»æ˜¯éœ€è¦åœ¨è‡ªå·±æœºå™¨è¿›è¡Œå¤„ç†ã€‚
 
æ“ä½œæ­¥éª¤ï¼š
1.  åœ¨å®å¡”çš„è½¯ä»¶å•†åº—ä¸­æœç´¢ Redis è¿›è¡Œå®‰è£…ï¼Œè¿™ä¸ªå®‰è£…è¿‡ç¨‹æ˜¯å‚»ç“œå¼çš„ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ Docker æˆ–è€…ç›´æ¥ç”¨å‘½ä»¤å®‰è£…ï¼Œéƒ½ä¸å¤æ‚ã€‚
2.  å®‰è£…å®Œæ¯•åéœ€è¦è¿›è¡Œä¸€äº›å¿…è¦çš„é…ç½®æ‰èƒ½è®©æˆ‘ä»¬æœ¬åœ°è®¿é—®åˆ° Redis æœåŠ¡ï¼Œå¦åˆ™ä½¿ç”¨æ—¶ä¼šæŠ¥é”™Â `Unable to connect to 39.96.*.*:6379`
3.  ç»ˆç«¯æ‰§è¡Œï¼Œé˜²ç«å¢™æ”¾è¡Œï¼š`firewall-cmd --zone=public --add-port=6379/tcp --permanent`
4.  ç»ˆç«¯æ‰§è¡Œï¼Œé˜²ç«å¢™é‡å¯ï¼š`firewall-cmd --reload`
5.  **redis.conf **æ³¨é‡Šæ‰Â `bind 127.0.0.1`
6.  **redis.conf**Â `protected-mode yes`Â æ”¹ä¸ºÂ `protected-mode no`
7.  ç°åœ¨é‡å¯ Redisï¼Œè¿™äº›æ“ä½œå¯ä»¥ç›´æ¥åœ¨æˆ‘ä»¬å®‰è£…çš„ Redis é‡Œè¿›è¡Œè®¾ç½®ã€‚

## [](https://gitcode.net/KnowledgePlanet/Lottery/-/wikis/%E7%AC%AC-2-%E9%83%A8%E5%88%86-%E9%A2%86%E5%9F%9F%E5%BC%80%E5%8F%91//%E7%AC%AC19%E8%8A%82%EF%BC%9A%E8%AE%BE%E8%AE%A1%E6%BB%91%E5%8A%A8%E5%BA%93%E5%AD%98%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%A4%84%E7%90%86%E6%B4%BB%E5%8A%A8%E7%A7%92%E6%9D%80#%E5%9B%9B%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91)å››ã€åŠŸèƒ½å¼€å‘

### [](https://gitcode.net/KnowledgePlanet/Lottery/-/wikis/%E7%AC%AC-2-%E9%83%A8%E5%88%86-%E9%A2%86%E5%9F%9F%E5%BC%80%E5%8F%91//%E7%AC%AC19%E8%8A%82%EF%BC%9A%E8%AE%BE%E8%AE%A1%E6%BB%91%E5%8A%A8%E5%BA%93%E5%AD%98%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%A4%84%E7%90%86%E6%B4%BB%E5%8A%A8%E7%A7%92%E6%9D%80#1-%E6%BB%91%E5%9D%97%E5%BA%93%E5%AD%98%E9%94%81%E8%AE%BE%E8%AE%A1)1. æ»‘å—åº“å­˜é”è®¾è®¡

[![](https://gitcode.net/KnowledgePlanet/Lottery/-/raw/master/doc/assets/img/Part-2/19-03.png)](https://gitcode.net/KnowledgePlanet/Lottery/-/raw/master/doc/assets/img/Part-2/19-03.png)

-   å¦‚å›¾æ‰€ç¤ºï¼Œå³ä½¿æ˜¯ä½¿ç”¨ Redis åˆ†å¸ƒå¼é”ï¼Œæˆ‘ä»¬ä¹Ÿä¸å¸Œæœ›æŠŠé”çš„é¢—ç²’åº¦æ”¾çš„å¤ªç²—ï¼Œå¦åˆ™è¿˜æ˜¯ä¼šå‡ºç°æ´»åŠ¨æœ‰åº“å­˜ä½†ä¸èƒ½ç§’æ€ï¼Œæç¤ºâ€œæ´»åŠ¨è¿‡äºç«çˆ†â€
-   é‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦æŒ‰ç…§æ´»åŠ¨ç¼–å·æŠŠåº“å­˜é”çš„é¢—ç²’åº¦ç¼©å°ï¼Œå®é™…æ“ä½œä¹Ÿå¹¶ä¸å¤æ‚ï¼Œåªæ˜¯æŠŠ`æ´»åŠ¨ID+åº“å­˜æ‰£å‡åçš„å€¼`ä¸€èµ·ä½œä¸ºåˆ†å¸ƒå¼é”çš„Keyï¼Œè¿™æ ·å°±ç¼©å°äº†é”çš„é¢—ç²’åº¦ã€‚

### [](https://gitcode.net/KnowledgePlanet/Lottery/-/wikis/%E7%AC%AC-2-%E9%83%A8%E5%88%86-%E9%A2%86%E5%9F%9F%E5%BC%80%E5%8F%91//%E7%AC%AC19%E8%8A%82%EF%BC%9A%E8%AE%BE%E8%AE%A1%E6%BB%91%E5%8A%A8%E5%BA%93%E5%AD%98%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%A4%84%E7%90%86%E6%B4%BB%E5%8A%A8%E7%A7%92%E6%9D%80#2-%E6%BB%91%E5%9D%97%E5%BA%93%E5%AD%98%E9%94%81%E5%AE%9E%E7%8E%B0)2. æ»‘å—åº“å­˜é”å®ç°

åœ¨æ´»åŠ¨é¢†åŸŸå±‚çš„é¢†å–æ´»åŠ¨æŠ½è±¡ç±»Â `BaseActivityPartake`Â æ·»åŠ æ–¹æ³• subtractionActivityStockByRedisã€recoverActivityCacheStockByRedisï¼Œåˆ†åˆ«ç”¨æˆ· Redis åº“å­˜æ‰£å‡å’ŒåŠ é” Key çš„å¤„ç†ã€‚

#### [](https://gitcode.net/KnowledgePlanet/Lottery/-/wikis/%E7%AC%AC-2-%E9%83%A8%E5%88%86-%E9%A2%86%E5%9F%9F%E5%BC%80%E5%8F%91//%E7%AC%AC19%E8%8A%82%EF%BC%9A%E8%AE%BE%E8%AE%A1%E6%BB%91%E5%8A%A8%E5%BA%93%E5%AD%98%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%A4%84%E7%90%86%E6%B4%BB%E5%8A%A8%E7%A7%92%E6%9D%80#21-%E5%BA%93%E5%AD%98%E6%89%A3%E5%87%8F%E6%93%8D%E4%BD%9C)2.1 åº“å­˜æ‰£å‡æ“ä½œ

**ActivityRepository#subtractionActivityStockByRedis**

```
@Override
public StockResult subtractionActivityStockByRedis(String uId, Long activityId, Integer stockCount) {

    //  1. è·å–æŠ½å¥–æ´»åŠ¨åº“å­˜ Key
    String stockKey = Constants.RedisKey.KEY_LOTTERY_ACTIVITY_STOCK_COUNT(activityId);
    
    // 2. æ‰£å‡åº“å­˜ï¼Œç›®å‰å ç”¨åº“å­˜æ•°
    Integer stockUsedCount = (int) redisUtil.incr(stockKey, 1);
    
    // 3. è¶…å‡ºåº“å­˜åˆ¤æ–­ï¼Œè¿›è¡Œæ¢å¤åŸå§‹åº“å­˜
    if (stockUsedCount > stockCount) {
        redisUtil.decr(stockKey, 1);
        return new StockResult(Constants.ResponseCode.UN_ERROR.getCode(), Constants.ResponseCode.UN_ERROR.getInfo());
    }
    
    // 4. ä»¥æ´»åŠ¨åº“å­˜å ç”¨ç¼–å·ï¼Œç”Ÿæˆå¯¹åº”åŠ é”Keyï¼Œç»†åŒ–é”çš„é¢—ç²’åº¦
    String stockTokenKey = Constants.RedisKey.KEY_LOTTERY_ACTIVITY_STOCK_COUNT_TOKEN(activityId, stockUsedCount);
    
    // 5. ä½¿ç”¨ Redis.setNx åŠ ä¸€ä¸ªåˆ†å¸ƒå¼é”
    boolean lockToken = redisUtil.setNx(stockTokenKey, 350L);
    if (!lockToken) {
        logger.info("æŠ½å¥–æ´»åŠ¨{}ç”¨æˆ·ç§’æ€{}æ‰£å‡åº“å­˜ï¼Œåˆ†å¸ƒå¼é”å¤±è´¥ï¼š{}", activityId, uId, stockTokenKey);
        return new StockResult(Constants.ResponseCode.UN_ERROR.getCode(), Constants.ResponseCode.UN_ERROR.getInfo());
    }
    return new StockResult(Constants.ResponseCode.SUCCESS.getCode(), Constants.ResponseCode.SUCCESS.getInfo(), stockTokenKey, stockCount - stockUsedCount);
}
```
-   ä»£ç ä¸­çš„æ³¨é‡Šå°±æ˜¯æ•´ä¸ªæ“ä½œæµç¨‹ï¼Œåˆ›å»º Keyã€å ç”¨åº“å­˜ã€åˆ¤æ–­åº“å­˜ã€**ä»¥å ç”¨åº“å­˜çš„ç¼–å·åšä¸ºåŠ é”key**ã€è°ƒç”¨ setNx åŠ ä¸€ä¸ªåˆ†å¸ƒå¼é”ï¼Œæœ€ç»ˆå®Œæˆæ•´ä¸ªç§’æ€æ‰£å‡åº“å­˜çš„åŠ¨ä½œã€‚
-   è¿™é‡Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„å®ç°æ–¹å¼ï¼Œä¾‹å¦‚ï¼š`luaè„šæœ¬`ã€zkã€jvmå±‚ï¼Œéƒ½å¯ä»¥å¤„ç†ï¼Œä½†ç»è¿‡éªŒè¯ luaè„šæœ¬ä¼šæœ‰ä¸€å®šçš„è€—æ—¶ï¼Œå¹¶å‘è¾ƒé«˜æ—¶ä¼šæœ‰é—®é¢˜ã€‚
-   ç§’æ€çš„è®¾è®¡åŸåˆ™æ˜¯ä¿è¯ä¸è¶…å–ï¼Œä½†ä¸ä¸€å®šä¿è¯100ä¸ªåº“å­˜å®Œå…¨æ¶ˆè€—æ‰ï¼Œå› ä¸ºå¯èƒ½ä¼šæœ‰ä¸€äº›é”å¤±è´¥çš„æƒ…å†µã€‚ä¸è¿‡åœ¨åº“å­˜æ•°æ®æœ€ç»ˆä¸€è‡´æ€§ä»»åŠ¡å¤„ç†ä¸‹ï¼ŒåŸºæœ¬ä¿è¯`3ä¸ª9`åˆ°`4ä¸ª9`çš„å¯ç”¨ç‡è¿˜æ˜¯æ²¡é—®é¢˜çš„ã€‚
-   å¦‚æœè¯´ä½ çš„åº“å­˜ç§’æ€tpså·²ç»åˆ°10çº§ä»¥ä¸Šï¼Œ**_ä¸€èˆ¬å•keyåœ¨10ä¸‡ä»¥ä¸‹æ˜¯å¯é çš„_ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±éœ€è¦è¿›è¡Œåº“å­˜åˆ†ç‰‡ï¼ŒæŠŠè·¯ç”±æ˜¯æ€æƒ³ç”¨åˆ° Redis ä½¿ç”¨ä¸Šï¼Œä¸åŒçš„ç”¨æˆ·è¿›å…¥ Redis è¿›è¡Œç§’æ€å¤„ç†æ—¶ï¼ŒæŠŠä»–çš„åº“å­˜æ“ä½œè·¯ç”±åˆ°å±äºä»–çš„åˆ†ç»„ä¸Šè¿›è¡Œå¤„ç†ï¼Œé‚£ä¹ˆè¿™æ ·å°±å¯ä»¥æ¨ªå‘æ‰©å±•äº†**ã€‚

#### [](https://gitcode.net/KnowledgePlanet/Lottery/-/wikis/%E7%AC%AC-2-%E9%83%A8%E5%88%86-%E9%A2%86%E5%9F%9F%E5%BC%80%E5%8F%91//%E7%AC%AC19%E8%8A%82%EF%BC%9A%E8%AE%BE%E8%AE%A1%E6%BB%91%E5%8A%A8%E5%BA%93%E5%AD%98%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%A4%84%E7%90%86%E6%B4%BB%E5%8A%A8%E7%A7%92%E6%9D%80#22-%E5%B9%B6%E5%8F%91%E9%94%81%E5%88%A0%E9%99%A4%E5%A4%84%E7%90%86)2.2 å¹¶å‘é”åˆ é™¤å¤„ç†

**ActivityRepository#recoverActivityCacheStockByRedis**

```
@Override
public void recoverActivityCacheStockByRedis(Long activityId, String tokenKey, String code) {
    // åˆ é™¤åˆ†å¸ƒå¼é” Key
    redisUtil.del(tokenKey);
}
```

-   ç§’æ€å®Œæ¯•åï¼Œæ¥ä¸‹æ¥çš„æµç¨‹æ˜¯ç”¨æˆ·è®°å½•è½åº“ï¼Œä½†å¯èƒ½è¿™ä¸ªæ—¶å€™ä¼šå‘ç”Ÿå¤±è´¥çš„æƒ…å†µï¼Œå› ä¸ºéœ€è¦åœ¨å¤±è´¥æ—¶æ¢å¤ç¼“å­˜çš„åº“å­˜ã€‚ä¸è¿‡è¿™ä¸ªæƒ…å†µä¸æ˜¯äº‹åŠ¡æ€§çš„ï¼Œå› æ­¤å¯èƒ½ä¼šæ¢å¤å¤±è´¥ï¼Œä¹Ÿå°±æ˜¯ä¿è¯ä¸è¶…å–ï¼Œä½†ä¸èƒ½ä¿è¯ä¸€å®šå®Œå…¨æ¶ˆè€—åº“å­˜ã€‚_å½“ç„¶è¿™ä¸ªéƒ¨åˆ†å…·ä½“çœ‹ä½ å¸Œæœ›çš„æ˜¯ä»€ä¹ˆï¼Œæ¯”å¦‚ä½ å¯ä»¥ç‰ºç‰²æ‰ä¸€äº›æ€§èƒ½ï¼Œè€ƒè™‘ lua è„šæœ¬å’Œç»™æ•´ä¸ªæµç¨‹åˆ†å¸ƒå¼äº‹åŠ¡é”ã€‚_
-   **å¦‚æœæœ€åçš„æ“ä½œæ˜¯æˆåŠŸçš„ï¼Œé‚£ä¹ˆæ­£å¸¸åˆ é™¤æ‰è¿™ä¸ªåŠ é”çš„ Key å°±å¯ä»¥äº†ï¼Œå› ä¸ºä¸‹ä¸€ä¸ªç”¨æˆ·è·å–çš„åˆ°çš„åº“å­˜æ»‘å—åˆæ˜¯æ–°çš„äº†**ï¼Œæ—§ Key å·²ç»æ²¡æœ‰ç”¨äº†ã€‚

### [](https://gitcode.net/KnowledgePlanet/Lottery/-/wikis/%E7%AC%AC-2-%E9%83%A8%E5%88%86-%E9%A2%86%E5%9F%9F%E5%BC%80%E5%8F%91//%E7%AC%AC19%E8%8A%82%EF%BC%9A%E8%AE%BE%E8%AE%A1%E6%BB%91%E5%8A%A8%E5%BA%93%E5%AD%98%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%A4%84%E7%90%86%E6%B4%BB%E5%8A%A8%E7%A7%92%E6%9D%80#3-%E6%B4%BB%E5%8A%A8%E7%A7%92%E6%9D%80%E6%B5%81%E7%A8%8B%E5%A4%84%E7%90%86)3. æ´»åŠ¨ç§’æ€æµç¨‹å¤„ç†

**BaseActivityPartake#doPartake**

[![](https://gitcode.net/KnowledgePlanet/Lottery/-/raw/master/doc/assets/img/Part-2/19-04.png)](https://gitcode.net/KnowledgePlanet/Lottery/-/raw/master/doc/assets/img/Part-2/19-04.png)

-   åœ¨é¢†å–æ´»åŠ¨çš„æ¨¡æ¿æ–¹æ³•ä¸­ï¼Œä¼˜åŒ–æ‰åŸæ¥ç›´æ¥ä½¿ç”¨æ•°æ®åº“è¡Œçº§é”çš„æµç¨‹ï¼ŒæŠŠ Redis åº“å­˜çš„æ‰£å‡æ·»åŠ åˆ°è¿™é‡Œã€‚
-   æ‰£å‡åº“å­˜åï¼Œåœ¨å„ä¸ªä»¥ä¸‹çš„æµç¨‹èŠ‚ç‚¹ä¸­ï¼Œå¦‚æœæœ‰æµç¨‹å¤±è´¥åˆ™è¿›è¡Œç¼“å­˜åº“å­˜çš„æ¢å¤æ“ä½œã€‚

### [](https://gitcode.net/KnowledgePlanet/Lottery/-/wikis/%E7%AC%AC-2-%E9%83%A8%E5%88%86-%E9%A2%86%E5%9F%9F%E5%BC%80%E5%8F%91//%E7%AC%AC19%E8%8A%82%EF%BC%9A%E8%AE%BE%E8%AE%A1%E6%BB%91%E5%8A%A8%E5%BA%93%E5%AD%98%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%A4%84%E7%90%86%E6%B4%BB%E5%8A%A8%E7%A7%92%E6%9D%80#4-%E5%8F%91%E9%80%81mq%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7)4. å‘é€MQæ¶ˆæ¯ï¼Œå¤„ç†æ•°æ®ä¸€è‡´æ€§

ç”±äºæˆ‘ä»¬ä½¿ç”¨ Redis ä»£æ›¿æ•°æ®åº“åº“å­˜ï¼Œé‚£ä¹ˆåœ¨ç¼“å­˜çš„åº“å­˜å¤„ç†åï¼Œè¿˜éœ€è¦æŠŠæ•°æ®åº“ä¸­çš„åº“å­˜å¤„ç†ä¸ºå’Œç¼“å­˜ä¸€è‡´ï¼Œè¿™æ ·åœ¨åç»­è¿è¥è¿™éƒ¨åˆ†æ•°æ®æ—¶æ‰èƒ½ä¿è¯ä¸€å®šçš„è¿è¥å¯é æ€§ã€‚

**ActivityProcessImpl#doDrawProcess**

[![](https://gitcode.net/KnowledgePlanet/Lottery/-/raw/master/doc/assets/img/Part-2/19-05.png)](https://gitcode.net/KnowledgePlanet/Lottery/-/raw/master/doc/assets/img/Part-2/19-05.png)

-   ç”³è¯·æ–°çš„ MQ Topicï¼š`bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic lottery_activity_partake`
-   è¿™é‡Œéœ€è¦æ³¨æ„ï¼ŒMQ çš„å‘é€ï¼Œåªå‘ç”Ÿåœ¨ç”¨æˆ·é¦–æ¬¡é¢†å–æ´»åŠ¨æ—¶ï¼Œå¦‚æœæ˜¯å·²ç»é¢†å–æ´»åŠ¨ä½†å› ä¸ºæŠ½å¥–ç­‰æµç¨‹å¤±è´¥ï¼ŒäºŒæ¬¡è¿›å…¥æ­¤æµç¨‹ï¼Œåˆ™ä¸ä¼šå‘é€ MQ æ¶ˆæ¯ã€‚

### [](https://gitcode.net/KnowledgePlanet/Lottery/-/wikis/%E7%AC%AC-2-%E9%83%A8%E5%88%86-%E9%A2%86%E5%9F%9F%E5%BC%80%E5%8F%91//%E7%AC%AC19%E8%8A%82%EF%BC%9A%E8%AE%BE%E8%AE%A1%E6%BB%91%E5%8A%A8%E5%BA%93%E5%AD%98%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%A4%84%E7%90%86%E6%B4%BB%E5%8A%A8%E7%A7%92%E6%9D%80#5-%E6%B4%BB%E5%8A%A8%E9%A2%86%E5%8F%96%E8%AE%B0%E5%BD%95-mq-%E6%B6%88%E8%B4%B9)5. æ´»åŠ¨é¢†å–è®°å½• MQ æ¶ˆè´¹

**LotteryActivityPartakeRecordListener**

```
@KafkaListener(topics = "lottery_activity_partake", groupId = "lottery")
public void onMessage(ConsumerRecord<?, ?> record, Acknowledgment ack, @Header(KafkaHeaders.RECEIVED_TOPIC) String topic) {
    Optional<?> message = Optional.ofNullable(record.value());
    // 1. åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦å­˜åœ¨
    if (!message.isPresent()) {
        return;
    }
    // 2. è½¬åŒ–å¯¹è±¡ï¼ˆæˆ–è€…ä½ ä¹Ÿå¯ä»¥é‡å†™Serializer<T>ï¼‰
    ActivityPartakeRecordVO activityPartakeRecordVO = JSON.parseObject((String) message.get(), ActivityPartakeRecordVO.class);
    logger.info("æ¶ˆè´¹MQæ¶ˆæ¯ï¼Œå¼‚æ­¥æ‰£å‡æ´»åŠ¨åº“å­˜ messageï¼š{}", message.get());
    
    // 3. æ›´æ–°æ•°æ®åº“åº“å­˜
    activityPartake.updateActivityStock(activityPartakeRecordVO);
}
```

-   æ¶ˆè´¹ MQ æ¶ˆæ¯çš„æµç¨‹å°±æ¯”è¾ƒç®€å•äº†ï¼Œæ¥æ”¶åˆ° MQ è¿›è¡Œæ›´æ–°æ•°æ®åº“å¤„ç†å³å¯ã€‚ä¸è¿‡æˆ‘ä»¬è¿™é‡Œæ›´æ–°æ•°æ®åº“å¹¶ä¸æ˜¯ç›´æ¥å¯¹æ•°æ®åº“è¿›è¡Œåº“å­˜æ‰£å‡æ“ä½œï¼Œè€Œæ˜¯æŠŠä»ç¼“å­˜æ‹¿åˆ°çš„åº“å­˜æœ€æ–°é•œåƒæ›´æ–°åˆ°æ•°æ®åº“ä¸­ã€‚å®ƒçš„ SQL =Â `UPDATE activity SET stock_surplus_count = #{stockSurplusCount} WHERE activity_id = #{activityId} AND stock_surplus_count > #{stockSurplusCount}`
-   æ›´æ–°æ•°æ®åº“åº“å­˜ã€å®é™…åœºæ™¯ä¸šåŠ¡ä½“é‡è¾ƒå¤§ï¼Œå¯èƒ½ä¹Ÿä¼šç”±äºMQæ¶ˆè´¹å¼•èµ·å¹¶å‘ï¼Œå¯¹æ•°æ®åº“äº§ç”Ÿå‹åŠ›ï¼Œæ‰€ä»¥å¦‚æœå¹¶å‘é‡è¾ƒå¤§ï¼Œå¯ä»¥æŠŠåº“å­˜è®°å½•ç¼“å­˜ä¸­ï¼Œå¹¶ä½¿ç”¨å®šæ—¶ä»»åŠ¡è¿›è¡Œå¤„ç†ç¼“å­˜å’Œæ•°æ®åº“åº“å­˜åŒæ­¥ï¼Œå‡å°‘å¯¹æ•°æ®åº“çš„æ“ä½œæ¬¡æ•°ã€‘

## [](https://gitcode.net/KnowledgePlanet/Lottery/-/wikis/%E7%AC%AC-2-%E9%83%A8%E5%88%86-%E9%A2%86%E5%9F%9F%E5%BC%80%E5%8F%91//%E7%AC%AC19%E8%8A%82%EF%BC%9A%E8%AE%BE%E8%AE%A1%E6%BB%91%E5%8A%A8%E5%BA%93%E5%AD%98%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%A4%84%E7%90%86%E6%B4%BB%E5%8A%A8%E7%A7%92%E6%9D%80#%E4%BA%94%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95)äº”ã€åŠŸèƒ½æµ‹è¯•

-   ç¡®ä¿ï¼škafka å¼€å¯ã€xxl-job å¼€å¯ã€redis æœåŠ¡å¼€å¯
-   ç¡®ä¿ï¼šæ´»åŠ¨çŠ¶æ€å¯ç”¨ã€æ´»åŠ¨åº“å­˜å……è¶³ã€æ´»åŠ¨æ—¶é—´æœ‰æ•ˆ

**å•å…ƒæµ‹è¯•**

**ActivityProcessTest#test_doDrawProcess**

```
@Test
public void test_doDrawProcess() {
    DrawProcessReq req = new DrawProcessReq();
    req.setuId("xiaofuge");
    req.setActivityId(100001L);
    DrawProcessResult drawProcessResult = activityProcess.doDrawProcess(req);
    logger.info("è¯·æ±‚å…¥å‚ï¼š{}", JSON.toJSONString(req));
    logger.info("æµ‹è¯•ç»“æœï¼š{}", JSON.toJSONString(drawProcessResult));
}
```

-   è¿™é‡Œä½ éœ€è¦ä¿è¯æµ‹è¯•çš„ç”¨æˆ· ID è¿˜æœ‰å‰©ä½™å‚ä¸æ´»åŠ¨çš„æ¬¡æ•°ï¼Œå¦åˆ™ä¸èƒ½æ­£å¸¸å‚ä¸æŠ½å¥–æ´»åŠ¨ã€‚

**æµ‹è¯•ç»“æœ**

```
17:31:11.517  INFO 40204 --- [a.clients.Metadata        : [Producer clientId=producer-1] Cluster ID: o1MyIgKrQ2eCeiUrFRD88A
17:31:11.542  INFO 40204 --- [vityPartakeRecordListener : æ¶ˆè´¹MQæ¶ˆæ¯ï¼Œå¼‚æ­¥æ‰£å‡æ´»åŠ¨åº“å­˜ messageï¼š{"activityId":100001,"stockCount":100,"stockSurplusCount":95,"uId":"xiaofuge"}
17:31:11.573  INFO 40204 --- [w.impl.DrawExecImpl       : æ‰§è¡ŒæŠ½å¥–ç­–ç•¥ strategyIdï¼š10001ï¼Œæ— åº“å­˜æ’é™¤å¥–å“åˆ—è¡¨IDé›†åˆ awardListï¼š["1"]
17:31:11.587  INFO 40204 --- [ce.draw.AbstractDrawBase  : æ‰§è¡Œç­–ç•¥æŠ½å¥–å®Œæˆã€å·²ä¸­å¥–ã€‘ï¼Œç”¨æˆ·ï¼šxiaofuge ç­–ç•¥IDï¼š10001 å¥–å“IDï¼š4 å¥–å“åç§°ï¼šAirPods
17:31:11.611  INFO 40204 --- [ucer.KafkaProducer        : å‘é€MQæ¶ˆæ¯(ä¸­å¥–å‘è´§å•) topicï¼šlottery_invoice bizIdï¼šxiaofuge messageï¼š{"awardContent":"Code","awardId":"4","awardName":"AirPods","awardType":1,"orderId":1461960297911812096,"uId":"xiaofuge"}
17:31:11.618  INFO 40204 --- [tion.ActivityProcessTest  : è¯·æ±‚å…¥å‚ï¼š{"activityId":100001,"uId":"xiaofuge"}
17:31:11.650  INFO 40204 --- [tion.ActivityProcessTest  : æµ‹è¯•ç»“æœï¼š{"code":"0000","drawAwardVO":{"awardContent":"Code","awardId":"4","awardName":"AirPods","awardType":1,"grantType":1,"strategyMode":2,"uId":"xiaofuge"},"info":"æˆåŠŸ"}
```

-   ä»æµ‹è¯•ç»“æœå·²ç»å¯ä»¥çœ‹åˆ°ï¼Œå¼‚æ­¥æ‰£å‡åº“å­˜çš„æµç¨‹å·²ç»ç”Ÿæ•ˆï¼ŒåŒæ—¶ä½ å¯ä»¥å»æ£€æŸ¥æ•°æ®åº“ä¸­æ´»åŠ¨åº“å­˜æ˜¯å¦å·²ç»å¼‚æ­¥æ›´æ–°ã€‚_å› ä¸ºæˆ‘ä»¬æœ‰ä¸€ä¸ªæ›´æ–°æ¡ä»¶åˆ¤æ–­æ˜¯å¦æ›´æ–°æ•°æ®æ¯”å‰©ä½™åº“å­˜æ•°æ®æœ€æ–°ï¼Œå¦åˆ™ä¸ä¼šæ›´æ–°_

---

1.  å­¦ä¹  Redis äº‘æœåŠ¡ç¯å¢ƒé…ç½®ï¼Œè‡³å°‘å¯ä»¥çŸ¥é“éœ€è¦é…ç½®å“ªäº›å†…å®¹ï¼Œæ‰å¯ä»¥è®©ä½ çš„æœ¬åœ°ç¯å¢ƒè®¿é—®åˆ° Redis äº‘æœåŠ¡
2.  ç†ŸçŸ¥åˆ†å¸ƒå¼é”çš„é¢—ç²’åº¦å¯ä»¥ç»†åŒ–çš„è®¾è®¡ï¼Œè¿™åœ¨ä½ ä»¥åçš„ä½¿ç”¨æµç¨‹ä¸­ï¼Œéƒ½å¯ä»¥ä½œä¸ºå‚è€ƒ
3.  å¯¹æ•°æ®æœ€ç»ˆä¸€è‡´æ€§æœ‰ä¸€ä¸ªåŸºæœ¬æ¦‚å¿µï¼Œå®ƒæ˜¯ä¸æ˜¯å¼ºæµç¨‹ã€ä»€ä¹ˆæ—¶å€™æ›´æ–°ã€æ€ä¹ˆç”¨ MQ è¿›è¡Œæ¶ˆå³°ï¼Œä»¥é¿å…æ‹–å®æ•°æ®åº“
4.  å­¦ä¹ æ•´ä¸ªè®¾è®¡ä»¥åŠå¯¹æµç¨‹çš„æŠŠæ¡ï¼Œä¸€ç‚¹åˆç†çš„è®¾è®¡ï¼Œåœ¨å°†æ¥çš„ä»£ç ç»´æŠ¤ä¸­ï¼Œéƒ½å°†å‘æŒ¥å·¨å¤§çš„ä»·å€¼