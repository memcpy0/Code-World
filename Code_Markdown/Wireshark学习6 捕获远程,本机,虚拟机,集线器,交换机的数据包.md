目前为止，捕获和分析的都只是源地址或者目的地址是**本机的数据包**。但现实中遇到的情况往往要复杂得多，**研究的对象要包括网络中的其他设备**，我们需要找出合适的方案来捕获并分析「**那些本来不属于本机的数据包**」。

实际上，这个问题的解决方法有很多种，其中有的会涉及软件使用，有的会涉及硬件安装，这些方案各自有适用的场合。围绕这些方法的具体实施步骤和适用场合进行展开，包括内容如下：
- 使用 Wireshark 完成**远程数据包捕获**；
- **集线器环境**下使用 Wireshark；
- **交换机环境**下使用 Wireshark（端口镜像功能、ARP 欺骗、分路器的使用）；
- 使用 Wireshark 完成**本地流量**的捕获；
• 使用 Wireshark 完成**虚拟机流量**的捕获；
# 1. 完成远程数据包捕获
在实际工作中，我们经常会遇到需要捕获其他设备通信数据包的情况。其中的一种情况就是，我们拥有这个设备的控制权，但不便直接去接触它，例如托管在机房的服务器，而图 1 中给出的就是这样一种情形。
图 1 需要监听的远程服务器
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307120852497.png)

很多人采用了在远程设备上安装Wireshark，然后再通过远程桌面控制的方式进行操作。这种做法的缺陷很明显，一来**加大了使用者的工作量**，二来**也产生了大量不必要的远
程控制数据包**。

其实，Wireshark 提供了**一种远程数据包捕获的功能**，这样我们就可以很方便地**监控远程服务器上的流量**（见图 2）。要实现这个功能的操作也并不复杂，只需要在服务器上安装 RPCAP 即可。如果你的服务器安装的是 Windows 系列操作系统的话就更加简单了，常用的 WinPcap 软件就包含了 RPCAP。你可以到 WinPcap 的官网下载 WinPcap，完成下载后，点击安装包，即可按照正常流程进行安装。
图 6 安装有 RPCAP 的远程服务器将数据包都转发给监听主机
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307120852088.png)
WinPcap 安装完成后，RPCAP 就也安装好了。安装之后的 RPCAP 的启动文件为 rpcapd.exe，接下来我们只要启动它就行了。在启动时还需要对 rpcapd 进行一些配置。

配置 rpcapd 时可以指定端口、身份验证以及操作模式等。首先使用 rpcapd 的参数-h 来查看这个工具的使用帮助，如图 3 所示。
图 3 rpcapd 的帮助文件
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307120853281.png)
rpcapd 有被动工作和主动工作两种模式，其中被动模式中需要客户端主动连接服务器。但==如果服务器所在的网络部署了防火墙，而且使用了 NAT（地址转换）技术，这种情况下，客户端就无法连接到服务器中==，就需要使用主动模式，让服务器去主动连接到客户端。

常用的几个参数如下所示。
- -b 指定 rpcapd 进程监听的 IP 地址，从别的地址进入到 rpcapd 的请求，它是不会给予响应的。如果省略该选项，就表示 rpcapd 监听所有的本地 ipv4 的地址。
- -p 指定 rpcapd 进程监听的端口，默认是 2002，可以省略。
- -l 指定一个地址列表文件，**允许哪些地址可以访问 rpcapd 进程**。
- -n 不启用认证功能，任何主机都可以访问 rpcapd 进程。
- -d 以守护进程方式运行。

现在以两台主机为例，一台为远程主机，IP 地址为 192.168.169.133，这台主机上安装了 WinPcap。另一台是我们的计算机，IP 地址为 192.168.1.102，安装了 Wireshark。我们在远程主机上启动 rpcapd 服务（见图 4），这里没有指定任何参数。
图 4 启动之后的 rpcapd
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307120855909.png)

我们的计算机上需要安装 Wireshark，然后启动这个工具。启动之后不要直接选择网卡，而是单击菜单栏上的选项按钮（见图 5）。
图 5 菜单栏上的选项按钮
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307120855230.png)
在弹出的“Wireshark·捕获接口”中选中右侧的“管理接口”（见图 6-6）。
图 6 Wireshark 中的“捕获接口”界面
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307120856418.png)
如图 7 所示，在“管理接口”界面的选项卡中选择“远程接口”，然后单击左下角的“+”按钮。
图 7 在 Wireshark 中添加一个远程接口
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307120856785.png)
如图 6-8 所示，在弹出的远程接口界面中添加远程主机和端口的信息，我们这个实例中远程主机的 IP 为 192.168.169.133，端口为默认的 2002。
图 8 在 Wireshark 中设置远程接口
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307120857573.png)
单击“OK”按钮，我们的 Wireshark 就可以捕获到远程主机上全部数据包了（见图 9）。
图 9 在 Wireshark 捕获远程主机上的数据包
如果希望对 rpcap 有进一步的了解，可以访问 http://rpcap.sourceforge.net/ 页面中提供的关于 rpcap 的详细信息。
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307120857015.png)

# 2. 集线器环境
很多网络方面的教材都涉及抓包这个问题，这里特别需要提出的一点就是==很多早期的教材都没有介绍到「装有抓包工具的计算机如何部署」==。这些书中一般只提到了将网卡设置为
混杂模式，接下来就说*可以捕获到计算机所在网络内的所有通信流量*。但是这种情形在现有的大部分网络中已经不再适用。

要了解这个原因，我们首先来回顾两个网络中常见的设备：集线器（HUB）和交换机。
- 集线器工作在局域网（LAN）环境下，应用于 OSI 参考模型的第一层，因此又被称为物理层设备。
- 例如一个具备了 4 个端口的集线器，共连接了 4 台计算机，而**集线器作为网络的中心对信息进行转发**。其中的计算机 A 要将一条信息发送给计算机 B，它首先要将信息发送到集线器上，而集线器会将这个信息从所有的端口**广播出去**，这时该网络的所有计算机都会接收到这条信息。每个计算机的网卡都会查看信息的目的地与自己的地址是否相同，如果相同的话则将其交给操作系统，否则就丢弃该数据包。
    图 10 集线器的工作原理
    ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307120900613.png)

使用了集线器的网络无疑是**进行抓包时最理想的环境**，只要将网卡调整为混杂模式就可以捕获到整个网络的数据。
# 3. 交换环境
但现在的网络中，集线器已经很难见到了，几乎所有的局域网都使用交换机作为网络设备。而交换机的原理完全不同于集线器。如图 11 所示，一个具备了 4 个端口的交换机，连接了 A、B、C、D 共 4 台计算机，其中的 A 要将一个信息发送到 B 处，而交换
机作为网络的中心对信息进行转发。只有计算机 B 才能收到来自 A 的信息，其他的主机是接收不到这个信息的。
图 11 交换机的工作原理
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307120901803.png)

这样就为我们**捕获其他设备上的数据包**带来了一些难度。
## 3.1 端口镜像
如果你**拥有了交换机的控制权限**，就可以检查这个交换机是否支持端口镜像。==如果支持这个功能，就无需对网络进行任何线路上的改动==。简单来说，端口镜像就是**将交换机上一个或者几个端口的数据流量复制并转发到某一个指定端口上**，这个指定端口被称为“镜像端口”（见图 12）。目前很多交换机都具备了端口镜像的功能。例如我们就可以将其中的一个端口设置为“镜像端口”，然后需要监视的流量都转发到这个镜像端口，这样我们**将要监控的计算机 A 连接到这个端口就可以对目标进行监控了**。图 12 给出了一个端口镜像的实例。

这里面以华为的交换机和路由器为例，下面我们首先给出在华为 S3700 中的配置方法，首先打开 ENSP，在里面新建一个拓扑文件，然后向里面添加一台 S3700 交换机、一台 PC、
一台客户端和一个服务端。构建好的网络结构如图 13 所示。
图 12 镜像端口
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307120902927.png)

图 13 使用华为的交换机构建的网络

这里面 3 台设备的连接方式如表 1 所示。
表 1
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141515031.png)
在本例中，我们使用 PC1 来监控发往服务端的通信流量，就可以将Ethernet0/0/2 配置为观察端口，将 Ethernet0/0/3 配置为镜像端口。下面给出了配置命令。
```
<Huawei>sys
[Huawei]observe-port 1 interface E0/0/3
[Huawei]
[Huawei]int E0/0/2
[Huawei-Ethernet0/0/2]port-mirroring to observe-port 1 outbound
[Huawei-Ethernet0/0/2]quit
[Huawei]
```
到此为止，凡是从 Ethernet0/0/3 端口发出的通信流量，就都会被交换机复制一份到Ethernet0/0/2 上。需要注意的一点是，在本书写作期间的 ESNP 版本中尚未实现交换机的端口镜像功能。不过你在操作真实设备时，按照上述的设置之后就可以实现端口镜像功能了。

路由器同样也提供了端口镜像功能，这里我们以华为的设备 A1220 为例。如表 2 所示，==当路由器与交换机在配置时，仅仅有一点区别==，就是在设置镜像端口时，交换机使用的是 port-mirroring 命令，而路由器使用的是 mirror 命令。这个实验的网络结构与图 13 相同，只需要将里面的交换机替换成路由器即可。
表 2
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141516300.png)
在本例中，我们使用 PC1 来监控发往服务端的通信流量，就可以将 Ethernet0/0/0 配置为观察端口，将 GE0/0/1 配置为镜像端口。
```
<Huawei>sys
[Huawei]observe-port interface e0/0/0
[Huawei]int GigabitEthernet0/0/0
[Huawei-GigabitEthernet0/0/0]ip address 192.168.1.1 255.255.255.0
[Huawei-GigabitEthernet0/0/0]quit
[Huawei]int GigabitEthernet0/0/1
[Huawei-GigabitEthernet0/0/1]ip address 192.168.2.1 255.255.255.0
[Huawei-GigabitEthernet0/0/1]mirror to observe-port outbound
[Huawei-GigabitEthernet0/0/1]quit
```
等待配置完成之后，我们就可以在路由器上单击鼠标右键，然后依次选中“数据抓包”→“Ethernet0/0/0”启动 Wireshark。接下来我们使用客户端去“ping”服务器，但由于客户端里面没有命令行，因此==需要在基础配置中使用“PING 测试”==（见图 6-14）。
图 14 使用虚拟路由器上的“PING 测试”
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141517931.png)

如图 6-15 所示，在“Ethernet0/0/0”接口中启动的 Wireshark 中就可以看到本来应该是发往 GE0/0/1 端口中的网络流量。
图 15 捕获到的本应发往 GE0/0/1 端口中的网络流量
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141517542.png)

ENSP 中的路由器实现了端口镜像功能，在实际工作中的这种方法也是十分便利的。

## 3.2 ARP 欺骗
在大多数情况下，**我们可能既不能去更改网络物理线路，也不能使用交换机的端口镜像功能**。这时可以使用 ARPSpoof 或者 Cain 之类的工具来实现中间人（NITM）攻击。这种技术经
常被黑客用来进行网络监听，所以也被看作是一种入侵行为。

ARP 欺骗无需对网络做出任何的改动，只需要在自己的计算机上运行欺骗工具即可，但需要注意的是这种行为往往会被认定为入侵行为。ARP 欺骗的原理如下所示。
（1）图 16 给出了一个正常情况时，**计算机 B 通过网关和外部进行通信的过程**。
图 16 正常的网络状态
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141518970.png)

（2）但是计算机 A 可以通过使用一些中间人攻击工具来欺骗计算机 B，如图 17 所示。
图 17 计算机 A 的欺骗行为
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141520827.png)

（3）接下来，**计算机 B 就会将原本发往网关的数据都发到计算机 A**，如图 18 所示。
图 18 受到欺骗的计算机 B
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141519514.png)

（4）使用同样的办法欺骗网关，**让网关误以为计算机 A 就是计算机 B**，从而实现中间人攻击。

中间人攻击是一个很有意思的技术。下面我们来介绍其中一种很有效的工具 Arpspoof，这个工具有 Windows 和 Linux 的两种版本，虽然它没有图形化的工作界面，但使用的命令格式很简单：
arpspoof [-i 指定使用的网卡] [-t 要欺骗的目标主机] [-r] 要伪装成的主机

例如这里面我们以监听192.168.169.132 和 192.168.169.2 之间的通信为例，就可以执行如下命令：
```java
root@kali:~# arpspoof -i eth0 -t 192.168.169.132 192.168.169.2
```
执行的过程如图 19 所示。
图 19 ARPSpoof 的使用方法
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141519703.png)

然后启动 Wireshark 就可以查看到两台计算机之间的通信了。ARP 欺骗是一个涉及内容较多的话题，可以参见 10.3 节。如果希望能了解详细过程的话，可以参考人民邮电出版社《Kali Linux 2 网络渗透测试实践指南》。

## 3.3 网络分路器
另外，在对其他计算机进行网络数据分析时，网络分路器（TAP）（见图 20）也是一个非常不错的选择。==网络分路器有些像我们生活中使用的水管“三通”的意思，即原来的流量正常通行，同时复制一份出来供监测设备分析使用==。图 20 给出的就是一个构造很简单的网络分路器，它一共有 4 个接口，左侧两个 Network 接口用来连接被监听的设备，右侧的 Monitor 接口用来连接监听设备。这个过程其实和交换机的镜像端口有一点像，只不
过 TAP 的使用要灵活一些。
图 20 一个简单的网络分路器（TAP）
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141520743.png)
在网络中安装网络分路器很简单，花费的时间也很少，所以是一种简单易行的方案。

将问题主机和网络设备插入一个网络分路器的左侧接口，然后将网络分路器的另一个接口连接到我们安装有 Wireshark 的主机上。这样所有的数据都会实时地显示在 Wireshark 中。

==这样做的优势很明显，不需要对网络设备进行设置，也无须担心数据的丢失==。而缺陷也很明显，首先需要购买 TAP 这个额外的硬件，而且对 TAP 的性能也有一定的要求，它的处理速度不能低于网络数据的传输速度，其次也需要对网络结构进行更改。

# 4. 完成本地流量的捕获
**通常 Wireshark 不能直接抓取本地的回环数据包**，这在很多时候都会给我们带来不便。

例如一个前台程序和它所使用的数据库都安装在同一台服务器上的时候，前台程序如果使用 127.0.0.1 这个地址来访问数据库，此时==直接使用 Wireshark 就无法捕获它们之间通信的
数据==。

这个问题可以通过在操作系统中进行一些设置后得以解决，不过这种方法比较复杂。

我们这里介绍另一种更为简单的方法，使用工具软件 RawCap 可以轻松地完成这个任务。RawCap 的体积十分小，只有 20 多 KB。下面介绍如何通过工具软件 RawCap 直接抓取本地网络包，省去设置带来的麻烦。

首先需要到 RawCap 的官方网站下载这个工具，在这个主页中还提供了详细的使用说明（见图 21）。
图 21 RawCap 的官方地址
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141521423.png)
当安装完成之后，就可以按照如下的步骤来使用 RawCap。
（1）打开 RawCap：输入 RawCap.exe+IP 地址+抓包数据存储的 filename.pcap。因为要捕获本机的流量，这里面的 IP 地址要设置为 127.0.0.1。例如：RawCap.exe 127.0.0.1 Capture.pcap
（2）如图 22 所示，进入抓包状态。
图 22 在 RawCap 中捕获数据包
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141521269.png)

（3）抓包结束之后，按“Ctrl+C”组合键停止抓包工作。在此期间捕获到的所有数据包都以 Capture.pcap 为名保存到了 RawCap 的所在目录下，接下来就可以使用 Wireshark 打开这个文件进行分析了。

# 5. 完成虚拟机流量的捕获
很多情况需要我们对虚拟机进行流量捕获，这里面以 VMware 为例，==当 VMware 安装后系统会默认安装 3 个虚拟网卡 VMnet0、VMnet1 和 VMnet8==（见图 23），**这些虚拟网卡除了无法接触到之外，其余的地方都是一模一样的**。下面给出了安装完 VMware 之后系统中添加的网卡设备，注意这里并不显示 VMnet0。

图 23 VMware 安装后会默认安装 3 个虚拟网卡
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141521681.png)

## 1. 桥接（Bridge）
这里面我们需要考虑 VMware（另一款虚拟机软件 Visual box 与此相同）的网络连接方式（见图-24），在使用虚拟机进行网络通信时，我们需要在以上的几种模式中做出选择，这些模式各自有适用的场合，也**各自有不同的捕获数据包的方式**。
图 24 虚拟机中网络连接
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141521225.png)
如果虚拟机采用了这种方式上网的话，那么就意味着**它将会和真实的计算机采用完全相同的联网方式**。==对应的虚拟机就被当成主机所在的以太网上的一个独立物理机来看待==，各虚拟机通过**默认的 VMnet0 网卡**与主机以太网连接，虚拟机之间的虚拟网络为VMnet0。这时你的虚拟机就像局域网中的一个独立的物理机一样。==桥接会使用 VMnet0 作为网卡，但这个虚拟网卡是看不到的，所以我们无法通过选择网卡的方式来捕获虚拟机的流量==。

而实际上虚拟机此时上网使用的**就是宿主机上网的那块网卡**，因此我们只需要选择正常上网的那块网卡，然后使用过滤器 `eth.addr==虚拟机的硬件地址` 来过滤即可。
## 2. 仅主机模式（Host-only）
==处于这种模式的主机相互之间可以通信，也可以与物理宿主机进行通信，但不能连接到除此以外的设备上==。我们只需要在选择网卡的时候选中“VMware Network Adapter Vmnet1”网卡就可以监听所有的通信流量（见图 25）。
图 25 在虚拟机网络选中“VMware Network Adapter Vmnet1”网卡
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141522297.png)

## 3. NAT 模式
只需要在选择网卡时选中“VMware Network Adapter Vmnet8”网卡就可以监听 NAT 模式下的所有虚拟机的通信流量。

# 6. 小结
这一章讲解了如何实现对 Wireshark 的部署。这部分内容看起来好像和数据包捕获没有直接关系，但却是展开工作的基础。
- 首先从远程捕获数据包开始，
- 然后分别介绍了如何在具有集线器和交换机的环境下使用 Wireshark。
- 最后讲解了如何捕获本机地址和虚拟机产生的数据包。这些内容会给你实际的工作带来帮助。