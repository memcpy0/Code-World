讲解了如何使用Wireshark来确定网络发生延迟的位置。在这一章中我们来探讨一个更常见的问题，那就是“为什么我的计算机不能上网了？”这个问题几乎每天都在发生，而如果你刚好负责某个单位的网络维护工作的话，那么一定会对此感到十分厌烦。很多原因都可能导致设备无法上网，本章就对它们逐个进行分析。

在这一章中，我们将会围绕如下主题对这个故障的排除方法进行讲解：
-建立一个用于测试的仿真网络；
-导致不能上网的原因；
-**检查计算机的网络设置**；
-检查**与网关的连接**；
-检查**DNS协议**；
-检查**网络传输路径**；
-检查**目标服务器**。

##8.1建立一个用于测试的仿真网络
为了能够更好地了解整个网络的状况，我们首先来构建一个模拟的仿真网络，在这个网络中存在着客户端、服务器以及连接它们的各种设备。构建完成的仿真网络如图1所示。
图1构建完成的仿真网络
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141748587.png)
这个网络结构的配置和第7章的基本一样，只是在内部网络中多添加了PC1和PC2，其中PC1的配置如图2所示。
图2PC1的配置信息
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141748391.png)

而PC2的IPv4配置中采用了DHCP方式，如图3所示。
图3PC2的配置信息
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141748902.png)

另外由于这个实验中我们还需要一台DHCP服务器，这里为了精简网络结构，所以我们在原来的网关路由器上开启了DHCP功能，开启的命令如下所示：
```java
interfaceGigabitEthernet0/0/0
ipaddress192.168.1.1255.255.255.0
dhcpselectglobal
```
#8.2可能导致不能上网的原因
在实际生活中导致计算机不能上网的原因有很多，正常情况下我们可以按照如下的步骤来进行故障排除。
-检查用户**所用设备的网卡是否正常启动**。
-检查用户所用设备上**每个网卡的IP地址、子网掩码、默认网关配置**是否正确。
-检查用户所在网络的**ARP协议是否正常工作**，例如网关的MAC地址是否正确。
-检查用户所在网络的**DNS协议是否正常工作**。
-检查用户所使用的**具体网络服务是否正常工作**。

下面我们就按照这个顺序来分别研究一下这些故障，其中前两个故障的排除都属于计算机的基本配置，它们都在下一节中进行讲解。
#8.3检查计算机的网络设置
##8.3.1确保网卡正常启动
虽然在正常情况下设备的网卡都是启用的，但也有很多情况网络故障确实是由于网卡没有启动所造成的。在Windows操作系统中我们可以==使用命令行中的ipconfig命令来查看网卡的状态和基本信息（IP地址、子网掩码、网关等信息）==。如果在Linux系统中的话，可以使用ifconfig命令。

如图4所示，这里面的①部分的“本地连接4”就是一个没有启动的网卡，而②部分的“本地连接2”则是一个正常工作的网卡，我们需要确保当前要使用的网卡已经启动。
图4使用ipconfig查看网卡的状态和基本信息
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141751556.png)

##8.3.2检查IP配置的正确性
一台计算机如果需要正常上网的话，那么就需要配置如下信息：
-IP地址；
-子网掩码；
-网关地址；
-DNS服务器地址。

通常一台计算机的IP配置有两种方法，一是**手动配置**，二是**使用DHCP分配的方式**。

这里面的网络配置包括IP地址、子网掩码、网关和DNS服务器地址。当使用ipconfig命令查看之后，发现网卡虽然启用，但没有显示IP地址时，就需要询问网络管理员，或者参考同一单位其他人的计算机来确定IP配置所使用的方法。==如果该计算机所处网络采用手动配置的方法，那么就需要根据网络的部署对其进行配置==。图5给出了Windows环境下对IP配置的方法。
图5Windows环境下对IP配置的方法
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141754155.png)

==如果这个网络要求采用DHCP动态分配IP方法的话，那么我们就需要对其进行分析了==。

如图6所示，以内部网络的PC2为例，该主机采用DHCP动态分配IP地址的方式。但在工作中却发现该主机无法上网。
图6不能上网的PC2
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141754075.png)
我们对这个主机进行检查，使用“ipconfig”命令查看这台主机的网络设置（见图7），发现并没有得IP地址等信息。
图7使用“ipconfig”命令
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141754434.png)
现在我们可以确定该计算机不能上网的原因，**在于没有通过DHCP协议获得IP地址等信息**，但是究竟是由于本机受到病毒感染从而造成DHCP协议不能正常工作，还是DHCP服务器没有正常工作，这还需要我们进一步分析。首先可在PC2处使用Wireshark进行抓包分析（见图8）。
图8在PC2处使用Wireshark进行抓包分析
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141755394.png)

在Wireshark中使用“bootp”作为显示过滤器，可以看到如图9所示的数据包。
图9使用“bootp”作为显示过滤器
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141755777.png)
##8.3检查计算机的网络设置117
可看到PC2在网络中持续发送==“DHCPDiscover”数据包，这些数据包的目的地址为“255.255.255.255”，表示这是一个广播数据包==。而==源IP地址为“0.0.0.0”则是因为该计算机现在还没有得到IP地址，不过由于它本身具有MAC地址，所以可以在局域网内部通信==。我们打开这个数据包的Ethernet部分可以看到它的MAC地址为“54:89:98:1c:67:fb”，如图10所示，这也正表明了该数据包来自于PC2。
图10数据包的源地址
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141755686.png)
继续向下移动到Bootstrap位置，我们可以看到这个信息的类型为BootRequest(1)（见图11）。
图11数据包的类型
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141756151.png)

**DHCP的消息一共有8种**，表1给出了DHCP协议中的8种类型。
表1DHCP协议中的8种类型
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141758521.png)
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141806826.png)
按照DHCP协议的要求，客户端会在网络中广播“DHCP Discover”请求，用来找DHCP服务器，而==当服务器收到这个请求之后，会用DHCP Offer来响应DHCP DISCOVER报文，此报文携带了各种配置信息==。但在我们刚刚捕获到的数据包中，却没有发现“DHCP Offer”报文，这说明在DHCP服务器端出现了问题。

通过排查，我们**发现DHCP服务器已经被关闭**。随后启动DHCP服务器，然后继续使用Wireshark查看捕获到的数据包（见图12）。
图12使用Wireshark查看捕获到的数据包
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141810279.png)
如果一台机器正常启动的话，==最先捕获到的两个数据包分别为DHCP Discover和DHCP Offer数据包，然后是DHCP Request和DHCP Acknowledgment数据包==。

在DHCP Offer数据包中包含如下数据。
- 你（客户端）的IP地址：这是DHCP服务器提供**可以使用的IP地址**。
- 子网掩码：这是DHCP服务器提供的**可以在网络上使用的子网掩码**。
- ==域名服务器：这是DNS服务器的IP地址==。
- 网关：这是网关的IP地址。

这些信息是保证网络通信最基本的内容，正常情况下，用户的设备会收到一个这样的DHCP Offer数据包回应。下面我们给出了一个完整的DHCPOffer数据包的详细内容，如图13所示。
图13 DHCP Offer数据包的详细内容
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141811629.png)
当网络比较繁忙时，我们也可以使用过滤器来**只显示出指定类型的DHCP数据包**，例如只显示DHCPAcknowledgement类型的数据包，这个过滤器表达式为：
```java
bootp.option.dhcp==5
```
如果方便的话，可以将这个过滤器作为一个按钮。另外也可以**将显示异常的DHCP过滤器字符串作为一个按钮**，例如当网络中出现第4类型、第6类型、第7类型的DHCP数据包都会导致用户设备不能上网，这个过滤器如下所示：
```js
bootp.option.dhcp==4||bootp.option.dhcp==6||bootp.option.dhcp==7
```
可以单击过滤表达式右侧的“+”，然后在标签里输入名称DHCP Error（见图14），在过滤器中输入上面的表达式，然后单击“OK”按钮。
图14DHCPError显示过滤器
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141812969.png)

以后如果你需要使用这个过滤器，只需要单击右侧的“DHCPError”（见图15）。
图15DHCPError显示过滤器按钮
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141813552.png)
## 8.3.3检查与网关的连接是否正常
当客户端获得了**IP地址、网关和DNS服务器信息**之后，接下来要检查的就是**网关**。==因为网关充当着整个网络的出入口，所以客户端必须要能够连接到它==。如图16所示，我们可以使用“ping”命令来测试与网关的连接情形。
图16使用“ping”命令来测试与网关的连接
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141813933.png)
如果ping不通的话，则说明与网关的连接出现了问题。==如果线路没有问题的话，则可能考虑两种情况，一是网关已经关闭，二是ARP协议出现了问题==。

计算机需要**使用ARP协议来解析「位于同一网络的网关的MAC地址」**。如果希望更好地对ARP数据包进行观察的话，可使用过滤器来完成对ARP数据包的过滤，显示过滤器的写法为“arp”。另外也可以在用户的设备上，使用“arp-a”命令来查看**系统缓存中的IP与MAC地址的对应关系**（见图17）。
图17查看ARP缓存的内容
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141814321.png)
如果ARP缓存中网关的IP地址与MAC地址对应没有问题，就可以判断ARP协议能够正常工作。
## 8.3.4 获取域名服务器的IP地址
当需要连接到互联网的某个网站时，使用的往往是一个域名而不是IP地址，这个过程中需要连接到DNS服务器对其进行查询。一个正常的DNS应答数据包的格式如图18所示。

==如果一个客户机不能获取Web服务器或者应用服务器的IP地址，那么我们可以通过数据包分析的方法来分析这个故障==，分析的目标就是来自DNS服务器的响应。

通过对比对失败的DNS响应与正常的DNS响应之间的区别，可以找出故障的根源。这种失败可能由于**DNS服务器配置的故障**，或者**由于你查询时使用了错误的URL和主机名**。
图18 DNS应答数据包
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141815580.png)
# 8.4 检查网络路径的连通性
好了，如果之前的检查都没有问题的话，那么从现在开始起，发出的数据包将远离我们，踏上去往目标服务器的路上，虽然不到一秒，但是这个数据包可能已经穿越了半个世界。

在本节中，使用Wireshark来分析离开网关之后的数据包。在这个分析过程中需要用到 `traceroute` 工具，它将显示出一条从我们主机到目标主机的通路。在Windows系统中，启动traceroute工具的命令为tracert。图19显示了从本机到百度官方网站的路径。
图19 traceroute工具
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141815928.png)
==这个工具利用了数据包中TTL值的特性，这个值就是数据包的生存时间==。虽然称之为生存时间，但是这和我们平时所讲到的时间并不相同，==它的值只有在经过一个路由器之后才会减少。当一个路由器收到TTL值为0的数据包就会将其丢弃掉==，并向这个数据包的源地址发回一个ICMP报文。

利用这个TTL的这个特性，traceroute程序会先向目标发送一个数据包，但这个数据包永远不会到达目标。因为它的TTL值被设置为1，所以**它仅仅到达了第一个中转站（路由器）就被丢弃**，但是这个路由器需要向源地址发送一个ICMP数据包。这样**源主机就知道数据所经过的第一个路由器了**。接着向目标发送TTL值为2的数据包，收到应答之后，再发送TTL值为3的数据包。这样一直到数据包到达目标为止，利用traceroute程序，我们就可以知道从源地址到达目标地址之间所经过的路由器。

这里推荐==使用一个更好的工具Ping Plotter（见图20），这个工具要远远比系统自带的工具要强大，可从PingPlotter官网下载一个免费的版本==。这个工具相对traceroute最大的优势在于，可以指定发送数据包的大小。
图20 PingPlotter的使用
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141816847.png)
首先我们启动Wireshark，然后Ping Plotter中的对话框中输入要目标地址“www.baidu.com”（见图21）。
图21 在PingPlotter中指定目标
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141816840.png)
按下右侧的三角形按钮，这时就会开始向目标发送数据包了。等数据包到达
www.baidu.com 时，就可以在Wireshark中停止数据包的捕获了，在此期间数据包经过的路径如图22所示。
图22 在PingPlotter中显示数据包经过的路径
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141816687.png)
在Wireshark找到并选中PingPlotter发出的第一个数据包，然后在数据包详细信息面板中选中IP协议部分（见图23）。
图23 显示数据包的IP包头
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141816880.png)
利用这个工具，就可以查看在到达目标网站之前，数据包都经过了哪些路由器以及在哪个路由器出现了问题。
## 8.5其他情形
如果一个用户到达目标服务器的故障是功能性的，也就是说两者的连接没有问题，但用户却不能正常使用目标服务器上的应用。可能导致故障的原因如下：
- 用户提供的**URL或者端口**是错误的；
- 这个端口被**防火墙**所屏蔽；
- 应用程序不再正常工作。

第一个原因往往是用户错误输入造成的，另外两个因素往往会导致所有人都无法访问。我们还需要确定到底是==目标主机整体都无法访问，还是仅仅是一个程序无法访问==。
- 如果服务器无法访问，那么显示ICMP信息应该为Destination Host is Unreachable或者Destination Port is Unreachable；
- 如果目标防火墙启用了屏蔽，那么所有的ICMP数据包都得不到回应。
- 如果服务器正常工作，但应用程序却是无法访问的，仅仅在客户端进行数据包捕获获取的信息可能并不足以找到故障的原因。但==通过查看TCP会话连接建立的数据包可以找到很多有用的信息==。
- 如果用户可以与目标程序建立TCP连接，但应用程序却不能正常工作。这时我们需要考虑的因素很多，最简单的方法就是比较用户与其他用户连接目标的数据包有什么不同。

如果排除了上面提到的这些可能性，下面列出的这些因素也可能会导致出现一个功能性的故障。
（1）**用户认证**：这种故障出现的主要原因是用户缺少适当的认证、授权、权限等。这是我们检查用户是否正常工作的第一个步骤。
（2）**用户自己计算机上的配置**：很多应用程序需要特定的配置，例如将特定文件放置在特定目录中。还有一些应用程序需要考虑特殊插件例如java、netframework等。通常，应用程序会提供应用程序配置的错误故障。
## 8.6小结
就不能上网的问题进行了分析，这是一个在日常生活中经常会遇到的问题。因此解决这个问题具有很强的实际意义，Wireshark的使用为我们带来了很大的便利。