练习歪门邪道的功夫，很快便能小有成就，但永远成不了高手。而名门正派的武功虽然入门艰辛，进步缓慢，却是成为一代宗师的必由之路。这段话深得我心，学习网络也只能老老实实地去参透各个协议，才能达到最高境界。**研究协议的过程虽然枯燥缓慢，但是不可或缺**。

有的技术人员喜欢重启一下或者乱试一通来碰运气，虽然也有成功时，但是概率很低。如果一个人经常有这样的好运气，那去赌场上班也许更加合适。我最近处理过的一个案例就很好地说明了这一点。

事情是这样的：现场工程师搭建了一台文件服务器来提供 NFS 共享，可是客
户端一直挂载不上，每次尝试都收到同一个报错“access denied by server while
mounting…”，如图 1 所示。
图 1
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131627199.png)

现场工程师检查了服务器和客户端的所有配置，但实在找不出原因，于是这个问题就拖了好几天。当他焦急地打我电话时，据说客户已经彻底失去耐心了，在机房里咆哮，“I am going to throw the box out of the window”。我只好安慰他说，“放心吧，帮我抓一个网络包，一小时内给你答复。”

之所以敢承诺这么短的时间，是因为我已经处理过上百个类似的问题。自从
用 Wireshark 学习了 NFS 的协议细节后，**我可以用它很快地解决任何挂载问题**，至今没有失手过。其实一小时还是保守估计，一般 5 分钟就够了。现场工程师很快就把配置信息和网络包传过来了：
- 服务器 IP：10.32.106.77
- NFS 共享的访问控制：/paddynmfs 192.168.26.139（rw） ##只允许 192.168.26.139 读写，其他客户端不能挂载

客户端 IP（见图 2）：
图 2
![Uploading file...0opob]()

现场工程师的排查过程如下所示。
```java
[root@localhost ~]#telnet 10.32.106.77 111
Trying 10.32.106.77...
Connected to 10.32.106.77 (10.32.106.77).
[root@localhost ~]#telnet 10.32.106.77 1234
Trying 10.32.106.77...
Connected to 10.32.106.77 (10.32.106.77).
[root@localhost ~]#telnet 10.32.106.77 2049
Trying 10.32.106.77...
Connected to 10.32.106.77 (10.32.106.77).
[root@localhost ~]# showmount -e 10.32.106.77
/paddynmfs
192.168.26.139
```
作为“碰运气”步骤，现场工程师把客户端和服务器都重启过了，但结果还是一样。

我仔细检查完以上信息，结论和现场工程师一样——**服务器和客户端的配置
都没问题。而且从排查过程还可以知道**：
-  从 telnet 的输出结果可见 portmap（111）、mount（1234）以及 NFS（2049）**进程所对应的端口都是可达的**；这说明网络是通的，**没有防火墙之类的设备拦截了挂载请求**；
- 从 showmount 的结果可以看到，**挂载时指定的共享路径也是正确的**。

到这里我也有点迷惑，一时想不出问题出在哪里。阅读以下内容之前，建议你停下来思考一下，还有什么因素可能导致了挂载失败？

幸好杀手锏没有出，我用 Wireshark 打开在服务器上抓到的包，然后用192.168.26.139 过滤了一下，如图 3 所示。
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131629416.png)
从图 4 中可以看出，客户端 10.32.200.45 发送了 mount 请求，但被服务器10.32.106.77 拒绝了，这倒符合“Access Denied”的症状。等等，客户端的 IP 不应该是 192.168.26.139 吗，怎么变成 10.32.200.45 了？这时候我恍然大悟：**两个网络之间估计存在 NAT（Network Address Translation），当客户端发出的请求经过NAT 设备时，Source IP 被改掉了**（图 5 显示了这个过程）。
图 5
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131630370.png)
由于服务器上的访问控制只允许 192.168.26.139 访问，所以来自 10.32.200.45的挂载请求自然被拒绝了。

我把分析报告发给现场工程师。他和客户沟通之后，果然证实了我的分析。最终把服务器和客户端连到一个网络中就挂载上了。实施部门的经理发来一封热情洋溢的感谢信，这让我想起几年前第一次得到 Patrick 的帮助时，我也表达过同样的感激之情。其实我们还应该感谢的，是 Gerald Combs。假如没有他的 Wireshark，我可能至今还不理解 NFS 的挂载过程，更不要说一小时内就找出问题。那天我把 MSN 签名档改成了“Life is tough, but Wireshark makes it easy”。