Wireshark不只应用于企业级数据中心。在高度依赖于网络的现代生活中，Wireshark也有广阔的用武之地，尤其是当前越来越流行的手机应用。这一部分介绍了**如何在家中搭建一个环境来抓取手机上的WiFi网络包**，**分析了微博和微信等不同App的网络行为**，揭露了家庭宽带如何被恶意劫持等。这一部分技术含量不一定很高，但是比较有趣。
### 假宽带真相
央视的【每周质量报告】做过一期关于网络的节目，叫“假宽带真相”。大意是说某些运营商的带宽远远达不到其承诺的标准，360的测速软件也“有明显的设计缺陷”，所以测出的结果远高于真实带宽。难得有个业内大新闻，我当然不会错过，当即就用Wireshark验证了一下。这一试才知道，**原来网络测速包含了不少有意思的知识点，所以便写出来和大家分享**。

我家当时用的是中国电信的10M宽带，从官网测到的结果如图1所示，下载速度达到1235KB/秒，差不多是10M了。在不同时间段测试都是一样的结果，所以应该是可信的。
图1
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091749662.png)
注意：中国特色的宽带服务是以下载速度为计算标准的，其实上传速度慢很多，上下行带宽严重不对等。这就是为什么会在图1中看到上传速度只有2M。本文不关注这一点，所以只分析下载速度。

这个速度究竟是怎样测出来的呢？我用Wireshark抓了个包，且看下面的详细分析。

点击Wireshark的Statistics菜单，再点击Conversations选项，可以得到图2所示的窗口。从中可见测速过程中用到了5个TCP连接在下载。因为端口号是80，所以应用层协议应该是HTTP。
图2 
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091750325.png)
为什么要选择5个连接，而不是更多或者更少呢？其实连接数的选取很有讲究。**之所以不用单个连接，是因为一个连接不可能时刻都在传输，有很多原因会导致它不得不短暂停滞。当某一个连接停滞时，其它的连接还可以继续传输，这样就能最大限度地利用带宽**。在《固定宽带接入速率测试方法》通信行业标准中，也明确规定了“测试中使用的线程数量为N（N≥4）”。

图3是其中一个连接的Time/SequenceNumber坐标图，我是在Wireshark中点击Statistics→TCPStreamGraph→Time-SequenceGraph（Stevens）菜单来生成它的。
图3
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091753694.png)

对这个连接而言，传输过程中遭遇了多次停滞，比如最严重的是0.3～7.8秒之间，**Sequence值几乎没有增长**。还好其他TCP连接在这段时间里仍在正常传输，所以带宽一点都没有浪费。**之所以没有用更多的连接数，是因为多到一定程度就没有意义了，甚至会影响TCP的拥塞控制效果**。我用iPerf测试过的，详情可见本书的《过犹不及》一文。究竟用多少个连接数最好，这是需要测试的，估计技术人员测下来的最佳连接数是5。随着百兆家庭带宽的普及，相信我们以后会看到更多的连接数。

再回到Wireshark的主界面。如图4所示，在下载测试开始之前，**客户端是用一个GET方法查到下载源的，即http://101.95.50.3/test.img。直接用IP的办法不错，因为不会受到DNS查询时间的影响**。
图4
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091758020.png)
获知下载源之后，就可以建立5个TCP连接下载了。图5是其中的一个连接，从Time一栏可见响应速度相当快，GET请求发出去3.1毫秒后（即16号包和18号包之间的时间差）就开始收到数据了。这是因为101.95.50.3位于上海电信的机房中，离我家不远。而且这应该是一台专门用来提供测速的服务器，很可能被全面优化过了。不过再怎么优化都不算作弊，电信承诺的10M本来就是理想状态下的带宽。看来央视曝光的假带宽问题没有发生在我身上。
图5
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091800223.png)
注意：高带宽并不意味着上什么网都快。**影响性能体验的因素很多，除了带宽，还有跨运营商、跨区域和服务器性能等**。就算你家里有100M宽带，靠VPN连到国外网站看视频也可能很卡。那作为第三方的360测速软件是否真的“有明显的设计缺陷”呢？我下载到了两个360测速软件，先来看第一个。如图6所示，测出来的带宽为8M，略低于电信官网的宣称值。
图6
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091805487.png)
于是再用Wireshark分析。从图7可见，360测速软件也选择了5个TCP连接来下载，端口号也是80，与电信的方式如出一辙。原理是一模一样，差别只是服务器的响应速度，电信服务器为3.1毫秒，360服务器则是4.9毫秒，这也许就是结果略有不同的原因。具体网络包和图5很像，为了不浪费篇幅我就不贴出来了。
图7
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091806905.png)

从这个工具看，360测速软件并不存在央视所说的“明显的设计缺陷”，否则电信官网也算设计缺陷。于是我决定试一下另一个360测速工具。从图8可见，其结果接近10M。
图8
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091806864.png)
再用Wireshark分析。从图9可见，这次除了HTTP下载，还有不少数据是通过P2SP的，传输层走的是UDP协议。央视的专家估计也看到这个现象，所以认为这是一个设计缺陷，说“这种P2SP测速方法，它会去选择一些同样安装了这款软件的其他的连接节点来进行测速，只要其中有一个节点，它是在这个用户同一个小区宽带的子网里面，它的这个链路质量就非常好，网速就非常快”。我有点怀疑这个猜测，因为一个小区里有多个用户安装测速软件的概率太低了。我自己测了几次的结果都差不多，假如真有一个节点在我们小区里，应该能从图9的统计表中看出这个“作弊”IP的流量。
图9
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091808910.png)

综上所述，**360测速软件还是有节操的，它体现的是模拟现实的网速，包括HTTP（浏览网页和刷微博之类的）和P2SP（比如迅雷下载）**。运营商提供的测速也没有作弊，不过它体现的是一个接近理想状况的网速。那为什么央视说有些宽带不达标，但360测速软件却给出很高的带宽呢？我认为这不是P2SP导致的，而**是因为这些运营商侦查到360正在测速，于是立即劫持，转变成在限速点之内测速了**。如果真是这样，那也是运营商的问题，不能怪测速工具。由于我没抓到这种包，所以就不多作评论。

最后声明一下，我写这篇文章的目的不是给上海电信做广告或者为360正名，只是想借助这个话题演示一下Wireshark的应用场景。**几乎所有和网络相关的问题都可以用Wireshark来探索学习，有时候稍微分析一下就能看得很远**。我对带宽缺斤短两也不在乎，因为从来不下载电影或者美剧。**网络的安全和通畅才是我最重视的，可惜这两点并不容易享受到**。

### 手机抓包
我很久以前就想在手机上抓包了。因为随着移动App的流行（见图1），**手机的流量越来越大，值得研究的技术问题也会越来越多**。像我这样还未融入现代社会的大叔，每个月都能用掉几百兆流量，那些摩登青年的流量之大可想而知。 

不过作为晚期拖延症患者，我迟迟没有付诸行动，直到有一天手机上的某个App莫名其妙地耗掉了近百兆流量，才不得不动手。我先打了个电话给中国移动，客服人员说，“我们最近收到很多例类似的报告了，原因还没有查明。”好吧，看来只能由我自己来查了，顺便搭建一个可以在手机上抓包的环境。

一番研究之后，我大概知道了业内人士都是怎么抓包的。**多数开发人员用Fiddler和Charles来抓**，包括安卓和iPhone。可惜它们都是针对Web的，不能满足我的全部需求。

有人说设个HTTP代理就可以在电脑上抓了，不过我感兴趣的协议不只是HTTP。有一些现成的安卓抓包工具，但需要root才能装。iOS上的工具则没有找到。搜到了一款叫tPacketCapture的工具，号称无需root也能抓，可是我的安卓测试机上不了Google Play。

真没想到手机抓包这么麻烦，相比之下电脑抓包实在太方便了，只要装个Wireshark就行，分分钟搞定。那有没有办法用Wireshark来抓手机上的包呢？这个问题让我想起了大学寝室的网络拓扑，当时我们寝室四个人只共享一个对外的网口，所以就在我的电脑上装了两个网卡，网卡1对外，网卡2和室友们的电脑连在一个交换机上，如图2所示。
图2
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091810110.png)
这样室友们的对外流量就是通过我的“网卡2→网卡1”出去了，**理论上只要在我的网卡上抓包**，就能知道哪位室友在和女神聊QQ，哪位室友在祝楼主好人一生平安了（兄弟们饶命，我就说说而已，没有真抓过）。假如把我家的网络拓扑也改成这样，让手机也通过我的电脑上网，不就可以用Wireshark抓到手机连WiFi时的包了吗？当前我家的网络拓扑如图3所示，手机的网络包都通过无线路由器出去了，我得改造一下，让它们走一台已经淘汰不用的台式机。
图3
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091811931.png)

线路改造只花了几分钟：我先把无线路由器撤掉，**再把入户modem直接连到台式机的网卡1上，这样台式机就可以上网了**。接下来**只要把台式机的网卡2（无线的）设为热点，就能供手机上网了**。网络拓扑如图4所示。
图4
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091812549.png)

接下来的配置过程复杂一点，但也说不上很难。
1. 执行图5的命令，将台式机的无线网络设成热点。
    图5
    ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091812164.png)
2. 把台式机的网卡1共享给无线网络，如图6所示。
    图6
    ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091813643.png)
3. 此时控制面板中应该可以看到4个连接，如图7所示。
    图7
    ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091813606.png)
4. 在手机上扫到热点，输入密码就连上了，如图8所示。
    图8
    ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091813319.png)
5. 在台式机上打开Wireshark，从CaptureInterfaces可以看到4个连接，勾上我们感兴趣的无线网络就可以了，本地连接没必要抓。注意有些老版本的Wireshark是抓不到无线网络包的，你也许需要升级到最新版本。
    图9
    ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091814810.png)

以上步骤仅供参考，因为在不同的环境中，即使严格遵循这些步骤也有失败的可能，比如有些无线网卡天生就不支持当热点。我还遇到过一个问题，就是在第4步时手机一直连不上，**抓包看到它发了很多DHCP请求给台式机，但是没有得到回复**，如图10所示。
图10
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091815838.png)

为了节省时间，我没有去研究解决DHCP的问题，而是在手机上人工配置了IP。如果你比我还懒，甚至可以连1、2、3步都不做，Google一下“无线网卡+WiFi热点”，找一些软件来自动完成这些步骤。不过这样做可能遇到流氓软件，安全性不能保证。

这次网络改造非常值得，因为从此家里每个手机的网络包都可以用Wireshark抓到了，使我更有动力去研究手机网络。比如我想知道手机开机后的第一个网络动作是什么，抓个包就一目了然。从图11可见，**它先通过DNS查询NTP服务器的IP地址，然后就发NTP包去同步时间了**。这就是为什么手机时间用不着调整，但是走得比江诗丹顿还准。至于本文开头提到的那个耗流量App，原来是因为它不停地刷某个网页，估计是中了木马，被我删掉了。
图11
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091815297.png)

### 微博为什么会卡
不知道为什么，我的微博有时候会很卡，比如刷新时会一直Loading（见图1）。这不只是我的个人感受，很多网友都抱怨过。而装在同一个手机上的微信，连的也是同一个WiFi，却没有这个症状。虽然这个问题出现的并不频繁，但假如我是微博的开发人员，肯定要把原因找出来。

当我的手机抓包环境搭好时，第一个想解决的问题就是这个。我随意发了一条微博，虽然没有碰到卡顿，但还是把包抓下来了。开头几个网络包如图2所示。
图2
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091817898.png)

我又发了一条测试私信，可惜也没有卡顿。开头几个网络包如图3所示。图3虽然两次都没有重现问题，但是从网络包可见，**微博的工作方式严重依赖DNS。它在调用任何功能之前都要先向DNS服务器查询，得到提供该功能的服务器IP，然后再建立TCP连接**。最神奇的是**它不会缓存查询结果，所以需要频繁地重复查询DNS**。我才抓了两分钟包，竟然就看到了上百个查询，这会不会就是微博卡顿的原因呢？我又抓了一个发微信的包作对比，如图4所示。
图4
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091817124.png)

果然，微信客户端直接就和一个IP地址建立了连接。不管这个IP是写在配置文件中的，还是之前就存在手机的缓存里的，这至少说明了**微信不像微博那样依赖DNS**。

为了进一步验证这个猜测，我故意把手机上的DNS服务器配成一个不存在的地址。不出所料，微信还是能照常工作，但微博就再也刷不出来了。之前我手机上配的DNS服务器位于美国，可能有时候跨国连接不稳定，所以导致了微博的卡顿现象。考虑到这一点，我尝试配了一个国内的DNS（见图5），果然从此再也没卡过了，刷起来异常流畅。
图5
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091818303.png)

当你看到这篇文章的时候，也许这个问题已经被新浪解决了，因为我已经向微博的技术人员反馈过（或者他们早已经知道）。相信解决起来也不复杂，只要像微信一样缓存IP就可以了。据我所知，苹果的AppStore和小米电视也遭遇过DNS导致的性能问题，所以**相信还有很多设备或者程序可以利用Wireshark来优化，只要把使用过程的包都抓下来，说不定就能发现值得改进的地方**。

最后再补充一个小发现。我发的微博内容是“capture test, will delete it soon.”，分享范围设成“仅自己可见”。没想到在Wireshark上直接就看到了明文（见图6底部），发私信就没有这个问题。因此我们连公共WiFi发微博的时候，还是要小心一点。不要以为设成“分组可见”或者“仅自己可见”就够私密了，其实在Wireshark上都能看到。
图6
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091819040.png)

### 寻找HttpDNS
这几年互联网行业有多火？假如有块陨石掉进创业园区，说不定能砸到两位互联网架构师；要是没学会几句互联网黑话，你都不好意思说自己是搞IT的。不久前就有位架构师在技术群里讨论鹅厂（黑话，即腾讯公司）的Http DNS，令我自惭形秽，因为这个词我从来没有听说过。

为了掩饰自己的孤陋寡闻，我悄悄做了点功课，发现这技术还挺有趣的。而要学习它，就得**从最传统的DNS开始说起**。我们都知道上网的时候需要先把域名解析成IP地址，比如我在浏览器中输入www.qq.com再按回车，就会通过DNS查询到该域名所对应的IP，然后再与之建立连接。

但是很多人并不知道，DNS的解析结果是很智能的。对于同一个域名，上海电信的用户一般会解析到属于上海电信的IP地址；北京联通的用户一般会解析到属于北京联通的IP地址。请看下面两个关于www.qq.com的不同解析结果。上海电信用户解析到了101.226.129.158（见图1）。经查证，该IP属于上海电信[1]。
图1
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091821210.png)
北京联通用户解析到了61.135.157.156（见图2）。经查证，该IP属于北京联通。
图2
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091821693.png)
这个智能技术是怎样实现的呢？原来**DNS支持GSLB（Global Server Load Balance，全局负载均衡），能根据DNS请求所包含的源地址返回最佳结果，从而匹配同地区、同运营商的IP，使用户体验到最好的性能**。图3演示了这个解析过程。
图3
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091822188.png)

不过这个机制并非完美，比如当用户自己配错DNS服务器的时候就可能出问题。**图3的腾讯GSLB服务器其实并不是通过用户的地址来判断该返回什么IP的，而是根据DNS服务器的地址来判断的**。假如上海电信用户偏偏要配一个北京联通的DNS地址，那它发送DNS查询时，就是由北京联通转给GSLB的，因此会解析到属于北京联通的IP地址。由于中国的跨运营商网络一向是瓶颈，所以用户体验会很糟糕。还有些用户配的是在美国的DNS服务器8.8.8.8，那就可能解析到一个位于美国的IP地址（启用了谷歌扩展协议的客户端除外），网速就更差了。根据公众号“鹅厂网事”的说法，他们遭遇的GSLB问题还有很多，比如劫持什么的，本文就不一一列举了。

那鹅厂的解决方式是什么呢？就是本文开头提到的HttpDNS。**它允许手机上的App直接查询腾讯自家的HttpDNS服务器，因此能根据用户的地址来判断应该返回什么IP，从而跳过传统DNS的影响**。换句话说，就是腾讯觉得用传统DNS不靠谱，所以自己做了一套解析方式，只不过**这套方式是走HTTP协议的**，图4演示了这个过程。
图4
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091823506.png)

从原理上看，HttpDNS是科学的，不过得多花些钱去部署。根据“鹅厂网事”的宣传，似乎在内部已经推广了：“HttpDNS已在腾讯内部接入了多个业务，覆盖数亿用户，并已持续稳定运行超过一年时间。而接入了HttpDNS的业务在用户访问体验方面都有了非常大的提升……国内最大的publicDNS服务商114DNS在受到腾讯DNS的启发下，也推出了HttpDNS服务……”

这个宣传听上去非常吸引人。去年发生过一次全国性的DNS瘫痪，当时鹅厂的几个应用（比如QQ和微信）都能正常使用，似乎就是一个有力的佐证。连鹅厂的竞争对手似乎也加入了宣传，比如淘宝的官方微博发过一条消息，称“手机淘宝使用专为移动设计的方案”不会受到DNS瘫痪的影响。当时也有圈内牛人出来解释，说这意味着手淘也开始用上HttpDNS了。总而言之，如果你对技术圈的八卦消息感兴趣，一定会觉得HttpDNS已经快颠覆DNS了。

事实真的如此吗？我一直有些怀疑，理由如下。
- **电脑上很多应用程序也依赖DNS解析，而且在电脑上很容易配错DNS服务器，理论上出问题的概率更大，为什么就不部署HttpDNS**？
- 而手机上的DNS地址一般是运营商自动分配的，出问题的概率小，为什么反而要部署？
- 即便运营商分配的DNS有问题，那也可以通过行政手段来解决，何必要为此大动干戈呢？
- 国外的互联网公司也会遇到这类问题，为什么它们就没有采用HttpDNS？
- **传统DNS基于UDP查询的速度很快，而HttpDNS肯定是基于TCP的，那还会浪费3次握手和4次挥手的时间**。
- **HttpDNS如果不加密，那也很容易被劫持；如果加密了，解析效率又会大受影响**。总之有太多难以解释的疑问了，我越琢磨就越想看看HttpDNS的庐山真面目。

为了解开这个谜题，我在搭好手机抓包环境之后，就设计了一系列实验来寻找这个传说中的新技术。
#### 实验1
1．启动Wireshark抓包。2．登录手机淘宝。3．停止抓包并分析。
Wireshark截屏见图5。这个结果令我大失所望，原来手淘老老实实地用传统DNS查询到了服务器d.taobaocdn.com的IP地址，然后就三次握手了。也就是说，它并没有用到HttpDNS。
图5
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091825313.png)

那淘宝官方微博宣称的“专为移动设计的方案”是什么呢？我又做了个实验。
#### 实验2
1．登录手机淘宝。2．然后故意把手机上的DNS服务器改错，发现手淘还能用。3．退出手淘，再次登录，就再也登不上去了。

可见这所谓的方案只不过是在登录之后缓存IP而已，并不是用HttpDNS取代DNS。既然手淘不行，我决定在手机上装个鹅厂的QQ试试。这一次我故意从一开始就配错DNS。
#### 实验3
1．在手机上配个无效的DNS，然后开始Wireshark抓包。2．登录手机QQ。3．停止抓包并分析。
Wireshark截图如图6所示。手机发了几个传统的DNS查询都没有得到响应，然后竟然就和IP地址113.108.90.53三次握手了。这个IP从何而来？应该就是来自Http DNS了吧？**然而在Wireshark中用尽各种Filter和Find都找不到相应的包**。难不成这个IP是安装QQ时就存在配置文件中的？我从IP库中查到它位于1500公里外的深圳市，应该不会是高度智能的HttpDNS解析出来的。
图6
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091826206.png)

三个实验结果都和预想的不同，真令人心情复杂，难道技术圈的传闻并不可靠？反正时间都花了这么多了，我索性再做一个实验，彻底搞清楚QQ的工作方式。
#### 实验4
1．在手机上配一个正确的DNS，然后开始Wireshark抓包。2．登录手机QQ。3．停止抓包再分析。

截图如图7所示。QQ老老实实地用传统DNS查到IP，然后就三次握手了。可见它首选的就是传统DNS，只有当DNS查询失败，它才直接用（可能存在配置文件里的）IP来登录，根本没有用到HttpDNS。
图7
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091827696.png)
一系列实验做下来，我竟然没有找到传说中的HttpDNS。鹅厂宣传的“多个业务”究竟指的是哪些，我也不得而知。不过既然连QQ和手淘都没在用，我怀疑世界上本来就没多少知名App在用它。即便有，我也没有动力再去寻找了。当然做了这些实验也不是一无所获，至少理清楚了几个知名App在域名解析上的行为差异。
- 新浪微博：一旦出现DNS问题就不能用，无论是否已经登录，因为它不缓存IP。详细实验过程请看前一篇。
- 手机淘宝：一旦出现DNS问题就无法登录，但是登录后再出DNS问题就不怕了，因为它有缓存IP。
- 手机QQ：出现DNS问题时也能用，因为它可以直接用（可能存在配置文件里的）IP，因此受DNS瘫痪的影响最小。

注意：我只是描述了当前观察到的现象，并不是说某个App比其他的更先进。而且互联网界变化很快，说不定等你看到这篇文章时，这些App的行为又有所不同，甚至真的用上Http DNS了，到时候抓包才知道。这件事也促使我重新审视技术圈的信息传播

。有段子说，“美国研究机构发现，人们很容易对‘美国研究机构发现’开头的报道信以为真。”同样地，当IT大厂慷慨地分享一项技术时，当圈内大牛热情地跟着传播时，我们就会本能地觉得高大上起来。而真实情况如何，却只有自己做实验才知道。小马过河，方知深浅。[1]

有很多网站可以查询IP地址的地理位置，本文采用的信息源是www.ipip.net。

### 谁动了我的网络
作为中国网民，**我们享有学习网络知识的天然优势**，这是很多老外一辈子都不敢奢望的。还记得刚学会上网的时候，某知名搜索网站突然就连不上了，有位学长说这是域名被封，直接连IP就可以了，还帮我修改了hosts文件。**于是我沿着这个方向研究，很快就理解了DNS协议**。在实践中学到的本领，比捧着课本背诵的不知道高到哪里去。

**又过了一阵，竟然连IP都连不上了。我在探索过程中，又学会了HTTP代理和VPN等科学上网技术**。就这样，十几年下来身经百战，不知不觉中掌握了**很多网络技术**，每天都能到外网和同行们谈笑风生。现在回忆起来，**我的知识真没多少是刻意去学的**，而是在和网络问题斗争时被动学会的。被虐久了还得了斯德哥尔摩综合症，去年到国外出差了一个月，便觉得食不知味，因为根本找不到学习的机会。回到国内赶紧打开浏览器，Duang立即弹出运营商推送的广告。还是那个熟悉的味道，回家的温馨顿时涌上心头。

本文要讲述的也是一个颇有中国特色的网络技术，其实很多人都遇到过，但没有去深究。最早向我反馈的是一位细心的网友，他在打开www.17g.com这个游戏网站时，有一定概率会加载出其他网站的游戏，比如xunlei的。他觉得很好奇，便采取了一些措施来排查。
1. 一开始怀疑是电脑中毒，于是在同网络下的其他电脑上测试，症状还是一样。
2. 其他地区的网友（包括我）打开这个网站时没有发现相同问题。
3. 他怀疑是当地运营商（哪家运营商我就不说了）搞的鬼，于是换了个宽带，果然就没问题了。

这位网友很生气，想知道运营商究竟对他的网络做了什么手脚，所以抓了个出问题时的包来找我。我刚开始以为很简单，肯定是**运营商的DNS劫持，即故意在收到DNS查询时回应一个假的IP地址**，从而**导致客户端加载错误的广告页面**。于是我打开网络包，用dns作了过滤，发现www.17g.com被解析到了IP地址123.125.29.243（它还有一个别名叫w3.dpool.sina.com.cn，见图1）。可是经过进一步测试验证，发现这个IP地址竟然是对的，并没有被劫持。
图1
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091829709.png)

既然不是DNS劫持，那又是什么原因导致的呢？可惜这位网友抓包的时候电脑上开了太多应用，所以干扰包很多，无法采用暴力方式来分析（就是指不过滤，用肉眼把所有包都一一看过的分析方式）。如果用“ip.addreq123.125.29.243”过滤则得到图2的结果，似乎平淡无奇，只是显示有些包乱序了，但不知道这意味着什么。后来我才知道这就是线索之一，具体原因后面会讲到。
图2
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091829938.png)

由于这是**我第一次分析劫持包**，所以不得要领，当晚分析到凌晨都没有弄明白。第二天早上只好到技术群求援了，一位在运营商工作的朋友给我科普了HTTP劫持的几种方式。其中有一种引起了我的注意，其大概工作方式如图3所示，实线箭头表示正常的网络包，虚线箭头表示运营商做的手脚。
图3
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091830475.png)

注意：这只是简单的示意图，不完全等同于真实过程。
- 在正常情况下，用户发出的HTTP请求（即图中的①）经过层层路由才能到达真实的Web服务器，然后真实的HTTP响应（即图中的③）又经过层层路由才能回到用户端。
- 而在做了手脚的网络中，**运营商可以在路由器上复制HTTP请求，再交给假的Web服务器**。然后**赶在真实的HTTP响应之前，把假的HTTP响应（即图中的②）送达用户**。==这个抢先应答会导致用户在收到真实的HTTP响应时，以为是无效包而丢弃==。

根据这个工作原理，我们能否推测出假的HTTP响应有什么特征呢？如果能，那就能据此过滤出关键包了。我首先考虑到的是**网络层的特征**：因为假Web服务器是**抢先应答的**，所以它发出的包到达用户时，TTL（Time to Live）可能和真实的包不一样。那要怎么知道真实的TTL应该是多少呢？==考虑到3次握手发生在HTTP劫持之前，所以我们可以假定参与3次握手的那台服务器是真的==，从图4可见其TTL为54。
图4
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091832027.png)

接下来就要动手过滤出假的包了。根据其源地址同样为123.125.29.243，但TTL不等于54的特征，我用 `(ip.src eq 123.125.29.243)&& !(ip.ttl==54)` 过滤，得到图5的两个包，即8号包和9号包。看看右下角显示了什么信息？这不正是我要寻找的假页面
图5
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091832161.png)

这个发现令我信心大增，有种拨云见日的感觉。再往下看几个包，果然发现了和jump.niu.xunlei.com的新连接。接着这个连接又把页面跳转到了“http://niu.xunlei.com/actives/welcome1426……”上（见图6）。跳来跳去地非常难以追寻。
图6
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091833434.png)

再后面的包就没必要分析了，以上证据已经足以向工信部投诉。据说投诉后运营商解决起问题来还挺爽快的，百度曾经上诉某运营商的劫持案件也获赔了。商场上的黑暗故事，就不在本书里展开讨论了，我们还是继续关注技术问题吧。

在这个案例中，**万一真假网络包的TTL恰好一样，还有什么办法可以找出假的包吗**？仔细想想还是有的。**比如服务器每发送一个包，就会对其网络层的Identification作加1递增**。由于4号包的Identification为4078（见图7），那它的下一个包，也就是8号包的Identification就大概是4079了（或者略大一些）。可是从图8可见，它的Identification一下子跳到了55872，这也是一个被劫持的明显的特征。

![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091834457.png)

那万一运营商技术高超，把TTL和Identification都给对上号了，我们还有什么特征可以找吗？还是有的！**刚刚介绍的两个特征都在网络层**，接下来我们可以到TCP层找找。在图5可以看到8号和9号这两个假冒的包都声明了“win=2102400”，表示服务器的接收窗口是2102400字节。对比一下其他网络包，你会发现这个数字大得出奇。为什么会这样呢？**这是因为真正的Web服务器在和客户端建立3次握手时，约好了它所声明的接收窗口要乘以128（见图9）才是真正的窗口大小**。假的那台服务器不知道这个约定，所以直接把真正的窗口值（win=16425）发出来，被这么一乘就变成了16425×128=2102400字节，大得夸张。
图9
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091835947.png)

这个特征在本案例中非常明显，但不是每个TCP连接被劫持后都会表现出来的。假如3次握手时没有声明图9所示的Window Scale值，那就无此特征了。

其实我在一开始还提到了另一个现象，即**图2中Wireshark提示的［TCP Previous segment not captured］和［TCP Out-of-Order］，意味着存在乱序**。为什么会有这些提示呢？这是因为假服务器伪造的包抢先到达，增加了Seq号，因此**等到真服务器发出的包到达时，Seq号已经对不上了**。Wireshark还没有智能到能判断真假包的程度，**只能根据Seq号的大小提示乱序了**。

总而言之，在理解了劫持原理之后，我们便能推理出假包的特征，然后再根据这些特征过滤出关键包。**但不是所有特征都能在每次劫持中体现出来的**，比如接收窗口的大小就很可能是正常的，所以一定要逐层认真分析。**这还只是众多劫持方式中的一种**，如果采用了其他方式，那么在包里看到的现象又会有所不同。等我下次遇到了，再写一篇跟大家分享。
### 一个协议的进化
互联网行业日新月异，几年前估计连马云都预想不到今天的网络规模。从打车、订餐、抢购手机到付款理财，几乎无孔不入。与之不相称的是，互联网所依赖的基础协议——HTTP却一直没有更新。知道现在最通用的HTTP1.1是什么时候出现的吗？20世纪末！

那是什么使得HTTP1.1青春永驻呢？是因为它的设计特别有前瞻性吗？可惜答案是否定的。**当今网络的两个特征，导致HTTP1.1已经成为性能瓶颈**[2]

现在网络的带宽比20世纪大得多，家庭带宽普遍在10兆以上，有些运营商甚至提供200兆的家庭套餐。每个页面的内容远比20世纪的丰富，比如包含了更多小图片。类似www.qq.com这样还不算炫目的网站，**光打开首页就能触发一百多个GET请求，但每个GET的数据量都不大**。这两个特征和HTTP1.1有什么冲突呢？

我们先从一个简单的例子开始说起。图1显示的是一个典型的网页打开过程，客户端只和服务器建立了一个TCP连接，然后从服务器上依次GET了三个资源，每个的数据量都很小，3个包就能完成，即1-3，4-6，7-9。
图1
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091844653.png)

从这个包里面可以看出不少问题。
1. 客户端不是多个GET请求一起发出的，而是先发出一个请求，等收到响应之后才发出下一个请求。这样假如前一个操作发生了丢包，就会直接影响到后续的操作，成为“线头阻塞”（Head of Line［HOL］Blocking）。
2. **即使没有丢包，每个GET至少也要耗费一个RTT（往返时间）**。因此采用这种非并发的方式时，上百个GET所耗费的时间总量就非常可观。
3. **这种工作方式导致同时发出的包数太少，所以TCP窗口再大也派不上用场。这就相当于带宽被浪费了**，家里办个200M带宽和10M带宽的上网体验差不多。想象一下六车道马路上总共跑着3辆车，你就能理解这种浪费了。
4. 还有一个副作用，就是**包数太少会凑不起触发快速重传所必需的3个DupAck**，因此一丢包就只能等待超时重传，效率大打折扣。

图1演示的还只是明文传输的情况，如果要加密传输还会出现更严重的延迟。图2是一个HTTP1.1加密传输过程，由于HTTP协议本身是明文传输的，所以用到了TLS来加密。
图2（发现前三次握手Win变化了）
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091850472.png)

这个过程可以分解成下面三步。
1. 前3个包是三次握手过程，完成时刻是0.0886秒。
2. 接下来的4～19号包是TLS握手过程，完成时刻是0.5206秒。
3. 20～22号包是真正的HTTP传输过程，完成时刻是0.7345秒。

不难看出，真正传输有效数据的是第三步，而它所耗费的时间在整个连接中的比例却并不高，大多时间是被前两步用掉了。**最近有人在倡导所有网站都加密，恐怕没有意识到这样做会给网速带来多少影响**。

既然单个连接不能并行发送HTTP请求，那能不能同时建立很多个连接呢？也不可以的，定义了HTTP 1.1的RFC2616明确把最大连接数限制为2个，原文如下：Clients that use persistent connections SHOULD limit the number of simultaneous connections that they maintain to a given server. A single-user client SHOULDNOT maintain more than 2 connections with any server.（使用长连接的客户端应当限制和某一台服务器的同时连接数。单用户客户端不能和任意一台服务器同时保持两个以上的连接。）

综合以上分析，我们可以得到一个结论，**即HTTP协议所导致的网络延迟才是影响上网体验的主要因素，而不是带宽**。那有没有改进的办法呢？的确有一些优化措施，比如大多数网站会**让客户端与多台服务器建立并发的TCP连接**。图3是我在打开国外某购物网站时的HTTP包，看上去似乎高效了很多，至少可以向多台服务器并行发送GET了。不过这个方案也不完美，**因为每个新建的TCP连接都会处于慢启动状态中，传输效率很低**。而**过了慢启动阶段，速度终于变快了，数据却已经传完了**。再说也不是每个网站都愿意承担多台服务器的成本。
图3
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091855827.png)

还有一个优化技术叫Pipelining，可惜它也受到一些限制，比如代理服务器不支持等。那有没有办法可以彻底地解决这些问题呢？我脑洞大开地想象一下，也许符合以下需求的协议才可以：
- 它不需要三次握手和加密握手，能够节省多个往返时间；
- 它没有慢启动过程，所以不会一开始就传得很慢；
- 它能并行发送请求和响应，即支持“多路复用”（Multiplexing）。

也就是说，当前的一个HTTP连接和理想中的差距大概如图4所示。同样是3个操作，理想中的模型处理起来会快得多。
图4
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091856147.png)

要完美实现这些需求，恐怕现有的HTTP和TCP机制都要被抛弃，得重新设计一套全新的协议才行。这在技术上也不是没有可能，说不定Google和Microsoft之类的公司就有这样的实力，但是在商业上完全不可行——在当前如此庞大的网络规模面前，谁也没有实力去推动所有网站、运营商和客户端做出改变。不要说TCP了，就连HTTP层的升级都会遇到不少阻力，因此只能采用向下兼容、逐步改进的办法。

近几年就有一些业内先锋尝试了不同的解决方案。其中最出色的是Google推出的SPDY协议，**它只是在HTTP和TCP之间增加了一层，从而支持多路复用等功能（即在一个TCP连接里并行处理多个HTTP请求）**，很容易得到现有网站和客户端的支持。**目前几乎所有主流浏览器都支持SPDY**，比如在Chrome上可以通过“chrome://flags”启用它，如图5底部所示。国外的主流网站也都支持SPDY，比如Facebook、Wordpress、YouTube和Twitter等，可惜这些网站我们都没有条件测试。SPDY的多路复用解决了本文开头提到的不少问题，比如带宽施展不开、丢包时难以触发快速重传等。经过几年的实验，SPDY终于在2015年“进化”到HTTP2.0。
图5
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091857983.png)

现在（2015年5月份）HTTP2.0的RFC还没有出来。不过在其草稿中，已经明确表示“An HTTP/2.0 connection is an application level protocol running on top of a TCP connection”。**只要它还是基于TCP的，就还有改进的空间，因为TCP三次握手和慢启动的负面影响仍然存在**。怎么改进呢？如果你观察足够仔细，还会在图5中看到一个“实验性QUIC协议”，它或许会在以后实现真正的零延迟通信，而且是用在HTTP上。

QUIC是Quick UDP Internet Connections的简称，旨在消除网页应用的延迟。由于**它本质上是UDP，所以不需要握手也没有慢启动过程，技术上的确有优势**。目前只有Google的网站支持QUIC，因为某些原因，中国技术人员还没有条件抓包来学习（用VPN也不行）。我委托一位印度同行抓了一个很简单的包，从图6的Seq号大致可以看到它是并发传输的。
图6
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091858090.png)

目前QUIC还没有流行开来，但Google已经发布了不少文档。说来有趣，我下载该文档时，发现其推荐语是“如果你需要一些材料来帮助睡眠，可以看看这些文档。”让人哭笑不得。打开来的第一句话又是“我为这篇文章的长度而抱歉，如果我有足够多的时间，一定会把它写得短一点。”再次被作者逗乐了，浏览了一下发现篇幅果然很长。还是等QUIC哪天真正流行了，再单独为它写一篇吧。

[2]本文所说的性能，指的是浏览网页或者刷微博之类的小流量场景，不包括下载电影这样的大流量场景。
### 假装产品经理
由于我最近经常评论手机App的设计细节，所以被一位新认识的网友问，“你是产品经理吧？连这个都知道。”被误认为产品经理可不算好事，因为很多“程序猿”眼中的“产品狗”就是技术渣渣（虽然我不是这样认为的，各有所长嘛）。

不过这一问倒是提醒了我，互联网行业的产品经理们也可以学学Wireshark的。如果需要研究对手的产品，用不着派间谍去偷文档，抓个包仔细分析就能得到不少信息，《寻找HttpDNS》中提到的IP缓存便是极好的例子。如果只是想改进自己的产品，抓个包看看可能也有意外收获。

就像Windows上自带的FTP客户端有个存在多年的bug，测试时很难发现，但用Wireshark一打开就一目了然，详情可见我上一本书中的《一个古老的协议——FTP》。今天我就假装一下产品经理，**用Wireshark分析一下微博APP是怎样上传和下载图片的**，这对一个社交App来说至关重要。

实验过程很简单，启动抓包后执行以下步骤。
1. 新建微博并选择一张3.9MB左右的图片，然后点“下一步”。
2. 随便输入些字符后点击发送按钮。
3. 点击这条已发微博的小图，从而打开大图。
4. 在大图上点击“原图”，然后停止抓包。

**每做完一个步骤都从电脑上ping一次手机的IP作为分隔标记，这是一个良好的习惯，有助于分析过程中区分每一步**。接下来开始分析，先用“http || icmp”过滤一下抓到的网络包，实验过程的每个步骤就都显示出来了。从图1可见，**四次ping的标记都赫然在目（Protocol栏显示为ICMP），因此很容易判断哪些包对应着哪个步骤**。我把上传和下载图片相关的HTTP请求都用方框标记出来，这样更加一目了然。
图1
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091900630.png)

接下来再看看每一步都发生了什么。在第一次ping之前，我的操作是在微博上选择手机里一张3.9MB的图片，然后点击“下一步”。本以为这个操作只发生在手机本身，所以不会有网络流量产生。没想到微博App在这一步就已经上传图片了，从图1可见**它用了两个POST来上传**（274和416两个包）。如果点开网络包的话，还可以从详情中看到总共传输了320KB。这一步至少透露出微博的产品经理作了如下考量。

**图片被选定之后就开始上传，而不是等到用户点击发送按钮之后。这样可以让用户感觉更流畅，好像点一下按钮就瞬间传完了**。当然提前上传也有负面作用：假如用户选定了多张图片并点击“下一步”，但是在发送前又改变主意了，于是点了“取消”，这样用户以为自己没有发过任何图片，**但其实多张图片的流量都浪费了**。3.9MB的图片只用了320KB的流量，说明**微博APP在上传图片之前会先大幅度压缩**，这就是为什么美女们好不容易PS完照片发出去，看到的效果却很糟糕。用网页版上传就不会压缩得这么严重，这也许是因为产品经理考虑到手机用户是**按流量计费**的，而网页版用户一般都用**包月宽带**。

接着往下看。在第二次ping之前，我的操作是**点击发送按钮**，所以看到两个POST（包号493和500）是情理之中的。只有526号包“GET/webp360/70398db5jw1epzpi0g292j20xc18gdo8.jpg”比较令人疑惑，为什么点发送的时候还会有GET图片的操作？其实这时已经发送完毕，开始下载小图并显示出来了。如果你观察足够仔细，会发现图片被上传到了unistore.weibo.cn（见274、416等包），而下载时却是走alikunlun（见526等包）。放Google一搜，原来阿里昆仑是阿里云CDN的内部名字。好吧，本来只是想分析一下产品设计，没想到连商业上的信息也不小心看到了，**新浪一定是把微博的CDN委托给阿里云了**。

插播一个读者疑问，为什么在这本书的截图中，Wireshark会把IP地址显示成域名呢？其实只要勾上View→Name Resolution→Enable for Network Layer就行了，步骤如图2所示。
图2
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091904758.png)

接下来再看看第三次ping之前的那个操作，即点开微博大图时的包。如图3所示，客户端通过GET下载了一张图片，“Content-Length:155971”说明下载的所谓大图比上传时的还小，只剩下156KB左右了，又压缩掉一半。这APP真会给用户省流量。
图3
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091904264.png)

微博大图上还有个“原图”按钮，我一点击又产生了图4的流量，这次下载的图是320KB左右。可见微博认为的原图是APP上传前压缩过的那个，比起真正的原图（3.9MB）还是小很多。
图4
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091905436.png)

在图片处理这一点上，本山寨产品狗只能看出这么多了。正牌的产品经理如果有心去钻研，相信还能找出更多来。要是想知道微博的其他底层细节，比如负载均衡或者文本加密等，也完全可以设计一些实验，然后抓包来研究。我个人的下一个研究对象则是某款流行的手机游戏，相信和社交应用会大有不同。