很多年来，IT公司的笔试试卷中都有这样一道送分题——列举TCP和UDP的差别。我遇到过的应聘者或多或少都能答出重点，比如TCP是可靠的，UDP是不可靠的等等，有些甚至能把教材中的段落原封不动地写出来。不过我最近开始怀疑这道笔试题的价值，因为很多人似乎是死记硬背的，完全不理解答案的真正含义。就算有部分人说得出个所以然，也不知道如何运用。

本文要分享的案例，就是关于TCP和UDP的差别。故事的背景是这样的：某公司的主数据中心设在上海，通过网络把数据同步到北京的镜像，每10分钟同步一次。项目实施时规划得很好，租用的带宽经过严密计算所以理论上完全满足需求，也用FTP传输验证过了。可是不知道为什么，实施后却无法在10分钟内完成数据同步。实施团队驻场数天都没有解决，只能怀疑租用的宽带质量有问题，于是就和网络提供商陷入了无休止的扯皮。到最后实在走投无路了，项目组决定抓一个网络包来分析，便找到了我。

我拿到包之后尝试了惯用的三板斧，可惜没有发现任何异常，于是只能检查其他方面的信息了。
1. 点击Wireshark的Statistics菜单，再点击Conversations，见图1。
    图1
    ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307081610776.png)
2. 从TCP标签可见传输的数据量（Bytes）极少，见图2。
    图2
    ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307081611188.png)
3. 再看UDP标签，发现传输的数据量（Bytes）明显大得多，见图3。
    ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307081611361.png)
4. 图3以上的初步分析表明数据是通过UDP传输的，而根据UDP在广域网中一贯的不靠谱表现（并不是说UDP这个协议本身不靠谱，而是很多基于UDP的应用程序没有做好性能优化），我认为这一点需要着重研究。于是我又粗略看了一下Wireshark的主窗口，果然发现很多图4这样的报错。
    图4
    ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307081612892.png)
    这个报错很常见，在1981年公布的RFC792就有介绍了：当接收方因为分片丢失而无法按时完成数据包的重组时，它可以放弃并回复一个超时消息。
    ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307081613019.png)
    也就是说，从上海发往北京的UDP数据包被分片传输了。但由于有些分片在路上丢失，导致北京一方无法完成重组，所以就出现了图4中的报错，过程如图5所示。
    图5
    ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307081918504.png)
    从中可见**一个分片的丢失，会导致所有分片都被重传一遍，效率极低**。这个例子说明了**UDP不能把大块数据先进行分段，所以很容易被网络层分片**；也说明了==UDP是不可靠的，它缺乏一个机制来确保数据被安全送达，所以只能由应用层来负责重传==。
    
找到了根本原因，解决起来就好办了。在研发人员能够优化UDP传输之前（技术上也是可以做到的），我建议把传输层换成TCP，这样理论上能大幅度提高性能。
    
理由如下。
1. **TCP有拥塞控制机制，能够降低网络拥塞时丢包的概率**。这一点细说起来太复杂，有兴趣的读者可参考我的上一本书的70～79页，本文就不赘述了。
2. **即便在丢包概率一样的情况下TCP也有优势**，TCP的分段机制可以把数据拆小后封装在多个包里，**避免了被网络层分片**。**重传TCP包的效率可比重传分片高多了**。比如同样大小的数据块分成6个TCP包传输，同样只丢失了最后一个，重传过程如图6所示。
    图6
    ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307081941185.png)
    可见TCP只需要重传丢失的那一个包，而不是所有包，所以**效率比重传分片高多了**。==在传输过程中应用层也不用负责重传事宜，因为TCP是可靠的，能确保数据被安全送达==。本文的例子中只用了6个包，所以对比还不够明显。假如一块数据要切成50个包来传，那TCP的优势就更能体现出来了。

项目组按照我的建议改成TCP之后，性能果然就上去了。因此这个问题本质上就这么简单，每一个过得了笔试的人本应该都会的。**从课本知识到实际应用之间，只差一个Wireshark来牵线搭桥**。

当然了，千万不要因为这个案例就否定UDP的价值，还记得我上本书提到DNS查询的例子吗？**UDP在那种场合就是领先的**。即使在本文的场景中，只要研发团队给力，用UDP也可以实现很好的性能。争论TCP和UDP哪个更好，就像百度贴吧每天在吵狮子和老虎谁更厉害一样无聊。它们俩都是其领域之王，只不过一个适合在草原，另一个适合在森林而已。
