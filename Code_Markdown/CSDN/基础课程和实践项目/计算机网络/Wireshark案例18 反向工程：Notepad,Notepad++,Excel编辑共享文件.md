
治疗强迫症
即使是轻度的强迫症都非常痛苦，经常遭受到各种细节的折磨，尤其是我这种连技术领域都逃不过的患者。举个简单的例子，十多年前我第一次编辑网络共享文件时就很焦虑，担心其他人也同时在编辑该文件，保存时会发生冲突。这种担忧挥之不去，以至于每次都要把共享文件移到本地硬盘，等编辑好了再移回去。

人们处理焦虑的方式各有不同，有些人喝喝咖啡晒晒太阳就觉得岁月静好了。可惜我就做不到这一点，一定要把细节都理清楚才能治愈，多年下来竟然也“被迫”学了不少知识。比如前面提到的共享文件的保存，如果用Wireshark探究一下，会发现满满都是技术含量，**设计良好的软件能完全避免我所担心的意外**。如果你需要开发一个处理文件的软件，也可以参（shān）考（zhài）这些设计。本文就通过几个简单的实验，分析一下Notepad、Notepad++和MicrosoftExcel在保存文件时的不同表现。
### Notepad实验
1．让小明和小红分别在自己的电脑上用Notepad打开同一个共享文件\\10.32.106.84\nas_share\Home\test\abc.txt。
2．小明写上一句“我是小明”并保存，然后小红写上一句“我是小红”并保存。
3．两人都关掉文件之后再打开，发现只有小红写的那句话保存下来了。
从实验结果可见，Notepad完全没有保护机制，所以虽然两个人都保存成功，但小明保存的内容被小红保存的覆盖了。这种事情遇到一次就会给强迫症患者留下一辈子的阴影。
### Notepad++
实验1．让小明和小红分别在自己的电脑上用Notepad++打开同一个共享文件\\10.32.106.84\nas_share\Home\test\abc.txt。
2．小明写上一句“我是小明”并保存，这时候小红的NotePad++弹出图1所示的提示。
图1
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091723412.png)
3．小红点击Yes加载了小明编辑过的内容，再写上一句“我是小红”并保存。4．两人都关掉文件之后再打开，发现两句话都被保存下来了。

从实验结果可见，Notepad++有不错的保护机制，所以不会导致数据丢失。**那它是怎样实现这个机制的呢**？用Wireshark看看就知道了。我在小红的电脑上启动抓包，发现当小明点击保存时，文件服务器给小红的电脑发了一个Notify Response，即通知她文件abc.txt被改动了（见图2右下角）。Notepad++收到这个Notify之后，就可以提示小红重新加载文件内容了。原理就是这么简单。
图2
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091724514.png)
### Excel实验
1．让小明在自己的电脑上用Excel打开共享文件\\10.32.106.84\nas_share\Home\test\test.xlsx并编辑。
2．让小红也打开同一个文件，结果收到了图3所示的提示，说明小明把文件锁定了，不允许其他人同时编辑。
图3
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091725642.png)

由实验结果可见，Excel的保护机制更加严密且贴心，连谁在编辑该文件都提示出来了。因此小红可以根据提示找到小明，让他赶紧编辑好然后关掉。那么问题来了，Excel是怎样做到这一切的呢？我在小红的电脑上抓了个包（见图4），发现**她在打开test.xlsx时，会尝试创建一个叫 `~$test.xlsx` 的临时文件。而因为该文件已经被其他人创建并锁定**，所以小红收到了“STATUS_SHARING_VIOLATION”的报错。接着小红读出 `~$test.xlsx` 的内容，得到了锁定者的名字（见图4右下角的xiaoming）。
图4
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091725115.png)
我在小明的电脑上也抓了包。从图5可见的确是他创建了~$test.xlsx并在里面写上了自己的名字。
图5
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091726183.png)

分析到这里，我们就知道了Excel是怎样防止共享文件被意外覆盖的，因此编辑时再也不用焦虑了。我们还可以根据这个机制设计一些办公室恶作剧。比如说，小明可以在Excel的选项窗口中把用户名改成大老板的名字（见图6底部），这样其他人打开该文件时就会以为是大老板正在编辑了，只好干等着。
图6
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091726389.png)

本文只是Wireshark在反向工程上的简单应用。如果你对这方面很感兴趣，完全可以用它来研究其他软件，有些真的可以调查到很深入的程度。

