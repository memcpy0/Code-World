@[toc]
> 参考数据通信与网络；Wireshark网络分析从入门到实践

局域网通常不是孤立运行，一般互相连接或者连接到因特网。**为了连接局域网或局域网的各个分段，我们需要使用连接设备**，连接设备能够工作在因特网模型的不同层，本章只讨论工作在**物理层和数据链路层的连接设备**，在[【计算机网络】第四部分 网络层(19) 逻辑寻址]()将讨论工作于前三层的设备。在讨论完这些连接设备之后，将说明**如何使用它们建立主干网**，最后再讨论**虚拟局域网**。

我们可以利用 eNSP 来构建虚拟的网络环境，在这个环境中包含了各种常见的网络设备——网线，集线器，交换机，路由器。对这些设备的原理进行介绍，实例中会同时使用 eNSP 和 Wireshark，通过学习，熟悉网络设备的同时也掌握这两种工具的使用。

---
# 15.0 网线
在最初的网络中并没有交换机和路由器之类的设备，计算机都是通过网线连接在一起的。仅仅依靠网线建立起一个网络看起来好像有些不可思议，网络的通信不是需要 IP 地址的吗？那么没有处理 IP 地址的设备，仅仅有网线有什么用呢？

首先来看一个实例，在这个例子中只有两台计算机，它们之间使用网线进行直连。实验的目的很简单，就是==查看在两台计算机上都不设置 IP 地址的情况下，查看两台计算机是否可以通信==。首先我们在 eNSP 中来构建一个这样的网络，步骤如下所示。
（1）在网络中添加两台 PC 机。
（2）然后使用Copper连接这两台 PC 机，并**启动**这两台设备。
（3）完成之后的网络结构如图 5-1 所示。
图 1 只使用网线连接的两台设备
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307112104578.png)

在建立网络的这个过程中，**我们没有为两台设备设置 IP 地址**。接下来，我们就来==构造一个数据包。右键单击 PC1，在弹出的菜单中选中“设置”，然后在弹出的配置选项卡中选中其中的“UDP 发包工具”==（见图 2）。
图 2 UDP 发包工具
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307112105317.png)
这个工具很实用，**它可以按照你的设计快速构造出一个UDP 数据包来**，这个数据包和真实世界的数据包是完全相同的，而且使用起来极为简单。图 3 给出了这个工具的操作界面。
图 3 UDP 发包工具操作界面
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307112105217.png)
现在，由于这两台 PC 机都没有 IP 地址，所以我们在构造数据包时，**为这个数据包的目的地址填写任意一个值均可**（**如果网络通信必须基于 IP 地址的话，那么任何数据包
应该无法到达 PC2**）。将该数据包的“目的 IP 地址”填写为“1.2.3.4”，“源 IP 地址”填写为“4.3.2.1”，目的端口号为“999”，源端口号为“999”，你可以任意填写这 4 个值，只需
要符合书写规范即可。

然后我们在 PC2 上启动 Wireshark（见图 4），以查看是否可以收到来自 PC1 所发出的这个数据包。
图 4 在 PC2 上启动 Wireshark
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307112113353.png)

返回 PC1 的“UDP 发包工具”界面，再勾选下方的“周期发送”（见图 5），然后单击发送按钮就可以将这个数据包发送出去了，在“发包个数”处可以看到已发送数据包的个数。
图 5 看到已发送数据包的个数
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307112113249.png)

切换到在 PC2 上所启动的 Wireshark，可以看到这里面已经捕获到了 PC1 所发出的数据包（见图 6）。
图 6 捕获到了 PC1 所发出的数据包
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307112115453.png)

现在回过头来，看下本节开始所提出的问题，IP 地址是网络通信所必需的吗？这其实是一种错误的观点，**网络的通信其实并非一定要基于 IP 地址，甚至是无需基于地址的**。有的读者可能注意到在本实验中出现了 MAC 地址，就是==在设置 UDP 数据包的时候，有一个“源 MAC 地址”和一个“目的 MAC 地址”选项。这两个选项对本实验是否有影响呢==？MAC地址是后面讲解七层模型定义中数据链路层的内容，不过它们的设置对于这个实验**没有任何影响**，我们来验证一下，保持 PC1 中“UDP 发包工具”的其他选项不变，然后将“源 MAC 地址”和“目的 MAC 地址”填写任意的值（见图 7），然后发送。
图 7 填写任意 MAC 地址发送
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307112120075.png)

在 PC2 上可以看到同样接收到了 PC1 中所发送的数据包，如图 8 所示。
图 8 在 PC2 上接收到的数据包
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307112122142.png)

**实际上两台设备只需要使用网线连接之后就可以完成通信，这个过程无需任何地址参与**。==整个通信是通过七层模型定义中的物理层完成的==，物理层的功能就是**利用传输介质为
数据链路层提供物理连接，实现比特流的透明传输**。在上例中，==当数据包从 PC1 的网卡出发之后，并不会关心自己去往何方，它们只会顺着网线的方向向前移动，直到到达下一个设备为止==。而**网线的作用就是将数据包从一端传输到另一端**。

# 15.1 连接设备
本节中，根据「在网络中所工作的层」把**连接设备** `connecting devices` 分成五类，如图15.1所示。
1. 工作在物理层以下的设备，如**无源集线器**。
2. 工作在物理层的设备（**中继器**或**有源集线器**）。
3. 工作在物理层和数据链路层的设备（**网桥**或**两层交换机**）。
4. 工作在物理层、数据链路层和网络层的设备（**路由器**或**三层交换机**）。
5. 工作在所有五层的设备（**网关**）。
![图15.1 五类连接设备](https://img-blog.csdnimg.cn/ab16408d5dd6437383b5abfd1af4ac46.png)

## 15.1.1 无源集线器
**无源集线器** `passive hub` 只是个**连接器** `connector` 。它连接来自不同分支的线路。在星型拓扑以太网 `star-topology Ethernet LAN` 中，无源集线器只是一个来自不同站点的信号冲突点，集线器是冲突点 `the hub is the collision point` 。==这种集线器是介质的一部分，它在因特网模型中的位置在物理层以下==。

## 15.1.2 中继器
**中继器** `repeater` 是仅工作在物理层的设备。网络（网线）内携带信息的信号在衰减到危及数据完整性之前，可以传输一段固定的距离。==中继器接收信号，并且在信号变得很弱或者被破坏之前，重新生成原始的位模式，然后中继器发送新生成的信号==。如图15.2所示，**中继器能够扩展局域网的物理长度**。

**中继器实际并不能连接两个局域网**，它连接的是**同一局域网的两个分段**。所连接的网段仍然是一个局域网的一部分。中继器不能连接采用不同协议的两个局域网。
![图15.2 连接局域网中两个网段的中继器](https://img-blog.csdnimg.cn/aaf5a1a11c564e9ca7bd03d3dfb478b3.png)
中继器可以克服 `10Base5` 以太网标准的长度限制。在这个标准下，电缆的长度限制在 $500m$ 以内。为了扩展长度，我们将电缆分割成几段，在分段间安装中继器。注意，==整个网络仍然是一个局域网，但是被中继器分割的部分称为**网段**== `segment` 。中继器作为一个两端口的节点 `The repeater acts as a two-port node` ，但**它仅工作在物理层**。当从任何一个端口接收到一帧时，它就重新生成、并转发给另一个端口，**它没有过滤能力**。

有人将中继器比做放大器，但这种比照是不准确的。==**放大器** `amplifier` 不能区分有效信号和噪声，它放大所有输入的信号==。**中继器不放大信号，它重新生成信号**。当中继器接收到微弱的或被破坏的信号时，就逐位地、以原始的信号强度生成一个拷贝。即**中继器是再生器，不是放大器**。

==中继器在链路中安装的位置是很关键的，它必须放置在信号的每个位被噪声改变之前、能够到达的位置==。小的噪声可能改变位电压的准确值，但不破坏它的可识别性（图15.3）。然而，如果被破坏的位传输的距离太远，积聚的噪声就可能完全改变它的含义。在这种情况下，原始电压就不能复原，必须纠错。在信号的可读性消失之前，放置在该处的中继器可以读出信号，足以确定原始电压，并按原始格式复制信号。
![图15.3 中继器的功能](https://img-blog.csdnimg.cn/e2e9e01d48774266ae58900cf7166ea0.png)
## 15.1.3 有源集线器
实际上，**有源集线器** `hub` 是一个多端口的中继器。它通常用于星型拓扑结构中，在站点间建立连接。我们已经见过，集线器在一些以太网配置中的应用实例（例如 `10Base-T` ）。实际上，集钱器也可以像图15 .4所示的那样**用来创建多级连接** `multiple levels of hierarchy` 。集线器的级连使用克服了 `10 Base-T` 标准的距离限制（$100m$）。
![图15 .4集线器级连](https://img-blog.csdnimg.cn/da56b00337c342b6a5997c41e9541633.png)

15.0 节中介绍的**物理层**虽然完成了两台设备的直连，但是如果现在有多台设备需要通信的话，这种方法就变得复杂起来了。试想一下，包含了 10 台设备，如果两两相连的话，那么每台设备就需要 9 个网卡，而需要的网线就更多了。

**为了节省硬件资源，网络一般都采用了中心型的结构。这种结构的特点就是将网络设备放置在中心**，然后将所有的终端设备连接到中心。集线**器（HUB）就是这样的一个网络
设备**，==它和网卡、网线等传输介质一样，也工作在“物理层”==。下面为了研究集线器的工作方式，我们在 eNSP 中按照如下的步骤建立一个网络结构。
（1）在网络中添加 3 台 PC 机。

（2）在网络中添加 1 台 HUB。添加的方法为在 eNSP 的分类中选中云，然后在下面选中，将其拖动到右侧拓扑图中。
（3）然后使用将每台 PC 机都连接到 HUB 上，并启动所有设备。
（4）完成之后的网络结构如图 5-9 所示。
图 9 使用 HUB 连接的 3 台设备
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307112128059.png)

那么接下来，我们**在 PC1 上构造数据包**，然后在 PC2 上和 PC3 上分别启动 Wireshark 来查看 HUB 对接收到数据包的处理方式。同样在这个例子中我们仍然没有为 PC1、PC2和 PC3 设置 IP 地址，具体步骤如下。
（1）打开 PC1 中的“UDP 发包工具”，更改里面的设置，将“目的 MAC 地址：”设置为“11-22-33-44-55-66”，“源 MAC 地址：”设置为“66-55-44-33-22-11”，“目的 IP 地址：”设置为“1.2.3.4”，“源 IP 地址”设置为“4.3.2.1”，“目的端口号”设置为“99”，“源端口号”设置为“88”。以上的值你可以任意设置，只需要符合书写要求即可。
（2）在 PC2 和 PC3 上都启动 Wireshark。
（3）然后在 PC1 的“UDP 发包工具”处，选中“周期发送”，然后单击“发送”按钮，如图 10 所示。
图 10 UDP 发包工具中进行设置
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307112129195.png)
（4）观察 PC2 和 PC3 上 Wireshark 所捕获到的数据包，如图 11 所示。
图 11 PC2 和 PC3 上 Wireshark 所捕获到的数据包
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307112129473.png)
从图 11 中可以看出 PC2 和 PC3 接收到的数据包是完全相同的。在填写了任意的 IP 地址和 MAC 地址之后，HUB 依然将 PC1 发出的数据包转发给了 PC2 和 PC3。由此我们可
以得知 HUB 的工作方式：**HUB 本身并不会识别 IP 地址和 MAC 地址，它只会将从一个接口所收到的数据包从其他的接口转发出去**。所以我们说 **HUB 是工作在物理层的**。

在进行数据包的捕获时，使用 HUB 是相当便利的。但是如果使用 HUB 作为组成网络的中心设备，却会存在很多缺点。一是**效率低下**，必须将一个数据包复制 n−1 份（n 的值为 HUB 端口的数量）。二是**数据的传输没有安全性**，因为每个数据包都会发送给全部设备。==网络中的任何一个设备只需要将网卡调整为混杂模式，就可以轻易实现对整个网络的监听==。

## 15.1.4 网桥
网桥 `bridge` 工作在物理层和数据链路层。用做物理层设备时，它重新生成接收到的信号；**用做数据链路层设备肘，它可以检查帧所包含的物理MAC地址**（源地址和目标地址）。
### 1. 过滤
有人会问，网桥和中继器/有源集线器Hub在功能上有什么差别？==网桥具有**过滤** `filtering` 能力，它检查帧的目的地址，并决定该帧是被转发或丢弃==。转发帧时必须指定端口，每个网桥都有一个**端口地址映射表**。

举个例子，如图16.5所示，两个局域网通过网桥相连。如果一个目的地址是 $712B13456142$ 的帧到达端口 $1$  ，网桥就查阅它的表，查找该帧离开的端口。根据映射表，目的地址是 $712B13456142$ 的帧从端口 $1$ 离开，因此不需要转发，该帧被丢弃。另一方面，如果一个目的地址是 $712B13456141$ 的帧到达端口 $2$ ，它离开的端口是端口 $1$ ，该帧被转发。在第一种情况下，局域网 $2$ **没有流量**；第二种情况下，两个局域网都有通信量。我们的例子中给出了一个两端口的网桥。实际上，**网桥通常有更多的端口**。
![图15.5 连接两个局域网的网桥](https://img-blog.csdnimg.cn/2c133c1cb2664183a699cc5445e1b01c.png)

还要注意：**网桥不改变帧中所包含的物理（MAC）地址**。
### 2. 透明网桥
**透明网桥** `transparent bridge` 是**一个它所连接的站点完全意识不到其存在的网桥**。==如果在系统中增加或移除一个透明网桥，则不需要重新配置==。参考IEEE 802.1d规范，安装有透明网桥的系统，必须符合以下三个标准：
1. 帧必须能从一个站点转发到另一个站点。
2. 通过学习网络中帧的传输，自动建立转发表。
3. 必须避免系统内循环。
#### (1) 转发
像讨论的那样，透明网桥必须正确地转发帧。
#### (2) 学习
最早的网桥的转发表是静态的。==配置网桥时，系统管理员需要手工输入每个表的条目。尽管过程简单，却并不实用。如果增加或移除了一个站点，转发表就必须手工修改。如果站点的MAC地址改变了（这并不少见） ，也是如此==。例如，安装一个新网卡就意味着一个新的MAC地址。

比静态表更好的解决方法是，**使用自动映射地址到端口的动态表**。==为了动态生成转发表，需要网桥从帧传输中逐渐学习==。要做到这一点，网桥对源地址和目的地址都要检查。**目的地址用来做转发决定**（**表查找**），**源地址用做添加和更新表条目的目的**。我们用图16.6来详细阐述这个过程。
1. 当站点 $A$ 向站点 $D$ 发送帧时，网桥还没有关于 $D$ 或者 $A$ 的表条目。帧将从所有三个端口转发出去，从而在网络中泛滥 `floods the network` 。然而，==通过查看源地址，网桥知道了站点 $A$ 位于「连接到端口 $1$ 的LAN」中，这意味着，将来目的地是 $A$ 的帧必须通过端口 $1$ 转发出去，网桥就添加这个条目到表中==。至此，转发表有了第一个条目。
4. 当站点 $E$ 向站点 $A$ 发送帧时，网桥有一个 $A$ 的条目，所以就**仅向端口 $1$ 转发该帧。这样就不会出现帧泛滥**。另外，还把该帧的源地址 $E$ 添加到表的第二个条目。
5. 当站点 $B$ 向站点 $C$ 发送帧时，网桥没有关于 $C$ 的表条目，所以又一次出现帧泛滥，再向表中添加新的条目。
6. 当网桥转发帧时，将继续这个学习过程。
![图15.6 学习型网桥和学习过程](https://img-blog.csdnimg.cn/76acac5c442844029e2c0e3d104c4dbf.png)
#### (3) 循环问题
**只要系统中没有冗余的网桥，透明网桥将工作得很好**。然而，系统管理员喜欢==使用冗余网桥（在两个LAN间使用多个网桥）来使系统更可靠。如果一个网桥失效，另一个网桥将接管，直到失效的网桥被修好或被替换==。不幸的是，冗余会在系统中产生循环。图16.7显示了一个很简单的例子，由于在系统中使用两个网桥连接两个LAN而产生了循环。
1. 站点 $A$ 向站点 $D$ 发送一帧。两个网桥的转发表都是空的，所以都转发帧，并且根据源地址 $A$ 更新各自的表。
2. ==现在LAN 2中有该帧的两份拷贝。网桥 $1$ 发出的拷贝由网桥 $2$ 接收，但是网桥 $2$ 没有任何关于目的地址 $D$ 的信息，此时出现帧泛滥。网桥 $2$ 发出的拷贝被网桥 $1$ 接收到，由于没有关于 $D$ 的信息，它也向所有端口发出==。注意，**网桥作为网络共享介质的两个节点，每个帧都是被独立处理的**，因为网桥使用了像CSMA/CD这样的访问方法。网桥的转发表被更新，但仍然没有目的地址 $D$ 的信息。
3. 现在LAN 1中有该帧的两份拷贝。又重复上一步骤的过程，每个帧都在网络中泛滥。
4. 这个过程一直持续。注意，**网桥也是中继器，并且重新生成帧，所以在每次重复中，都有该帧重新生成的新拷贝**。
![在这里插入图片描述](https://img-blog.csdnimg.cn/58abd0a71eae4534ab4a898a1caced7f.png)

为了解决循环问题，IEEE规范要求，网桥使用**生成树算法**来建立**无循环拓扑结构** `loopless topology` 。
#### (4) 生成树
在图论中，**生成树** `spanning tree` 是一个没有循环路径的图。在用网桥连接的LAN中，这就意味着，要建立「**每个局域网都能通过唯一路径（没有循环）到达其他任何LAN**」的拓扑结构。因为电缆和网桥之间是物理连接，我们不能改变系统的物理拓扑结构，但却可以创建一个**覆盖物理拓扑的逻辑拓扑结构**。图15.8说明了一个有 $4$ 个LAN和 $5$ 个网桥的系统，说明了物理系统和它在图论中的表示。虽然一些书把LAN表示成节点、而网桥表示成连接线，但在这里**把LAN和网桥都显示成节点，连接线表示LAN和网桥的连接**。

为了找出生成树，我们需要给连接线分配一个成本（度量）。成本的解释规则留给系统管理员。它可以是最小跳数（节点）的路径、最小延迟的路径、或者最大带宽的路径。如果两个端口有相同的最小值，系统管理员只需选择一个。我们在这里选择**最小跳数**作为成本。但是我们会在[【计算机网络】第四部分 网络层(22) 传递、转发和路由选择]()看到，==通常从LAN到网桥的跳数为 $0$，而从网桥到LAN的跳数为 $1$==（？）。

算法的过程包括以下三个步骤：
1. 每个网桥有一个内置的ID（ 通常是唯一的序列号）。==每个网桥广播它的ID，这样所有网桥都知道哪个是最小的ID，**选择ID最小的网桥作为根网桥**（作为树的根）==。我们假定 `B1` 有最小ID。所以它被选为根网桥。
2. 这个算法尝试找出，「**从根网桥到其他每个网桥或LAN的最短路径（最小成本的路径）**」，可以通过检查「从根网桥到目的地的整个成本」来找出最短路径。图15.9给出了最短路径。
![图15.8 连接的 LAN系统和它的图示](https://img-blog.csdnimg.cn/2fab2b6812aa491290050176127b1605.png)

3. **最短路径的组合生成了最短的树** `The combination of the shortest paths creates the shortest tree` ，如图15.9所示。
![图15.9 找出网桥系统的最短路径和生成树](https://img-blog.csdnimg.cn/5e0c51cbe939492dbe38fa351b2d65f4.png)

4. 基于生成树，我们标记**属于生成树部分的端口**为**转发端口** `forwarding port` ，它转发网桥接收到的帧，还标记**不属于生成树部分的端口**为**阻塞端口** `blocking port` ，它阻塞网桥接收到的帧。图15.10显示了，有转发端口（实线）和阻塞端口（虚线）的LAN物理系统。注意，生成树中从任一 LAN到其他LAN只有一条路径。这意味着从一个LAN到另一个LAN只有一条路径。你可以自己证明从LAN 1到LAN 2、LAN 3、或LAN 4只有一条路径。对LAN 3和LAN 4同样正确。
![图15.10 使用生成树算法后的转发端口和阻塞端口](https://img-blog.csdnimg.cn/1d4b30dd07594c2b9411f565df54bee0.png)
我们已经通过手工描述了生成树算法，但这不是实际情况。每个网桥都配置有一个软件包，以动态地完成这个过程。网桥互相发送称为**网桥协议数据单元** `bridge protocol data units, BPDU` 的特定消息，用来更新生成树。 当系统有变化时，如某个网桥出现故障、或者增加或移除网桥，生成树都需要更新。
 
#### (5) 源路由网桥
另一个在有冗余网桥的系统中，防止网桥循环的方法是使用**源路由网桥** `source routing bridge` 。透明网桥的职责包括过滤帧、转发和阻塞，==在有源路由网桥的系统中，这些职责由源站点来执行，某种程度由目的站点来执行==。

**在源路由算法中，发送站点指定帧必须经过的网桥，这些网桥的地址包含在帧中**（由源站点来指定路由）。换句话说，帧中不仅包含了源地址和目的地址，还包含了所有要经过的网桥地址。在发送数据帧之前，源站点通过和目的站点交换特定的帧，来得到这些网桥地址。源路由网桥是IEEE设计用于令牌环局域网的，现在这些局域网并不普及。

### 3. 用网桥连接不同的局域网
理论上，网桥在数据链路层应该能够连接使用不同协议的局域网，如以太局域网连接到无线局域网。然而，有很多问题需要考虑：
- **帧格式**。每种局域网类型都有自己的帧格式（比较以太网帧和无线局域网帧）。
- **最大数据长度**。如果接收的帧长度对目的局域网来说太大了，那么**数据帧必须分割成几个帧**，然后在目的站点重新组装。然而，**没有数据链路层的协议支持帧的分割和重新组装**。
    我们将在[【计算机网络】第四部分 网络层(19) 逻辑寻址]()看到，这在网络层是允许的。因此，**网桥必须丢弃任何对系统来说太大的帧**。
- **数据速率**。每种局域网类型都有自己的数据速率（例如以太网的数据速率是 $10\textrm{Mbps}$ ，而无线局域网的是 $1\textrm{Mbps}$ ）。**网桥必须缓存帧以补偿这个差别**。
- **位顺序**。每种局域网类型都有自己的位发送策略。有些先发送字节中高位，而有些先发送低位。
- **安全**。有些局域网，如无线局域网，在数据链路层执行安全措施。而有些则没有，如以太局域网。安全通常包括加密（[【计算机网络】第七部分 网络安全(30) 密码学]()）。当接收到来自无线局域网的帧肘，在转发给以太局域网之前，网桥需要解密这些信息。
- **多媒体支持**。有些局域网支持多媒体和这种通信所需要的服务质量，而有些则不支持。

---
## 15.1.5 两层交换机
因为 HUB 效率低下，又没有安全保障，所以很快就被另一种设备所替代了。这种新的设备就是交换机，**它工作在 OSI 七层模型物理层之上的数据链路层**。在开始了解交换机之前，我们首先来了解一下物理地址的概念。
- 物理地址（MAC 地址）：也叫硬件地址，长度是 48 比特（6 字节），由十六进制的数字组成，分为前 24 位和后 24 位。
- 前 24 位叫作组织唯一标志符（Organizationally Unique Identifier，OUI），是由 IEEE 的注册管理机构给不同厂家分配的代码，用于区分不同的厂家。
- 后 24 位是由厂家自己分配的，称为扩展标识符。**同一个厂家生产的网卡中 MAC 地址的后 24 位是不同的**。

以我们的计算机为例，每一个网卡都会有一个物理地址，**正常情况下这个地址是在网卡生产过程中设置好的，因此也不会发生变化**。如果你要查看计算机上网卡的物理地址，在 Windows 操作系统上可以在命令行中输入“ipconfig /all”，得到的信息如图 12 所示。
图 12 在命令行中输入“ipconfig /all”
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307112144650.png)
这里显示的 4C-CC-6A-62-4E-29 就是本机网卡的物理地址，其中“4C-CC-6A”是厂家的代码，后面的“62-4E-29”是这个网卡的扩展标识符。

交换机与集线器同样拥有多个端口，但**不同的地方在于交换机可以读取数据包的内容，并且可以识别数据包中的物理地址部分**。

==当使用"交换机"这个术语时，必须要谨慎，因为交换机可能代表两种不同的东西==。必须要加上设备所工作的层次来加以说明。可以有两层交换机或者三层交换机。**三层交换机 `three-layer switch` 工作在网络层，它是路由器的一种**；**两层交换机 `two-layer switch` 工作在物理层和数据链路层**。
- **两层交换机是一个有许多端口并且有更好（更快）性能的网桥**。有少量端口的网桥只可以连接几个局域网，有更多端口的网桥可以给每个站点分配唯一的端口，每个站点都作为独立的实体。这意味着**没有通信量竞争（没有在以太网中见到的冲突）**。
- 两层交换机像网桥一样，基于接收到帧的MAC地址做出过滤决策。但是，==两层交换机更加复杂。它有缓存区来保存帧进行处理，有交换组件使得更快地转发帧==。一些新型的两层交换机，称为**快速交换机**，已经设计成一检查到帧头部的MAC地址就转发帧。

交换机的工作原理如下。
1. 学习：交换机中有一张 MAC 地址表，**它里面的每一个表项记录着交换机某个端口所连接设备的硬件地址**。这个对应可能是一对多的，表示*一个端口连接了多个设备*。每当交换机接收到一个数据帧时，首先会查看这个帧里面的**源地址**，然后在 MAC 表中查询是否存在对应这个地址的表项，如果存在就更新这个记录。如果不存在，就将「这个源地址与来源端口编号」作为一条新记录填写到 MAC 地址表中。
2. 转发：当交换机收到数据帧之后，还需要查看**该数据包中的目的硬件地址**，然后在 MAC 地址表中查找这个目的地址对应的表项，如果找到，就要**将数据帧从记录对应的端口发送出去**。
3. 更新：这个 MAC 地址表并非是固定不变的，而是每隔一段时间就会更新。==每个记录都有生命周期，时间到了这些记录就会消失==。

下面为了研究交换机的工作方式，我们在 eNSP 中按照如下所示的步骤建立一个网络结构。
（1）在网络中添加 3 台 PC 机。
（2）在网络中添加 1 台交换机。添加的方法为在 eNSP 的分类中选中交换机，然后在下面选中，将其拖动到右侧拓扑图中。
（3）然后使用将每台 PC 机都连接到交换机上，并启动所有设备。
（4）完成之后的网络结构如图 5-13 所示。
图 13 使用交换机连接的计算机
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307112148927.png)
我们按照和前面集线器实例中相同的步骤，测试交换机是否可以识别 IP 地址或者硬件地址。同样，在这个例子中我们仍然没有为 PC1、PC2 和 PC3 设置 IP 地址。
（1）打开 PC1 中的“UDP 发包工具”，更改里面的设置，你可以任意设置里面的值，只需要符合书写要求即可，如图 5-14 所示。
图 14 打开 PC1 中的“UDP 发包工具”
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307112156158.png)
（2）在 PC2 和 PC3 上都启动 Wireshark。
（3）然后在 PC1 的“UDP 发包工具”处，选中“周期发送”，然后单击“发送”按钮。
（4）观察 PC2 和 PC3 上 Wireshark 所捕获到的数据包，如图 15 所示。
图 15 PC2 和 PC3 上 Wireshark 所捕获到的数据包
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307112157750.png)

可从图 5-15 中可以看出 PC2 和 PC3 接收到的数据包是完全相同的。在填写了任意的 IP 地址和 MAC 地址之后，交换机也同样将 PC1 发出的数据包转发给了 PC2 和 PC3。乍
看之下，好像交换机和集线器没有什么区别了？

其实这里的交换机和集线器有着本质的区别，**集线器是完全不能识别数据包中的地址，因而会将所有的数据包广播出去**。但交换机是能识别数据包中的硬件地址的。上面这个例子中，==交换机也将数据包广播出去的原因在于它并不知道到底哪个端口可以到达“11-22-33-44-55-66”，所以才广播出去的==。

那么如何查看交换机中端口与硬件地址的对应关系呢？我们以华为交换机为例。首先在交换机 LSW1 上单击右键，然后在弹出的菜单上选中“CLI”（见图 16）。
图 16 打开交换机 LSW1 的操作界面
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307112202743.png)
接下来可以启动华为交换机 LSW1 的命令行操作界面，虽然你可能对此有些陌生，但 是真实的华为设备的操作界面与此完全相同（见图 17）。
图 17 交换机 LSW1 的操作界面
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307112206799.png)
在这个交换机中查看端口与硬件地址的对应关系，需要先进入系统视图（使用命令 system-view），然后执行命令“display mac-address”（见图 18）。
图 18 执行命令“display mac-address”
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307112206999.png)

这个 CAM 表的内容是动态的，当交换机从一个端口（例如 Eth0/0/1）收到了数据包之后，就会解读这个数据包中的源 MAC 地址（例如 66-55-44-33-22-11），然后将这个地址和
端口的对应关系作为一行添加到 CAM 表中。

下面我们来构造一个目的 MAC 地址为 PC2 的数据包，查看 PC3 是否可以收到这个数据包。首先在 PC2 的设置选项卡中查看 MAC 地址，得到的结果为 54-89-98-7B-28-F1。打开 PC2 中的“UDP 发包工具”，填写目的端口号和源端口号，然后发送。再查看 CAM 表的内容，如图 19 所示。
 
图 19 查看 CAM 表的内容
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307112206956.png)

可以看到这里面又多了一个“54-89-98-7B-28-F1”和 Eth0/0/2 的对应关系。接下来按照以下步骤进行。
（1）如图 5-20 所示，打开 PC1 中的“UDP 发包工具”，更改里面的设置，其中将目的 MAC 地址设置为“54-89-98-7B-28-F1”，其他值可以任意设置，只需要符合书写要求即可。
图 5-20 打开 PC1 中的“UDP 发包工具”
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307112206161.png)
（2）在 PC2 和 PC3 上都启动 Wireshark。
（3）然后在 PC1 的“UDP 发包工具”处，选中“周期发送”，然后单击“发送”按钮。
（4）观察 PC2 和 PC3 上 Wireshark 所捕获到的数据包（见图 21）。
图 21 观察 PC2 和 PC3 上 Wireshark 所捕获到的数据包
 ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307112207675.png)

我们可以看到从 PC1 发送出来的数据包，之后在 PC2 接收到了，而 **PC3 则完全没有收到**，这表明该数据包都被发送达到了 PC2 处。

现在==用一句话来总结集线器和交换机的区别，那就是“集线器广播，交换机转发”==。
## 15.1.6 路由器
**路由器** `router` 是三层设备，它基于 **分组的逻辑地址（主机到主机寻址）** 路由分组。在Internet中，路由器通常连接LAN和WAN ，它有一张表用来决策路由。**路由表通常是动态的，使用路由协议更新**。我们将在[网络层(19) 逻辑寻址]()、[网络层(22) 传递、转发和路由选择]()中更详细地讨论路由器和路由选择。图15.11给出了Internet的一部分，它使用路由器来连接LAN和WAN。
![图15.11 连接独立LAN和WAN的路由器](https://img-blog.csdnimg.cn/51351de261314ee49fc89febe07144f3.png)

除了 MAC 地址之外，数据包中还包含 IP 地址。当一个数据包到达网关/路由器之后，就需要这个 IP 地址起作用了，数据包从网关到达目标所在子网的过程叫作路由。

数据包在网络中就按照“存储再转发”的方式移动着，网络中的一个又一个中转站，就是那些专门用来“存储再转发”数据包的专用计算机。这些设备最初被称作是“接口信息处理器”，这是因为它们最初的目的就是作为通用计算机和网络其余部分进行连接的接口。

后来这些专门用来进行通信的计算机被称为路由器，这是因为它们用来将数据包路由到最终目的地。

因特网的核心就是一组协同工作的路由器，它们在同一时间可以将数据包从各个源地址移动到各个目的地址。每一台计算机或者局域网都可以通过连接到路由器而将数据包发送到因特网上的各个目的地。

路由器通过路由协议来执行路由选择和数据包转发功能。路由分为静态路由和动态路由，其相应的路由表称为静态路由表和动态路由表。静态路由表由网络管理员在系统安装时根据网络的配置情况预先设定，网络结构发生变化后由网络管理员手工修改路由表。动态路由随网络运行情况的变化而变化，路由器根据路由协议提供的功能自动计算数据传输的最佳路径，由此得到动态路由表。

eNSP 中提供了很多关于路由器的实例，在启动 eNSP 时，你就可以看到这些实例，如图 22 所示。
图 22 eNSP 中自带的路由器配置范例
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307112153248.png)
各位如果对路由所使用的协议感兴趣，可以对这些实例进行研究，本书只涉及简单的路由配置，所以这里不再详细介绍。 

## 15.1.7 三层交换机
三层交换机是路由器，但更快更复杂。三层交换机中的交换光纤允许更快的表查询和转发。某种程度上，我们可以互换地使用路由器和三层交换机。
## 15.1.8 网关
虽然一些书互换地使用术语网关和路由器，但是大多数书还是对两者有区分的。**网关** `gateway` 通常是**工作在因特网全部五层或者OSI模型中全部七层的计算机**。网关拿到一条应用消息、读取消息并解释消息。这意味着，**它能作为两个使用不同模型的互联网的连接设备**。例如，设计成使用OSI模型的网络，可以连接到使用因特网模型的另一个网络。连接两个系统的网关接收到来自第一个系统的帧时，把它交付给OSI应用层，然后删除这条消息。

**网关可以提供安全性**。在[【计算机网络】第七部分 网络安全(32) 因特网中的安全措施]()中，将学到网关用来过滤不需要的应用层消息。

---
# 15.2 主干网
这里所讨论的一些连接设备，可以用来在主干网中连接局域网。**主干网 `backbone network` 允许连接多个局域网**。==在主干网中，站点不直接连接到主干上，站点是局域网的一部分，由主干来连接这些局域网==。**主干网本身也是使用局域网协议的局域网**，比如以太网；**每个到主干网的连接本身是另一个局域网**。

尽管有很多不同的结构可以使用在主子网中，这里只讨论两种最常见的结构：总线型和星型结构。
## 15.2.1 总线型主干网
在总线型主干网 `bus backbone` 中，**主干网的拓扑结构是总线型**。主干本身可以使用支持总线型拓扑结构的协议的其中一种，如 `10Base5` 或者 `10Base2` 。

==总线型主干网通常作为分布式主干网，来连接一个组织的不同建筑物，每个建筑物可以包含单独的局域网，或者是另一个主干网（通常是星型主干网）==。使用总线型主干网的一个典型例子是**在校园内连接单层或多层建筑物**，每个单层建筑物通常有一个单独的局域网，每个多层建筑物有一个主干网（通常是星型主干网）连接每层的局域网。总线型主干网可以互连这些局域网和主干网。图15.12展示了基于网桥的、连接有四个局域网的总线型主干网 `a bridge-based backbone with four LANs`。
![图15.12 总线型主干网](https://img-blog.csdnimg.cn/47da55c9fbe54a3d8fecf44c06fa2b62.png)
在图15.12中，如果一个站点需要向同一LAN中的另一个站点发送帧，相应的网桥将阻塞该帧，这个帧永远也到达不了主干。但是，如果一个站点需要向另一个LAN中的站点发送帧，网桥将传输该帧到主干，由适当的网桥接收并发送到目的LAN。==每个和主干相连的网桥，都有一个该网桥的LAN一侧的所有站点列表，基于这个表的内容来决定是阻塞还是转发帧==。

## 15.2.2 星型主干网
**星型主干网** `star backbone` ，有时称为折叠式或交换式主干网，其拓扑结构是星型。在这个配置中，**主干网仅是一台连接局域网的交换机**（这就是为什么称为折叠式主干网的原因）。

图15.13展示了一个星型主干网。注意，在这个配置中，交换机担当主干的工作，并且同时连接LAN。**星型主干网最常用做一个建筑物内的分布式主干**——在一个多层的建筑物内，通常有服务特定楼层的LAN，星型主干网连接这些LAN。只有一个交换机的主干网，可以安装在地下室或第一层，用单独的电缆从交换机连接到每个LAN。如果单个的LAN也有物理星型拓扑结构，则所使用的集线器（或交换机）可以安装在相应楼层的机柜中，或者所有的都可以安装在最靠近交换机的地方。我们在安装有主干网交换机和集线器或交换机的地下室中，经常可以看到机架或机柜。

![图15.13 星型主干网](https://img-blog.csdnimg.cn/51833e17dcac471793345a8e7d36f57a.png)
## 15.2.3 连接远程LAN
主干网的另一个常见的应用是**连接远程LAN**。当公司有几个拥有局域网的办公室，并且需要连接起来时，这种类型的主干网就很有用处。可以通过网桥、有时称为**远程网桥** `remote bridges` 来连接，这些网桥充当连接局域网和点对点网络（如租用的电话线路或ADSL线路）的连接设备，==在用远程网桥连接的远程主干网中，点对点链路被认为是一个局域网==。这个情况中的点对点网络称为**没有站点的LAN**，点对点链路可以使用类似PPP这样的协议。图15.14展示了一个连接远程LAN的主干网。
![图15 .1 4 连接远程LAN](https://img-blog.csdnimg.cn/5c01ae1e7b7b4f0aaec02cf723a975c6.png)

我们介绍了网络中常见的几种硬件，并给出了一些实例。了解这些硬件可以
更好地帮助我们使用 Wireshark。在本章开始的时候我们首先介绍了网线，介绍这个硬件的
目的是让读者明白在即使没有地址的情况下，网络也能够通信。接下来我们介绍了集线器
和交换机，这是两种很容易弄混的设备，但是它们的工作原理完全不同。最后我们简单讲
解了路由器，在网络中这是一个极为重要的设备，eNSP 中也提供了很多详尽的实例，各位
读者如果感兴趣的话，可以在这些实例中进行抓包分析。
在下一章中，我们将会讲解如何在一个网络中部署 Wireshark。这是一个很重要的问题，

---
# 15.3 虚拟局域网
如果站点物理上属于某个LAN，那它就被当做该LAN的一部分，成员关系的标准是地理位置。如果需要在属于不同物理LAN的两个站点之间建立虚拟连接，那该怎么办呢？我们可以像局域网一样，概略地定义**虚拟局域网**  `virtual local area network, VLAN` ，不过是通过软件、而非通过物理线路来配置。

通过一个例子来详细说明这个定义。图15.15展示了一个工程公司中的交换式局域网，有 $10$ 个站点被分组成通过交换机连接的 $3$ 个LAN。前 $4$ 个工程师作为第一组工作在一起，接下来的 $3$ 个工程师作为第二组，最后 $3$ 个工程师作为第三组。LAN被设置成支持这种安排。
![在这里插入图片描述](https://img-blog.csdnimg.cn/7497548c13db4dd9b1bd7b32910ab9e1.png)
但是，如果管理员需要将两个工程师从第一组调到第三组，以加快第三组的项目进度，将会带来什么影响呢？LAN的配置需要改变，网络技术员必须重新布线。如果下一个星期，两个工程师又要回到原来的组，相同的问题会再次出现。==在交换式局域网中，工作组的改变意味着网络配置的物理改变==。

图15.16展示了被划分成三个VLAN的一个交换式局域网。VLAN技术的全部思想是**将LAN划分成逻辑的、而不是物理的网段**。一个LAN可以划分成称为VLAN的多个逻辑LAN，每个VLAN是组织的一个工作组。如果某人从一个组移动到另一个组，就没有必要改变物理配置。**在VLAN中，组的成员是由软件而不是硬件来定义的**。==任何站点都可以逻辑地移动到另一个VLAN中，VLAN的所有成员都可以接收发送到特定VLAN的广播信息==。这意味着，如果某个站点从VLAN 1移动到VLAN 2，它将接收发送到VLAN 2的广播信息，而不再接收发送到VLAN 1的广播信息。

很明显，先前例子中的问题，可以通过使用VLAN很容易地得到解决。通过软件把工程师从一个工作组移动到另一个工作组，比改变物理网络的配置要容易得多。
![图15.15 连接三个LAN的交换机](https://img-blog.csdnimg.cn/f54ea0e69a52457ca73134595a89dbe6.png)

VLAN技术甚至允许**连接在不同交换机上的站点组成一个VLAN**。图15.17展示了一个有两台交换机和三个VLAN的主干LAN，交换机 $A$ 和 $B$ 的站点属于不同VLAN。 
![图15 . 17 主干网中使用VLAN软件的两个交换机](https://img-blog.csdnimg.cn/2a9e917901b3402b8f12a0b40a30fcf7.png)

对有两个分离的建筑物的公司来说，这是一个好的配置。每个建筑物都可以拥有自己的交换式LAN，这些LAN由主干网连接。第一个和第二个建筑物内的人可以处于同一个工作组，即使他们由不同的物理LAN来连接。

从这三个例子中，我们可以定义VLAN的一个特征：**VLAN创建广播域**，它将属于一个或多个物理LAN的站点分组到广播域中；VLAN 中的站点和其他站点通信时，就像它们属于一个物理网段一样。

## 15.3.1 成员
采用什么特征来分组VLAN中的站点呢？厂商使用不同的特征，例如端口号、MAC地址、IP地址、IP多播地址，或者以上两种或多种联合使用。
- **端口号**：有些VLAN厂商使用交换机的端口号作为分组依据。例如，管理员可以定义连接在端口 $1, 2, 3, 7$ 的站点属于VLAN 1，连接在端口 $4,10, 12$ 的站点属于VLAN 2，依此类推。
- **MAC地址**：有些VLAN厂商使用 $48$ 位MAC地址作为分组依据。例如，管理员可以定义 MAC地址为 $E2342A12334$ 和 $F2A123BCD341$ 的站点属于VLAN 1。
- **IP地址**：有些VLAN厂商使用 $32$ 位IP地址作为分组依据。例如，管理员可以定义IP地址为 $181.34.23.67,\ 181. 34.23.98,\ 181. 34.23.112$ 的站点属于VLAN 1。
- **多播IP地址**：有些VLAN厂商使用多播IP地址作为分组依据。IP层的多播现在转换为数据链路层的多播。
- **联合使用**：最近有些厂商开发的软件，支持联合使用所有这些特征。管理员在安装软件时可以选择一个或多个特征。另外，软件可以重新配置来改变这些设置。

## 15.3.2 配置
站点怎样分组到不同的VLAN中呢？可以通过以下三种方式之一：手工、半自动和自动。
- **手工配置**：==采用手工配置方式时，网络管理员在安装VLAN时，要使用VLAN软件手工地将站点分配到不同的VLAN中==。以后要将站点从一个VLAN迁移到另一个VLAN中时，也要手工地操作。注意，这不是一个物理配置，而是逻辑配置。这里，"手工地"这个词代表管理员使用VLAN软件时，需要键入端口号、IP地址或者其他特征。
- **自动配置**：==在自动配置中，使用管理员定义的标准，自动地将站点连接到VLAN或断开与VLAN的连接==。例如，管理员可以定义项目编号作为分组的标准。当用户改变项目时，他将自动地迁移到新的VLAN 中。
 - **半自动配置**：==半自动配置在某种程度上介于手工配置和自动配置之间==。通常，初始化时是手工操作，迁移时是自动完成。

## 15.3.3 交换机间的通信
在多交换式主干网中，每个交换机不仅必须知道哪个站点属于哪个VLAN，而且必须知道连接在其他交换机上的站点的成员。例如，在图15.17中，交换机 $A$ 必须知道交换机 $B$ 上连接的站点的成员状况，交换机 $B$ 也必须知道交换机 $A$ 同样的信息。有三个方法可以达到这个目的：表维护、帧标记和时分多路复用。
- **表维护**：在这种方法中，当一个站点向它的组成员发送广播帧时，交换机将在一个表中增加一个条目，并记录站点的成员关系。交换机互相发送自己的表以定期更新。
- **帧标记**：在这种方法中，**当帧在交换机之间传输时，将会在MAC帧上加一个额外的头部来定义目标VLAN**。接收帧的交换机使用帧标记，决定接收广播消息的VLAN 。
- **时分多路复用** `TDM` ：==在这种方式中，交换机之间的连接（主干）被划分成时分共享通道==（[第二部分 物理层和介质(6)]()）。例如，如果在一个主干网中VLAN的总数是 $5$ 个，每个主干划分成 $5$ 个通道，去往VLAN 1的通信量在通道 $1$ 中传输，去往VLAN 2的通信量在通道 $2$ 中传输，依此类推。通过检查帧到达时的通道，接收的交换机就可以确定目的VLAN。

## 15.3.4 IEEE标准
1996年，IEEE 802.1小组委员会通过了称为 `802.1Q` 的标准，定义了**帧标记**的格式。这个标准也定义了在多交换式主干网中使用的格式，并且支持在VLAN中使用多家供应商的设备。IEEE 802.1Q已经开放了「与VLAN有关的其他问题」进一步标准化的方法，多数的厂商已经接受这个标准。

使用VLAN有以下优势：
- **降低费用和节省时间**：VLAN可以降低站点从一个组到另一个组的迁移费用。物理上重新配置费时又昂贵，相对于把站点物理地移动到另一个网段或另一个交换机上，使用软件移动要容易和快捷得多。
- **建立虚拟工作组**：VLAN可以用来建立虚拟工作组。例如，在大学校园环境中，工作于同一个项目中的教授可以互相发送广播报文，而没有必要属于同一个系。**与以往使用的IP多播功能相比，这种方式降低了通信量**。
- **安全**：VLAN提供了附加的安全措施。属于同一个工作组的人们，被授权允许发送广播报文，而其他工作组的人将接收不到这些报文。

