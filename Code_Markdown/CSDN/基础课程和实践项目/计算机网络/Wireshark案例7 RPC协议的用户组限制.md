做销售的朋友最近非常郁闷，因为即将到手的单子被竞争对手抢走了。他在饭局上 诉苦的时候，技术细节引起了我的极大兴趣。仔细询问之后，我把症状归纳如下：
他的 客户是一家超大机构，内部组织非常庞杂，所以从信息化的角度看，有些用户（user） 属于数十个用户组（group）。当这家机构试用我朋友家的NFS服务器时，发现了一个 诡异的现象，就是有些文件明明允许某个用户组访问的，但是属于该组的用户却访问不 了。

为了更清楚地分析这个现象，我在实验室搭建了一个同样的环境来重现问题。 1．在Linux客户端创建了一个测试账号叫linpeiman，并将其加入到20个用户组中，如 图1所示。 
图1
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307071657787.png)
2．把某个NFS服务器上的共享目录挂载到客户端，见图2。 
图2 
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307071657612.png)
3．用root账号在共享目录中创建了20个空的测试文件，然后把它们逐个分配给第一步提 到的那20个用户组，并将权限都设为070（表示用户组拥有所有访问权限），见图3。理 论上账号linpeiman属于这20个用户组，所以应该对这20个文件都有访问权限。 
图3 
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307071700504.png)
4．用账号linpeiman逐一打开（cat）这些文件，发现前16个没有报错，但是后面4个都 遭遇了Permission denied错误，如图4所示。这个症状就好像linpeiman不属于后4个用 户组似的。 
图4 
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307071700266.png)
我觉得这个实验结果完全不科学。分明是一模一样的配置，为什么就有些文件不可以访 问呢？重复了几次实验都是一样结果，我只好尝试一些其他的方式来排查。 

我先在一个本地目录中创建了20个文件，并把权限设成跟共享目录上的一样，结果发现 每一个文件都可以顺利打开，见图5。 
图5 
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307071701286.png)
既然本地文件是好的，就说明问题很可能出在服务器上。而且根据那位销售朋友的说 法，在他们竞争对手的NFS服务器上确实不存在这个问题，不知道是怎么做到的。到了 这时候肯定要“出大招”了，**我在访问这些文件时抓了个网络包下来分析**。 
1．既然报错是Permission denied，我就用了Ctrl+F搜索字符串“denied”，见图6。 
图6 
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307071701298.png)
2．这一搜果然找到了服务器响应的375号包（见图7），定位到了出问题的时间点。不 过真正有价值的却是它的上一个包，即来自客户端的374号包。从图7底部可见RPC （Remote Procedure Call）层只把16个Group ID传给服务器，而不是20个。 
图7 
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307071702204.png)
3．这些ID对应着哪些用户组呢？我们来看看Linux客户端的/etc/group文件（见图8）， 果然是前16个，后面的4个不知道为什么被遗漏了。至此真相大白，原来问题根源还是 在客户端的RPC层上，不知道它为什么遗漏了后4个用户组，服务器是被冤枉的。而本 地访问之所以没有出问题，是因为不需要调用RPC层发送用户组。
图8 
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307071703904.png)

4．我查了RPC协议所对应的RFC 5531，果然找到如下关于“gids<16>”的定义。 
```java
structauthsys_parms { 
    unsignedint stamp; 
    stringmachinename<255>; 
    unsignedintuid; 
    unsignedintgid; 
    unsignedintgids<16>; 　　　　 
};
``` 
看来最多传16个用户组是RFC限制的。于是问题来了，那竞争对手是怎样避免这个限制 的呢？一番调查之后，我才发现业内普遍采用了一个颇为“机智”的办法，即**把客户端 的/etc/passwd和/etc/group文件复制到服务器上**，需要用到用户组的时候就自己在服务 器上查询，**完全忽略客户端通过RPC层传过来的信息**。其实这样做会有后遗症，比如以 后在客户端修改了用户组，但是忘记同步到服务器上，就会出现访问问题。 

对我这位做销售的朋友来说，虽然丢了单子，但是通过Wireshark发现了根源，能亡羊 补牢也是好的。说不定下一个单子就能扳回来呢？