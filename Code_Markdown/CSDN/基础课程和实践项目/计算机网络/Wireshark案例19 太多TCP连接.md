
过犹不及
最近有个中东公司的远程镜像偏慢，研究了很久都没有进展，因此便寄希望于Wireshark，抓了个包给我分析。该环境的网络拓扑如图1所示，主数据中心位于中东，需要定时把新数据同步到英国去，常常因为传输太慢而同步超时。
图1
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091715088.png)

我用Wireshark打开网络包，找到Analyze Expert Info菜单选项，果然看到了图2所示的大量重传。由于全部网络包也就十多万个，**这个重传比例已经算相当高了**。
图2
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091716593.png)

那导致重传的因素是什么呢？当我点到Statistics→Conversations菜单选项时，图3的统计结果似乎给了一些启示——这台服务器竟然用了50个TCP连接来做数据同步。
图3
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091716809.png)

**使用多个TCP连接的原因不难理解**。因为网络延迟、拥塞和应用层设计等因素，单个连接无法占满整个物理链路。比如用某些协议传输一连串字母所命名的小文件时，在链路上可能形成图4这样的断断续续的数据流，就像用吸管喝饮料时混进了大量的空气。
图4
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091717188.png)

这个问题的确是可以通过增加一些连接数占满链路来解决。图5演示了增加一个连接后的状况（传输的是一连串数字命名的文件），可见相同时间里传输的数据总量增加了。
图5
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091717561.png)

那是不是连接数越多越好呢？从理论上看并非如此。**当连接数多到足以占满整个链路时，再增加连接就没有意义了，甚至可能带来负面效果**。这是由以下原因造成的。==多个连接需要更高的资源成本。比如连接的建立和断开，以及维护每个连接需要分配的内存，都会消耗服务器的资源==。太多连接抢占同一个链路，有可能会增加丢包率。就像**用多辆车来运输货物可以加快速度一样，当车辆多到足以引发交通事故时就适得其反了**。说不定图2中的丢包就有一部分是过多的连接数导致的。

以上只是理论分析，我决定在实验室中粗略模拟一下。该实验环境中的最大发送窗口是65535字节，当我只启用一个TCP连接时，“中东”很快就发送了65535字节的“在途字节数”，即**耗光了发送窗口**，因此Wireshark提示［TCP window Full］（见图6）。**这种情况下“中东”只好停下来等待“英国”的Ack，收到Ack后才能接着往下传**。这也说明了**带宽没有被完全利用，应该增加发送窗口或者连接数来补充**。当我把连接数增加到3个时，果然就不再看到这个提示了。
图6
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091719777.png)
> 注意：Wireshark提示的［TCPwindowFull］和［TCPzerowindow］意义不同，但是有很多人会混淆。前者表示这个包的发送方意识到 **“在途字节数”已经达到对方所声明的接收窗口，不能再发了**；而后者表示**这个包的发送方意识到自己的缓存区已经满了，无法接收更多数据**。

启用3个TCP连接时的性能如图7所示，为5.055Mbit/s，跟理想速度很接近（该公司租用的带宽确实小了点），此时在包里也没有看到重传。
图7
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091720159.png)
而当连接数增加到50个时，就降到了图8所示的4.081Mbit/s了，差不多20%的幅度，同时也出现不少重传（重传图就不贴出来了）。可见实验结果和我们的理论分析一致。
图8
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091721858.png)
以上分析，从理论到实验都说明了**连接数并非越多越好**。那究竟多少是最合适的呢？**这和网络带宽、往返时间以及发送窗口都有关系**。我没有固定的计算公式，只能一边调节连接数一边观测，测到最佳性能时的那个连接数就是了。本文开头提到的那个“中东-英国”镜像问题，后来也是这样调优的。不过这种调优一般提升幅度有限，对于很多中东土豪公司来说，最直截了当的方式还是购买带宽和加速器。

看到这里，你可能会想起**在中国很流行的多线程下载工具，其原理是否也是通过提高链路利用率来提升速度呢**？比如家里装了百兆宽带，用单线程下载电影的时候只有100KB/s，用了双线程就能接近200KB/s了。**这个原理其实和本文所分析的很不一样，因为它的性能瓶颈并不在链路或者网络协议上，而是服务器给每个连接所设置的速度限额**。要是在服务器上解除了限额，那很可能单线程的性能也可以超过200KB/s。