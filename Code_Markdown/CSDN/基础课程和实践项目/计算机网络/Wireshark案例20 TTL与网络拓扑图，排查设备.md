
如何科学地推卸责任
作为一名高尚的工程师，我们当然要勇于承担责任，这几乎是业内第一美德。不过**只需承担自己的那部分就够了**，不要把别人的也扛到身上，让真正的责任方来承担才最科学。

然而划分责任并不容易。现在一套IT系统往往涉及多个厂商的产品，比如Oracle的数据库装在了EMC的存储上，然后用Cisco的网络设备来做远程镜像。项目签收时各家销售都很开心，但等到出问题时就轮到售后头疼了。比如数据库的远程镜像老是同步不了，底层原因又不是一眼就能看出来的，这种情况应该由谁来负责呢？假设故障点是在网络上，那让Oracle的工程师来排查反而耽误时间了，难不成每次事故都要组织大会诊吗？**还好有了Wireshark，划分责任就简单多了，只要抓包分析就行**。

本文分享的便是这样一个案例。我司做容灾产品的售后部门最近接到一个投诉，说远程镜像死活建不起来。技术支持工程师非常尽职，仔细地检查了所有配置，发现都是对的；又测试了网络连接，也都ping得通——总之看上去似乎什么都是好的，但就是建不起来。**一般远程镜像的网络环境不会很复杂，就是通过层层路由，把数据从生产服务器复制到灾备服务器上**，如图1所示。
图1
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091734854.png)
怎么办呢？你可能会觉得凡是林沛满分享的案例都是先抓个包，然后英明神武地用Wireshark解决掉了（希望没有给各位留下这样自吹自擂的印象）。不过这次却有点狼狈，我的确在生产服务器上抓了包，但是并没有看出原因。截图见图2，生产环境（Prod_Server）的部分数据包发到灾备服务器（DR_Server）之后，收到了大量的RST（即RESET）回复，说明被拒绝了。
图2
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091734900.png)

客户斩钉截铁，“你看一目了然吧，Wireshark上带RST标志的包明显都是从灾备服务器发出来的，所以就是你们的设备有问题，应该由你们来负责。”我对他的推理无力反驳，的确应该到灾备服务器上检查配置和日志。这可把我们的技术支持急坏了，因为他在灾备服务器上完全查不出问题。

我们似乎走进了一条死胡同。Wireshark把原因指向了灾备，但我们在灾备上又没有发现问题。走投无路之际，我只好从头再梳理一遍，看看有没有漏掉什么。最后还真让我想到一个可能性——**虽然在生产服务器上看到了RST包，但这并不能证明该包一定就是从灾备发过来的**。假如是网络路径上的某个设备伪装成灾备发的，那就不算我们的责任啦，应该**在两边的服务器上同时抓包才能判断**。技术支持工程师也没有更好的办法，只好照办了，喜讯也很快传来：灾备那边果然没有发过RST包，客户在铁证面前也认同了我们的观点。这责任推卸得堪称完美。

既然和我司无关，我也就不再关注这件事情了。没想到几天后和同事吃饭时，听说这案子还没有了结。仔细打听了一下，原来客户不知道怎样定位发RST的那台设备，所以问题还是解决不了。帮人帮到底，能否用Wireshark来辅助定位呢？我们研究了一下，发现还是可以的：**根据RFC1812，一个网络包的TTL每减去1就意味着它经过一次路由**。接下来我们再看图3，RST包的TTL为62。由于TTL的初始值一般为64，那就说明很可能是距离生产服务器两跳（64−62=2）的那台设备发出来的。**客户只需翻出网络拓扑图**，就能大概知道是哪台设备了。
图3
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091735126.png)
这个案子就此结束了，说破了似乎很简单，但是刚遇到时确实很迷茫。事实上当我想到TTL的时候，已经意识到刚开始的建议是不对的，没必要两边同时抓包，**直接对比生产服务器上抓到的正常包和RST包就行了**。正常包的TTL请见图4，说明生产服务器和灾备服务器之间跨了6跳。
图4
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091736081.png)
这个技巧还可以运用到其他的场景中，比如前几天有朋友说百度的JS被劫持来攻击GitHub，我立即告诉他可以抓包看TTL。后来该方法被国外一些技术人员证实时，这位朋友简直惊呆了，以为我有多厉害。其实我是先花了很多时间在这个案子上才琢磨出来的。套用一句有点腻的心灵鸡汤，就是“台上一分钟，台下十年功。”