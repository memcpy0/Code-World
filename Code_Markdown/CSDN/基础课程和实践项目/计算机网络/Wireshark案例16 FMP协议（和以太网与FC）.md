
昙花一现的协议
1998年，在波士顿附近的一座小镇上，几位技术人员被召集到了一起。他们都是存储巨头EMC的工程师，目的是找到一个方法来缓解当时网络带宽所形成的性能瓶颈。

今天的年轻人已经难以想象20世纪90年代的网络带宽是什么样子的。初期连数据中心里的服务器都只有十兆，后来才增加到百兆。而现在一台廉价电脑都已经配千兆卡了，这样对比一下你就能理解当时的网络有多落后。低带宽对个人电脑还不算大问题，但对企业级服务器就是严重的瓶颈了，比如在网络存储上读写大量数据的时候（拓扑见图1）。想象一下，假如你是当时皮克斯动画工作室的员工，每天要访问动辄1GB以上的视频文件，性能体验该有多糟糕。有什么办法可以解决这个问题呢？
图1
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091704943.png)
以我的创新能力和知识视野，如果参与这个项目估计只能做做流控，尽量使传输性能接近理论最大值。而这个项目组显然更有创意，他们想到了当时带宽已经达到2Gbit/s的FC（Fibre Channel）。成功的话可以从百兆提升到2Gbit/s，增幅的确非常大。

讲到这里就得补充一下网络存储的架构。如图2所示[4]（此图中的客户端相当于图1中服务器的角色），**当时的网络存储是用多个硬盘组成LUN（即一层虚拟的存储设备），然后再在LUN上创建文件系统**，供以太网上的NFS或CIFS客户端访问。
图2
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091705935.png)

可惜FC有别于以太网，它支持访问LUN，但不支持访问文件系统。也就是说，我们不能简单地把图2的以太网连接替换成FC。如果把客户端和LUN之间用FC连接起来，变成图3的样子，那么带宽的确能提高好多倍。然而新的问题又来了，**客户端是不知道文件存放在LUN上的位置的，所以即使连上了也不知道怎么读写**。这使我们处于一个两难的境地。
1. 客户端能通过以太网访问文件系统，但是带宽太小了。
2. 客户端能从FC访问LUN，却不知道文件在LUN上的存放位置。图3怎么办呢？

这个项目组想到了一个办法。他们把以太网和FC的优势结合起来。**先通过以太网访问文件系统，获知文件存放在LUN上的位置，然后再通过FC去LUN上读写**。由于文件位置的数据量很小，所以通过小带宽的以太网也能快速完成；而文件内容的数据量很大，FC的大带宽也能充分发挥优势。根据这个原理，项目组开发了一个叫FMP（File Mapping Protocol）的网络协议，**专门用于客户端向文件系统查询文件的存放位置**。图4展示了增加FC连接后的拓扑，即两种网络协作传输的样子。
图4
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091706025.png)
访问文件当然不仅是读写内容这么简单，还要操作元数据和避免访问冲突，等等。当时CIFS和NFS协议在这方面已经很成熟了，所以FMP就和它们结合起来使用。**只有当客户端需要读写大块的文件内容时才调用FMP，然后再通过FC访问其文件内容**，其他时候照样走CIFS和NFS。

举个例子，如果我们看中了文件系统里一部10GB的电影，那就通过FMP获得该电影文件在LUN上的存放位置，然后再通过FC快速地下载它。如果我们只需要读一个1KB的小文件，那直接通过CIFS或NFS就行了，因为用了FC也不见得能提高多少性能。换句话说，**就是用FMP拓展了CIFS和NFS，使它们适用于高性能场合**。

至今我的电脑中还保存着一份FMP网络包。如图5所示，Protocol显示为FMP，存储服务器通过GetMapReply把文件内容在LUN上的位置（Extent）告知客户端。实现起来就这么简单。
图5
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091707202.png)
FMP刚面世的时候颇受欢迎，因为性能提升太明显了，连中国最顶尖的科研机构和证券公司都在用它，我刚毕业时还用Wireshark帮它们分析过几次FMP包。用我国学术界今年流行的语言来说，这个技术也算是“突破了冯·诺依曼瓶颈的束缚，产生了巨大的国际影响”。后来的pNFS（即NFSv4.1）也借用了它的理念，图6中的LAYOUT GET操作，本质上和图5的GetMap就是异曲同工。
图6
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091708847.png)

可惜好景不长，随着以太网的更新换代，带宽已经接近甚至超过了FC。现在单用NFS或CIFS就可以实现很高的性能，依赖FMP的场景也就越来越少了，过去两年里甚至没有一家公司找我看过FMP或者pNFS的包。波士顿附近的项目组也早就解散，我现在只能从旧资料中找到这几位老同事的名字：Jeff、Boris、Jason、Peter，还有一位姓Jiang的华人。

在世界IT史上，类似命运的优秀产品还有不少，美好而短暂，就像昙花一现。我写这篇文章并不只是为了缅怀这个我付出过心血的协议，也想借它揭示IT界一个普遍规律——==网络协议的面世是受市场需求驱使的。我们完全可以根据自己的需要设计一个新协议，不要以为这是遥不可及的事情==。不过在这个日新月异的领域中，新的协议可能很快就会老去，而老协议却可以焕发第二春。**唯一能青春永驻的，只有Wireshark了**。