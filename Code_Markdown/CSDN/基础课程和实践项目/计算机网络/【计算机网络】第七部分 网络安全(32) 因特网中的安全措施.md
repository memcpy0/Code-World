@[toc]

在这里，要说明某些安全问题，特别是保密性和报文鉴别是如何应用于「因特网模型的网络层、传输层和应用层」的。还简要说明IPSec协议如何在IP协议中增加鉴别和安全 `authentication and confidentiality` 、SSL/TLS如何针对TCP协议完成相同的任务、以及PGP如何针对SMTP协议（电子邮件）完成相同的任务。

在所有这些协议中，我们需要考虑一些共同的问题。**首先，需要生成一个MAC ，其次要加密报文，或许要加密MAC**。这就是说，尽管有某些细小的差异，但讨论的三个协议都会从适当的层得到一个分组，并创建一个加密的新分组 `create a new packet which is authenticated and encrypted` 。如图32.1所示。![](https://img-blog.csdnimg.cn/b4a8707c411043e0ac201e56502b7e53.png)

注意：在加密过程中，可以包括、也可以不包括安全协议的头部和尾部。还应注意，有些协议还需要在被加密的分组中有更多的信息 ` some protocols may need more information in the secured packet` 。图32.1仅表示了一般的思想。

在所有这些协议中的一个共同问题是安全参数 `security parameters` 。即使在图32.1的简化结构中，也间接地表明：**Alice与Bob彼此在发送安全数据之前，需要知道有关一些安全参数的信息**。他们尤其需要知道，用于鉴别和加密/解密的算法。即使可以为世界上的每个人预先确定这些算法，但它们并不像我们将看到的那样，Bob和Alice仍然需要至少两个密钥 `Even if these algorithms can be predetermined for everyone in the world, which they are not as we will see, Bob and Alice still need at least two keys` ：一个用于MAC，一个用于加密/解密。换句话说，这些协议的复杂性不存在于「计算MAC数据和执行加密的方法」。事实上，它存在于「计算MAC数据和实施加密」之前，我们需要在Alice与Bob之间创建一组安全参数。

先粗略看一下，这些协议中的任一个都好像必须有无限多的步骤。因为要发送安全的数据，必须要用一组安全参数，而安全参数的安全交换又需要第二组安全参数 `The secure exchange of security parameters needs a second set of security parameters` ，而第二组安全参数的交换又需要第三组安全参数，等等直至无穷。

为了减少步骤，我们可使用公开密钥加密方法 `public-key cryptography` 。**如果每一方都有一对私钥和公钥，则步骤数可减到一步或二步**。
- 在一步版本中，我们可用会话密钥来生成该MAC、并加密数据和MAC。会话密钥和算法列表可用分组发送，但用公开密钥加密算法加密。
- 在二步版本中，首先用公开密钥加密算法建立安全参数。然后用安全参数去安全地发送真正的数据。

这三个协议中，PGP使用第一种方法，而其余两个协议IPSec和SSL/TLS使用第二种方法。

---
# 32.1 IP层的安全： IPSec
IP层安全 `IP Security, IPSec` 是由因特网工程任务组 `IETF` 设计的、用来为「网络层的分组」提供安全的一组协议。IPSec帮助去生成「经过鉴别的、安全的IP层的分组 `authenticated and confidential packets for the IP layer` 」，如图32.2所示。
 ![图32.2](https://img-blog.csdnimg.cn/9fc11ed3d1e941038baa693185db7284.png)

## 32.1.1 两种方式
IPSec以两种不同的方式运行：传输方式和隧道方式，如图32.3所示。![图32.3 IPSec协议的传输方式和隧道方式](https://img-blog.csdnimg.cn/574b3a42cc7845c2a1237ea1931bb6b7.png)
### 1. 传输方式
在传输方式 `transport mode` 下，IPSec保护「从传输层传递到网络层的内容」。换言之，**传输方式保护网络层的有效载荷，有效载荷被封装在网络层中** `the transport mode protects the network layer payload, the payload to be encapsulated in the network layer`（？）。注意：传输方式不保护IP头部。即**传输方式不保护整个IP分组，而仅保护来自传输层的分组（此处作为 `IPSec` 有效载荷）**。在这种方式下，对来自传输层的信息增加IPSec的头部与尾部。然后再增加IP头部。

**传输方式通常用于主机到主机（端到端）的数据保护**。发送主机使用IPSec，鉴别和/或加密「来自传输层的有效载荷」，接收主机使用IPSec，检验鉴别 `check the authentication` 和/或解密IP分组、并将它传递给传输层。图32.4说明了这个概念。
![图32.4 传输方式](https://img-blog.csdnimg.cn/81b25bfbdb0a4244b361a651c5cabc02.png)
### 2. 隧道方式
在隧道方式 `tunnel mode` 下，IPSec保护整个IP分组，包括头部。将IPSec加密方法用于整个分组，然后增加一个新的头部，如图32.5所示。

不久将会看到，这个新的IP头部与原来的IP头部有一些不同的信息。**隧道方式通常用于两个路由器之间，或一个主机与一个路由器之间、以及一个路由器与一个主机之间**。如图32.5所示。
![图32.5 隧道方式](https://img-blog.csdnimg.cn/9ce2b6bcf3ca4b66a17948eb946a19a4.png)
换言之，当发送方或接收方不是主机时，我们使用隧道方式。整个原始分组受到保护，不受来自发送方和接收方之间的入侵，就好像整个分组都经过了一个假想的隧道。
## 32.1.2 两种安全协议
IPSec定义了两种安全协议：鉴别头部 `Authentication Header, AH` 协议和封装安全载荷 `Encapsulating Security Payload, ESP` 协议。在IP层提供鉴别和/或加密。

### 1. 鉴别头部协议
**鉴别头部协议用于鉴别源端主机，并用来确保IP分组所携带载荷的完整性，但不提供保密性**。这一协议使用散列函数和一个对称密钥生成报文摘要 `The protocol uses a hash function and a symmetric key to create a message digest` ，并将摘要插入鉴别头部中。根据其运行方式（传输方式或隧道方式），将 `AH` 插入到相应的位置。图32.6表示了在传输方式下，各个字段以及鉴别头部的位置。
![图32.6 传输方式中的鉴别头部](https://img-blog.csdnimg.cn/40680f07d12b497c8cff93a1f57debfa.png)
当由IP数据报携带鉴别头部时，IP头部中协议字段的初始值就替换为值 $51$ 。在鉴别头内部的一个字段（下一个头部字段 `the next header field` ）规定了**协议字段的初始值**（由IP数据报携带的有效载荷类型）。加入鉴别头部的步骤如下：
1. 一个鉴别头部加入到有效载荷中，将鉴别数据字段 `the authentication data field` 的值置为零。
2. 有可能加入填充项，以使总长度适合于特定的散列算法。
3. 散列处理是根据总的分组计算的。然而，只有那些在传输过程中不会改变的IP报头字段，才能包含在报文摘要（鉴别数据）的计算过程中。
4. 将鉴别数据加入到鉴别头部中。
5. 协议字段的值改为 $51$ 后，将IP头部加入。

各个字段简要描述如下：
- 下一个头部 `Next header` 。这个 $8$ 位字段定义了IP数据报所携带的有效载荷类型（TCP、UDP、ICMP、OSPF等）。它与「封装前的IP头部的协议字段」具有相同的功能。换言之，==该过程将「IP数据报中协议字段的值」复制到此字段，并将「新IP数据报中协议字段的值」现在设置为 $51$ ，以表明该分组携带有鉴别头部==。
- 有效载荷长度 `Payload length` 。这个 $8$ 位字段的名称容易使人误解。它定义的并不是有效载荷的长度，而是==定义了以 $4$ 字节的倍数计算的鉴别头部的长度，但它不包括最前面的 $8$ 个字节==。
- 安全参数索引 `Security parameter index, SPI` ：$32$ 位的安全参数索引字段的作用，类似于虚电路的标志符。对于在称为安全关联 `security association`（稍后讨论）的连接期间发送的所有分组，`SPI` 都是相同的。
- 序列号 `Sequence number` 。$32$ 位的序列号为数据报提供排序信息。序列号不允许重复 `The sequence numbers prevent a playback` ，注意：**即使分组是重传的，序列号也不重复**。当达到 $2^{32}$ 时，序列号不再循环计数，这时必须建立新的连接。
- 鉴别数据 `Authentication data` 。最后一项，鉴别数据字段是对整个IP数据报应用哈希函数的结果，但是哈希计算中不包括「在传输过程中发生改变的字段」（比如生存时间）。

### 2. 封装安全载荷
AH协议并不提供保密性，只提供源端鉴别和数据完整性 `The AH Protocol does not provide privacy, only source authentication and data integrity` 。IPSec后来定义了一个可选的、称为封装安全载荷 `Encapsulating Security Payload, ESP` 的协议，**它提供源端鉴别、完整性以及保密性**。ESP增加了一个头部和一个尾部。注意，**ESP的鉴别数据加在分组的末端，这样使计算更容易**。图32.7表示了ESP的头部和尾部的位置。

![图32.7 传输方式中的封装安全载荷](https://img-blog.csdnimg.cn/73f68d3ae7964fc9a618357ceb45691d.png)
当IP数据报携带ESP的头部和尾部时，IP头部中协议字段的值更改为 $50$ 。在ESP尾部内有一个字段（下一个头部字段 `the next-header field` ），保留着协议字段的初始值（IP数据报所携带的载荷类型，比如TCP或UDP）。ESP过程遵循下列步骤：
1. 将ESP尾部加入到有效载荷中。
2. 对有效载荷和尾部进行加密。
3. 加入ESP头部。
4. 使用ESP头部、有效载荷以及ESP尾部来生成鉴别数据。
5. 将鉴别数据加入到ESP尾部的末端。
6. 将协议值改为 $50$ 后，再加入IP头部。

头部和尾部的字段如下： 
- 安全参数索引 `Security parameter index` 。这个 $32$ 位的安全参数索引字段的规定，与AH协议类似。
- 序列号 `Sequence number` 。这个 $32$ 位的序号字段的规定，与AH协议类似。
- 填充 `Padding` 。这个可变长（ $0\sim 255$ 字节）的全 $0$ 字段作为填充使用。
- 填充长度 `Pad length` 。这个 $8$ 位的填充长度字段，定义了填充的字节数。取值范围为 $0\sim 255$ ，最大值很少出现。
- 下一个头部 `Next header` 。这个 $8$ 位的下一个头部字段的定义，与AH协议类似。它与「封装前IP头部中的协议字段」有相同的目的。
- 鉴别数据 `Authentication data` 。最后，鉴别数据字段是对部分数据报使用鉴别方案进行计算所得出的结果 `the result of applying an authentication scheme to parts of the datagram` 。注意AH和ESP中认证数据之间的差异。在AH中，IP头部的一部分包含在认证数据的计算中；在ESP中，情况并非如此。

### 3. IPv4和IPv6
**IPSec同时支持IPv4和IPv6**。但是在IPv6 中，AH和ESP是作为扩展头部的一部分。

### 4. AH与ESP
ESP协议是在AH协议已经使用后设计的。**ESP除了能做AH能做的任何事情外，还能提供额外的功能（保密性）**。问题是，为什么我们需要AH？答案是我们并不需要 `The answer is, We don't` 。但是，AH的实施已经包含在一些商业产品中，这意味着AH仍是因特网的一部分，直至这些产品被淘汰。

### 5. IPSec提供的服务
这里提到的AH和ESP两个协议，可在网络层对分组提供几种安全服务。表32.1显示了每一个协议可用的服务列表。
![表32.1](https://img-blog.csdnimg.cn/276f13984ab74c79b7feacbbe508b6f5.png)
- **访问控制**。在下一节中将会看到，IPSec通过使用安全关联数据库 `SADB` 间接地提供访问控制。当一个分组到达目的端时，如果还没有为该分组建立安全关联，那么就丢弃该分组。
- **报文鉴别**。AH和ESP两者通过使用鉴别数据，提供报文的完整性。一个数据摘要由发送方创建并发送，以供接收方检查。
- **实体鉴别**。要用安全关联和「发送方发送的数据的密钥散列数据摘要」 `keyed-hashed digest` ，对AH和ESP中的数据发送方进行身份鉴别。 
- **保密性**。在ESP中的报文加密提供了保密性，但是AH没有提供保密性。如果需要保密性，我们应使用ESP而不是AH 。
- **避免重放攻击**。在两个协议中，用序列号和一个滑动的接收窗口来防止重放攻击 `replay attack`  。当建立安全关联时，每个IPSec头部都有一个唯一的序列号。序列号从 $0$ 开始增加、直到 $2^{32} - 1$（序列号字段的大小是  $32$ 位）。当序列号到达最大值时，它复位为 $0$ 。同时删除旧的安全关联（见下一节），并建立新的安全关联。为了防止处理重复的分组，IPSec要求接收方使用固定大小的窗口 `To prevent processing of duplicate packets, IPSec mandates the use of a fixed-size window at the receiver` 。接收方固定窗口大小的默认值是 $64$ 。
 
## 32.1.3 安全关联
在引言中提到，三个协议（IPSec、SSL/TLS和PGP）中的每一个，在它运行前必须要一组安全参数。在IPSec中，安全参数的建立是通过一种称为安全关联 `Security Association, SA` 的机制完成的。

因为我们已经知道，IP是一个无连接协议：每个数据报彼此独立。对这种类型的通信，可用下列三种方法之一建立安全关联：
1. 与每个数据报相关的安全参数，可以包含在该数据报中。IPSec的设计者没有可能选用这种方法，因为在每个数据报中都增加安全参数、会带来大量的开销，特别是当数据报在传输过程中被多次分段时。
2. **对每个数据报建立一组安全参数** `A set of security parameters can be established for each datagram` 。这就是说：为了建立安全参数，在传输每个数据报之前，发送方与接收方之间需要交换一组分组。这种方法可能比第一种方法效率更低，IPSec设计者也没有使用。
3. IPSec设计者使用第三种方法。当发送方第一次有一个数据报、要发送给某一特定的接收方时，在发送方与该特定的接收方之间建立一组安全参数。该组安全参数可被保存，用作以后向同一个接收方传输IP分组。


安全关联是IPSec一个很重要的方面。**IPSec用安全关联，将IP无连接协议改进为面向连接的协议**。我们可以将关联认为是连接。我们可以说，==当Alice与Bob一致同意他们之间用一组安全参数，则他们之间已建立了一个逻辑连接（称为关联）==。但是，他们可能不会一直使用此连接。连接建立后，Alice可以今天发送一个数据报，过几天后再发送另一个数据报等等。逻辑连接就在那里，可以发送一个安全的数据报了 `The logical connection is there and ready for sending a secure datagram` 。当然，他们可以中断连接，或者过一会建立一个新的连接（这是一种更安全的通信方法）。

### 1. 一个简单的例子
一个安全关联是一个很复杂的信息组。然而，我们能用一个最简单的情形加以说明。Alice想要利用关联与Bob进行双向通信。Alice要有一个出关联 `outbound association`（用于到Bob的数据报）和一个入关联 `inbound association`（用于来自Bob的数据报），同时Bob也要有相同的关联。在这种情况下，安全关联对于Alice和Bob来说简化为两个小表，如图32.8所示。
 
![图32.8 简单的入和出安全关联](https://img-blog.csdnimg.cn/a234e8a958994d18ac4c97f13a95dd03.png)
图32.8表示了，当Alice需要向Bob发送数据报时，她使用IPSec的ESP协议，用密钥为 $x$ 的SHA-1执行鉴别，而用密钥为 $y$ 的DES执行解密。当Bob需要向Alice发送数据报时，他使用IPSec的AH协议，用密钥为 $z$ 的MD5执行鉴别。注意：**Bob的入关联与Alice的出关联是相同的，其逆亦是**。

如果Alice想向许多人发送消息，而Bob需要接收来自许多人的消息，这一点尤其正确。此外，每个站点都需要有入站和出站SAs，以允许双向通信。换句话说，我们需要一组可以收集到数据库中的SA。
该数据库称为安全关联数据库（SADB）。该数据库可以被视为一个二维表，每一行定义一个SA。通常，有两个SADB，一个入站，一个出站。
### 2. 安全关联敬据库
一个安全关联可能是很复杂的。如果Alice要发送多份报文给多个人，Bob需要接收来自多个人的报文时，这一点尤其正确。另外，每个站点都需要有入关联和出关联，才能允许双向通信。换言之，我们要有一组关联，它们被聚合成为一个数据库。这个数据库称为**安全关联数据库** `secutity association database, SADB` ，该库可认为是二维的表，其中每行定义一个关联。通常有两个SADB： 一个人SADB，另一个出SADB。

### 3. 安全参数索引
为了区别一个关联与另一个关联，用一个称为**安全参数索引** `security parameter index, SPI` 的参数标识每个关联。这个参数与目的地址（出去）或源地址（进入）以及协议（AH或ESP） 结合起来，唯一地定义一个关联。

## 32.1.4 因特网密钥交换
现在我们来解决最后的部分，如何创建SADB。**因特网密钥交换** `Internet key exchange, IKE` 是用于建立SADB中入关联与出关联的一个协议。

IKE创建IPSec中的关联。IKE是在其他三个协议（Oakley、SKEME和ISAKMP） 之上的、一个更复杂的协议，如图32.9所示。
![图32.9 IKE的组件](https://img-blog.csdnimg.cn/ae3e5d20a47b4584b2f594171905a2f3.png)- Oakley协议是由 *Hilarie Orman* 开发的一个协议，它是在 *Diffie-Hellman* 密钥交换方法 `the Diffie-Hellman key-exchange method` 基础上的一个密钥生成协议，但做了一些改进。Oakley是一个无格式的协议，就是说没有规定交换的报文的格式。
- SKEME是由 *Hugo Krawcyzk* 设计的，它是另一个密钥交换协议。它在一个密钥交换协议中，使用公钥加密进行实体鉴别。
- **因特网安全关联和密钥管理协议** `Internet Security Association and Key Management Protocol, ISKAMP` 是由国家安全机构 `NSA` 设计的协议，它具体实现IKE定义的交换。它定义多个分组、协议及参数，允许IKE交换发生在标准化的和格式化的报文中，从而生成安全关联。

可能会问，ISAKMP如何从发送方传送到接收方？这一协议旨在适用于任何基础协议。例如，该分组可以用作网络层或传输层中的有效载荷。当我们使用IPSec时，很自然地，这个数据包被认为是IP协议的有效载荷，且被携带在数据报中。接下来的问题是，携带ISAKMP的数据报如何安全地交换？答案是没有必要（安全交换），在ISAKMP分组中，没有需要加密保护的内容。 
## 32.1.5 虚拟专用网
**虚拟专用网** `virtual private network, VPN` 是一个在大型组织中日益流行的技术，这些组织使用全球互联网、进行组织内部和组织之间的通信，但在内部通信中又必须进行保密。这里讨论VPN ，是因为它将IPSec协议用到IP数据报的安全性上 `it uses the IPSec Protocol to apply security to the IP datagrams` 。
### 1.**专用网**
专用网 `private network` 是为组织机构内部使用而设计的。它允许对共享资源的访问，同时提供保密性。在讨论这些网络之前，先定义两个常用的有关术语：内联网和外部网。
- **内联网** `intranet` 是使用因特网模型的专用网 `private network (LAN)` 。然而，对网络的访问局限于组织机构内部的用户。网络使用针对全球因特网开发的应用程序，如HTTP，并且可能有Web服务器、打印服务器、文件服务器等。
- **外部网** `extranet` 与内联网是相同的，但有一个主要差别：在网络管理员的监控下，组织机构外部的特定群体的用户可以访问某些资源。例如，组织机构可以允许授权的客户查看产品说明书、可用性以及在线订购，大学或学院可以让远程教育的学生在进行口令检查后、接入计算机实验室。

使用因特网模型的专用网必须使用IP地址。有以下三种选择：
1. 可以向因特网管理机构申请一组地址，并在该网络不与因特网连接的情况下使用这些地址。这种策略的好处是：如果将来该组织机构决定连接到因特网，它就能相对容易地做到这一点。然而，这种策略也有一个坏处：地址空间被浪费掉了。
2. 网络可以在不向因特网管理机构申请的情况下使用任何地址。因为网络是独立的，地址无须保持唯一性。然而，这种策略有一个严重的缺陷：用户可能错误地将这些地址混淆为全球因特网的一部分。
3. 为了克服第一种和第二种策略中的问题，因特网管理机构已经保留了三组地址，如表32.2所示。![表32.2 专用网寻址](https://img-blog.csdnimg.cn/cbec901d7215410f8f327d8f2a9f0026.png) 

任何组织机构都能在没有因特网管理机构允许的情况下使用这些地址。任何人都知道这些保留地址是为专用网使用的。它们在组织机构内部是唯一的，但在全球范围内是不唯一的。

路由器不会将分组中的这些地址作为目的地址转发。

### 实现保密性
要实现保密性，组织机构可以使用以下三种策略之一：专用网络、混合网络和虚拟专用网。
专用网络
当路由信息在组织机构的内部时，如果组织机构需要实现保密性，则可使用前面所讨论的专用网络
（private network） 。在单个网点范围内的小型组织机构可以使用单独的 LAN 。组织机构内部的人员可以相互发送数据，对外部而言，内部是安全的。拥有多个网点的大型组织机构可以建立专用的互联网。不同网点的 LAN可以使用路由器和租用线路相互连接起来。换言之，互联网可以由专用 LAN和专用 WAN组成。图32.10表示了一个有两个网点的组织机构的情况。

LAN之间使用路由器和一条租用线路相互连接起来。
![图32.10 专用网络](https://img-blog.csdnimg.cn/debfdc4345d84bcc9089237e80bf64f1.png)
在这种情况下，组织机构建立了一个完全与因特网独立的专用互联网。对于不同网点的主机之间的端到端的通信，组织结构可以采用因特网模型。但是，组织机构没有必要向因特网管理机构申请IP地址。它可以使用专用 IP地址。该组织机构可以使用任何类的 IP地址，可以在内部进行网络和主机地址分配，因为互联网是专用，因此它与因特网中的另一个组织机构的地址重复不会产生任何问题。

混合网络
如今，大多数组织机构都需要在其内部的数据交换中实现保密性。但是，同时它们需要连接到因特网与其他组织机构进行数据交换。一种解决方案是采用混合网络 `hybrid network` 
混合网络允许组织机构拥有自身的专用互联网，同时还能访问因特网。组织机构内部的数据通过专用互联网路由，组织机构间的数据通过因特网路由。图32.11表示了这种情况下的一个例子。

拥有两个网点的组织机构通过一条租用线路，使用路由器 Rl 和 R2将两个网点进行专用连接。它使用路由器 R3和R4将这两个网点连接到因特网。组织机构在两种类型的通信中都使用全局 IP地址，但是目的地址为内部的分组通过路由器 Rl 和R2路由，而目的地址为外部的分组通过路由器 R3和R4路由。
 
图32.11 混合网络
虚拟专用网
专用网络和混合网络都有一个主要的缺陷：费用问题。专用广域网 `WAN` 费用昂贵。连接多个网点，就需要多条租用线路，这意味着要付出高昂的月租费。一种解决
方案是使用因特网来同时解决专用的和公开的通信。一种称为虚拟专用网的技术就允许组织机构使用因特网同时达到以上两个目的。

VPN建立一个专用但是虚拟的网络。说它是专用的，是因为它可以保证在组织机构内部的保密性。说它是虚拟的，是因为它不使用实际的专用 WAN ，这种网络在物理上是公开的，但虚拟为专用的。
图32.12表示了虚拟专用网的思想。路由器 R1 和R2使用 VPN技术保证组织机构的保密性。
 
图32.12 虚拟专用网
 
VPN技术
VPN技术在隧道方式下使用 IPSec来提供鉴别、完整性以及保密性。

隧道技术
为了保证组织机构的保密性和其他安全措施，VPN可以在隧道方式下使用IPSec。在这种方式下，组织机构中每个专用的 IP数据报都封装到另一个数据报中。为了在隧
道技术 `tunneling` 中使用 IPSec，VPN需要使用两组寻址方式，如图32.13所示。
 
图32.13 VPN中的寻址
公共网络（因特网）负责将分组从 Rl 传送到 R2.外部人员无法解密分组的内容，也不能解密源地址与目的地址。解密过程发生在R2 ，它找到分组的目的地址并转发该分组。


---
# 32.2 SSL/TLS
传输层安全提供端到端的应用安全服务，该应用使用可靠的传输层协议，如TCP 。其思
想是为因特网上的事务提供安全服务。例如，当一位顾客在钱购物时，要求下列安全服务：
1.顾客需要确保服务器属于真正的销售商，而不是属于冒充者。顾客不希望将她自己的
信用卡号交给一位冒充者（实体鉴别）。同样的，销售商也需要对顾客进行鉴别。
2.顾客与销售商需要确保报文的内容在传输过程中没有被更改（报文完整性）。
3.顾客与销售商需要确保冒充者截获不到诸如信用卡号之类的敏感信息（保密性）。
当今，在传输层提供安全性最主要的两个协议是安全套接字层（SSL）协议和传输层安全
（TLS）协议。
TSL实际上是 SSL的 IETF版本。我们首先讨论SSL ，然后简要提及 SSL与 TLS 的主要差别。图32.14表示了 SSL和TLS 在因特网模型中的位置。
## 32.2.1 SSL服务
图32.14 因特网模型中 SSL和TLS的位置
设计安全套接层（Secure Socket Layer , SSL） 是为了对来自应用层的数据提供安全和压缩服务。
SSL可接收到来自应用层任何协议的数据，一般典型的是 HTTP协议。来自应用层的数据被压缩（可选的）、被签记和被加密，然后将它们传给可靠的传输层协议如 TCP 。

Netscape在 1994年开发了 SSL ，1995年发布第2版和第 3版。本章讨论SSLv3 ，它对接收到的应用层数据提供了多个服务。
分段
SSL首先将数据划分为等于或小于 214个字节的块。
压缩
在客户和服务器之间协商某一无损压缩方法对每个段进行压缩，这个服务是可选的。
报文完整性
要保持数据完整性，
SSL使用密钥散列函数创建MAC 。
保密性
为了提供保密性，原始数据和MAC使用对称密钥加密方法进行加密。
成帧
给被加密的有效载荷增加一个头部，然后将它传给一个可靠的传输层协议。
## 32.2.2 安全参数
在前一节我们讨论IPSec时，提到交换数据双方的任一方对每一次关联
（SA） 都需要一组
参数。
SSL具有相似的目的，但方法是不同的。没有安全关联，但有密码组和加密的密码一起
组成安全关联。
密码组
对每次 SSL会话，密钥交换、散列和加密算住一起定义密码组
（cipher
suite） 。每个密
码组以 SSL开头后跟密钥交换算法并用 WITH将密钥交换算法与加密算法和散列算撞分开。
例如，
SSL-DHE-RSA -WITH-DES-CBC-SHA
定义 DHE-RSA
（临时的 Diffie-Hellman RSA数字签名）以 DES-CBC作为加密算法进行密
钥交换而 SHA 作为散列算 t击。注意：
DH是固定的 Diffie-Hellman ，
DHE是临时的 Diffie­
Hellman ，而DH-anon是匿名的 Diffie-Hellman 。表 32.3表示了在美国所用的密码组。我们没有
包括那些用于出口的。注意：不是所有的密钥交换算邑（建立报文鉴别和加密的密钥）、加密
算昌和鉴别算法组合包含在密码组列表中。在表中有些算法我们没有定义或讨论过，但为了
完整说明使得读者对密码组有一个总的思想。
表32.3 SSL密码组表
 
安全参数的第三部分时常称为加密的密码。为了报文的完整性和保密性，
SLL需要6个密
码加密的密码，
4个密钥和2个IV 。
客户与服务器需妥有 6个不同的加密的密码。
生成这些密码的加密的过程，如图32.15所示。客户机需要一个用于报文鉴别的密钥，一
个用于加密的密钥和一个用于块加密的密钥。服务器的需要也相同。
SSL要求一个方向上的这
些密钥与另→个方向上的密钥不同。这样，如果一方遭到攻击，另一方不受影响。下面将看
到通过使用一个协商协议生成这些参数。
 
图32.15
SLL中生成密码的加密
1.客户和服务器交换两个随机数，一个是客户生成的，另一个是服务器生成的。
2.客户和服务器用前面讨论过的某一密钥交换算桂交换预主密码
（premaster secret） I
3.对预主密码应用两个散列函数
（SHA-l 和MD5） 生成48位的主密码
（master secret） I
4.对主密码应用预先规定的不同常数和同一组散列函数生成可变长的密码。
# 32.2.3 会话与连接
IP和TCP协议的特性是不同的。
IP是无连接协议，而TCP是面向连接的协议。
IPSec 中的
关联将无连接 IP转换成面向连接的安全协议，而TCP 已是面向连接的。然而 SSL设计者采用二
级连接性的办法：会话
（session） 和连接
（connection） 。两个系统之间的会话是一次关联，
它能持续有很长的一段时间。在一次会话期间，连接可建立和中断若干次。 
在会话建立期间生成的一些安全参数，一直有效直到会话终止（例如，加密组和主密钥）。
有些安全参数对每个连接必须重新生成（或偶尔是可恢复的）
（例如，
6个密码）。
## 32.2.4 四个协议
我们已讨论过 SSL的思想，但没有说明 SSL如何实施它的任务。
SSL在两层上定义了四个
协议，如图32.16所示。记录协议
（Record Protocol） 是承载者，它携带来自其他三个协议的
报文，也携带来自应用层的数据。对传输层，通常是TCP来说，来自记录协议的报文是它的
有效载荷。握手协议
（Handshake Protocol） 向记录协议提供安全参数，它建立一个密码组并
提供密钥和安全参数。它也实施用户对服务器的鉴别，以及如需要的话服务器对用户的鉴别。
改变密码规格协议（ ChangeCi pherS pec Protocol） 用于发出加密密码准备就绪的通知。警告协
议
（Alert Protocol） 用于报告不正常情况。本节将简要讨论这些协议。
应用层
 
图32.16 四个 SSL协议
握手协议
握手协议使用报文协商密码组、实现客户对服务器的鉴别、（如需要）服务器对客户的鉴
别，并通过建立加密密码交换信息。握手用四个阶段完成，如图32.17所示。
 
图32.17 握手协议
改变密码规格协议
我们己看到密码组的协商和加密密码的生成都是在握手协议期间逐步生成的。现在的问
题是，双方向时使用这些安全参数?
SSL规定双方在发送或接收到一个特殊报文（改变密码规
格报文）之前不使用这些参数或密码。这个特殊的报文是在握手协议中交换的、在改变密码
规格协议中定义的。在改变密码规格报文交换前，有价值的仅是悬而未用的列。

警告协议
SSL使用警告协议报告差错和不正常情况，它仅有一种类型的报文，即警告报文。它说明
警告问题以及其程度（缓和的或致命的）。
记录协议
记录协议携带来自上层（握手协议、改变密码规格协议和警告协议或应用层）的报文。
报文被分段和选择性地压缩。通过使用协商的散列算法将MAC增加到压缩报文中。被压缩的
段和MAC用协商的加密算法加密。最后，将 SSL头部加到加密的报文中。图32.18表示了在发
送方这个过程以及在接收方的相反过程。
来自上层协议的有效载荷
 
图32.18 记录协议实施过程
## 32.2.5 传输层安全
传输层安全
（Transport Layer Security , TLS） 是IETF的 SSL版本。两者很相似，但略有
不同。我们在下面强调不同处：
·版本。本节讨论的 SSLv3.0是与TLSv l.O一致的 g
·密码组。
TLS密码组不支持 Fortezza ，
·加密密码。加密密码生成有几种不同的方毯。
TSL 用伪随机数函数（ pseudorandom
function , PRF） 生成主密钥以及密钥资料$
·警告协议。
TLS删除某些警告报文并增加某些新的警告;
·握手协议。某些报文的细节在TSL中已改变$
·记录协议。TLS不用 MAC而用在第 31 章定义的HMAC 。

---
# 32.3 PGP
在应用层提供安全性的协议中一个是
相当好的保密性
（Pretty Good Pri vacy ,
PGP）
协议，
PGP用来生成鉴别的与安全
的电子邮件。图32.19表示了在TCP/IP协
议族中的PGP的位置。
发送电子邮件是一次活动，活动的实
质与前面两节所看到是不同的。在 IPSec
 
图32.19
在TCP/IP协议族中的PGP的位置
 

或SSL中，我们假定双方在他们之间建立一个会话，并在两个方向上交换数据。而在电子邮件
中不存在会话，
Alice与 Bob不可能生成会话。
Alice发送电子邮件给Bob ，而在以后的某一时
间 Bob才阅读该邮件，他可以发送回答或不回答。我们只要讨论单向报文的安全性就可以，因
为 Alice 向 Bob发送报文与 Bob向 Alice发送报文完全是独立的。
## 32.3.1 安全参数
如果电子邮件是一种一次性的活动，那么发送方和接收方如何能确定安全参数为电子邮
件安全使用呢?如果没有会话和没有握手协商加密和鉴别的算法，接收方如何能知道发送方
为每次目的选取哪一种算法?接收方如何能知道所用的加密和鉴别密钥的值呢?
PGP的设计者和开发者 Phil Zimmerman提供了上述问题的一个非常好的解决办毯。要求
安全参数与报文一起送。
在PGP 中，发远方的报文需要包括该报文所用的算法标识符以及密钥的值。
I
## 32.3.2 服务
PGP可按用户要求提供多个服务，一封电子邮件可使用这些服务中一个或多个。
明文
最简单的情况是用明文发选电子邮件的报文（没有服务）。发信人Alice书写一个封邮件发
给接收人Bob。该邮件存储在Bob的邮箱中直到被他检索。
报文鉴别
下一个改进或许是ìJ：Alice在报文上签名，她创建一个报文摘要并用她的私钥在摘要上签
名。当 Bob接收到该报文后，他用 Alice 的公钥验证该报文。这种情况下，需要两个密钥，
Alice需要知道她的私钥，而Bob需要知道Alice的公钥。
压缩
进一步改进是压缩报文和摘要使分组更紧凑，这种改进对安全没有贡献而对减少通信量
带来好处。
一次性会话密钥的保密性
正如我们前面讨论的那样，电子邮件系统中的保密性可用一次性会话密钥的传统加密方
法实现。
Alice可生成一个会话密钥，使用会话密钥加密报文和摘要，
并随报文一起发送密钥
本身。但是，为了保护会话密钥，
Alice用 Bob的公钥加密它。
代码变换
PGP提供的另一种服务是代码变换。大多数电子邮件系统只允许使用 ASCII码的文本。为
了对其他不是ASCII字符提供转换方案，
PGP使用基数为 64的变换。每个发送的字符（加密后）
被变成基数为 64的代码。
分段
在已被转换成基数64的代码后，为了使每个被传输的单元能适应下面电子邮件协议的统
一格式的大小，PGP 允许报文分段。
## 32.3.3 一种设想情形
让我们说明鉴别和保密性两种服务组合的情况。PGP总的思想是假定基于一组人需要彼此信任地交换电子邮件报文。组中的每个人以某种方式知道（具有信任）其他任何人的公钥。按照这个单一的假定，图32.2θ表示了 Alice发送一个己鉴别的和已加密的报文到 Bob的简单情形。
 
图32.20 一个己鉴别的和己加密的电子邮件报文的情形
发送方
在这种设想情形下，Alice的步骤如下：
1.Alice生成一个会话密钥（用于对称的加密/解密） ，并把它与它将要使用的加密钥算法串接在一起，用 Bob的公钥进行加密。然后Alice在加密的结果前面添加公钥加密算蓓的标识符。报文的这个部分包含三个信息：会话密钥、将要使用的对称加密/解密算法和对这个部分已使用的不对称加密/解密算法。
2. a.Alice用公钥签名（散列）算法鉴别报文（电子邮件） ，并用她的私钥加密它，所得到
的结果称为数字签名。Alice在签名前附加公钥标识符（用于加密的）和签名散列算撞标识符
（用于鉴别）。报文的这部分包含签名和二个附加信息：加密算法和散列算法。
b. Alice 将上面生成的三个信息部分与报文（电子邮件）串接在一起，用步骤 1生成的会话密钥加密串接的全部信息。
3. Alice合并步骤 1 和2的结果，（添加适当的 PGP头部）向 Bob发i恙。

接收方：在这种设想情形下Bob在接收到 PGP分组后，其步骤如下：
1. Bob使用他的私钥解密会话密钥和对称密钥算法标识符。
2. Bob使用步骤 l 所得到的会话密钥和算撞解密 PGP报文的其余部分。现在Bob有了报文的内容、用于生成和加密签名的公钥算撞标识符以及用于生成散列报文的散列算法标识符。
3. Bob使用Alice的公钥和PA2定义的算陆解密摘要。
4. Bob使用第2步获得的HA的散列算法生成报文的散列代码。
5. Bob比较第3步解密摘要与第4步散列代码。如果相同，他接收报文，否则，丢弃报文。

## 32.3.4 PGP算法
表32.4表示PGP所用的算法，该表是不完全的，因为新的算法不断在增加。
表32.4 算法
 
## 32.3.5 密钥环
在前面的设想中，我们假定Alice仅仅只向Bob发送报文，但通常并不是如此。Alice可能需要给多个人发送报文。此时，Alice需要一个公钥的密钥环 `key ring` ，环中的每个密钥属于Alice需要通信的每个人。另外，PGP设计者还指定了一个私钥/公钥对的环。一个理由是Alice想要经常更换她的密钥对，另一个理由是Alice可能需要对不同的人分组（朋友、同事等） ，对每组使用不同的密钥对。所以，每个用户需要两个环：一个私钥/公钥对环和其他人的公钥环。图32.21 表示了一个4个人的团体，每个人的私钥/公钥对环以及其他人的公钥环。

图32.21表示了每个公钥环的7个公钥。在该环中的每个人保存其他人的公钥。
 
图32.21 环
例如，Alice有多个属于她的和其他人的私钥/公钥对。注意：每个人可能有多个公钥。两种情况可出现。
1. Alice发送一个报文给团体中某一个人。
a. 她用她的私钥对摘要签名$
b 她用接收方的公钥对一个新生成的会话密钥进行加密：
c.她用会话密钥对报文和摘要进行加密。
2.Alice接收到来自团体中某个人的报文。
a.她用她的私钥解密会话密钥 g
b.她用会话密钥解密报文和摘要 z
c.她用她的公钥认证摘要。

## 32.3.6 PGP证书
为了信任公钥的持有者，在 PGP 组中的每个使用者都需要隐式地或显式地拥有公钥持有者的证书副本。虽然证书可来自认证中心（CA） ，但是，在 PGP 中不要求这个规定。PGP 有它自己的认证系统。

使用 X509证书的协议基于信任度的层次结构。预先定义一个从根到任何证书的信任链。每个用户完全信任在根级（前提）的 CA机构，根对在第二级的一些 CA发出证书，一个第二级 CA对在第三级发出证书，等等。需要被信任的每一方呈现来自树的某一 CA 的一份证书。如 Alice不信任 Bob发出的认证书，她可求助高一级机构直到根级（它对系统运行必须信任）。换言之，存在着从完全信任的CA到一个证书的一条单一路径。

在 PGP中，不需要有CA o 坏中任何一个人都可对环中其他任何人签署一个证书，表示他担保公钥正确。例如 Bob可以为Ted 、Jhon和Anne等签署证书。在 PGP中信任没有层次结构，也没有树。正因为没有层次结构，Ted可从Bob获得一个证书和从 Liz获得另一个证书。如果Alice想要沿着Ted证书的线路，则有二条路径：一条由 Bob 出发，另一条由 Liz 出发。一个引起关注的问题是Alice完全信赖Bob ，但仅部分信赖 Liz。为了获得一个证书，存在完全信任或部分信任的多条路线。在PGP中，证书的介绍者通常称为介绍人（introducer）。

在PGP 中，对于任何对象可以有完全信任或部分信任的多条路径。

信任和合法性
PGP的全部操作是基于介绍人的信任、证书的信任和公钥的合法性。
介绍人信任级
由于没有中央权威机构，显然，如果用户 PGP环中每一个用户必须完全信任其他每一个，则环不能很大。（在实际生活中，我们不可能对认识的每一个人都完全信任）。为了解决这个问题，PGP允许信任有不同级别。级别数大多与实现有关，但为了简单起见，让我们对介绍人指定三级：无信任、部分信任和完全信任。介绍人信任（i ntroducer trust） 级是环中其他介绍人指定的。例如，
Alice可完全信任Bob和部分信任赖Anne ，对John完全不信任。

PGP没有机制去确定介绍人的信任程度，它按用户的想法做出决定。
证书信任级
当 Alice接收到介绍人的一个证书时，她将该证书存储在对象名（已签定的实体）下。证书信任
`certificate trust` 级通常与介绍证书的介绍人的信任级相同。假定Alice完全信任Bob ，部分信任Anne和Janette ，不信任John ，则会发生下列设想的情况。
1.Bob介绍两个证书：一个是Linda的证书（用公钥Kl） ，另一个是Lesley的证书（用公钥
K2） 。Alice存储Linda名下的公钥和 Linder的证书，并指定该证书为完全信任级。
Alice也存储Lesley名下的证书和公钥，并指定该证书为完全信任级。
2. Anee发出一个John的证书（用公钥 K3） 。Alice存储这个证书和John名下的公钥，但她
对这个证书指定部分信任。
3.Janette发出两个证书，一个是John的证书（用公钥K3） ，另一个是 Lee的证书（用公钥
K4） 。Alice存储John名下的证书和Lee名下的证书，每个证书指定部分信任级。注意：现在有
两份John的证书，每一份都是部分信任级。
4. John发出 Liz的证书，Alice可丢弃或保存该证书为不信任级。
密钥合住性
使用介绍人与证书信任级的目的是决定公钥的合住性。
Alice需要了解Bob、John、Liz、Anne等的公钥是否合法。

PGP用一个很简单的办法定义密钥合法性 `key legitimacy` 。一个用户密钥合法性的级是该用户的权重信任级。例如，假设我们对证书指定下列的权：
1. 对不信任的证书，权为0 ，
2. 对部分信任的证书，权为 112 ，
3. 对完全信任的证书，权为 1 。

然后，要完全信任一个实体，Alice需要有一个完全信任的证书、或两个部分信任的证书。例如，在前面假想情况下，由于Anne和 Janette 已介绍过John的证书，每个证书的信任级为 112 ，因此Alice可使用 John的公钥。注意：属于一个实体的公钥的合越性与那个人的信任级别无关。且然 Bob可用 John的公钥发送一个报文给他，但是 Alice不接受John介绍的证书，因为对Alice来说，John是不可信任的。

启动环
可能会问上面讨论问题如何实现。如果没有人为一个完全信任或部分信任的实体发送证书，将会怎样?例如，如果没有人发送 Bob的证书，那么如何确定 Bob公钥的合法性？PGP中，一个信任或部分信任的实体的公钥合法性也可用其他方法确定：
1.Alice直接获得 Bob 的公钥。例如，
Alice与 Bob直接碰面交换写在纸上或台子上的
公钥$
2.如果Alice能识别Bob的语音，贝Ij Alice可打电话获得他的公钥，
3.PGP提出一个较好的解决办法是Bob通过电子邮件发送他的公钥给Alice o
Alice与Bob两
人各自都将该公钥生成一个 16字节的MD与（或一个20字节 SHA-l ）摘要，这个摘要用 8组表
示，每组是4个十六进制数，这称为指纹
（fingerprint） 。然后Alice可通过电话验证指纹。如果
在邮件传输期间，公钥被改动或改变，则两个指纹就不匹配。甚至为了更方便些，
PGP创建
一个字表。表中每一个字代表一个4个数的组合。当 Alice打电话给Bob时.
Bob可发出 8个字
（或 10个字）的声音给Alice o
PGP精心挑选这些字避免重复。例如，如果 sword在表中，则
word就不在表中，
4.PGP不阻止Alice在单一过程中从CA获得Bob的公钥，然后她将该公钥插入公钥环中。
信任网
最后PGP在一组人之间形成信任网
（web of trust） 。如果每个实体向其他实体介绍多个实
体时，那么每个实体的公钥环越来越大。环中的实体彼此可发送它安全的电子邮件。
密钥废除
一个实体需要在自己的公钥环中回收公钥。如果密钥持有者怀疑该密钥不安全（例如，
被窃）或有效期将到。为了废除一个公钥，持有者可以发送一个她自己签名的废除证书。废
除证书必须签用旧的公钥签名，并传播给环中所有使用该公钥的人。

---
# 32.4 防火墙
上述所有安全措施都无法阻止Eve向系统发送有害的报文。使用防火墙可以达到对系统访问进行控制的目的。防火墙（firewall ）是一种安装在组织机构的内部网络与因特网之间的设备（通常是路由器或者计算机）。它用于转发某些分组而过墟掉（不转发）其他分组。图32.22表示一个防火墙。

例如，防火墙可以过捷掉所有目的地址为特定主机或特定服务器（比如 HTTP）的分组。防火墙在组织机构中用来拒绝对特定主机或特定服务的访问。

图32.22 防火墙
防火墙通常划分为分组过捷防火墙和基于代理的防火墙。
## 32.4.1 分组过滤防火墙
防火墙可以用作分组过撞器。它可以根据网络层和传输层的头部信息来转发或阻止分组，
这些头部信息是指：惊和目的 IP地址、源端口和目的端口地址以及协议类型（TCP或者UDP） 。
分组过滤防火墙
（packet-fileter firewall） 是使用过滤表来确定抛弃（不转发）哪些分组的路由器。图32.23表示了这种类型防火墙过撞表的一个例子。

图32.23 分组过滤防火墙

根据图32.23 ，对下列分组进行过滤：
1. 对来自网络 13 1.34.0.0的分组要进行阻止（安全防范）。注意*（星号）意思是"任何一个"
2. 对目标是任何内部TELNET服务器（端口为 23） 的进入分组要进行阻止。
3. 对目标是内部主机 194.78.20.8的进入分组要进行阻止。组织机构只希望该主机作内部
使用 。
4. 对目标是HTTP服务器（端口为 80） 的流出分组进行阻止。组织机构不希望雇员浏览因
特网。 
## 32.4.2 代理防火墙
分组过滤防火墙是基于「在网络层和传输层头部（lP和TCP/UDP）中可利用的信息」进行工作的。然而有时，我们需要基于「报文自身（在应用层）中可利用的信息」进行报文过滤。例如，假设组织机构需要实现以下关于其Web页面的策略：只有那些先前已与公司建立商业联系的
因特网用户、才拥有访问权，同时阻止其他用户的访问。在这种情况下，分组过滤防火墙是行不通的，因为它无益辨别到达TCP端口 80（HTTP） 的不同的分组。检查必须在应用层（使用URL）完成。

一种解决方案是安装一台代理计算机（有时称为应用网关） ，它位于顾客（用户客户端）计算机和公司计算机之间。如图32.24所示。
 
图32.24 代理防火墙

当用户客户端进程发送一份报文时，代理防火墙
`proxy firewall` 运行服务器进程来接收该请求。服务器在应用层打开该分组，查看该请求是否合法。如果请求合法，服务器便以客户端进程的身份将报文发送给公司中实际的服务器。如果不合楼，报文就被抛弃，同时向外部的用户发送一份错误报文。通过这种方式，外部用户的请求在应用层进行了基于内容的过滤。图32.24表示了代理防火墙的实现。
