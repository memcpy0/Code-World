**中间人攻击**又被简称为 **NITM 攻击**，这是一种很有意思的攻击方式。攻击者会把自己的设备放置在网络连接的两台设备中间，以此来监听它们之间的通信，==当然这个中间位置是逻辑上的而不是物理位置==。攻击者就像是一个间谍，**它不断从一个设备接收信息，解读之后再转发给另一个设备**。在这个过程中两个设备之间的通信并没有中断，因此它们**完全不会发觉多了一个“中间人”**。

国内的网络安全行业有一本很经典的图书《白帽子讲 Web 安全》，该书的作者就提到他在进入阿里巴巴之后很快就通过网络嗅探获得了开发总监的邮箱密码。这里面提到的网络嗅探正是利用了中间人攻击技术，这种技术是最受黑客欢迎的技术，因为**它极为简单高效**。

上一章介绍 TCP/IP 协议族模型中第一层的攻击方法，而**这种中间人攻击技术就是利用了模型第二层 ARP 协议**（也有人认为 ARP 协议属于 TCP/IP 协议族模型的第一层）的缺陷。就如下主题展开介绍：
- 中间人攻击的相关理论；
- 使用 Wireshark 的专家系统分析中间人攻击；
- 发起中间人攻击；
- 如何防御中间人攻击。
## 10.1 中间人攻击的相关理论
在上一章发现了某单位网络变慢的原因。不过该单位的网络在平静了一段时间之后却又出现了新的问题，多个用户反映自己的密码被盗。我们通过调查发现，这些被盗的密码属于多种不同的应用，其中既有购物网站，也有电子邮箱，甚至还有该单位用于上传下载文件的 FTP。考虑到受害的用户数量众多，而且这些密码又都分属于不同的应用，所以被钓鱼网站欺骗的可能性较小。我们初步认为这有可能是由于网络内部遭到了中间人攻击造成的。

中间人攻击的目标**并不是交换机**，而是**终端设备**（例如计算机、手机等）。**在每一台终端设备中都有一个 ARP 缓存表**，这个表中保存了一些 IP 地址和 MAC 地址之间的对应关系。

通常应用程序只能通过 IP 地址进行通信，但==在内部网络中使用的交换机却不能识别 IP 地址==。因此每一台终端设备在发送应用程序产生的数据包时，**必须在它里面添加上一个 MAC 地址**。而这个 MAC 地址是哪里来的呢？
### 10.1.1 ARP 协议的相关理论
**互联网可以看作是无数局域网的集合**，我们以自身所处的局域网为例。==每当我们要向外部发送一个数据包的时候，需要首先判断这个数据包是否是发往局域网外部的==，这一点可以通过子网掩码和本机的 IP 地址进行计算，如果是发往本机所在局域网内的主机，那么将数据包直接交给目标主机。如果是发往局域网外部的数据包则需要交给网关，再由网关进行转发。

数据包在局域网内部是无法使用 IP 地址进行通信的，因为**局域网中的连接设备只能识别 MAC（硬件）**。但**应用程序发出的数据包中往往只包含了目标的 IP 地址**，此时就需要**由 ARP 程序来找到数据包目的 IP 地址对应的 MAC 地址**。

在每一台计算机中都存在有一个 **ARP 缓存表**，这个表动态地保存了一些 IP 地址和MAC 地址的对应关系。当计算机接收到一个数据包之后，就会通过 ARP 程序在这个表中查找**包中 IP 地址所对应的表项**，然后根据这个表项在数据包中再添加 MAC 地址。==如果没有在缓存表中找到对应的表项，ARP 程序就会在局域网中进行广播，询问网络中是否存在这样一个 IP 地址==。**如果局域网中有计算机使用了这个 IP 地址，那么它就会回应一个包含了自己 MAC 地址的信息**，这样计算机就可以将这个信息添加到自己的 ARP 缓存中，并**将这个数据包填写好目的 MAC 地址发送输出**。

如果想要更好地了解这个过程，可按照如下步骤进行操作（假设你使用的是一个 Windows 操作系统的主机）。
（1）查看本机的各种信息，例如硬件地址、IP 地址、子网掩码和网关地址（见图 1）。在 Windows 系统中，可以打开一个 cmd 命令行，然后在里面输入命令"ipconfig /all"。 
图 1 查看一下本机的各种信息
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182206359.png)
（2）启动 Wireshark，并在主界面中选中要使用的网卡（见图 2）。
图 2 选中要使用的网卡
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182207564.png)
（3）使用 Wireshark 开始捕获数据包，将“arp”作为过滤器（见图 3）。
图 3 使用“arp”作为过滤器
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182207017.png)
（4）当捕获开始之后，我们可以**使用“arp -a”命令来查看 ARP 缓存中的内容**（见图4）。在这个 ARP 缓存表中，我们可以看到网关主机 192.168.1.1 的硬件地址。
图 4 使用“arp -a”命令来查看 ARP 缓存
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182207164.png)
（5）如图 5 所示，==使用“arp -d”命令来清除 ARP 缓存中的内容。这样做的目的是观察 ARP 协议的请求和应答过程==。**如果 ARP 缓存中已经存在了网关的条目，那么就不会发生这个请求和应答过程了**。
图 5 使用“arp -d”命令来清空 ARP 缓存
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182208466.png)
（6）清空了 ARP 缓存之后，我们再使用浏览器打开一个页面，这时我们的主机就会**在局域网中发送一个 ARP 请求**（见图 6）。
图 6 发送一个 ARP 请求
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182208359.png)
（7）停止数据包的捕获。
（8）由于捕获到了大量与本机无关的 ARP 数据包，因此这里面我们使用一个更为详细的过滤器。在第一步中已经知道了本机的硬件地址为“4c-cc-6a-62-4e-29”，我们以此来建立一个显示过滤器 `eth.addr==4c-cc-6a-62-4e-29 and arp`（见图 7）。
图 7 建立一个显示过滤器
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182209123.png)
（9）应用显示过滤器之后，可以看到**数据包列表面板中包含两种类型的数据包**，分别是 **ARP 请求和 ARP 应答**。ARP 请求的内容是“Who has 192.168.1.1？Tell 192.168.1.104”，这里面的 192.168.1.1 是网关的地址，192.168.1.104 是本机的地址。选择这个数据帧，然后**在数据包信息面板中查看其中的信息**，如图 8 所示。
图 8 ARP 请求数据包的内容
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182209893.png)
- ARP 请求数据帧中的**前面 4 项硬件类型**（Hardware type）、协议类型（Protocol type）、**硬件地址长度**（Hardware size）、协议地址长度（Protocol size）是固定的。
- Opcode 用来表明这个 ARP 数据帧的类型，这个值为 1 表示这是一个请求，为 2 表示这是一个应答。
- Sender MAC address 表示发送方的硬件地址，Sender IP address 表示发送方的 IP地址。
- Target MAC address 表示目标的硬件地址，但**此时发送方是并不知道这个地址的**，所以只能将这个值设置为 00:00:00:00:00:00，表示将这个数据包发送给整个**局域网的全部主机**。
- Target IP address 表示目标的 IP 地址，发送方希望这个 IP 地址的主机回答自己的硬件地址。
 
接着，我们选择下面的这个数据帧，这是一个 ARP 应答，ARP 应答的内容是“192.168.1.1 is at dc:fe:18:58:8c:3b”，如图 9 所示。
图 9 ARP 应答数据包的内容
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182210743.png)
- ARP 应答数据帧中的前面 4 项硬件类型（Hardware type）、协议类型（Protocol type）、硬件地址长度（Hardware size）、协议地址长度（Protocol size）固定的。
- Opcode 的值为 2，用来表明这个 ARP 数据帧的类型为应答。
- Sender MAC address 表示应答方的硬件地址，Sender IP address 表示应答方的 IP 地址。
- Target MAC address 中填写请求方的硬件地址，在我们这个例子中为 4c-cc-6a-62-4e-29。
- Target IP address 表示请求方的 IP 地址。

现在我们回来总结 ARP 的工作流程，ARP 协议的数据包使用数据帧的形式进行封装。当一台主机希望取得某个 IP 地址对应的硬件地址时，就会广播一个请求，目标是本地局域网中的所有计算机。**具体的做法就是将目的以太网地址设置为 00:00:00:00:00:00**，这样目标接收到这个请求后，就会返回一个应答。==而局域网中的其他计算机在接收到这个请求之后，虽然明白这个请求不是发给自己的，但也会将里面的 Sender MAC address 和 Sender IP address 写入自己的 ARP 缓存中==。

下面列出了一些在对 ARP 进行分析时**极为有用的 Wireshark 过滤器**。
- 最简单的 ARP 过滤器就是“arp”。
- 如果希望得到 ARP 的请求，可以使用 `arp.opcode==0x0001` 。
- 如果希望得到 ARP 的应答，可以使用 `arp.opcode==0x0002` 。
- 如果希望获得源地址或者目的地址为 dc:fe:18:58:8c:3b 的数据帧，可以使用 `arp.src.hw_mac== dc:fe:18:58:8c:3b`

上面的几个显示过滤器也可以组合起来使用，如果只希望查看来自 `dc:fe:18:58:8c:3b` 的请求可以使用 `arp.src.hw_mac== dc:fe:18:58:8c:3b && arp.opcode==0x0001` 
## 10.1.2 ARP 欺骗的原理
ARP 协议简单高效，但这个协议存在一个重大的缺陷，就是**这个过程并没任何的认证机制**，也就是说如果一台主机收到 ARP 请求数据包，形如“注意了，我的 IP 地址是 192.168.1.100，我的物理地址是 22: 22: 22: 22: 22: 22，IP 地址 192.168.1.2 在吗，我需要和你进行通信，请告诉我你的物理地址，收到请回答！”的数据包，**但并没有对这个数据包进行任何真伪的判断，无论这个数据包是否真的来自 192.168.1.100，都会将其添加到 ARP 表中**。因此==黑客就可能会利用这个漏洞来冒充网关等主机==。

## 10.2 使用专家系统分析中间人攻击
在这个网络中所有的主机地址都是 192.168.169.0/24，网关地址为 192.168.169.2。我们在这个网络中任选了一台主机进行数据包捕获，在收集一段时间数据之后，将这些数据包保存为 lecture10.pcang。

然后我们打开这个文件开始对其进行分析，文件内容如图 10 所示。
图 10 打开这个文件的内容
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182233530.png)
这个数据包文件中前面的部分都是一些交换机产生的 STP 数据包，这里并没有发现问题。可是从第 13 个数据包开始，我们发现几乎所有的数据包都是 ARP 数据包。这一点就很不正常，因为通过前面的介绍我们已经了解了 ARP 的工作流程，通常一个主机在建立一个连接时，只需要发送一个 ARP 请求，收到一个 ARP 应答。这也就表示**只需要两个 ARP 数据包就可以完成**。如果同时出现了大量的 ARP 数据包，通常是由以下 3 种情况造成的。
- 有攻击者**在利用 ARP 请求对网络主机进行扫描**。
- 有计算机感染了 ARP 病毒并在破坏网络的通信。
- 有攻击者**在利用 ARP 欺骗在发动中间人攻击**。

结合 10.1 节中客户的反映来看，显然是有攻击者在利用 ARP 欺骗在发动中间人攻击的这种可能性是最大的。但仍然需要对其进一步进行分析，找出更确切的证据。

这里==要使用 Wireshark 中的一个强大的智能功能——专家系统==。其实在上面的数据包文件中，不仅仅是我们发现了问题，Wireshark 也同样发现了问题。而且 Wireshark 比起我们来说拥有更大的优势，因为它的处理速度远不是手工可以相比的。

当 Wireshark 在数据包文件中发现了问题之后，就会在左下角显示一个圆形按钮（见图 11），根据问题严重性的不同，这个按钮的颜色也不同。
图 11 Wireshark 中的专家系统
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182235533.png)

点击圆形按钮之后就会弹出 Wireshark 的专家系统窗口，在这个窗口中我们看到这里有一个黄颜色的 Warning（见图 12），里面分成了 5 列，分别为 Packet（类型）、Summary（说明）、Group（组）、Protocol（协议类型）、Count（数量）。
图 12 Wireshark 的专家系统窗口
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182242519.png)

Wireshark 就会给出一个警告，这个警告表示发现了有重复的 IP 地址。信息“Duplicate IP address configured (192.168.169.134)”是通知我们 192.168.169.134 与另外的一个 IP 地址使用了同一个 MAC 地址。这里列出的数据包来自攻击者发出的 ARP 应答。**使用鼠标点击这个 Warning，就可以看到所有包含这个警告的数据包（见图 13）**。
图 13 专家系统窗口警告的数据包
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182242004.png)
Wireshark 的专家系统在提醒我们，**现在 192.168.169.2 和 192.168.169.134 所对应的硬件地址是相同的，都是 00:0c:29:23:1e:f4**。回到数据包列表面板处，我们还可以看到图 14 所示的情形。
图 14 数据包列表面板处的显示
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182243310.png)
这里的 ARP 数据包都是成对出现的，先是第 12 个数据包声明 192.168.169.2 的 MAC 地址是 00:0c:29:23:1e:f4，接着第 13 个数据包又声明 192.168.169.134 的 MAC 地址是 00:0c:29:23:1e:f4。这说明 **00:0c:29:23:1e:f4 主机在同时冒充 192.168.169.2 和 192.168.169.134**，这是在进行**双向欺骗**。在 13 个数据包后面提示了跟专家系统中一样的警告。

由此我们可以得出最后的结论，**网络中 MAC 地址是 00:0c:29:23:1e:f4 此时正在进行中间人攻击**，它已经在计算机 192.168.169.134 和网关 192.168.169.2 之间充当了中间人，**从而监听了所有 192.168.169.134 和外部的通信**，自然也获取了使用 192.168.169.134 主机用户的密码。

我们已经在 Wireshark 的专家系统帮助下找到问题的所在了，那么不妨再来了解一下 Wireshark 专家系统，这对于日后的操作有很大的帮助。**Wireshark 中的专家系统信息保存在解析器中**，专家信息将网络中不正常的数据包分成如下的 4 种。
- Errors：数据包或者解析器错误，用红色表示。
- Warnings：来自 application/transport 的**异常响应**，用黄色表示。
- Notes：来自 application/transport 的**异常响应**，用浅蓝色表示。
- Chats：关于工作流的信息，用蓝色表示。

在数据包捕获过程中，**位于状态栏的左部的专家系统按钮是不可用的**，只有当结束捕获状态之后，专家系统按钮才可以使用，如图 15 所示。
图 15 专家信息系统按钮
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182244592.png)
通过单击这个圆形按钮就可以打开专家系统。如图 16 所示，在专家系统窗口中会显示出各种专家信息数据包，在右下方的显示按钮上单击，可以看到一个过滤器，**这里可以将你不感兴趣的数据包去掉**。
图 16 专家系统窗口
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182244308.png)
本例中使用专家系统检查了 ARP 协议的问题，但目前的专家系统主要用来解决 TCP的通信故障问题。在之后的版本中，**Wireshark 可能会扩展专家系统的功能**。虽然专家系统十分有用，但是在实际工作中我们却不能过度地依赖它，往往还需要进一步验证。

## 10.3 如何发起中间人攻击
正所谓“知己知彼，百战百胜”，前面我们刚刚利用 Wireshark 的专家系统分析了一个中间人攻击的实例。接下来我们来了解一下这种攻击是如何实现的。
## 10.3.1 使用 arpspoof 来发起攻击
现在我们就来**演示一次 ARP 欺骗的过程**，这次欺骗中实现了对目标主机与外部通信的监听。在实例中，我们所使用的主机 Kali Linux 2 中的网络配置如下所示。
- IP 地址：192.168.169.130
- 硬件地址：00:0c:29:12:dd:23
- 网关：192.168.169.2

而我们**要欺骗的目标主机的网络配置**如下所示。
- IP 地址：192.168.169.133
- 硬件地址：00:0c:29:2D:7F:89
- 网关：192.168.169.2

网关的信息如下所示。
- IP 地址：192.168.169.2
- 硬件地址：00:50:56:f5:3e:bb

在正常情况下，我们先来看一下**目标主机的 ARP 表**（见图 17）。
图 17 目标主机的 ARP 表
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182246860.png)
这时的目标主机没有受到任何攻击，所以里面的 ARP 表示正确的，当目标主机上程序要通信的时候，例如访问一个外网地址“www.163.com”的时候，**这个时候会首先将数据包交给网关**，再由网关通过各种路由协议送到“www.163.com”处。

这个网络中设置的网关地址为 192.168.169.2，按照 ARP 表中的对应硬件地址为00:50:56:f5:3e:bb，**这样所有的数据包都发往这个硬件地址了**。现在我们**只需要想办法将目标主机的 ARP 表中的 192.168.169.2 表项修改了即可**，修
改的方法很简单，==因为 ARP 协议中规定，主机只要收到一个 ARP 请求之后，不会去判断这个请求的真伪，就会直接将请求中的 IP 地址和硬件地址添加到 ARP 表中==。如果之前有了相同 IP 地址的表项，就对其修改，这种方式被称为**动态 ARP 表**。

我们使用一种工具来演示这个实例。在 Kali Linux 2 中提供了很多可以实现网络欺骗的工具，以其中最为典型的 arpspoof 来演示一下，首先在 Kali Linux 2 中打开一个终端，输入“arpspoof”就可以启动这个工具（见图 18）。
图 18 在终端中启动 arpspoof
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182249051.png)

这个工具的使用格式为：
```bash
arpspoof [-i 指定使用的网卡] [-t 要欺骗的目标主机] [-r] 要伪装成的主机
```
现 在 我 们 的 主 机 IP 地 址 为 192.168.169.130 ， 要 欺 骗 的 目 标 主 机 IP 地 址 为 192.168.169.133。现在这个网络的网关是 192.168.169.2，所有主机与外部的通信都是通过这一台主机完成的，所以**我们只需要伪装成网关，就可以截获到所有的数据**。那么现在的实验中所涉及的主机包括以下各项。
- 攻击者：192.168.169.130
- 被欺骗主机：192.168.169.133
- 默认网关：192.168.169.2

下面就使用 arpspoof 来完成一次网络欺骗：
```java
root@kali:~# arpspoof -i eth0 -t 192.168.169.133 192.168.169.2
```
执行的过程如图 19 所示。
图 19 正在进行攻击的 arpspoof
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182252900.png)
现在**受到欺骗的主机 192.168.169.133 就会把 192.168.169.130 当作是网关**，从而把所有的数据都发送到这个主机，我们在主机 192.168.169.133 上查看 Arp 表就可以看到，此时**192.168.169.2 与 192.168.169.130 的 mac 地址是相同的**（见图 20）。
图 20 被欺骗主机的 ARP 表
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182252504.png)
现在 arpspoof 完成了对目标主机的欺骗任务，可以截获到目标主机发往网关的数据包。但这里有两个问题，首先 arpspoof 仅仅是会截获这些数据包，并不能查看这些数据包，所以我们还需要使用专门查看数据包的工具，例如现在在 Kali Linux 2 中打开 Wireshark，就可以看到由 192.168.169.133 所发送的数据包了（见图 21）。
图 21 Wireshark 捕获到的数据包
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182253703.png)
但==我们的主机也不会再将这些数据包转发到网关，这样将会导致目标主机无法正常上网==，所以我们需要在主机上开启转发功能。打开一个终端，开启的方法如下所示：
```js
root@kali:~# echo 1 >> /proc/sys/net/ipv4/ip_forward
```
这样我们就**可以将截获到的数据包再转发出去**，被欺骗的主机就仍然可以正常上网，从而无法察觉受到了攻击。

## 10.3.2 使用 Wireshark 来发起攻击
虽然 ARPspoof 是一个非常简单实用的工具，但它却**隐藏了攻击实现的细节**。那么现在我们换到黑客的角度来思考问题，看看他们是如何利用 Wireshark 的。要知道 Wireshark 不仅仅是网络维护者的工具，同样也是黑客手中的强大利器。现在我们就来模拟一下黑客是如何使用 Wireshark 来发起 ARP 欺骗的。

我们在 Kali Linux 2 虚拟机中首先使用“arp -d”清除掉 ARP 表中的内容，然后启动
Wireshark 进行数据包捕获。将显示过滤器设置为 `arp.opcode ==0x0002` 来捕获 ARP 应答（ARP reply）。单击任意一个找到的数据包，数据包详细信息面板中显示的内容如图 22 所示。
图 22 Wireshark 捕获到的数据包
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182254283.png)
思路很简单，**将这里的 Sender MAC address 字段的内容修改为主机的 MAC 地址，将 Sender IP address 字段的内容修改为要冒充的主机的 IP 地址**。然后将这个数据包发送出去。但这仅仅依靠 Wireshark 实现不了的，因为 Wireshark 没有修改和发送数据包的功能。

所以这里我们就在这个数据包信息面板中单击鼠标右键，然后选中“Export Selected Packet Bytes”，将其保存为一个文件，这里起名为 ArpSpoof。
接下来我们使用一个编辑器（任意类型的 16 位编辑器都可以）打开这个 ArpSpoof，然后**将里面的 54:89:98:2e:66:25 替换成为我们主机的 Mac 地址**，**将 192.168.169.134 替换为网关的地址**，最后将其仍然保存为 ArpSpoof。

Kali Linux 2 中提供了一个可以专门用来将文件以数据包发送出去的工具 file2cable，我们使用这个工具将刚刚修改好的 ArpSpoof 发送出去，发送的命令为：
```js
root@kali:~# file2cable -i eth0 -f ArpSpoof
```
好了，这样我们就完成了一次 ARP 欺骗攻击。是不是很简单？后面我们将介绍一些ARP 欺骗的防御机制。

## 10.4 如何防御中间人攻击
目前防御中间人攻击的方法很多，下面介绍了几种比较典型的手段。
### 10.4.1 静态绑定 ARP 表项
因为 **ARP 表中的内容是动态更新的**，每当设备接收到 ARP 数据包时就会修改里面的表项，所以攻击者才可以随心所欲地篡改被害者设备的 ARP 表。例如图 23 中箭头指向的“dynamic”就表示这里面的表项为动态的。
图 23 Wireshark 捕获到的数据包
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182259785.png)
不过，在 ARP 表中除了这种动态表项之外，还有一种不会被修改的静态表项类型
“static”。**考虑到中间人攻击时通常篡改的都是网关的地址，所以我们需要将其 IP 地址和 MAC 地址绑定**。绑定的命令为：
```js
arp -s 网关的 IP 地址 网关的 MAC 地址
```
另外，**交换机上也提供了端口安全机制**，我们可以进行设置，**将端口和设备的 Mac 地址绑定**。这里以华为的设备为例，配置过程如下所示。在配置模式中配置一个端口绑定的 MAC 地址和 IP 地址：
```js
user-bind mac-addr mac-address ip-addr ip-address interface interface-list
```
经过这个设置之后，只有硬件地址为 mac-address，IP 地址为 ip-address 的数据包才可以通过这个端口来使用网络。**不过这个方法并不适合大型网络，因为配置起来工作量过大**。
## 10.4.2 使用 DHCP Snooping 功能
DHCP 是一种可以实现**动态分配 IP 的协议**，目前应用得十分广泛。我们家庭中使用的无线路由就使用这个协议为设备分配 IP 地址。DHCP 监听（DHCP Snooping）是一种 DHCP 安全特性。当**交换机开启了 DHCP-Snooping 后，会对 DHCP 报文进行侦听**，并可以==从接收到的 DHCP Request 或 DHCP Ack 报文中提取并记录 IP 地址和 MAC 地址信息==。然后利用这些信息建立和维护一张 DHCP Snooping 的绑定表，这张表包含了**可信任的 IP 和 MAC
地址的对应关系**。在华为设备中启用 DHCP Snooping 功能的方式如下：
```bash
[Huawei]dhcp snooping enable //全局启用
[Huawei]vlan 2
[Huawei-vlan2]dhcp snooping enable //在 vlan 中启用 snooping 功能
[Huawei-vlan2]quit
```
现在的交换机大都提供了基于 DHCP Snooping 绑定表的 ARP 检测功能，例如在华为中提供了“arp anti-attack”功能，启动该功能的命令为：
```
arp anti-attack check user-bind enable //开启 dhcp snooping 的 arp 检测
arp anti-attack check user-bind alarm enable //开启 dhcp snooping 的 arp 检测告警功能
quit
```
需要注意的是，目前由于网络设备的生产厂家的不同，因此它们的 ARP 检测功能也都有一定的区别，例如思科的设备使用的就是 ARP inspection。
## 10.4.3 划分 VLAN
VLAN（虚拟局域网）是对**连接到的第 2 层交换机端口的网络用户**的逻辑分段，也就是建立了一个虚拟的网络。==每一个 VLAN 中的所有设置都好像连接到了一个虚拟的交换机一样，这样 VLAN 里面的设备就不能接收其他 WLAN 的 ARP 数据包==。通过 VLAN 技术可以局域网中建立多个子网，这样就限制了攻击者的攻击范围。
## 10.5 小结
对第 2 个网络攻击技术——ARP 欺骗技术进行了讲解。**ARP 欺骗技术是中间人攻击的实现基础**，从 ARP 欺骗的原理开始讲解，并在Wireshark 的帮助下对 ARP 欺骗进行了深入的分析。还介绍了 Wireshark 中的强大工具——专家系统的使用方法。最后给出了如何完成 ARP 欺骗，以及如何防御这种攻击的方法。