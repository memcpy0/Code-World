网络安全是一个十分重要的话题，但也是一个十分复杂的问题。各种针对网络的攻击手段层出不穷，对于网络的守护者来说，将这些手段进行分类是一个十分棘手的工作。本书采用了 TCP/IP 协议族中的分层结构对此进行了分类，按照每种攻击所在的层次对其进行归类。因此会按照**链路层、网络层、传输层和应用层**这个顺序来介绍常见的攻击技术。

据统计，目前网络安全的问题有 80%来自于“内部网络”，很多黑客也将攻击目标从单纯的计算机转到了网络结构和网络设计上来。因为**链路层是内部网络通信最为重要的协议**，而交换机正是这一层的典型设备，所以讲解以交换机为例。但==相比起其他网络设备来说，交换机的防护措施往往也是最差的，因此也经常成为黑客攻击的目标==。

就交换机所面临的各种常见攻击手段进行讲解，并给出了具体的解决方法。在这个过程中Wireshark 将会成为你手中最有利的工具，在它的帮助下一点点揭开黑客攻击的神秘面纱。如下主题展开介绍：
- 针对交换机的常见攻击方式；
- 使用 Wireshark 的统计功能分析针对交换机的攻击；
- 使用 macof 发起 **MAC 地址泛洪攻击**；
- 如何防御 MAC 地址泛洪攻击。

# 9.1 针对交换机的常见攻击方式
首先我们先从一个真实的案例来看，图 1 展示了某个单位的网络结构。
图 1 某个单位的网络结构
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307141827852.png)
这个网络在之前一直可以正常运行，但在前些天很多用户突然发现网络速度变得十分缓慢，经过我们的检查没有发现线路方面的问题。但发现每次重启交换机之后，网络速度就会恢复正常。而经过一段时间之后，网络速度就会再次变得缓慢。

到此为止，==我们判断要么是交换机硬件本身出了故障，要么就是交换机遭到了攻击从而无法正常工作==。为了解决这个问题，我们使用另一台交换机替换了原本的交换机，但不久之后仍然出现了网络速度变慢的问题，所以基本确定交换机遭到了攻击。

在前面已经介绍过了交换机的原理，这是一个工作在数据链路层的设备。**它可以识别数据包中的 MAC 地址，但无法识别出里面的 IP 地址**。==交换机中有一个包含了端口和硬件地址对应关系的 CAM 表，目前常见的攻击手段大都是针对 CAM 表的==。下面列出了一些常见的攻击手段。
## 9.1.1 MAC 地址欺骗攻击
由于交换机中的 CAM 表是动态更新的，所以攻击者往往可以通过各种手段对其进行操纵。==一个攻击者就可以通过向交换机发送伪造的数据帧，从而实现对CAM表的修改==。

例如现在局域网中有两个主机，黑客使用的是主机硬件地址为22:22:22:22:22:22，连接到了 FastEthernet0/1，而目标主机硬件地址为 33:33:33:33:33:33，即 FastEthernet0/2。此时交换机中的 CAM 表的内容如表 1 所示。
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307170009167.png)
黑客将数据包中的源 MAC 地址修改为 33:33:33:33:33:33，然后发送到交换机，然后里面的 CAM 表就会显示如表 2 所示。
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307170010960.png)

这样一来，==交换机就会认为目标主机在端口 FastEthernet0/1，从而将所有的数据都发往FastEthernet0/1，黑客就可以截获所有属于目标计算机的通信==。
## 9.1.2 MAC 地址泛洪攻击
交换机有两种工作方式，正常情况下，**交换机会通过 CAM 表对数据包进行转发**，==如果 CAM 表不能工作时，交换机则会将数据包从全部端口转发出去==。因此黑客可以利用工具在短时间制造大量的数据帧发送给交换机，从而==导致 CAM 表爆满，这样交换机就会退化成集线器==。关于这种攻击方式我们将在下一节中给出具体的讲解。
## 9.1.3 STP 操纵攻击
交换机中另外一个隐患来源于生成树协议。==STP 的原理是按照树的结构来构造网络拓扑，消除网络中的环路，避免由于环路的存在而造成广播风暴问题==。STP 允许冗余，但同时确保每一时刻只有一条链路是运行的，并且没有回路出现。由于 **STP 协议中各交换设备是通过交换 BPDU 报文信息传播生成树信息**，而黑客就可以通过发送伪造的 BPDU 报文，控制交换设备的端口转发状态，从而动态地改变网络拓扑结构，并将所有的网络流量劫持。

## 9.1.4 广播风暴攻击
由于**以太网中的部分协议都是以广播形式工作**的，例如地址解析协议（ARP）、动态主机配置协议（DHCP）等，因此交换机在正常情况下也需要对这些数据包进行广播。但这些广播会占用主机资源和网络资源，在遭受黑客攻击时，就会导致广播在网段内被大量复制，占用大量的网络资源，网络性能下降，甚至网络瘫痪，这就是广播风暴攻击。

为了确定交换机受到了哪种威胁，我们决定在用户甲所使用的主机开始捕获数据包。并将捕获到的数据包保存为 SwitchAttack.pcapng。然后对其进行分析以找出问题的所在。
# 9.2 使用 Wireshark 分析针对交换机的攻击
在 Wireshark 中打开了 SwitchAttack.pcapng 文件，我们很快就在这里面发现了问题。在这个文件中开始很正常地出现了一些 ARP 数据包之后，从编号为 83 号的数据包出现了==大量无论是源地址还是目的地址都不属于用户主机的数据包==（见图 2）。
图 2 Wireshark 中出现的奇怪数据包
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307180857534.png)
用户主机的 IP 地址为 192.168.32.132，以第 83 个数据包为例，它却收到了由 86.177.72.125 发往 198.194.117.13 的数据包，**这些数据包无论是源地址还是目的地址都不在本地网络的范围内**。我们又分别在其他用户的主机上进行了数据包捕获，结果发现了同样的问题。
## 9.2.1 统计功能
现在发现网络中出现了大量来历不明的数据包，可是到底出现了多少个数据包呢，这些数据包是否来自同一个源地址，或发向同一个目的地址呢？如果手动地逐个计算的话，显然这是一个十分繁重的重复劳动。好在 Wireshark 中提供了极为强大的网络统计功能，利用这些功能可以对网络活动有一个宏观的了解。在这一节中，介绍Wireshark 在统计方面提供的一些重要工具，它们都位于菜单栏“统计”选项的下拉菜单中（见图 3）。
图 3 Wireshark 中的统计功能菜单
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182147012.png)
当我们可以单击“**捕获文件属性**”来查看当前捕获文件的信息。这里面可以查看当前文件的名称、大小、格式、创建时间、经历时间、使用接口以及各种统计信息（见图 4）。
图 4 捕获文件属性
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182147735.png)

另外，如果需要添加一些自定义信息的话，可以在下面的“捕获文件描述”文本框中输入自定义内容。例如我们希望**记录该数据包文件的内容**就可以**输入注释**，然后单击“保存注释”（见图 5）。
图 5 保存注释功能
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182148092.png)
现在已经了解了当前文件中包含了 49915 个数据包，可是这些数据包都属于哪些类型呢，这个问题可利用统计菜单中的“**协议分级**”来解答（见图 6），它以节点的形式展示了捕获到的数据包中各种不同协议的统计信息。这些协议之间存在包含关系，例如**所有的数据包都需要有 Frame 层**，所以 **Frame 协议的数据包的数量 49915** 就是**全部捕获数据包的数量**，显示按字节百分比的数量就是 100（百分数）。而像 IP 协议可以为 TCP 和 UDP 两种不同的协议提供支持，所以看到 IP 协议类型的数据包总数为 49825，其中 TCP 的有 0 个，UDP 有一个。
图 6 统计菜单中的“协议分级”功能
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182148782.png)
这个比例看起来很不正常，通常情况下我们在网络中看到的数据包大部分都应该是 TCP 和 UDP，而在这个数据包文件中居然完全没有 TCP 和 UDP 协议的数据包，==整整 49915 个数据包全都是单纯的 IP 数据包，并没有实现任何功能，也没有承载数据==。因此它们很有可能都是攻击者恶意构造的数据包。

接下来，再分析这些数据包的来源和目的，这里需要使用到**统计功能的“对话”选项**（见图 7），它开始统计不同主机之间的通信信息。尤其在我们在对服务器和设备之间的信息进行**端对端的分析**时，你就会发现这个功能特别有用。点击了“对话”按钮之后，就会打开“对话”会话窗口，这个窗口如下所示包含了多个选项卡，分别是 Ethernet、IPv4、IPV6、TCP 和 UDP。在这个窗口的右下角有一个“Conversation 类型”，在这个选项中还提供了多种常用的协议类型，我们可以通过对列出的协议进行选择来确定选项卡。
图 7 Wireshark 中的“对话选项卡”
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182149784.png)
- Ethernet 选项卡：如图 8 所示，这个选项卡后面的数字表示在这次数据捕获中出现**硬件地址的数量**，下面的内容是根据**源主机和目的主机的硬件地址**（MAC）来对捕获到的流量进行分类。默认情况下，所有的硬件地址会以“dc:fe:18:58:8c:3b”的形式显示。如果勾选了左下方的“解析名称”单选框，Wireshark 就会将这种地址解析为更容易理解的“厂商品牌+扩展标识符”的形式，例如“Tp-Link_58:8c:3b”。==如果勾选了这个选项之后却没有发生任何的变化，可能是因为在捕获过程中，菜单栏中“视图”→“解析名称”的子菜单中的“解析物理地址”没有被勾选上==。
    图 8 解析名称
    ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182151169.png)

- IPv4 选项卡：根据**源主机和目的主机的逻辑地址**（IPv4）来对捕获到的流量进行分类。后面的数字表示在这次数据捕获中出现逻辑地址的数量。这个地址同样可以使用左下方的“解析名称”单选框（见图 9）。
    图 9 IPv4 选项卡
    ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182150658.png)
- IPv6 选项卡：根据逻辑地址（IPv6）来对捕获到的流量进行分类。
- TCP 选项卡和 UDP 选项卡：这两个选项卡中列出了**设备之间的所有会话**，这些会话基于**通信的 IP 地址和端口的不同**进行分类。需要注意的是，两台设备之间的通话可能有多个，**这些通话就需要通过端口来区分**。有了这两个选项卡可以轻松地查看捕获数据包中所有会话的数量、大小和持续时间。

从“Ethernet 选项卡”中我们看到了在刚刚捕获到的文件中，在不到两分钟的时间里出现了 49825 个**不同源地址和目的地址**之间的会话，而且这些会话都只有一个数据包。这一点显然是极为不正常的，通常来说**一个会话应该包含有多个数据包，这里我们更加确定了这些数据包是攻击者构造的恶意数据包**。

除此之外，我们还发现了另外一个问题，就是在用户甲的计算机上居然可以接收到**网络中其他用户与外界的通信**。这表示==当前交换机已经不能正常对数据包进行转发，而是在广播所有接收到的数据包==。

经过分析之后，我们将发现的所有问题总结为如下 3 点。
（1）网络中出现了大量来历不明的数据包，这些数据包无论是源地址还是目的地址都不在该网络中。
（2）交换机不再对网络中的通信进行转发，而是**将收到的通信进行广播**，所有的主机上都能收到广播的数据包。
（3）所有的这些数据包的**协议类型和长度都是相同的**（见图 10）。
图 10 数据包的协议类型和长度
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182153666.png)

根据以上几点分析，我们最后判断网络之所以变得缓慢，是因为交换机遭到了 MAC地址泛洪攻击。
## 9.2.2 MAC 地址泛洪攻击
MAC 地址泛洪攻击是一种**针对交换机的攻击方式**，目的是**监听同一局域网中用户的通信数据**。前面已经介绍过交换机的工作核心：端口-MAC 地址映射表。这张表中记录了交换机每个端口和与之相连的主机 MAC 地址之间的对应关系。==通常情况下，交换机的每个端口只会连接一台主机，因而在 CAM 表中每个端口只会对应一个 MAC 地址==。

如果在这种一一对应的情况下，交换机就无需担心 MAC 地址泛洪攻击的，因为一台交换机只有几十个端口，这样整个 CAM 表中最多也只有几十个项。==但是由于现在的交换机都使用了级联技术==，也就是 A 交换机可以连接到另一个 B 交换机的级联端口上。这样在 B 交换机的**级联端口**上就会**对应多台主机的 MAC 地址**，从而**在 CAM 表中产生大量的记录**。

但==交换机的缓存有限，因此它的 CAM 表中能保存的内容也是有限的==。而且连接到交换机上的设备也可能经常会更换，所以**交换机无需永远记住所有的端口与 MAC 地址的对应关系**。所以 **CAM 表采用了动态的更新方式**，表中的每一个记录都被设定了一个自动老化时间，如果某个 MAC 地址在一定时间（例如 300 秒）不再出现，那么交换机将自动把该 MAC 地址从地址表中清除。当该 MAC 地址再次出现时，将会被当作新地址处理，从而使交换机可以维护一个精确而有用的 CAM 地址表。**交换机档次越低，交换机的缓存也就越小，能够记住的 MAC 地址数也就越少**。

MAC 泛洪攻击就是**由攻击者通过工具产生大量的数据帧，这些数据帧中的源 MAC地址都是伪造的，而且并且不断变化**。因而交换机将在攻击主机所连接的端口上**产生大量的 MAC 地址表条目**，从而**在短时间内**将交换机的 CAM 地址表填满，直到再无法接收新的条目。

此时对于网络中那些事先没有在交换机的 MAC 地址表中留下记录的主机，**它们之间的数据通信就会全部采用广播的方式进行**，这样虽然并不影响数据的发送和接收，但此时的交换机实质上就是一台集线器，攻击者在网络中的任何一台主机上打开 Wireshark，就可以监听到网络中的这些流量。
## 9.2.3 找到攻击的源头
好了，现在我们已经确定了当前交换机遭到的是 MAC 泛洪攻击，攻击者发送这些数据包的目的就是**用来填满交换机的 CAM 地址表**。我们可以肯定这些数据包**一定是来自于网络的内部**，因为这些数据包的目的 IP 地址多种多样，不可能通过互联网路由到内部网络。

而这些数据包的源 MAC 地址和目的 MAC 都是伪造的，显然也无法以此来找出攻击者的位置。对于攻击的来源，可以从图 11 中了解细节。
图 11 攻击的来源
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182157365.png)

不过，好在我们拥有交换机的控制权，在本案例中使用的交换机为华为 S3700。这款交换机提供了多种有用的功能，查看 CAM 映射表的命令为“display mac-address”。执行这个命令的结果如图 12 所示。
图 12 CAM 映射表的内容
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182157539.png)
这个 CAM 映射表一共分成了 7 列，其中第 1 列“MAC Address”表示 MAC 地址，第5 列“Port”表示交换机的端口。这里面可以看到在 MAC Address 列中有大量的硬件地址，而在 Port 列却只有 Eth0/0/3 一个端口。

根据交换机的原理我们知道，当一个数据包进入到一个端口时，交换机就会将该数据包中的源地址和这个端口的编号写入 CAM 表。而现在的 Port 列却只有 Eth0/0/3 一个端口，这说明大量的不同源 MAC 地址的数据包进入到了交换机的 Eth0/0/3（port 3）。而这些数据包又是攻击者恶意构造的，所以连接到 Eth0/0/3 的主机就是攻击的来源。

事实也正是如此，我们通过交换机端口的连接找到了发起攻击的计算机。这台计算机由于保护不善而被黑客远程控制，并被黑客利用来监听网络中的通信。
## 9.3 使用 macof 发起 MAC 地址泛洪攻击
现在我们已经了解了泛洪攻击的原理，那么你是不是很想知道黑客是如何发起这种攻击的呢，了解黑客的攻击过程可以帮助我们更好地对其防御，下面讲攻击的过程。这里要使用到前面配置的“Basic_net.topo”，打开之后的网络结构如图 13所示。
图 13 网络结构图
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182158043.png)
接下来启动 Kali Linux 2，在这个系统中已经**内置了 macof 工具**。利用这个工具我们可以轻松的发起一个 MAC 地址泛洪攻击。

在 Kali Linux2 中启动一个命令行，然后在里面启动 macof，使用参数 `?` 可以查看这个工具的使用方法（见图 14）。
图 14 macof 的使用方法
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182158958.png)
最简单的方法就是直接输入 macof（见图 15），由于华为 S3700 的 CAM 表很大，所以需要同时开启多个 macof，这样才可以快速将 CAM 表填满。
图 15 macof 的攻击过程
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182159428.png)
交换机在遭到了攻击之后，内部的 CAM 表很快就被填满了。交换机退化成集线器，会将收到的数据包全部广播出去，从而无法正常向局域网提供转发功能。
## 9.4 如何防御 MAC 地址泛洪攻击
根据我们上面的分析可以得出，虽然攻击者可以伪造出大量的数据包来攻击交换机，但==由于攻击者的数据包只能从交换机的某一个端口进入，所以我们可以限制每一个端口对应的 MAC 地址数量即可==。

目前的交换机大都提供了这种功能，我们仍然以 ENSP 中的华为 S3700 交换机为例。在上例中我们已经发现了所有的流量都来自于交换机的 Ethernet0/0/3 端口，那么就可以在这个端口上进行设置，**保证该端口最多可以学习 8 个 mac 地址**，在交换机中进行配置命令如下：
```bash
[Huawei-Ethernet0/0/3] port-security enable
[Huawei-Ethernet0/0/3] port-security mac-address sticky
[Huawei-Ethernet0/0/3] port-security protect-action protect
[Huawei-Ethernet0/0/3] port-security max-mac-num 8
```
完成这个配置之后，我们再次在 Kali Linux 2 系统中启动 macof 进行攻击。攻击进行一段时间之后，我们在交换机中使用 display mac-address 命令来查看它的 CAM 表（见图 16）。
可以看到虽然攻击者依然产生了大量的数据包，但是依然只占用了 CAM 表中的 8 项，因而永远无法达到填满整个 CAM 表的目的。
图 16 当前交换机的 CAM 表
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307182200808.png)

## 9.5 小结
这一章开始了对网络安全的分析之旅。网络安全是一个非常复杂的问题，所以我们按照 TCP/IP 分层的方式，对网络中的常见攻击行为进行了讲解。从最底层的链路层开始讲解，**交换机就是工作在这一层的设备**。围绕交换机面临的典型攻击手段——MAC 泛洪攻击给出了详细的介绍。从一个案例开始，对案例中的数据包文件进行了分析和总结，进一步总结了这种攻击的特点。**最后给出了这种攻击手段的实现和解决方案**。

从下一章开始，在 Wireshark 的帮助下来了解一种网络层的攻击方法：ARP欺骗。