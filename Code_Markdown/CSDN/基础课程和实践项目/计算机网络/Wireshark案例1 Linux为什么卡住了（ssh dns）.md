>**像福尔摩斯一样思考**
>有位读者在豆瓣上评论我的上一本书，说有阅读侦探小说的感觉。我对此并不觉得惊讶，因为用Wireshark排查问题，和侦探破案的思路是一致的。神探福尔摩斯的破案秘诀是“溯因推理”——先观察所有细节，比如鞋根上的泥疙瘩甚至烟灰；然后作出多种推理和假设；接着刨去各种不可能，最后剩下的“无论多么难以置信，肯定没错。”
>
>用Wireshark分析网络包时也类似，我们**先要在网络包中寻找各种线索**，然后**根据网络协议作出推理**，接着刨去人为（有意或无意）掩盖的证据，才能得到最后的真相。尤其是和保密机构打交道的时候，工程师进不了机房，文档也不能公开，所以一切线索只能自己在包里找，**感觉就更像破案了**。

已经有5位读者求助过这个问题。症状看图1，他们通过SSH登录Linux服务器时，输完用户名就卡住了，要等待10秒钟才提示密码输入。这究竟是什么原因导致的呢？
图1
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307071420178.png)
我也是Linux菜鸟，虽然尝试过搜索“sshhang”等关键词，但没找到相关信息。

10秒钟的时间并不算长，吃个薯片喝口咖啡就过去了。但是作为强迫症患者，我还是容不得它的存在，因此向大家演示一下怎样用Wireshark一步步解决这个问题。

首先是抓包，步骤如下。
1.在Linux服务器上启动抓包。
2.从笔记本SSH到Linux服务器，输入用户名并回车。
3.等待10秒左右，直到登录界面提示输入密码。
4.停止抓包。

这样就可以得到**一个涵盖该现象的网络包**了。一般在实验室中没有干扰流量，**不用过滤也可以分析**，不过==最好在做实验时就养成过滤的习惯，以适应生产环境中抓到的包==。

**因为我们是通过SSH协议登录的，所以可以直接用“ssh”来过滤**，如图2所示。**SSH包都是加密了的**，因此我们看不出每个包代表了什么意思，不过这并不影响分析。从图2中可以看到，21号包和25号包之间恰好就相隔10秒。
图2
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307071422279.png)
这两个包之间所发生的事件，可能就是导致这个现象的原因。于是我再用`"frame.number>21&&frame.number<25"`过滤，结果如图3所示。
图3
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307071424149.png)

从图3中可以看到，Linux服务器当时正忙着**向DNS服务器查询10.32.200.23的PTR记录（即反向解析）**，试图**获得这个IP地址所对应的域名**。该IP属于我们测试所用的笔记本，但由于DNS服务器上没有它的PTR记录，所以两次查询都等了5秒钟还没结果，总共浪费了10秒钟。

我们由此可以推出，**这台Linux服务器在收到SSH访问请求时，会先查询该客户端IP所对应的PTR记录**。假如经过5秒钟还没有收到回复，就再发一次查询。**如果第二次查询还是等了5秒还没回复，就彻底放弃查询**。我们甚至可以进一步猜测，如果DNS查询能成功，就不用白等那10秒钟了。

为了验证这个猜测，我在DNS服务器中添加了10.32.200.23的PTR记录，如图4所示，然后再次登录。
图4
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307071425980.png)

这一次果然立即登录进去了。从图5的Wireshark截屏可见，DNS查询是成功的，所以21号包和26号包之间几乎是没有时间停顿的。
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307071427207.png)
明白了DNS查询就是问题的起因，接下来就知道怎么进一步研究了。只要**在Google搜索“sshdns”**，第一页出来的链接都是关于这个问题的。随便挑几篇阅读一下，就**连我这样的Linux初学者都能把这个问题研究透了**。

原来这个行为是定义在“/etc/ssh/sshd_config”文件中的，默认配置是这样的：
```
[root@Linux_Server~]#cat/etc/ssh/sshd_config|grep-iusedns#UseDNSyes
```
改成下面这样就可以解决了，不用去动DNS服务器上的配置：
```
[root@Linux_Server~]#cat/etc/ssh/sshd_config|grep-iusednsUseDNSno
```
我经常说**技能比知识更重要**，这就是例子之一。==学会了使用Wireshark，其他知识也会跟着来的==。
