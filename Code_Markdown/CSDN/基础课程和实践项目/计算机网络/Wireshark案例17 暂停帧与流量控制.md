
### 另一种流控
朋友最近遇到了一桩怪事，他把服务器的网络从千兆改造成万兆，没想到用户纷纷抱怨性能下降。于是他不得不降回千兆，用户们反而感觉性能恢复了。朋友觉得很委屈，不明白是什么原因导致他好心办成了坏事。

改造之后的网络拓扑大体如图1所示。交换机和服务器之间从千兆升到万兆了，而客户端和交换机之间维持千兆不变。
图1
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091710110.png)
我分析了改造前后的网络包。发现当数据从客户端流向服务器时，两者看不出任何差别。但是**当数据从服务器流向客户端时，改造后的重传率明显增加了**。我们可以在Wireshark上点击Analyze菜单，再点击Expert Info看到重传统计，如图2所示。
图2
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091710264.png)

这里要补充说明一下，**只要很少的丢包重传就足以对性能造成巨大影响**。**当局域网中的重传率超过0.1%就值得采取措施了**，快速重传和超时重传的影响很不一样，所以这个经验值仅供参考。假如能降低到零当然最好，但实际上0.01%以下的重传率是很难消除的。

从Wireshark看到重传现象之后，接下来的任务就是找出为什么高带宽反而伴随着更多重传了。我的猜测是**换成万兆之后，服务器的发送速度加快了，但由于客户端还是千兆的，一时消化不了这么多，所以数据就拥堵在交换机上。当交换机的缓冲区被占满时，就不得不把包丢掉**，从而导致总体性能反而不如改造前。
图3
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091712601.png)
网络理论说起来太抽象了，所以我们用图3来辅助理解。水龙头相当于服务器，漏斗相当于交换机。改造前的水龙头流速和漏斗的出口流速保持一致，所以虽然不快但也不至于溢出。把水龙头改造变大之后，其流速超过了漏斗出口的流速，因此过了一段时间水就会溢出漏斗。下次你开车堵在下高架的匝道上时，也可以体验一下相同的拥塞原理。

那像我朋友一样把万兆改回千兆就是对的吗？其实也不一定，假如有10个客户端同时从服务器下载数据，那在服务器上用万兆网络就很合适，**因为这些客户端可以平摊流量，数据就不会拥堵在交换机上**。这相当于在漏斗上再挖9个出水口，也就不会溢出来了。换句话说，**服务器的带宽本来就应该比客户端大才合理，尤其是在客户端特别多的时候**。不过为了避免拥塞，最好设计一种流控机制，**允许交换机在过载时通知服务器发慢一点，即便暂停传输的效果也会比拥塞丢包好**。

IEEE802.3x所定义的“暂停帧”（PauseFrame）就实现了这个功能。当交换机的缓冲区即将被填满时，它可以给服务器发一个暂停帧，让它等待一会再发。这样就**避免了溢出丢包，从而避免了重传**。交换机在等待时间里会继续把缓冲区的数据传给客户端，使负担得以释放。服务器需要等待的时间长度是由暂停帧指定的pause_time指定的。过了等待时间之后，服务器才可以发数据。

**假如交换机缓冲区里的数据提前消化了，它还可以给服务器发一个pause_time为0的暂停帧，告诉服务器无需等待了**。我的实验室机器上抓不到暂停帧，因为它太底层了。好在Wikipedia上有一个例子，是暂停时间为65535 quanta的（每个quanta相当于512比特时间），如图4所示。有兴趣分析这种包的话，也可以到Wireshark官网下载示例包。
图4
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091714132.png)
暂停帧的DestinationMAC地址固定是01-80-C2-00-00-01，所以在不同的环境中看到相同的地址也不要觉得奇怪。另外，**暂停帧可以是双向的，即服务器在必要的时候也可以向交换机请求暂停**。

==在过去几年里，我在不少生产环境中利用暂停帧解决过性能问题。现在FCoE（Fibre Channel over Ethernet）技术似乎有发展的势头，它也需要依赖暂停帧来缓解拥塞，所以相信暂停帧的应用会越来越广泛的==。记住**要在主机和交换机上都相应配好**，否则是不会起效的，配置命令请参照厂商提供的手册。

**从暂停帧的工作原理可知，它适用于相邻设备间的流控**，所以在图1这样的环境中可以工作得很好。但是在图5的环境中，如果你指望它从客户端一路影响到服务器，那就不现实了。**只有TCP层的流控，才能立即作用于整个路径**。
图5
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091715060.png)
