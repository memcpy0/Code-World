@[toc]


如[第2章]()所述，==网络层上的通信是主机到主机（计算机到计算机）==。世界上任一地方的一台计算机需要与任何另一台计算机通信，通常是通过因特网实现。发送计算机所要传输的分组，在到达目的计算机前，可能经过若干个局域网或广域网。

为了这一层的通信，还需要一个**全球寻址**的方案，在第2章中称为**逻辑寻址**。目前用术语**IP地址** `IP address` 表示，它是指「**TCP/IP协议栈的网络层**」**中的逻辑地址**。因特网地址是 $32$ 位长，能给出的最大地址个数是 $2^{32}$ ，在无混淆的情况下，称这些地址为**IPv4地址**或简称为IP地址。

除了IP层其他有关问题外，还需要更多的地址，这激发了称为「IP新的一代」或「**IPv6**」的IP层的一个新设计。在这一版本中，因特网使用 $128$ 位地址，让地址分配更具灵活性，这些地址称为**IPv6地址**。

本文首先学习当前因特网使用的IPv4地址，然后讨论IPv6地址。
```cpp
有关IPv4协议的多数请求评论中, 可找到对IPv4地址的讨论:
760, 781, 791, 815, 1025, 1063, 1071, 1141, 1190, 1191, 1624, 2113
有关IPv6协议的多数请求评论中, 可找到对IPv6地址的讨论:
1365, 1550, 1678, 1680, 1682, 1683, 1686, 1688, 1726, 1752, 1826, 1883, 1884,
1886, 1887, 1955, 2080, 2373, 2452, 2463, 2465, 2466, 2472, 2492, 2545, 2590
NAT的讨论可在下列请求评论中找到:
1361, 2663, 2694
```

---
# 19.1 IPv4地址
**IPv4地址** `IPv4 address` 是一个 $32$ 位地址，它**唯一地、通用地**定义了一个连接在因特网上的设备（例如，主机或路由器）。
- IPv4地址是**唯一的**。唯一指的是每一个地址定义了在因特网上的一个且仅有一个设备。在因特网上的两个设备，永远不会具有同样的IPv4地址。但是，**有一些策略可将一个IP地址暂时指定给一个设备，然后被取消又将该地址指定给另一设备**。此外，**如果在因特网上，一个设备（如路由器、交换机）连接 $m$ 个物理网络，则它需要拥有 $m$ 个地址**。
- IPv4地址是**通用的**，因为这个地址系统必须被「任何一个愿意连接到因特网上的主机」所接受。 
 
## 19.1.1 地址空间
IPv4协议定义了一个**地址空间** `address space` 。地址空间是该协议能用地址的总个数。如果协议使用 $N$ 位定义地址，由于每位可能有两个不同的值 $0$ 和 $1$ ，因而 $N$ 位有 $2^N$ 个地址，所以地址空间是 $2^N$ 。

IPv4使用 $32$ 位地址，这就是说地址空间是 $2^{32}$ 或 $4294967296$（多于四百万）。在理论上，如果没有其他限制，就可有超过四百万个设备连接到因特网上。由于存在限制，实际可使用地址的个数要少一些。

## 19.1.2 标记法
IPv4地址有两种常见的标记法：**二进制标记法** `binary notation` 和**点分十进制标记法** `dotted-decimal notation` 。

### 1. 二进制标记法
在这一标记法中，IPv4地址用 $32$ 位表示。为使可读性更强，常在每 $8$ 位之间插入一个或逗哥空格。每 $8$ 位称为一个字节。因此，IP地址常称为 $32$ 位地址、四个 $8$ 位地址或一个 $4$ 字节地址。下面是一个用二进制标记法表示的IPv4地址的实例。
$$01110101\ 10010101 \ 00011101\ 00000010$$

### 2. 点分十进制标记法
为了使IPv4地址更加简洁、更易阅读，因特网地址常用十进制形式来书写，并用十进制点来分隔这些字节。下面是上述地址的**点分十进制标记法** `dotted-decimal notation` 。
$$117.149.29.2$$

图19.1表示了IPv4地址的二进制标记法和点分十进制标记法。由于每个字节（$8$ 位组）是 $8$ 位，每个点分十进制数的取值范围是 $[0, 255]$ 。
![在这里插入图片描述](https://img-blog.csdnimg.cn/667530bada8f4b51a5aabb234b6f27d9.png)![在这里插入图片描述](https://img-blog.csdnimg.cn/216a34f82f904bdb8f4c9d8859dba747.png)
【例19.1】将下列IPv4地址由二进制标记法转为点分十进制标记法。
a. 10000001 00001011 00001011 11101111
b. 11000001 10000011 00011011 11111111
解：我们可将 $8$ 位组用一个等价的十进制数代替，并添加点来分隔。
a. 129.11.11.239
b. 193.131.27.255

【例19.2】将下列IPv4地址由点分十进制标记法转换为二进制标记法：
a. 111.56.45.78
b. 221.34.7.82
解：将十进制数用等价的二进制数代替：
a. 01101111 00111000 00101101 01001110
b. 11011101 00100010 00000111 01010010

【例19.3】寻找下列IPv4地址的标记法中的差错。
a. 111.56.045.78
b. 221.34.7.8.20
c. 75.45.301.14
d 11100010.23.14.67
解：
a. 首位必须非0 (045)；
b. IPv4地址不能有多于四位；
c. 每个数必须小于等于 255（301在范围外）;
d. 二进制标记法与点分十进制标记法不能混用。

## 19.1.3 分类寻址
IPv4寻址在开始时使用了**类**的概念，这种体系结构称为**分类寻址** `classful addressing` 。虽然这一方案正在逐步被取代，还是简短讨论它，以说明分类寻址的基本原理。

==在分类寻址中，地址空间被划为五类：$A, B, C, D, E$ 。每一类拥有地址空间的某些部分==。当一个地址用二进制标记法或点分十进制标记法给出，我们可从开头的几位求出这个地址所属的类：
- 如果地址用二进制标记法给出，前面的几个位即可告诉我们所属的类。
- 如果地址用点分十进制标记法给出，那么第一字节就定义了类。

这两种方法如图所示：
![在这里插入图片描述](https://img-blog.csdnimg.cn/46c4d5e4f23f434cadafc52142574433.png)
【例19.4】求每个地址的类.
a. **0**0000001 00001011 00001011 11101111
b. **110**00001 10000011 00011011 11111111
c. **14**.23.120.8
d. **252**.5.15.111
解：
a. 第一位是 $0$ ，这是个 $A$ 类地址 `class A address` ；
b. 前三位是 $110$ ，这是个 $C$ 类地址 `class C address` ；
c. 第一个字节是 $14$（在 $0\sim 127$ 之间），这个地址是 $A$ 类；
d. 第一个字节是 $252$（在 $240\sim 255$ 之间），这个地址是 $E$ 类

### 1. 地址类与地址块
==分类寻址存在的一个问题是：每个地址类被分为一个固定数量的地址块，并且每个地址块都具有固定的长度==。如表19.1所示。
![在这里插入图片描述](https://img-blog.csdnimg.cn/6ff52c11c9724519b6b5c79d2d2fb4bd.png)
分析该表。当一个组织机构申请一个地址块时，被允许 $A$ 类、$B$ 类或 $C$ 类中的一个块：
- **$A$ 类地址** `Class A address` 是为那些具有大量的主机或路由器的大型组织机构所设计的；
- **$B$ 类地址** `Class B address` 是为那些可能具有数万台主机或路由器的中型组织机构所设计的；
- **$C$ 类地址** `Class C address` 是为那些具有少量主机或路由器的小型组织机构所设计的。

这种设计的缺点在于：
- $A$ 类地址中**块个数**可能比「几乎所有的组织机构的需要」都要大，这就是说该类中许多地址被浪费掉了。
- $B$ 类**地址块中的地址个数**比「大多数中型组织机构的需要」也太大，因而该类中的许多地址也被浪费掉了。
- 而 $C$ 类**地址块的个数**比「大多数组织机构的需要」又太少。
- 在[【计算机网络】第四部分 网络层(20) IP协议](https://memcpy0.blog.csdn.net/article/details/122375582)中将看到**D类地址** `Class D address` 是为多播而设计的。这类中的每一地址用来定义连接因特网上的一组主机。因特网管理机构错误预测需要 $268\ 435\ 356$ 组，这是永远不会发生的，**这里浪费了太多的地址**。
- 最后，**$E$ 类地址** `Class E address` 是为将来用而保留的，仅有少数几个被使用，这也引起了地址的浪费。

==可以说，在分类寻址中，大部分可用的地址被浪费了==。

### 2. 网络号与主机号
==在分类寻址中，$A, B, C$ 类中的一个IP地址被分为**网络号** `netid` 与**主机号** `hosted`== 。**依照地址类的不同，它们具有不同的长度**。==网络号标志主机（或路由器）所连接到的网络，而主机号标志该主机（或路由器）==。图19.2表示了网络号和主机号的字节，网络号用彩色表示、主机号用白色表示。注意，**$D, E$ 类地址并没有分成网络号与主机号**。
![在这里插入图片描述](https://img-blog.csdnimg.cn/9a37262e6139438db45264d09a92f0e2.png)

在 $A$ 类中，一个字节定义网络号，三个字节定义主机号；在 $B$ 类中，两个字节定义网络号，两个字节定义主机号；在 $C$ 类中，三个字节定义网络号，一个字节定义主机号。

### 3. 掩码（与CIDR）
虽然**分类寻址中网络号和主机号的长度是预先规定的**，但我们也可用连续 $1$ 的串后跟连续 $0$ 的串组成的一个 $32$ 位**掩码** `mask`（也称为**默认掩码** `default mask`）。$A, B, C$ 类的掩码如表19.2所示。**$D, E$ 类没有掩码的概念**：
![在这里插入图片描述](https://img-blog.csdnimg.cn/5adff117ea2740b69cd39d23521d2858.png)
==掩码能帮助我们找到网络号和主机号==。例如对 $A$ 类地址，掩码有 $8$ 个 $1$ ，就是指 $A$ 类任何地址前 $8$ 位定义网络号，后面 $24$ 位定义主机号。

表19.2中最后的列用 $/n$ 的形式表示掩码，在分类寻址中这里是 $n$ 是 $8, 16, 24$ 。这种标记法称为**斜杠标记格式**或**无类域间路由选择** `Classless Interdomain Routing, CIDR` ，**用于无类寻址中**，将在后面讨论。之所以在这里介绍，是因为它也可用于分类寻址中。==后面，我们还将看到，分类寻址是无类寻址的一种特殊情况==。

### 4. 子网化
在分类寻址的时代，已经引入了**子网化** `subnetting` 概念。如果一个组织机构被指派了 $A$ 类或 $B$ 类中的一大块地址，它可以将这些地址划分为几个连续的组 `contiguous groups` ，并赋予每一组给较小的网络（称为**子网** `subnet` ）。特殊情形下，一个子网与邻近子网间有共享地址的部分。**子网化是在掩码中增加 $1$ 的个数**，无类寻址中将看到这一点。

### 5. 超网化
虽然 $A$ 类地址和 $B$ 类地址已几乎用完，但仍有大量要求中等规模的地址块。然而，$C$ 类地址块空间只能容纳最多 $256$ 个地址，无法满足多数组织机构的需要，甚至一个中等规模的组织机构也会需要更多的地址。一种解决问题的方法是**超网化** `supernetting` 。

==在超网化中，一个组织机构能将几个 **$C$ 类块地址**构成更大范围的地址空间==。换言之，将几个网络联合起来构成一个超网 `supernet` 。一个组织机构要申请**一组 $C$ 类地址块**而不是仅仅一个。例如，一个需要 $1 000$ 个地址的组织机构可以申请 $4$ 个 $C$ 类地址块，该组织就可以使用这些地址创建一个超网。

超网化是在（$C$ 类地址的）掩码中减小 $1$ 的个数。例如，一个组织机构需要 $4$ 个 $C$ 类地址块，掩码从 $/24$ 变成 $/22$ 。**在无类寻址中，我们会看到没有超网化的需要** `We will see that classless addressing eliminated the need for supernetting` 。
### 6. 地址耗尽
分类寻址方案的缺陷、加上互联网的快速发展，导致可用地址几乎耗尽。尽管因特网设备个数还是小于 $2^{32}$ 地址空间（当时），我们已耗尽 $A$ 类和 $B$ 类地址，而 $C$ 类地址块对多数中等规模的组织机构来说太小了。减轻这问题的一个解决办法是**无类寻址** `classless addressing` 思想。过时的分类寻址已被无类寻址所取代。

## 19.1.4 无类寻址
为了克服地址耗尽，并使更多组织机构接人因特网，设计并开发了**无类寻址**。**在这个方案中，没有类，但地址仍然以块的形式授予** `there are no classes, but the addresses are still granted in blocks` 。
### 1. 地址块
==在无类寻址中，当一个小的或大的实体需要连接因特网时，给它分配一个适合的地址块==。块的大小（地址的个数）按实体大小规模与性质来决定。例如，可以给一个家庭仅分配一个由 $2$ 个地址组成的地址块，给一个大型的组织机构分配由几千个地址组成的地址块。因特网服务提供商 `lSP` 可根据其提供服务的顾客数，分配几十万个或几万个地址组成的地址块。

### 2. 限制条件
为了简化对地址处理，因特网管理机构对无类地址块强加了 $3$ 个限制条件：
1. 块中的地址必须是一个接着一个连续的；
2. 一个块中**地址的个数是 $2$ 的整数次幂** $(1, 2, 4, 8, \dots)$ ；
3. **块的起始地址必须能被块的个数整除** `The first address must be evenly divisible by the number of addresses` 。即块的起始地址最右边几位是连续的 $0$ 。

【例19.5】图19.3表示，给一个小型商业公司分配一个由 $16$ 个地址组成的地址块，用二进制标记法和点分十进制标记法表示。
![图 19.3 分配给一个小型组织机构 16个地址的块](https://img-blog.csdnimg.cn/d4568b7f8ce644b083d12a2a3c2f6905.png)
我们可以看见对这个块实施了限制。地址都是连续的，地址的个数是 $2$ 的次幂 $16=2^4$ ，而起始地址可用 $16$ 整除。起始地址转换成十进制数是 $3\ 440\ 387\ 360$ 。当它被 $16$ 除，商是 $215\ 024\ 210$ 。
### 3. 掩码
定义块地址的一个较好的方法是，**选择块中任一地址和掩码** `select any address in the block and the mask` 。如前所述，一个掩码是 $32$ 位的数，其中最左边 $n$ 位都是 $1$ ，而最右边 $32-n$ 位都是 $0$ 。然而在无类寻址中，==一个地址块所用的掩码中 $1$ 的位数可取 $0$ 到 $32$ 中任一个值，用斜杠（CIDR标记法）很方便给出这个 $n$ 的值==。

在IPv4寻址中，块地址可用 $x.y.z.t/n$ 来定义，其中 $x . y . z. t$ 定义了一个地址，而 $/n$ 定义掩码。**地址和 $/n$ 可以完全定义整个地址块（起始地址、最后地址和地址个数）**。
- 起始地址：块的起始地址的二进制标记法，可通过设置最右边 $32-n$ 位都是 $0$ 求得。 
- 最后地址：块的最后地址的二进制标记法，可通过设置最右边 $32-n$ 位都是 $1$ 求得。
- 地址个数：块中地址个数是最后地址与起始地址的差加 $1$ ，可简单地用公式 $2^{32- n}$ 表示。

【例19.6】分配给某一小型组织机构一个地址块。我们已知块中一个地址 $205.16.37.39/28$ ，求该块的起始地址？
解：已知地址的二进制表示是 $11001010\ 00010000\ 00100101\ 00100111$ ，如果置最右边 $32-28$ 位都为 $0$ ，则得到块的起始地址 $11001010\ 00010000\ 00100101\  00100000$ 或 $205.16.37.32$ 。这个块的实际情况，如图19.3所示。

【例19.7】求例19.6中的最后地址。
解：已知地址的二进制表示是 $11001010\ 00010000\ 00100101\ 00100111$ ，如果置最右边 $32-28$ 位都为 $1$ ，则得到块的最后地址 $11001010\ 00010000\ 00100101\  00101111$ 或 $205.16.37.47$ 。这个块的实际情况，如图19.3所示。

【例19.8】求例19.6中的地址个数。
解：$n$ 的值是 $28$ ，这就是说地址个数是 $2^{32 -28} =16$ 。

【例19.9】求起始地址、最后地址和地址个数的另一种方法，是用 $32$ 位二进制（或 $8$ 位十六进制）数的掩码表示。当我们编制一个程序去求这些信息时，这特别有用。在例19.5中，$/28$ 可表示为 $11111111\ 11111111\ 11111111\ 11110000$（$28$ 个 $1$ 和 $4$ 个 $0$）时，求
a. 起始地址:
b. 最后地址，
c. 地址个数。
解：
a. 起始地址可用**给定地址与掩码进行与运算**求得，这里与运算是对应位逐位与操作，如
果两位都是 $1$ ，则与操作结果为 $1$ ，否则为 $0$ 。
```cpp
地址: 11001010 00010000 00100101 00100111
掩码: 11111111 11111111 11111111 11110000
起始: 11001010 00010000 00100101 00100000
```
b. 最后地址可用**给定地址与掩码的反码进行或运算**求得，这里或运算是对应位逐位或操
作，如果两位都是 $0$ ，则或操作结果为 $0$ ，否则为 $1$ 。
```cpp
给定地址: 11001010 00010000 00100101 00100111
掩码取反: 00000000 00000000 00000000 00001111
最后地址: 11001010 00010000 00100101 00101111
```
c. 地址的个数可由**掩码求反，它的十进制数加 $1$** 求得。
```cpp
掩码取反: 00000000 00000000 00000000 00001111
地址的个数: 15+1=16 0
```

### 4. 网络地址
IP寻址中一个很重要的概念是**网络地址** `network address` 。当一个组织机构已有一个
地址块时，它可自由地给连接到因特网的每一个设备分配地址。然而，==该块的起始地址通常（不是永远）被用作一个特殊地址，不分配给任何设备，它称为网络地址，定义该组织机构的网络，也就是对于全球其他部分来说，它是该组织机构本身的网络==。在后面一章，将会看到起始地址是「路由器用来引导从外部发送到组织的消息的地址」。图19.4表示了给某组织机构分配了一个 $16$ 个地址的块。
![图 19.4 有关地址块205.16.37.32/28的网络配置](https://img-blog.csdnimg.cn/8fd11ebd68ae49dc8c4099cc357b7ab8.png)
该组织机构的网络通过路由器连接到因特网。路由器有两个地址，一个属于**获准的块**，另一个属于**路由器另一端所在的网络**。由于我们不知道连接在另一端网络的有关信息，我们称第二个地址为 $x.y.z.t/n$ 。在组织机构地址块中的 $(205.16.37.32)$ 到 $205.16.37.47$ 的所有指定报文，都直接地或间接地发送到 $x.y.z.t/n$ 。我们之所以说直接或间接，是因为不知道路由器连接的另一端网络的结构。
 
### 5. 层次结构
像我们碰到的其他地址或标识符一样，**IP地址也存在层次结构**。例如，北美电话网络的层次结构有 $3$ 级，最左的 $3$ 个数字定义地区代码，下一个 $3$ 个数字定义交换局代码，最后 $4$ 个数字定义到中心局本地回路的连接。图19.5表示了电话号码的层次结构。
![图 19.5 北美电话网络层次结构](https://img-blog.csdnimg.cn/c912fd257d4248a4a35a1b5ae60cbe62.png)
#### (1) 二级层次结构：没有子网化
==当没有划分子网时，IP地址仅能定义二级层次结构==。地址 $x.y.z.t/n$ 的最左边的 $n$ 位定义网络（组织机构的网络)），而最右边的 $32-n$ 定义连接到网络的特定主机（计算机或路由器）。这两个常用术语就是前缀与后缀，即**定义网络部分的地址称为前缀** `prefix` ，**定义主机部分的地址称为后缀** `suffix` 。图19.6表示了IPv4地址的层次结构。==前缀是网络中所有地址公用的，后缀对于不同的设备是不同的==。
![图 19.6 IPv4地址中二级层次结构](https://img-blog.csdnimg.cn/816e81e1b1a24c188e0f5dd8e83e2103.png)
#### (2) 三级层次结构：子网化
一个组织机构被指派一大块地址，它想要分成几个网络（称为子网），划分不同子网的地址。世界的其余部分仍将该组织机构看做是一个实体，但其内部有几个子网。==所有消息都被发送到路由器地址，该地址将组织连接到互联网的其余部分；路由器将消息路由到适当的子网==。然而，该组织机构需要创建多个较小地址子块，每个子块分配给特定的子网。组织机构有它自己的掩码，每个子网也必须有它自己的掩码。

作为一个例子，假定已给一个组织机构分配的地址块为 $17.12.40.0/26$ ，它有 $64$ 个地址。该组织有 $3$ 个部门，需要该块地址划分为 $32,16, 16$ 个地址的子块。可用下列论点求出新的掩码：
1. 假设第一个子网的掩码是 $/n1$ ，则 $2^{32 -n1}$ 必定是 $32$ ，也就是说 $n1=27$ ；
2. 假定第二个子网的掩码是 $/n2$ ，则 $2^{32-n2}$ 必定是 $16$  ，也就是说 $n2=28$ ；
3. 假定第三个子网的掩码是 $/n3$ ，则 $2^{32 -n3}$ 必定是 $16$ ，也就是说 $n3=28$ 。

这是指具有掩码为 $/26$ 的该组织机构，有三个掩码 $/27, /28, /28$ 。图19.7表示上述情况的一个配置。
![图 19.7 一个子网化网络中的配置和地址](https://img-blog.csdnimg.cn/d242f61f44074aa085b86802a3113ad8.png)
让我们验证一下，是否可以从子网的任一地址中求出子网地址。
a. 在子网 $1$ 中，从地址 $17.12.14.29/27$ 可求出子网的地址，如果我们使用该子网的掩码 $/27$ 的话：

```cpp
主机: 00010001 00001100 00001110 00011101
掩码: /27
子网: 00010001 00001100 00001110 00000000 => (17.12.14.0)
```
b. 在子网 $2$ 中，从地址 $17.12.14 .45/28$ 可求出子网的地址，如果我们使用该子网的掩码 $/28$ 的话：
```cpp
主机: 00010001 00001100 00001110 00101101
掩码: /28
子网: 00010001 00001100 00001110 00100000 => (17.12.14.32)
```
c. 在子网 $3$ 中，从地址 $17.12.14.50/28$ 可求出子网的地址，如果我们使用该子网的掩码 $/28$ 的话：
```cpp
主机: 00010001 00001100 00001110 00110010
掩码: /28
子网: 00010001 00001100 00001110 00101000 => (17.12.14.48)
```
注意：应用网络的掩码 $/26$ ，可以从地址中的任一个地址求出网络地址 $17.12.14. 0/26$ ，这不难证明。

==可以说，通过划分子网，可以得到三级层次结构==。注意，在该例子中，子网前缀的长度对于不同的子网是不同的，如图19.8所示。
![图 19.8 IPv4中三级层次结构](https://img-blog.csdnimg.cn/699491957bb44dfe87f1eb4c58642220.png)

#### (3) 多级层次结构
==**无类寻址结构没有限制层次结构的级数**，一个组织机构可以将已给予的地址块划分为子块，每个子块可依次再划分为更小的子块等==。在ISP中可见到这样的例子——国家级ISP可将已给予的大块地址划分为较小的子块，将它们分配给区域级ISP，而每个区域级ISP将从国家级ISP接收到的地址块，再划分为更小子块，并将它们分配给本地级ISP。每个本地级ISP将从区域级ISP接收到的地址块，再划分为更小的子块，并将每一个子块分配给不同的组织机构。最后，组织机构划分接收到的块，并由它组成多个子网。
### 6. 地址分配
无类寻址的下一个问题是地址分配，地址块如何分配？最终负责地址分配的是称为**因特网名称和编号分配组织** `Internet Corporation for Assigned Names and Addresses, ICANN` 的全球权威机构。但是，**ICANN通常不向个人组织机构分配地址**。它分配一大块地址给ISP，每个ISP依次将已给予它的块划分为较小子块，并将各个子块分配给它的用户。换言之，将一个ISP接收到的一大块地址分配给它的用户。这称为**地址聚合** `address aggregation` ：将多个地址块组成一个块并分配给一个ISP（？）。

【例19.10】给一个ISP分配了起始地址为 $190.100.0.0/16$（$65,536$ 个地址)的地址块，ISP需要按如下要求，给 $3$ 组客户分发这些地址：
1. 第一组有 $64$ 个客户，每个需要 $256$ 个地址；
2. 第二组有 $128$ 个客户，每个需要 $128$ 个地址；
3. 第三组有 $128$ 个客户，每个需要 $64$ 个地址。

设计这些子块，并求出分配后还有多少可用的地址？
解：图19.9表示了该情况。分配给该ISP的地址个数 $65536$ ，由ISP分配的地址个数: $40960$ ，可用地址个数 $24576$ 。
- 组 $1$ ：对于这组，每个客户需要 $256$ 个地址，就是说需要用 $8$ 位定义每一台主机，那么前缀的长度是 $32-8=24$ 。地址是：
	```cpp
	第1个客户: 190.100.0.0/24, 190.100.0.255/24
	第2个客户: 190.100.1.0/24, 190.100.1.255/24
	...
	第64个客户: 190.100.63.0/24, 190.100.63.255/24
	总计= 64 x 256 = 16384
	```
- 组 $2$ ：对于这组，每个客户需要 $128$ 个地址，就是说需要用 $7$ 位定义每一台主机，那么前缀的长度是 $32- 7=25$ 。地址是：
	```cpp
	第1个客户: 190.100.64.0/25, 190.100.64.127/25
	第2个客户: 190.100.64.128/25, 190.100.64.255/25
	...
	第128个客户: 190.100.127.128/25, 190.100.127.255/25
	总计= 128 x 128 = 16384
	```
- 组 $3$ ：对于这组，每个客户需要 $64$ 个地址，就是说需要用 $6$ 位定义每一台主机，那么前缀的长度是 $32- 6 = 26$ 。地址是：
	```cpp
	第1个客户: 190.100.128.0/26, 190.100.128.63/26
	第2个客户: 190.100.128.64/26, 190.100.128.127/26
	...
	第128个客户: 190.100.159.192/26, 190.100.159.255/26
	总计= 128 x 64 = 8192
	```
![图19.9 由ISP分配和分发地址的例子](https://img-blog.csdnimg.cn/a2b6f393f7434749855866a1b559360d.png)

## 19.1.5 网络地址转换
想使用因特网的家庭用户和小型业务公司的数量在不断增加。最初，这些用户通过**拨号线路**连接到因特网，这就意味着==他们在一段特定的时间内是连接在因特网上的，一个具有地址块的ISP**动态地为这些用户分配地址**，当一个用户需要肘，就给他分配一个地址==。但现在情况已不同了，家庭用户和小型商业公司能通过**ADSL线路或有线调制解调器**连接到因特网；另外，许多用户并不仅只使用一个地址，因为他们创建了由几台主机组成的小型网络，每台主机都需要一个IP地址。由于地址短缺，这成了一个严重的问题。

对该问题的一个快速解决方案，称为**网络地址转换** `network address translation , NAT` 。**NAT能使用户在内部拥有大量的地址，而在外部只有少量的地址**；而且，**内部通信能使用内部的地址，外部通信能使用外部地址**。

为了将家庭或商业公司内部使用的地址、与因特网上使用的地址相分离，因特网权威组织机构**预留了三组地址作为专用地址** `private addresses` ，如表19.3所示。任何组织机构都能使用这组地址以外的地址，而不必得到因特网权威组织机构的许可。
![表 19.3 专用网络地址](https://img-blog.csdnimg.cn/ac9d81afcc9f479d9ce61aec96ea1f54.png)
大家都知道，**这些预留地址是留给专用网络的**。==在组织机构内部它们是唯一的，但在全世界范围内它们并不唯一== `They are unique inside the organization, but they are not unique globally` 。**路由器不能转发「将这些地址作为目的地址的分组」**。

==通过**一台运行NAT软件的路由器**，站点必须只有一条与全局因特网相连接的链路==。图19.25显示了一个利用NAT实现的简单例子。

如图19.10所示，**专用网络使用专用地址**。将一个网络与全球地址连接起来的路由器，**使用了一个专用地址和一个全球地址**。专用网络相对于因特网的其他部分是透明的，并且「因特网的其他部分」只能看见一台「地址为 $200.24.5.8$ 的NAT路由器」。
![图 19.10 NAT实现](https://img-blog.csdnimg.cn/65a09241cd55416c86d35ee8fe756c90.png)
### 1. 地址转换
所有外发的分组都通过NAT路由器发送出来，该路由器用**全球NAT地址**来替代**分组中的源地址**；所有输入的分组也要通过NAT路由器，该路由器用**相应的专用地址**来替代**分组中的目的地址**（NAT路由器的全球地址）。图19.11说明了地址转换的一个例子。
![图 19.11 NAT中的地址](https://img-blog.csdnimg.cn/4c69f9a70d1345a2a5642b3008a3a589.png)

### 2. 转换表
可能注意到，将源地址转换成外发地址是一件简单的事情 。但是，NAT路由器如何知道「来自因特网的分组的目的地址」呢？可能有数十个或数千个专用IP地址，每个专用IP地址各自属于某台特定的主机。**如果NAT路由器有一个转换表，问题就可以得到解决**。
#### (1) 使用一个IP地址
在最简单的情况下，**一个转换表只有两列：专用地址和外部地址（分组的目的地址）**。==当路由器转换外发分组的源地址时，它同样分析其目的地址（它标志了分组的去向）；当响应从目的地址返回时，路由器利用分组的源地址（作为外部地址）来找出分组的专用地址==。图19.12说明了这种思想。
![图 19.12 NAT地址转换](https://img-blog.csdnimg.cn/b0b20b0d7599434185357707105ef5a9.png)
==在该策略中，通信必须由专用网络 `the private network` 来发起==。前面所描述的NAT机制，要求专用网络发动通信。正如我们所看到的那样，NAT主要由ISP使用，ISP为每个用户分配一个单一的地址。然而，==**用户可能是「一个具有许多专用地址的专用网络」的一员**，这种情况下，与因特网的通信通常总是由用户站点发起的，并使用诸如HTTP、TELNET或FTP这类的客户端程序、访问相应的服务器程序==。例如，当ISP的电子邮件服务器接收到由一个非用户站点发送的电子邮件时，电子邮件就存储在用户邮箱中直到被检索（？）。==如果运用NAT技术，专用网络就不可能为它的网络之外的客户端运行服务器程序==。

#### (2) 运用IP地址池
==因为NAT路由器只有一个全球地址，因而只有一台专用网络主机能访问同样的外部主机==。为了打破这种限制，NAT路由器使用了一种**全球地址池**技术。例如，不是只使用一个全球地址 $(200. 24.5.8)$ ，NAT路由器能使用四个地址 $(200.24.5.8,\ 200.24.5.9,\ 200.24.5.10,\ 200.24.5.11)$ 。在这种情况下，有四台专用网络主机能够同时与同样的外部主机通信，因为**每对地址都定义了一条连接**。然而，还是存在一些不足：在本例中，==不能与同样的目的端建立四条以上的连接；没有一台专用网络主机能同时访问两个外部服务器程序==（如HTTP和FTP）。

#### (3) 同时运用IP地址和端口号
为了**能在专用网络主机和外部服务器程序之间、建立多对多关系**，需要获取转换表中更多的信息。例如，假定在一个专用网络中有两台主机，地址分别为 $172.18.3.1$ 和 $172.18.3.2$ ，需要访问一台地址为 $25.8.3.2$ 的外部主机上的HTTP服务器。==如果转换表有 $5$ 列，而不是 $2$ 列，其中包括**传输层协议的源和目的端的端口号**，这样就可以消除二义性==，在[第23章]()中将讨论端口号。表19.4是这种表的一个示例。
![表 19.4 5列转换表](https://img-blog.csdnimg.cn/eab7dee4b0ce4867871a1246e964bcf9.png)
注意：当来自HTTP服务器的响应返回时，目的地址 $(25.8.3.2)$ 和目的端口号 $(1400)$ 的组合，就确定了应该接收这一响应的内部网络主机。还须注意，==要使这种转换能正常运作，临时端口号 $1400, 1401$ 必须是唯一的==。

### 3. NAT和ISP
==一个服务于拨号客户的ISP，可用NAT技术保存地址==。例如，假定ISP获准 $1000$ 个地址，但有 $100 000$ 个客户。每个客户被指定一个专用网络地址。ISP将输出分组中的 $100 000$ 源地址的每一个地址，转换为 $1000$ 个全球地址中某一个地址，它将输入分组中的全球目的地址、转换为相应的专用地址。图19.13表示了这个概念。
![图 19.13 ISP和NAT](https://img-blog.csdnimg.cn/18eafaffd11e4a37926db6afe067fd98.png)

---
# 19.2 IPv6地址
虽然诸如无类寻址、在[【计算机网络】第四部分 网络层(21) 地址映射、差错报告和多播](https://memcpy0.blog.csdn.net/article/details/122274218)中讨论的动态主机配置协议 `DCHP` 和NAT等，能暂时解决问题，但是因特网地址耗尽依然是长期存在的问题。这个问题与其他诸如「没有对实时音频和视频传输提供资源」、以及「某些应用不提供数据加密与鉴别」等问题一起，促使IPv6协议的提出。本节中将**比较IPv6地址与IPv4地址的结构**。
## 19.2.1 结构
IPv6地址 `IPv6 address` 由 $16$ 个字节（$8$ 位组）组成：它的长度是 $128$ 位。
### 1. 十六进制冒号标记法
为了使地址的可读性更好，IPv6协议指明了**十六进制冒号标记法** `hexadecimal colon
notation` 。在这种标记法中，将 $128$ 位划分为 $8$ 个部分，每个部分为 $2$ 字节。在十六进制标记法中，$2$ 个字节包括 $4$ 个十六进制数字，每 $4$ 个数字用一个冒号分隔开，如图19.14所示。
![图 19.14 IPv4地址用二进制与十六进制冒号标记法](https://img-blog.csdnimg.cn/c11e087d2e4a43dfbc5e2f20ad6b8dc1.png)
### 2. 缩短
即使是用十六进制格式表示，IP地址也非常长，但它的许多数字是 $0$ 。在这种情况下，可以将地址缩短。==一个部分（即两个冒号之间的 $4$ 个数字）的前导零可以省略。只能删除前导零，不能删除尾随零==（图19.15）。使用这种缩短 `abbreviation` 形式，$0074$ 可写为 $74$ ，$000F$ 可写为 $F$ ，而 $0 000$ 可写为 $0$ 。注意：$3210$ 就不能缩短。==如果有几个连续的部分仅包含 $0$ ，则还可再进行缩短。我们可以将所有的 $0$ 移去，而用两个冒号来代替 $0$== 。注意：**这种类型的缩短对一个地址仅能使用一次，如果有两串 $0$ 的部分，则只能有其中的一部分进行缩短**。
![图 19.15 缩短的 IPv6地址](https://img-blog.csdnimg.cn/bd00c35bf046489eadeec04d560d2b19.png)
将缩短地址再扩展开是很简单的，将未缩短的部分对齐，将一些 $0$ 插入进来就可得到原来扩展的地址。
 
【例19.11】将地址 $0: 15:: 1: 12:1213$ 扩展成原来的地址。
解：首先需要将双冒号的左侧与原来模式的左侧对齐，将双冒号的右侧与原来模式的右侧对齐，以插入我们所需要的多个 $0$ 。

```cpp
xxxx: xxxx: xxxx: xxxx: xxxx: xxxx: xxxx: XXXX
   0:   15:         			 1:   12: 1213
```
这就是说，原来地址是

```cpp
0000: 0015: 0000: 0000: 0000: 0001: 0012: 1213
```

## 19.2.2 地址空间
IPv6有非常大的地址空间，有 $2^{128}$ 个可用的地址。==IPv6地址设计者将地址空间划分成多个类，每个地址的一些 `leftmost bits` 称为**类型前缀** `type prefix` ，用来定义它的类==。这个类型前缀是可变长的，但代码设计使得第一部分的代码都没有相同的，这样在给出一个地址时就不会有歧义，就能轻易确定类型前缀。表19.5表示了每一种类型地址的前缀，表中第 $3$ 列表示每一种类型相对于整个地址空间占有多少份额。
![表 19 . 5 IPv6地址的类型前缀](https://img-blog.csdnimg.cn/93c70099abbf4f78949859433aec504e.png)

### 1. 单播地址
**单播地址** `unicast address` 定义一个单独的计算机，发送到单播地址的分组必须传递给这个指定的计算机。IPv6地址协议定义了两种类型的单播地址：**基于地理的地址** ` geographically based address` 和**基于提供者的地址** `provider-based address` 。此处我们讨论第二种类型的地址，第一种类型的地址留给将来定义。

==基于提供者的地址，通常由普通的主机作为一个单播地址使用==，其地址格式如图19.16所示。 
![图 19.16 基于提供者的单播地址前缀](https://img-blog.csdnimg.cn/d432d5fb4d5547dcbc8ebcc6c245dc7d.png)
基于提供者的地址具有如下的一些字段：
- **类型标识符** `type identifier` 。这个 $3$ 位字段定义**这个地址是基于提供者的地址**。
- **注册标识符** `registry identifier` 。这个 $5$ 位字段指出**注册这个地址的机构**，目前已经定义了 $3$ 个注册中心。`INTERNIC`（代码 $11000$ ）是北美的注册中心；`RIPNIC`（代码 $01000$ ）是欧洲的注册中心；`APNIC`（代码 $10100$ ）是亚洲和太平洋国家的注册中心。
- **提供者标识符** `provider identifier` 。这个可变长字段标识**因特网接入提供者**（如 ISP）。对这个字段的推荐长度是 $16$ 位。
- **用户标识符** `subscriber identifier` 。当一个组织机构通过一个提供者接入因特网时，就给它分配一个用户标识符。对这个字段的推荐长度是 $24$ 位。
- **子网标识符** `subnet identifier` 。每一个用户可以有多个不同的子网，而每一个子网可以有不同的标识符。**子网标识符在用户的地区范围内定义一个特定的网络**，对这个字段的推荐长度是 $32$ 位。
- **节点标识符**。最后一个字段定义**连接到子网的节点的标识**。对这个字段的推荐长度是 $48$ 位，使它和以太网使用的 $48$ 位的链路（物理）地址相兼容。将来这个链路地址可能会和节点的物理地址相同。
 
### 2. 多播地址
**多播地址** `multicast address` 用于定义一组主机而不仅是一个主机。发送给多播地址的分组，必须传递到该组中的每一个成员。图19.17表示了多播地址的格式。
![图 19.17 IPv6中多播地址](https://img-blog.csdnimg.cn/9633bda167f6415b91736edac3aed505.png)
第二个字段是定义组地址的一个标志：永久的或暂时的。**永久的组地址由因特网管理机构定义，并可在任何时刻对它进行访问**。另一方面，**暂时的组地址只是临时使用**。例如，参加电话会议的系统就可使用暂时的组地址。第三个字段定义组地址的范围，各种范围如图19.17所示。
### 3. 任播地址
IPv6也定义**任播地址** `anycast address` ，它与多播地址一样也定义一组计算机。然而，发送到任播地址的分组必须传递给**该组成员中的一个且仅有一个**，即最近的一个（具有最短路径的一个）。虽然任播地址的定义还存在争议，==一种可能的用法是，对于一个「覆盖了因特网中大范围逻辑区域的ISP」的所有路由器，指定一个任播地址。ISP以外的路由器，将发送给ISP的数据包传递到最近的这个ISP的路由器==。**没有块会被分配给任播地址** `No block is assigned for anycast addresses` 。

### 4. 保留地址（未指明地址、环回地址、兼容地址、映射地址）
在地址空间中，另一类是**保留地址** `reserved address` 。这类地址以 $8$ 个 $0$ 开始（前缀类型是 $00000000$ ）。这类定义的一些子类，如图19.18所示。
- **未指明地址** `unspecified address` 是用于**当主机不知道它自己的地址时**，它发送查询以便找出其地址。 
- **环回地址** `loopback address` 是**主机用来测试它自己、而不需要连接到网络上**。
- **兼容地址** `compatible address` 用于从IPv4到IPv6的转换（[【计算机网络】第四部分 网络层(20) IP协议](https://memcpy0.blog.csdn.net/article/details/122375582)）。==当一台使用IPv6协议的计算机，要发送报文到另一台使用IPv6协议的计算机，但报文需要通过的网络某一部分仍使用IPv4协议操作时，就需要该地址==。
- **映射地址** `mapped address` 也是用于从IPv4到IPv6的转换，它用于 **「一台己安装了IPv6的计算机」要发送分组到「一台仍使用IPv4协议的计算机」**。
![图 19.18 IPv6中保留地址](https://img-blog.csdnimg.cn/973e46fcd66b4ec8a724e3176f1f717d.png)

### 5. 本地地址
==一个组织机构想要使用IPv6协议，但还没有连接到全球因特网，就要用这种地址==。换言之，**它们提供专用网络地址**。==在该组织机构网络以外，没有人能将报文发送给使用这些地址的节点==。为此目的，定义了两种类型的地址，如图 19.19所示。
 
![图 19.19 IPv6中本地地址](https://img-blog.csdnimg.cn/feb46ed4e5084e74b610f07aeb567183.png)

 
**本地链路地址** `link local address` **用于一个孤立的子网**；而**本地站点地址** `site local address` **用于具有几个子网的站点**。

