有一些技术，人们即便每天都在使用，也未必能意识到它的存在。

DNS就是这样一种技术。
- 当我在浏览器上输入一个域名时，比如 www.example.com ，其实不是根据该域名直接找到服务器，而是先用DNS解析成IP地址，再通过IP地址找到服务器。
- 有时候甚至不用输入任何域名，也会在不知不觉间用到DNS。比如**打开公司电脑，用域账号登录操作系统，就是依靠DNS找到DomainController来验证身份**。

毫不夸张地说，如果有一天突然失去DNS，世界会立即陷入混乱。我家里的笔记本IP为192.168.1.101，DNS服务器IP为106.186.28.239。如果在打开www.example.com的过程中抓了包，就能看到图1所示的解析过程。
图1
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131503097.png)
笔记本：“请问www.example.com的A记录是什么？”
服务器：“是93.184.216.119。”
获得IP之后，笔记本就可以和93.184.216.119建立HTTP连接了。**这个例子中提到的A（Address）记录，指的是从域名解析到IP地址**。如果你经常处理DNS包，还会看到不少其他类型的记录。
```bash
C:\Users\21839>nslookup
DNS request timed out.
    timeout was 2 seconds.
默认服务器:  UnKnown
Address:  10.80.13.1

> help
命令:   (标识符以大写表示，[] 表示可选)
NAME            - 打印有关使用默认服务器的主机/域 NAME 的信息
NAME1 NAME2     - 同上，但将 NAME2 用作服务器
help or ?       - 打印有关常用命令的信息
set OPTION      - 设置选项
    all                 - 打印选项、当前服务器和主机
    [no]debug           - 打印调试信息
    [no]d2              - 打印详细的调试信息
    [no]defname         - 将域名附加到每个查询
    [no]recurse         - 询问查询的递归应答
    [no]search          - 使用域搜索列表
    [no]vc              - 始终使用虚拟电路
    domain=NAME         - 将默认域名设置为 NAME
    srchlist=N1[/N2/.../N6] - 将域设置为 N1，并将搜索列表设置为 N1、N2 等
    root=NAME           - 将根服务器设置为 NAME
    retry=X             - 将重试次数设置为 X
    timeout=X           - 将初始超时间隔设置为 X 秒
    type=X              - 设置查询类型(如 A、AAAA、A+AAAA、ANY、CNAME、MX、
                          NS、PTR、SOA 和 SRV)
    querytype=X         - 与类型相同
    class=X             - 设置查询类(如 IN (Internet)和 ANY)
    [no]msxfr           - 使用 MS 快速区域传送
    ixfrver=X           - 用于 IXFR 传送请求的当前版本
server NAME     - 将默认服务器设置为 NAME，使用当前默认服务器
lserver NAME    - 将默认服务器设置为 NAME，使用初始服务器
root            - 将当前默认服务器设置为根服务器
ls [opt] DOMAIN [> FILE] - 列出 DOMAIN 中的地址(可选: 输出到文件 FILE)
    -a          -  列出规范名称和别名
    -d          -  列出所有记录
    -t TYPE     -  列出给定 RFC 记录类型(例如 A、CNAME、MX、NS 和 PTR 等)
                   的记录
view FILE           - 对 'ls' 输出文件排序，并使用 pg 查看
exit            - 退出程序
```
- PTR记录：**与A记录的功能相反，它能从IP地址解析到域名**。PTR有什么作用呢？比如IT部门发现最近公司里的机器10.32.106.47和YouTube 之间数据流量很大，用nslookup一查PTR记录就知道原来是阿满在上班时间偷看视频了（见图2）。
    图2
    ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131505150.png)
    网络包显示如下（见图3）：
    图3
    ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131506610.png)
- SRV记录：Windows的域管理员要特别关心**SRV记录，因为它指向域里的资源**。比如我想知道我们公司的域nas.com里有哪些DC，只要随便在一台电脑上查询 `_ldap._tcp.dc._msdcs.nas.com` 这个SRV记录就可以了。如果你也想查贵司的DC，请把nas.com改成正确域名即可。图4是查询过程的截图。
    图4
     ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131507883.png)
    网络包显示如下（见图5）：
    图5
    ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131508215.png)
- CNAME记录：**又称为Alias记录，就是别名的意思**。比如我的服务器10.32.106.73同时提供网页（www）、邮件（mail）和地图（map）服务。图6是该服务器在DNS中的配置，其中www的A记录指向了10.32.106.73，还有两个别名记录mail和map指向了www。客户端访问这3个域名时，都会被定向到10.32.106.73上面。
    图6
    ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131508825.png)
    别名是如何起作用的呢？当客户端查询mail.nas.com或者map.nas.com时，DNS服务器通过www.nas.com找到10.32.106.73，然后把结果返回给客户端。图7是访问mail.nas.com时抓的包。
    图7
    ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131509310.png)
    那直接把10.32.106.73配给mail和map可以吗？当然是可以的，但如果某天要改变这个IP地址，就不得不在DNS上修改www、mail和map这3项记录了。
    而在使用别名的情况下，==只要修改www一项的IP就行了，mail和map都没有必要改动==。**别名的使用节省了管理时间**，站长们应该会喜欢这个功能。

了解完DNS的基本功能之后，我们再来看看它的工作方式。

刚才说到我的笔记本在解析www.example.com时用到了DNS服务器106.186.28.239。其实这台服务器非常可疑，因为我查到它属于美国一家私有云提供商，不知道通过什么方式配到我电脑上的。世界上还有很多这样不权威的DNS服务器，就连电信和有线通等宽带提供商的DNS服务器也是不权威的。==所谓“不权威”，并不是指它们一定不值得信任，而是因为它们本身不包含DNS的注册信息==。当收到新的DNS查询时，它们要从权威DNS服务器（属于一个叫ICANN的非营利性组织）那里查到结果，然后再返回给客户端。

从本文的第一个抓包中，我们只知道不权威DNS服务器成功解析了www.
example.com，却不知道它是怎么做到的。有可能是**它收到我的请求之后，悄悄地查询了权威DNS服务器，然后告诉我答案**。这种工作方式称为**递归查询**，其特点是==客户端（我的笔记本）完全依赖服务器（那台可疑的DNS服务器）直接返回结果==。

除了递归之外，还有一种叫**迭代查询**的方式，其特点是客户端先查到根服务器的地址，再从根服务器查到权威服务器，然后从权威服务器查……直到返回想要的结果。

**用dig命令加上“+trace”参数可以强迫客户端采用迭代查询**。图8就是查询的整个过程。可见迭代查询要比递归查询麻烦得多，但最后解析到的结果倒是一致的。
图8
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131513658.png)
这个迭代查询的网络包如图9所示。从中可以看到笔记本192.168.1.101发出了7个查询，才得到最终的结果。
图9
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131514993.png)
如果这两个抓包还不足以说明递归和迭代的差别，我们可以用生活中的例
子来类比。
- 递归查询：老板给我发个短信：“阿满，附近哪个川菜馆最正宗？”我屁颠屁颠地去问我的吃货朋友二胖，二胖又问了他的女友川妹子；川妹子把答案告诉二胖，二胖再告诉我，最后我装作很专业的样子回复了老板。这个过程对老板来说就是递归查询。
- 迭代查询：老板说：“阿满，推荐一下附近的洗脚店呗？”我立即严辞拒绝：“这个我不知道，不过你可以问问公关部的张总。”老板去找到张总，又被指引到销售部的小李，最终从小李那里问到了。这个过程就是迭代查询，因为是**老板自己一步一步地查到答案**。

说完DNS的工作方式，我们再来认识**它的一个很有用的特性**。我的DNS中
有两个叫“Isilon-Cluster”的同名A记录，分别对应着IP地址10.32.106.51和
10.32.106.52。当我连续执行两次“nslookupIsilon-Cluster.nas.com”时，抓到的
网络包如图10所示。
图10
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131515111.png)
可见两次返回的IP地址是一样的，但**顺序却是相反的**。如果我执行第三次nslookup，结果又会跟第一次一样，这就是**DNS的循环工作（round-robin）模式**。

这个特性可以广泛应用于负载均衡。比如某个网站有10台Web服务器，**管理员
就可以在DNS里创建10个同名记录指向这些服务器的IP**。==由于不同客户端查到
的结果顺序不同，而且一般会选用结果中的第一个IP==，所以大量客户端就会**被均衡地分配到10台Web服务器上**。随着分布式系统的流行，这个特性的应用场景将会越来越多，比如本例中的分布式存储设备Isilon。

说了这么多DNS的好话，那它有没有缺点呢？当然有，而且还不少。
- 就像雕牌洗衣粉被周佳牌模仿一样，DNS上也存在山寨域名。比如招商银行的域名是www.cmbchina.com，但www.cmbchina.com.cn和www.cmbchina.cn却不一定属于招行。如果这两个域名被指向外表和招行一样的钓鱼网站，就可能会骗到部分用户的银行账号和密码。
- 如果**DNS服务器被恶意修改**也是很危险的事情。比如登录招行网站时虽然用了正确域名www.cmbchina.com，但由于DNS服务器是黑客控制的，很可能解析到一个钓鱼网站的IP。
- 即便是配了正规的DNS服务器，也是有可能中招的。比如正规的**DNS服务器遭遇缓冲投毒**之后，也会变得不可信。
- DNS除了能用来欺骗，还能当做攻击性武器。著名的**DNS放大攻击**就很让人头疼。下面是我在执行“digANYisc.org”（解析isc.org的所有信息）时抓的包，可见6号包发出去的请求只有25字节（见图11底部的Length:25），而11号包收到的回复却能达到3111字节（见图12底部的Length3111），竟然放大了124倍。
    图11
    ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131520025.png)
    图12
    ![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131520805.png)
    假如在6号包里伪造一个想要攻击的源地址，那该地址就会莫名收到DNS服务器3111字节的回复。利用这个放大效应，黑客只要控制少量电脑就能把一个大网站拖垮了。