有位运维人员跟我讲了一件趣事：他有个客户端连不上某台服务器，但连接其他服务器都没有问题；那台服务器跟其他客户端的通信也很好，唯独遇到这个客户端就不行。这种情况已经不能用排除法来定位根源了，就好像它们天生相克一样。运维团队已经研究了很多天，还是毫无头绪，于是就在客户端抓了个包给我分析。
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091642174.png)

从图1可见，这个连接的确出了问题。具体分析如下。
1. 1号包和2号包是**MAC地址解析过程**。即客户端通过ARP广播，获得了服务器的MAC地址00:15:5d（本文只显示MAC地址的前半部分）。
2. 3、4、5号包是**客户端向服务器发起的三次握手**，此时看起来并没有问题。
3. 6号包是客户端发给服务器的数据，但由于服务器没有响应，所以在7号包重传了一遍。到这一步已经显示出传输问题了。
4. 8号包又是来自服务器的[SYN,ACK]，表明它是4号包的重传。也就是说，从服务器的角度看，**4号包还没有送达客户端，意味着三次握手还没真正完成**。
5. 接下来的包仍然是重传，说明它们根本无法正常通信。

我们能从这个现象中推理出什么呢？至少可以知道3号包能够到达服务器，因此才会有4号包的[SYN,ACK]。**但是5号包却没能到达服务器，因此服务器收不到对4号包的确认，不得不选择重传**。这就很奇怪了，既然3号包可以到达服务器，说明**不存在路由交换或者防火墙方面的障碍**，为什么5号包就到达不了呢？
图2
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091645354.png)
以我过往的经验是无法凭空想象出原因的，只能继续在Wireshark中寻找线索，逐个包分析。先看看图2中的3号包，**是从客户端发到服务器的MAC地址00:15:5d，与ARP中看到的地址一致**。
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091656803.png)
再看图3中4号包的详情，竟然是从服务器的MAC地址ec:b1:d7发出来的，而不是之前看到的那个00:15:5d。**为什么会莫名其妙地出现这个MAC？** 它会带来什么影响？目前还不得而知。
图3
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091701831.png)

再看图4中的5号包，客户端把它发到这个新的MAC地址ec:b1:d7了。难道这就是无法送达的原因吗？我觉得非常有可能。
图4
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091701062.png)

分析到这里，我们可以作出进一步推理。
1. 服务器上的一个IP对应了两个MAC地址，其中00:15:5d能收包，但不知道为什么没发包；而ec:b1:d7能发包却收不到包。我还是第一次看到这样诡异的状况。
2. 客户端的表现也很奇怪。**明明能通过ARP获得服务器的MAC地址（即00:15:5d），但一看到对方的发来的包里MAC有变化**（即变成ec:b1:d7），就立即回复给这个新MAC。一般的主机都是**持续使用缓存在ARP表里的那个老MAC地址的**。
3. 也就是说，这两台设备各自有一个奇怪的特征，单独存在时都不会出问题，但是放到一起就不行了。

我们只要纠正其中一方的行为，问题就能解决了。**运维人员最后选择在客户端启用ARP表，果然问题就消失了**，因为从此客户端只发包给00:15:5d。不过我最感兴趣的还是那台服务器的配置，为什么一个IP会对应两个MAC呢？后来终于拿到了配置信息，==原来服务器上的多个网卡被绑定成一个NIC Teaming，类型为Transmit Load Balancing（TLB）==。TLB的特点就是**收包工作只由一个网卡负责，发包工作则分摊给所有网卡**，如图5所示。也就是说00:15:5d既能收也能发，但ec:b1:d7只能发不能收，所以当客户端把包回给ec:b1:d7的时候就被丢弃了。
图5
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307091703132.png)
像这样隐蔽的问题，**假如没有Wireshark真不知道如何解决**。而有了Wireshark却显得很简单，即使对配置信息一无所知也能迎刃而解。**如果说有什么工具能彻底改善工作体验，我的回答毫无疑问是Wireshark**。