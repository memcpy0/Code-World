回想第1章介绍Wireshark使用过程时的最后步骤，就是将捕获到的数据包保存为文件。现实中很多情况都需要我们这样做。例如我们在网络中发现了一些奇怪的现象，但又无法找出问题的所在。这时就可以将在此期间捕获的数据保存成文件，然后将这个文件交给网络方面的专家进行研究。这时就需要用到 Wireshark 的文件处理功能。

Wireshark 提供了多种功能来实现对文件的保存操作。这一章将围绕以下主题展开：
- **“捕获接口”对话框的输出功能**；
- 环状缓冲区；
- “捕获接口”对话框的其他功能；
- **保存捕获到的数据**；
- **保存显示过滤器**；
- 配置文件的保存。

# 1. 捕获接口的输出功能
在使用 Wireshark 的实例中，如果没有将捕获到的数据包保存起来，那么这些数据包的内容就都保存在一个临时文件中，当你关闭 Wireshark 的时候，系统会询问是否保存这些数据包，如果选择是，它们就会被保存到硬盘中，否则就会被丢弃。

实际上，我们既可以像这样**在数据包捕获操作结束之后来完成保存操作**，也可以**在捕获操作开始之前就指定好保存操作**。下面我们首先来了解在数据包捕获操作开始前就指定好保存选项的设置方法。

首先在菜单栏处依次单击“捕获”→“选项”，然后会弹出一个“Wireshark·捕获接口”的对话框，在这个对话框中有 3 个选项卡，分别为“输入”“输出”和“选项”，如图 1 所示。对文件的管理主要使用后两个选项卡。
图 1 Wireshark 的捕获接口的 3 个选项卡
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307111201509.png)
默认情况下，文件后面的文本框有一段灰色的文字“留空使用临时文件”，这表示 Wireshark 并不会将捕获到的数据包永久保存起来。==但是我们可以指定 Wireshark 将其保存为指定的文件，同时也指定保存的位置和格式==。

单击文件右侧的“浏览”按钮，可以打开一个 Windows 文件管理器，在这个管理器中选择保存的位置并输入文件的名字（后缀名可以是 pcapng 或者 pcap），如图 2 所示。
图 2 在 Wireshark 中指定捕获文件
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307111333861.png)

然后单击“保存”按钮，Wireshark 中支持将捕获到的数据以“pcap-ng”和“pcap”两种形式保存起来，目前 Wireshark 推荐使用“pcap-ng”格式。
但由于 Wireshark 往往会捕获到大量的数据包，尤其是在一个十分繁忙的网络中工作时，可能在很短的时间内，就会得到一个十分巨大的文件。这样在分析时会十分麻烦，有时Wireshark 甚至会无法打开这样巨大的文件（你甚至会发现 Wireshark 停止响应）。

一种有效的方法就是将这些数据包保存到多个文件中，Wireshark 提供了一种智能的保存方法，它可以每经过一段时间就保存为一个文件，也可以每捕获到一定大小的数据就保存成一个文件。

下面我们以用时间分割为例，将每隔 10 秒捕获的数据保存为一个文件，使用的方法为勾选“自动创建新文件，经过…”，然后勾选下方的第 2 个复选框，在文本框中输入 10，单位选择为“秒”（见图 3）。
图 3 “Wireshark·捕获接口”中“输出”选项
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307111334934.png)

选择完毕之后，单击“开始”捕获数据包，这时 Wireshark 就会将每隔 10 秒捕获到的数据包单独的保存成文件。图 4 给出了保存文件的示例。
图 4 在 Wireshark 中保存的文件
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307111334416.png)

Wireshark 会根据你前面设定的名字、包的顺序、抓包的时间来为这些文件命名，例如第一个文件的名字为test_00001_20180420085327，表示这是捕获的第一个数据包，是在2018 年 4 月 20 日 8 点 53 分 27 秒完成的。
# 2. 环状缓冲区
如果你使用 Wireshark 进行网络监控的话，很快就会发现无论多大的硬盘也会有耗尽时。这一点跟我们现实生活中使用的视频监控一样，不管多大的空间终究会用完。那么人们是怎么解决这个问题的呢？事实上，**他们采用了一种循环覆盖的方法**，比如一个视频监控只能存储 7 天的录像，那么我们假设每 1 天的录像保存为 1 个文件，从 1 月 1 号 00:00 开始起到 1 月 7 日 24:00 共 7 天的录像就会装满整个硬盘，那么新的内容该怎么办呢？这时系统就会删除掉 1 月 1 日那一天的视频。然后将 1 月 8 日的视频保存起来，以后依次删除掉最老的记录。

Wireshark 中提供了类似的功能，但==你选择了多文件输出的时候，如果不希望这个文件的个数一直在增加，可以选择使用环形缓冲器，这样 Wireshark 就不会不断地产生新的文件==。具体的设置如图 5 所示。
图 5 环形缓冲器的使用
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307111335359.png)
这样，不论 Wireshark 运行了多久，它最多会产生 3 个文件，当捕获到新的数据包时， Wireshark 就会将最初的文件删除，然后生成一个新的文件。但是文件总数永远保持为 3 不变。
# 3. 捕获接口的其他功能
## 3.1 显示选项
在 Wireshark 捕获接口对话框中除了“输入”和“输出”，还有一个“选项”按钮，这个按钮提供了 3 种功能，分别是显示选项、解析名称和自动停止捕获。
图 6 捕获接口中的选项设置
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307111434730.png)
图 6 中标记为 1 的地方是“显示选项”的 3 个功能，
- 如果勾选了其中的“实时更新分组列表”，那么每当捕获到了新的数据包之后，数据包列表面板中的信息就会实时更新。
- 如果勾选了其中的“实时捕获时自动滚屏”，数据包列表面板在数据更新之后，面板会自动滚动。这两个选项默认是选中的。
- 如果勾选了“显示额外的捕获信息对话框”的话，那么在捕获数据包的时候就会弹出一个以百分比形式显示的统计数据窗口。

图 6 中标记为 2 的地方是“解析名称”的 3 个功能，
- 如果你勾选了“MAC 地址解析”这个选项的话，Wireshark 就会将 MAC 地址解析成一种更容易识别的形式，例如 dc:fe:18:58:8c:3b 就会被转换为 Tp-linkT_58:8c:3b，这样我们就可以容易地识别出这是一台 Tp-link 的设备，**MAC 地址转换的规则为转换 6 个字节中的前 3 个。通常设备的 MAC 地址的前 3 个字节就是生产厂商的标识符**。不过并不是所有的 MAC 地址都可以转换成功。
- 如果勾选了“解析网络名称”的话，Wireshark 就会将 IP 地址装换成域名或者主机名，例如 180.149.132.151 就会被解析为 www.a.shifen.com。但是这个解析是通过发送 DNS 请求实现的，因此会给系统造成额外的开销。
- 最后一个“解析传输层名称”表示**将传输层的端口号解析成对应的应用层服务，这个并不一定准确**。解析的原理是我们常用的服务往往要运行在固定的端口上，例如 http 往往会运行在 80 端口，而 telnet 就会运行在 21 端口上。也就是说这个功能其实是依靠一张端口和服务的对应表来实现的。

## 3.3 自动停止捕获
图中 6 标记为 3 的地方是“自动停止捕获”，利用这个功能可以实现自动停止捕获。图 7 列出了 4 个可以触发停止捕获的条件，我们可以勾选其中的一项或者几项。这 4 个条件的意义如下所示。
图 7 “自动停止捕获”选项
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307111436954.png)
- 第一个单选框的单位是分组，如果勾选它的话表示捕获的数据包达到指定数量时，停止捕获。
- 第二个单选框的单位是分组，表示创建的文件达到指定数量时，停止捕获。
- 第三个单选框的单位可以选择千字节、兆字节和千兆字节，表示捕获到的文件达到指定大小时，停止捕获。
- 第四个单选框是时间，单位可以是秒、分钟和小时，表示到达捕获的时间时，停止捕获。如果勾选了多个选项的话，那么只要其中任意一个条件满足的话，就会停止捕获。

在完成了捕获操作之后，我们还需要对其进行检查。首先应该做的就是下拉数据包列表的滚动条，以确定当前捕获的数据包正是我们所希望获取的。

另外还需要考虑的就是丢包率，我们使用的网卡和操作系统未必能将全部的数据包都捕获到，**在 Wireshark 底部中心状态栏会以百分比的形式来显示丢包率**。这一点在捕获无线流量的时候尤为明显，我们往往需要多次操作才可能捕获到一个完整的无线连接过程。这种情况会影响到我们对流量的分析。如果希望保证捕获数据包的效率，可以使用性能更高的计算机和网卡，也可以调整捕获设备所处的位置。

# 4. 保存捕获到的数据
这个保存过程也可以在数据包捕获完成之后进行。在完成了一个捕获过程之后，我们对其进行分析。之后的工作就是要将这些数据包作为一个文件保存到硬盘上。这个文件可以包含全部的数据包，也可以只包含那些符合过滤规则的数据包。

如图 8 所示，在菜单栏上依次选中“文件”→“另存为”，在弹出的 Wireshark 保存对话框中选中要保存文件的位置，输入要保存文件的名称。如果你不为这个文件指定扩展名的话，那么 Wireshark 将会根据“保存类型”后面给出的选项（默认为 pcapng）来作为文件的扩展名。在“保存类型”中还提供了很多种常用的文件类型，这样我们就可以很方便地在其他网络分析工具中打开这个文件。
图 8 Wireshark 中的保存选项
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307111437797.png)

需要使用多文件进行保存或者在捕获中使用了环状缓冲区的话，可以通过在菜单栏上依次选中“文件”→“文件集合”→“列出文件”来选择和打开一个文件（见图 9）。
图 9 Wireshark 中的“列出文件”
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307111438183.png)

也可以只将那些符合捕获规则的数据包保存起来，方法是先在菜单栏上依次选中“文件”→“导出特定分组”，可以看到这里面有两个选项“Captured”和“Displayed”，其中的“Displayed”已经被选中（见图 10）。
图 10 Wireshark 中的保存时的过滤选项
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307111438920.png)
这里显示此次一共捕获到了 947 个数据包，符合显示过滤器规则的有 7 个，现在保存的文件将只包含这 7 个符合规则的数据包。

# 5. 保存显示过滤器
**经常使用的过滤器也可以保存起来，以便于以后再次使用**。具体的做法是依次单击菜单栏上的“分析”→“显示过滤器”，打开 Wireshark 的显示过滤器编辑窗口，如图 11 所示。
图 11 Wireshark 中的显示过滤器
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307111439435.png)
单击这个对话窗口左下方的“+”按钮，在左侧“新建显示过滤器”中输入过滤器的名称（例如 baidu），在右侧输入“显示过滤器”的内容，我这里输入的是 `ip.addr==www.baidu.com` （见图 12），完成之后单击 OK 按钮。
图 12 新建显示过滤器
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307111439561.png)
如图 13 所示，这样一个新的名为“baidu”的过滤器就添加到 Wireshark 中了。
图 13 在 Wireshark 中添加一个显示过滤器
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307111440390.png)
新创建的显示过滤器会保存在 Wireshark 配置目录中的 dfilters 文件中，这个文件会根据系统的不同有所区别，在 64 位 Windows 7 操作系统中，这个文件位于 `C:\Users\admin\AppData\Roaming\Wireshark` 中，可以使用文本编辑器来修改这个文件。dfilters 中的每一个显示过滤器都以一行的两个部分来显示，分别表示显示过滤器的名称和显示过滤器的内容（见图 14）。
图 14 Wireshark 保存的显示过滤器
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307111441596.png)

在这个文本框中删除一个显示过滤器之后，重启 Wireshark，就看不到这个显示过滤器了。另外也可以在显示过滤器对话框中单击“-”来删除这个过滤器。
# 6. 保存配置文件
现在已经对 Wireshark 进行了大量的配置，这些操作在我们对数据包进行捕获和分析时将会十分便利。但**如果我们更换一台电脑或者重新安装系统的话，那么这些设置就没有了，重新进行这些配置将会是一件十分繁琐的事情**。不过 Wireshark 可以将这些设置以文件的形式保存起来，这样一来，我们无论是希望在其他电脑上还是重装系统之后都还可以使用这些配置。

例如目录中的 **cfilters 保存了你所设置的捕获过滤器，dfilters 中保存了显示过滤器，colorfilters 中保存了着色规则。preferences 中保存了首选项设置**，这些文件都保存在了硬盘上。当我们安装 Wireshark 的时候，系统就会自动地产生一个“Global configuration”目录，默认的配置文件都在这个目录中。如果你对默认配置文件进行了修改，这些改动会保存在 “Personal configuration”目录中。这两个目录的位置随着系统的不同而有所区别，如果想要查看的话，可以单击 Wireshark 菜单上的“帮助”→“关于 Wireshark”。然后在弹出的“关于 Wireshark”对话框中选中“文件夹”选项卡，就可以看到“Global configuration”等目
录的所在位置（见图 15）。
图 15 Wireshark 中配置的保存目录
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307111442073.png)
我们也可以在“Location”位置双击地址连接，这样就可以使用资源管理器打开这个目录，例如双击打开“Personal configuration”目录，可以看到这个目录的内容如图 16 所示。
图 16 Wireshark 中保存配置的目录
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307111443396.png)
在这个 profiles 文件中包含了对 Wireshark 做出的各种配置和自定义功能，我们可以将里面的文件复制到其他计算机上的 Wireshark 目录中，或者分享给其他使用者，这样无论在哪里都可以使用到一模一样的 Wireshark 了。

也可以创建一个 Wireshark 配置文件，具体的步骤如下。
（1）在 Wireshark 工作界面的最右下角处（状态栏的最右侧）有一个“配置文件：Classic”，这表示当前使用的配置文件名为 Classic，它保存在 Wireshark 的 profiles 目录的 Classic 文件夹中。在最右下角处单击鼠标右键会弹出一个菜单，然后选择“New”（见图 17）。另
外，你也可以在菜单栏上选择“编辑”→“配置文件”→“+”。
图 17 Wireshark 中的配置文件
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307111443616.png)
（2）这时就会弹出 Wireshark 的配置文件管理窗口，我们首先可以为这个文件起一个名字，默认的名字为“New profile”（见图 3-18）。
图 18 Wireshark 中添加一个新配置文件
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307111443488.png)
（3）如图 3-19 所示，这个新建的文件是空的，它保存在配置文件的同名文件夹中，单击“OK”按钮就会自动创建并应用这个新建的配置文件了。
图 19 添加的新配置文件
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307111444435.png)
不同的配置文件适合不同的使用环境，我们可以对这些配置文件进行修改，也可以根据情况对它们进行切换。切换的方法就是在最右下角的位置单击鼠标右键，然后在弹出的菜单中依次选择“切换到”→“New profile”（你要选择的配置文件名）（见图 20）。
图 20 切换配置文件
# 7. 小结
这一章讲解了 Wireshark 中的各种保存功能，其中包括设置数据包捕获文件的保存位置和格式，对过滤器的保存，对配置文件的保存。善于利用这些保存功能，将为你的工作带来很大的便利。另外需要注意的是，Wireshark 允许你在数据开始捕获前就指定好保存的位置和格式，也允许你在捕获完成之后再保存，这是两种不同的操作。