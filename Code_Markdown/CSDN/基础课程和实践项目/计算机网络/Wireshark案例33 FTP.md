也许难以想象，FTP 协议在 1971 年就出现了。在那时，现代的网络模型还
没有形成，所以 **FTP 完全称得上网络界的活化石**。

它的发明人也很有意思，是印度工程师 Abhay Bhushan。要知道早期的网络协议起草者几乎是清一色的欧美工程师，Bhushan 能够占得一席之地绝对称得上传奇。虽然看起来文质彬彬，但实际上 Bhushan 热爱运动，尤其擅长马拉松和铁人三项（我印象中计算机科学之父 Alan Turing 也是位长跑健将）。

一个古老的协议能有如此活力，一定是有深层原因的。**FTP 的过人之处，就在于它用最简单的方式实现了文件的传输**—客户端只需要输入用户名和密码，就可以和服务器互传文件了；有的甚至**连用户名和密码都不用**（匿名 FTP）。
- FTP常被用来传播文件，尤其是免费软件；
- 另一个广泛应用是采集日志，我们可以**让服务器发生故障之后，自动通过 FTP 把日志传回厂商**。

这些场合之所以适合 FTP而不是 NFS 或者 CIFS，就是因为**它实现起来更加简单**。一个软件使用起来简单，并不意味着它的底层设计也很简单。如果你抓了一
个 FTP 的网络包，**乍一看会觉得非常复杂**，尤其是在端口号的管理上。在我的实验室中，我从 Windows 客户端登录了一次 FTP 服务器，然后下载了一个叫
linpeiman.txt 的文件。我们先来看看登录的过程（见图 1）。
图 1
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131523883.png)
```bash
C:\Users\21839>ftp
ftp> help
命令可能是缩写的。  命令为:

!               delete          literal         prompt          send
?               debug           ls              put             status
append          dir             mdelete         pwd             trace
ascii           disconnect      mdir            quit            type
bell            get             mget            quote           user
binary          glob            mkdir           recv            verbose
bye             hash            mls             remotehelp
cd              help            mput            rename
close           lcd             open            rmdir
```
接下来看看登录过程的网络包，前三个包无需解析（见图 2），就是由客户端
发起的三次握手。唯一值得记住的是 FTP 服务器的控制端口 21。
图 2
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131523994.png)
现在来分析 5、7、8、10、11 号包的过程（见图 3）。
图 3
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131524679.png)
5 号包：服务器：“我准备好接受访问啦，顺便说一下我是一台 EMC 公司的存储，版本号 8.1.1.33。”
7 号包：客户端：“我想以用户名 linpeiman 登录。”
8 号包：服务器：“那你把 linpeiman 的密码告诉我。”
10 号包：客户端：“密码是 123456。”
11 号包：服务器：“密码正确，linpeiman 登录成功。”

从以上分析可见，FTP 是用明文传输的，连我的密码 123456 都可以被Wireshark 解析出来。**如果对安全的要求非常高，就不能采用这种方式**。接下来再看下载文件的过程（见图 4）。
图 4
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131526631.png)

现在分析下载过程的网络（见图 5）。
图 5
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131527078.png)
13 号包：客户端：“我想从 IP=10.32.200.41，端口为 208×256+185=53433 连接你的数据端口（公式中的 256 为约定好的常数）。”
14 号包：服务器：“可以的，我同意了。”
15 号包：客户端：“那我想下载文件 linpeiman.txt。”
22 号包：服务器：“给你传了。”

上面这些包并没有真正传输文件内容，我们接着看（见图 6）。
图 6
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131527545.png)
16、17、18 号包也是三次握手，不过这次发起者是 FTP 服务器。服务器的端
口号采用了 20，**客户端的端口则为之前协商好的 53433**。
19 号包：服务器：“给你文件内容（文件内容“Life is tough. Wireshark makes it easy.”可见于图 6 中的底部）。”
**20、21、23、24 号包为四次挥手过程，表示数据传输结束，TCP 连接关闭了**。

从以上分析可见，==客户端连接 FTP 服务器的 21 端口仅仅是为了传输控制信息，我们称之为“控制连接”==。**当需要传输数据时，就重新建立一个 TCP 连接，我们称之为“数据连接”**。随着文件传输结束，这个数据连接就自动关闭了。不但在下载文件时如此，就连**执行 ls 命令来列举文件时，也需要新建一个数据连接**。

**在我看来这不是一种高效的方式**，因为三次握手和四次挥手就用掉 7 个包，而 ls命令的请求和响应往往只需要 2 个包，就像开着卡车去送快递一样不经济。图 7
显示了这个例子的两个连接情况。
图 7
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131530511.png)
我花了很长时间来思考 Bhushan 先生为何把 FTP 的控制连接和数据连接分开来，不过至今还是不能领悟。我唯一能想到的好处是连接分开后，就有机会在路由器上把控制连接的优先级提高，免得被数据传输影响了控制。举个例子，当文件下载到一半时我们突然反悔了，就可以 Abort（终止）这次下载。如果 Abort请求是通过优先级较高的控制连接发送的，也许能完成得更加及时。当然我的猜测可能是错的，20 世纪 70 年代的路由器也许根本不支持优先级。

如果你为 FTP 配置过防火墙，还会发现这种方式带来了一个更加严重的问
题—**由于数据连接的三次握手是由服务器端主动发起的（我们称之为主动模
式），如果客户端的防火墙阻挡了连接请求，传输不就失败了吗**？碰到这种情况时，我建议你试一下 FTP 的被动模式。图 8 是在被动模式下抓到的包。**由于被动模式的登录过程和主动模式一样**，所以我们从登录后开始讲起。
图 8
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131531943.png)
24 号包：客户端：“**我想用被动模式传输数据**。”
25 号包：服务器：“你可以连接到 IP=10.32.106.112，端口号为 240×256+217=61657（公式中的 256 为约定好的常数）。”
29 号包：客户端：“我想下载 linpeiman.txt。”
30 号包：服务器：“给你传了。”
上面这些包并没有真正传输文件内容，我们接着看（见图 9）。

图 9
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131532282.png)
26、27、28 号包是数据连接的三次握手，可见**这一次由客户端主动发起（所
以对服务器来说是被动的）** ，连接的服务器端口为之前协商好的 61557。
31、32、33、34、35 号包完成了文件内容的传输，然后关闭数据连接。同样
从图 9 底部可以见到该文件的内容：Life is tough. Wireshark makes it easy.
最后我在 FTP 命令行中打了个“bye”命令（见图 10）。
图 10
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131534917.png)
Goodbye 过程的网络包如图 11 所示。
图 11
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131534636.png)
39 号包：客户端：“我要退出啦。”
40 号包：服务器：“好的，Goodbye!”（FTP 是我所知道最讲礼仪的协议。）
 
41、42、43、44 号包是四次挥手过程，断开控制连接，完成了一次 FTP 的生命周期。

你也许想问，那如何**指定客户端采用主动还是被动模式**呢？很多 FTP 客户端
软件都有这个选项。比如图 12 是 WinSCP 上的截图，选中 Passive mode 即表示被动模式。
图 12
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131535800.png)
理论上所有 FTP 客户端都应该支持这两种模式，但 Windows 自带的 ftp 命令
似乎只支持主动模式。图 13 是我试图采用被动模式的命令。
图 13
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202307131535626.png)
从图 13 中看，当我输入“quote pasv”命令时，的确显示进入被动模式
（Entering Passive Mode）。接下来我们看看图 14 的网络包。12 号和 13 号包也的确显示进入被动模式，但是再接下来的网络包却完全是主动模式的样子。
图 14
![Uploading file...ljt1q]()
从结果看，12 号和 13 号包完全没有起作用。这很可能是 Windows 的一个 bug，
我在 Windows 7 和 Windows 2003 都看到了相同的结果。那微软的测试部门为什么没有发现呢？如果没有用 Wireshark 来抓包检查，测试人员是很难测出这个问题的，我也是在写这篇文章时碰巧看到。从这个不经意的发现，就可以知道
Wireshark 的价值。