


@[toc]

在计算机系统中，除了**CPU和内存**之外，其他的**大部分硬件设备称为外部设备**。
外部设备种类繁多，特性各异，操作方式的差别也很大，从而使得操作系统的设备管理（`device management`）变得十分复杂。

---
# 7.1设备管理概述
## 7.1.1设备分类
计算机设备种类繁多，**从不同的角度出发**，I/O设备可分成不同的类型。下面列举几种常见的分类方法。

按设备的使用特性分类：
- 存储设备：用来**保存各种信息**的设备。如磁盘，磁带等。
- I/O设备：向CPU**传输信息**或**输出**经过CPU加工处理**信息**的设备。如键盘、显示器和打印机等。

按设备的共享属性分类：
- 独占设备：在**一段时间**内**只允许一个用户进程使用**的设备。
- 共享设备：在**一段时间**内**允许多个进程使用**的设备。
- 虚拟设备：指通过虚拟技术将**一台独占设备**改造成**若干台逻辑设备**，**供若干个用户进程同时使用**。通常把这种经过虚拟技术处理后的设备称为虚拟设备。 

按信息交换单位分类：
- 块设备：处理信息的**基本单位是字符块**。一般块的大小为512B～4KB，如磁盘、磁带等是块设备。
- 字符设备：处理信息的**基本单位是字符**。如<ins>键盘</ins>、<ins>打印机</ins>和<ins>显示器</ins>是字符设备。

按设备从属关系分类：
- 系统设备：指**操作系统生成时**已经**登记在系统中**的**标准设备**。如<ins>键盘</ins>、<ins>打印机</ins>和<ins>显示器</ins>等。
- 用户设备：指**操作系统生成时**未登记入系统的非标准设备。如鼠标、绘图仪，扫描仪等。 

## 7.1.2 设备管理的任务和功能 
设备管理的主要任务是：
- 完成用户提出的I/O请求
- **分配**I/O设备
- **提高**I/O设备的**利用率**
- 方便用户使用I/O设备

为了完成述任务，设备管理应具备以下功能：
- 设备分配：**根据**用户的**I/O请求**，为之**分配设备**。包含控制器和通道。
- 设备处理：负责启动设备及I/O操作完成时的中断处理。
- 缓冲管理：为**缓和CPU与I/O速度**不匹配的矛盾常设置缓冲区。缓冲管理负责缓冲区的分配和释放及有关管理工作。
- 设备独立性：又称设备无关性，是指用户编制程序时所使用的设备与物理设备无关。设备独立性有两种类型：
	- 独立于同类设备的具体设备号
	- 独立于设备类型


## 7.1.3 设备控制器与通道
### 1. 设备控制器
设备一般由**机械**和**电子**两部分组成，设备的电子部分通常称为**设备控制器**(`device controller`)。在微型计算机中，又称为**接口卡**。 

控制器处于CPU与I/O设备之间，它**接收从CPU发来的命令**，并去**控制I/O设备工作**。

设备控制器是一个**可编址设备**，当它**控制一个设备时有一个设备地址**；当它**控制多个设备则应有多个设备地址**。

设备控制器的功能：
- **接收和识别**来自CPU的**命令**：用**控制寄存器**。
- **实现**CPU与控制器、控制器与设备之间的**数据交换**：用**数据寄存器**。
- **记录设备的状态**供CPU查询：用**状态寄存器**。
- **识别**控制的每个**设备地址**：用**地址译码器**。

设备控制器由三部分组成：
- 设备控制器与处理机的接口：实现==CPU与设备控制器之间==的通信。
- 设备控制器与设备的接口：实现==设备与设备控制器之间==的通信。
- I/O逻辑：**实现对设备的控制**，它负责接收命令、对命令进行译码、再根据译出的命令控制设备。
<img src="https://img-blog.csdnimg.cn/20200528173552279.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70" width="50%">
### 2. 通道
通道有自己的指令系统，**该指令系统比较简单**，一般只有数据传送指令、设备控制指令等。由通道指令构成的程序是通道程序。
通道与一般处理机的区别：指令类型单一；没有内存。

根据信息交换方式的不同，可将通道分成以下几种类型：
- 字节多路通道：该通道**以字节交换方式**工作。它通常含有若干个**非分配型子通道**，每个子通道连接一台I/O设备，这些子通道**按时间片轮转方式**共享主通道，**每次交换完一个字节后便轮换**。<b><font color="#ff0000">一般用于连接中、低速I/O设备</b></font>。

- 数据选择通道：又称数组选择通道，该通道含有**一个分配型子通道**，在**一段时间**内只能**执行一个通道程序**，控制**一台设备**传送**一批数据**，当一道程序执行完后，再选择与通道相连的另一台设备。<b><font color="#ff0000">一般用于连接高速I/O设备</b></font>。
- 数据多路通道：又称数组多路通道，该通道是**前两种通道的结合**，它以**分时方式**执行几个通道程序，每执行一个通道程序的一条通道指令控制传送一组数据后，就转向另一个通道程序。<b><font color="#ff0000">一般用于连接高、中速I/O设备</b></font>。

其中，I/O通道(channel)是**专门负责输入/输出工作的处理机**。它具有执行I/O指令的能力，并通过**执行通道程序**来控制I/O操作。

## 7.1.4  I/O系统结构
I/O系统结构不尽相同，大致分成两类：
- 微型机I/O系统结构：
	微型机I/O系统多采用**总线I/O系统结构**，**CPU和内存**==直接连接到总线上==，**I/O设备**==通过设备控制器连接到总线上==。
<img src="https://img-blog.csdnimg.cn/20200528175445570.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70" width="50%">
- 主机I/O系统结构：
通常**为主机配置的设备较多**，若所有设备都通过总线与CPU通信则**总线和CPU的负担过重**。为此在I/O系统结构中增加了**一级I/O通道**。 
<img src="https://img-blog.csdnimg.cn/20200528191419144.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70" width="50%"> 
多通路I/O系统
因通道价格较贵，使系统内设置的通道少，这样通道往往成为I/O的瓶颈。解决瓶颈问题的办法是**采用多通路配置方案**。
<img src="https://img-blog.csdnimg.cn/20200528191624153.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70" width="50%">
# 7.2   I/O控制方式
I/O控制方式发展过程中始终贯穿的宗旨是**尽量减少主机对I/O控制的干预**。常用的输入/输出控制方式有下述几种：
- 程序直接控制方式
- 中断控制方式
- 直接存储器访问控制方式
- 通道控制方式

## 7.2.1 程序直接控制方式
**早期**计算机系统中无中断机构，设备控制**采用程序直接控制方式**。程序直接控制方式**也称为轮询方式**。即==定期对设备状态进行查询，然后做出相应的处理==。

以输入为例，其过程为：
<img src="https://img-blog.csdnimg.cn/2020052819304786.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70" width="50%">
程序直接控制方式特点：工作方式简单，但CPU的利用率低。
 
## 7.2.2 中断控制方式
现代计算机系统中对设备的控制**广泛采用了中断控制方式**。以输入为例，其过程为：
<img src="https://img-blog.csdnimg.cn/20200528193309272.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70" width="50%">中断控制方式特点：
<b><font color="#FF0000">CPU与设备并行工作</b></font>，仅当I/O结束时才需CPU**花费极短时间做中断处理**。CPU利用率大大提高。

## 7.2.3 DMA控制方式
中断方式**以字节为单位中断**CPU，**对块设备其效率极低**，为此引入了DMA。DMA控制方式的思想是——在外设与内存之间**开辟直接的数据交换通路**，在控制器的控制下，==设备和内存之间可以成批地进行数据交换==。

为实现**主机与控制器之间**成块数据的直接交换，必须==在DMA控制器中设置如下寄存器==：
- 命令/状态寄存器 `CR` ：存放命令及状态
- 内存地址寄存器 `MAR` ：存放内存起始地址
- 数据寄存器 `DR` ：存放传输的数据
- 数据计数器 `DC` ：存放要读写的字（节）数

DMA控制器的组成如下图：
<img src="https://img-blog.csdnimg.cn/2020052819415596.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70" width="50%">DMA工作过程：
<img src="https://img-blog.csdnimg.cn/20200528194231625.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70" width="50%">
DMA方式与中断方式的主要区别：
- 中断控制方式在**每个数据传送完成后中断CPU**，而DMA控制方式则是在**所要求传送的一批数据全部传送结束时中断CPU**；
- 中断控制方式的数据传送是在中断处理时**由CPU控制**完成，而DMA控制方式则是**在DMA控制器的控制**下完成。

## 7.2.4 通道控制方式 
通道控制方式是DMA控制方式的**发展**，==所需的CPU干预更少==。因此，通道控制方式与DMA方式类似，也是一种**以内存为中心**，实现**设备与内存直接交换数据**的控制方式。

在通道控制方式中，CPU**只需发出启动指令**，指出要求通道**执行的操作**和**使用的I/O设备**，该指令就可以启动通道并使该通道从内存中调出相应的通道程序执行。以输入为例，其通道工作过程为：
<img src="https://img-blog.csdnimg.cn/20200528194504705.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70" width="50%">

---
# 7.3 中断技术
中断是现代操作系统的常用技术之一，==是实现多道程序的必要条件==。
## 7.3.1 中断的基本概念
中断：指计算机系统内发生了某个**急需处理的事件**，使CPU**暂停当前正在执行的程序，转去处理相应的事件处理程序**，待处理完毕后又返回原来被中断处继续执行。涉及到的有：
- 中断源：引起中断发生的事件。
- 中断请求：中断源向CPU发出的**请求中断处理的信号**。
- 中断响应：CPU收到中断请求后**转向相应事件处理程序**的过程。
- 断点：发生中断时，**刚执行完的那条指令**所在的**单元号**。
- 恢复点：断点的**逻辑后继指令的单元号**。
- 现场：是指中断的那一时刻**能确保程序继续运行的有关信息**。
- 程序状态字：**反映程序运行状态**的一组信息。主要包括：指令地址、指令执行情况、CPU状态（管/目态）、中断屏蔽字、寻址方式等。
- 禁止中断：不允许CPU响应中断，也称为关中断。
- 允许中断：允许CPU响应中断，也称为开中断。
- 开中断和关中断是为了<b>==保证某些程序执行的原子性==</b>。
- 中断向量：用来**存放中断处理程序**的**入口地址**，一般每个中断信号**占用两个单元**：一个单元用来存放中断处理程序的**入口地址**，另一个单元用来保存**处理中断时CPU应具有的状态**。
- 中断屏蔽：中断屏蔽表示**暂时封锁对中断的响应**，待屏蔽消除后再响应。

## 7.3.2 中断的分类及优先级
### 1. 中断分类
根据中断信号的含义和功能可以将中断分为5类：
- 硬件故障中断：**机器发生故障时**产生的中断。如电源故障、奇偶校验错等。
- 输入/输出中断：**外设或通道操作正常完成**或**发生某种错误时**产生的中断。如==传输结束==、设备错误等。
- 外中断：中央处理机**外部的非通道式装置**引起的中断。如时钟中断、控制台中断等。
- 程序性中断：程序执行时**发生了程序性质的错误**或出现了**某些特定状态**而产生的中断。如溢出、地址错、指令跟踪等。
- 访管中断：对OS**提出某种服务要求时**发生的中断，又称软中断。

强迫性中断和自愿性中断：
- 强迫性中断由**随机事件引起**而非程序员事先安排，==硬件故障中断、程序性中断、外部中断及输入/输出中断==是强迫性中断。
- 自愿性中断：是**正在运行程序所期待的事件**，是由执行一条**访管指令**所引起的。

根据中断信号的来源可以将中断分为两类：
- 外中断。指**来自**处理机和内存**外部**的中断，包括I/O设备发出的I/O中断、各种定时器引起的时钟中断等。
- 内中断。指在**处理机和内存内部**产生的中断，内中断一般称为陷入或异常，包括程序运算引起的各种错误，如地址非法、校验错、存取访问控制错、算术操作溢出等。

### 2. 中断优先级
中断优先级是中断响应的优先级别。
- 当多个中断发生时，系统**根据优先级决定响应中断的次序**，优先响应高优先级的中断，同级中断则**按硬件规定的次序**响应。
- 中断优先级**由高到低**的顺序为：==硬件故障中断、访管中断、程序性中断、外部中断、输入/输出中断==。

## 7.3.3 中断处理过程
一旦CPU响应中断，系统就开始进行中断处理。中断处理过程如下：
- 保护被中断进程现场。
- 分析中断原因，转去执行**相应的中断处理程序**。
- 恢复被中断进程的现场，CPU继续执行原来被中断的进程。

---
# 7.4  缓冲技术管理
提高**处理机与外设**并行速度的另一项技术是**缓冲技术**。

## 7.4.1 缓冲的引入
 引入缓冲(`Buffering`)的主要原因有：
- 缓和CPU与I/O设备间**速度不匹配**的矛盾；
- 提高CPU与I/O设备并行操作的程度；
- **减少设备对CPU的中断频率**，放宽CPU对中断响应时间的限制。

缓冲的实现方法：
- 硬件缓冲器：如I/O控制器中的数据缓冲寄存器，但**成本太高**。
- 软件缓冲：一片**内存区域**，用来**临时存放输入输出数据**。

缓冲技术分为：
- 单缓冲
- 双缓冲
- 循环缓冲
- 缓冲池

## 7.4.2 单缓冲
单缓冲是在设备和处理机之间设置一个缓冲区。 
<img src="https://img-blog.csdnimg.cn/2020052820005044.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70" width="50%">
单缓冲执行过程：
- 在**块设备输入**时，先**从磁盘**把**一块数据**输入至**缓冲区**，然后OS将缓冲区中的数据**送到用户区**；
- 在**块设备输出**时，先将要输出的数据**从用户区复制到缓冲区**，然后再将缓冲区中的数据**写到设备**。
- 在**字符设备输入**时，缓冲区用于**暂存**用户**输入的一行数据**。在输入期间，**用户进程阻塞**以**等待**一行数据输入完毕；
- 在**字符设备输出**时，用户进程**将一行数据送入缓冲区后**继续执行计算。当用户进程**已有第二行数据要输出**时，若第一行数据**尚未输出完毕**，则**用户进程阻塞**。 

## 7.4.3 双缓冲
引入双缓冲，可以进一步提高处理机与设备的并行操作程度。
<img src="https://img-blog.csdnimg.cn/20200528200343533.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70" width="50%">
双缓冲的过程：
- 在块设备输入时，可**先将第一个缓冲区装满**，之后便**装填第二个缓冲区**，与此同时OS可**将第一个缓冲区中的数据传到用户区**；当第一个缓冲区中的数据处理完后，若第二个缓冲区已装满，则处理机又可处理第二个缓冲区中的数据，而设备又可装填第一个缓冲区。输出与此类似。
- 在字符设备输入时，若采用**行输入方式**和双缓冲，则用户**在输入完第一行后**，CPU执行第一行中的命令，而用户可以**继续向第二个缓冲区中输入一行数据**。

## 7.4.4 循环缓冲
若==输入输出速度与数据处理速度相当，则双缓冲能获得较好的效果==；若速度**相差较大**，则可以通过**增加缓冲区的数量**来改善性能。
<img src="https://img-blog.csdnimg.cn/2020052820081694.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70" width="50%">
循环缓冲的组成：
- 循环缓冲中包含**多个大小相等**的**缓冲区**，每个缓冲区中**有一个指针指向下一个缓冲区**，==最后一个缓冲区的指针指向第一个缓冲区，由此构成一个环形==。
- 循环缓冲用于输入/输出时，还**需要两个指针** `in` 和 `out` 。
- 对于输入而言，`in` 指向**下一个可用的空缓冲区**，`out` 指向**下一个可以提取数据的满缓冲区**。显然，对输出而言正好相反。

## 7.4.5 缓冲池
循环缓冲**适用于合作进程**，当**系统较大**且**共享缓冲区的进程较多**时，这要**消耗大量内存**。==目前广泛使用的是公用缓冲池==。

缓冲池由多个缓冲区组成，其中的<b><font color="#FF0000">缓冲区可供多个进程共享，既能用于输入又能用于输出</font></b>。 

缓冲池中有三种类型的缓冲区队列：
- 空缓冲队列：由**空闲缓冲区**构成的队列
- 输入队列：**装满输入数据**的缓冲区队列
- 输出队列：**装满输出数据**的缓冲区队列

除上述三个队列之外，还有四种工作缓冲区：
- 用于**收容输入数据**的工作缓冲区
- 用于**提取输入数据**的工作缓冲区
- 用于**收容输出数据**的工作缓冲区
- 用于**提取输出数据**的工作缓冲区

缓冲池有四种工作方式：
- 收容输入：当输入进程需要输入数据时，便**从空缓冲队列的队首**摘下一个空缓冲区，把它**作为收容输入工作缓冲区**，然后把数据输入其中，**装满后**再将它**挂到输入队列队尾**。
<img src="https://img-blog.csdnimg.cn/20200528202341188.png)
- 提取输入：当计算进程需要输入数据时，便**从输入队列队首**取得一个缓冲区**作为提取输入工作缓冲区**，计算进程从中提取数据，**数据用完后**再将它**挂到空缓冲队列尾**。
<img src="https://img-blog.csdnimg.cn/20200528202420913.png)
- 收容输出：当计算进程需要**输出数据**时，便**从空缓冲队列的队首**取得一个空缓冲区，**作为收容输出工作缓冲区**，当其中**装满输出数据后**，再将它**挂到输出队列尾**。
<img src="https://img-blog.csdnimg.cn/20200528202433311.png)
- 提取输出：当要输出时，由输出进程**从输出队列中**取得一装满输出数据的缓冲区，**作为提取输出工作缓冲区**，当**数据提取完后**，再将它**挂到空缓冲队列的末尾**。

<img src="https://img-blog.csdnimg.cn/20200528203600952.png)

---
# 7.5   设备分配
当**进程提出I/O请求**时，**设备分配程序**便按照**一定的策略**为其**分配设备**，同时还应**分配相应的控制器和通道**，以保证CPU与设备之间的通信。

## 7.5.1 设备分配中的数据结构
设备分配依据的主要数据结构有：
- 设备控制表（`DCT`）：系统为**每个设备**配置**一张设备控制表**，用于**记录设备的特性**及与**I/O控制器连接的情况**。
<img src="https://img-blog.csdnimg.cn/20200528204958494.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70" width="50%">
- 控制器控制表（COCT）：控制器控制表也是**每个控制器一张**，它反映**I/O控制器的使用状态**以及**和通道的连接情况**。
<img src="https://img-blog.csdnimg.cn/20200528205018786.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70" width="50%">
- 通道控制表（CHCT）：**每个通道**都配有**一张通道控制表**，它反映**通道的使用状态**。
<img src="https://img-blog.csdnimg.cn/20200528205041307.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70" width="50%">

- 系统设备表（SDT）：系统设备表**整个系统一张**，它记录了系统中**所有物理设备的情**况，每个物理设备占一个表目。
<img src="https://img-blog.csdnimg.cn/20200528205056472.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70" width="50%">
---
## 7.5.2 设备分配策 
系统在进行设备分配时，应考虑以下因素：
- 设备的使用性质
- 设备分配算法
- 设备分配的安全性
- 设备独立性
- ......

### 1.设备的使用性质
按**共享属性设备**有三种类型：
- 独占：这种设备在**一段时间内只允许一个进程独占**。
- 共享：这种设备允许**多个进程同时共享**。
- 虚拟：设备本身虽是独占设备，但经过某种技术处理后可改造成虚拟设备。 

针对上述三种设备可采用**三种不同的分配方式** 。
- **独享分配**：在将一个设备分配给某进程后便**一直由它独占**，直至该进程完成或释放该设备后，系统才能再将该设备分配给其他进程使用。
- **共享分配**：将设备**同时分配给多个进程使用**。但这些进程对设备的访问需要进行合理调度。 
- **虚拟分配**：虚拟分配**针对虚拟设备**，其实现过程是：
	- 当进程**申请独占设备**时，系统给它**分配**共享设备上的**一部分存储空间**；
	- 当进程要**与设备交换信息**时，系统就把要交换的信息**存放在这部分存储空间中**；
	- 在适当的时候，将设备上的信息**传输到存储空间中**或将存储空间中的信息**传送到设备**。

### 2.设备分配算法
设备分配通常**只采用**以下两种算法：
- 先来先服务：根据进程对某设备**发出请求的先后次序**，将它们排成**一个设备请求队列**，设备分配程序总是把设备首先分配给队首进程。
- 优先级高者优先：按对某设备提出I/O请求的进程**优先级由高到低排队**，==对优先级相同的I/O请求，按先来先服务的算法排队==，设备分配程序总是把设备首先分配给队首进程。


### 3. 设备分配的安全性
设备分配的安全性是指在**设备分配**中应**保证不发生进程死锁**。设备有两种分配方式：
- 静态分配：用户**作业开始执行前**，由系统**一次分配**该作业**所要求的全部设备、控制器和通道**。一旦分配，就一直为该作业所占用，直到该作业被撤消为止。
静态分配方式==不会出现进程的死锁，但设备的使用效率低==。

- 动态分配：在进程执行过程中**根据需要进行设备分配**，一旦使用完之后便立即释放。
动态分配方式==有利于提高设备利用率，但分配算法使用不当有可能造成进程死锁==。
动态分配又分为：
	- 安全分配：每当**进程发出I/O请求后**便进入**阻塞**状态，直到**I/O操作完成时**才被**唤醒并释放资源**。
特点：==设备分配安全，但进程进展缓慢==。
	- 不安全分配：进程发出I/O请求后**继续运行**，需要时又可发出第二个I/O请求、第三个I/O请求等。**仅当**进程**所请求的设备被其他进程占用时**才进入**阻塞**状态。
特点：==进程推进迅速，但可能死锁==。


### 4. 设备独立性
设备独立性：又称设备无关性，是指用户编制程序时使用的设备与实际使用的物理设备无关。
- 逻辑设备：用户程序中使用的设备。
- 物理设备：计算机系统中存在的设备。

为实现设备独立性，应在用户程序中**使用逻辑设备名请求**某类设备，而在**程序实际执行**时**使用物理设备名**。为此系统应具有**将逻辑设备名转换为物理设备名**的功能。可以采用逻辑设备表实现变换。其表项可包含：
- 逻辑设备名
- 物理设备名
- 设备驱动程序地址

---
## 7.5.3 设备分配程序
### 1. 单通路设备分配
单通路设备分配程序假定**用户使用物理设备名**，采用**单通路**的I/O系统结构。当**进程提出I/O请求**时，系统的**设备分配程序**按下述步骤进行：
- 分配设备：根据**物理设备名**查找 `SDT` ，从中找到该设备的 `DCT` ；
再根据 `DCT` 中的设备状态字段**查看设备忙否**，若**忙**则将进程**插入设备等待队列**；
否则计算本次设备分配的安全性，**若安全则进行分配**，否则仍将该进程**插入设备等待队列**。
- 分配控制器：设备分配后，再到 `DCT` 中找到与该设备相连的 `COCT` ，从该表的状态字段中可知**该控制器是否忙碌**。
若忙，则将进程**插入该控制器的等待队列**；否则**将该控制器分配给进程**。

- 分配通道：从 `COCT` 中找到与该控制器连接的 `CHCT`，从该表的状态字段中可知该通道是否忙碌。
若忙，则将进程**插入该通道的等待队列**；否则**将该通道分配给进程**。

在将相应的设备、控制器、通道分配给进程后，便可以启动I/O设备实现I/O操作。

### 2. 多通路的设备分配1
为了提高系统的灵活性和可靠性，**通常采用多通路的I/O系统结构**。同时用户**使用逻辑设备名**提出请求。其分配步骤如下：
- 根据进程所提供的设备类型**检索系统设备表**，找到第一个该类设备的 `DCT` 。
若设备忙，继续查找，**仅当所有该类设备都忙时**，才把进程**插入到该类设备的等待队列中**。 
- 设备分配后，便可检查与此设备相连的第一个控制器，若控制器忙，则再检查与设备连接的下一个控制器。
- 若**与此设备相连的所有控制器都忙**，则只要该设备不是该类设备的最后一个，便可**退回到第一步找下一个空闲设备**；否则将该进程**插入控制器等待队列中**。
- 若给进程分配了控制器，便可检查与此控制器相连的第一个通道。
若通道忙，再查看与此控制器相连的第二个通道，若**与此控制器相连的全部通道都忙**，则只要该控制器不是与设备连接的最后一个控制器，便**返回到第二步**，否则将该进程**插入通道等待队列**。

---
## 7.5.4 Spooling系统
Spooling技术是将**独占设备改造为共享设备**的技术。

Spooling是 `Simultaneous Peripheral Operating On-Line` 的缩写，意思是**外部设备同时联机操作**，又称**假脱机操作**。

在Spooling系统中，用一道程序**模拟脱机输入时**的**外围控制机功能**，把低速输入设备上的数据传送到高速磁盘上；再用另一道程序来**模拟脱机输出时**的**外围控制机功能**，把数据从磁盘传送到低速输出设备上。

Spooling系统由三部分组成：
- 输入井和输出井：**磁盘**上的两个**存储区域**。输入井收容I/O设备输入的数据。输出井收容用户程序的输出数据。

- 输入缓冲区和输出缓冲区：**内存**中的两个**缓冲区**。
输入缓冲区用于暂存由输入设备送来的数据，以后再传送到输入井；
输出缓冲区用于暂存从输出井送来的数据，以后再传送到输出设备。

- 输入进程和输出进程：
输入进程**模拟脱机输入**时的**外围控制机**，将用户要求的数据从输入设备**通过输入缓冲区**再送到输入井，当CPU需要输入数据时**直接从输入井读入内存**；
输出进程**模拟脱机输出**时的**外围控制机**，把用户要求输出的数据先从内存送到输出井，待输出设备空闲时，再将输出井中的数据**经过输出缓冲区**送到输出设备上。 

Spooling系统组成图：
<img src="https://img-blog.csdnimg.cn/20200528230044288.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70" width="50%">
共享打印机：
打印机是**常用的独享设备**，但利用Spooling技术可以将它**改造成供多个用户共享的设备**。
当用户进程请求打印输出时，Spooling系统同意为它打印，但**不将打印机真正分配给它，而只为它做两件事**：
- 由输出进程在**输出井**中为之**申请一空闲磁盘区**，并将要打印的数据送入其中；
- 输出进程**再为用户进程**申请一张空白的用户请求打印表，并将用户的**打印要求填入其中**，再**将该表挂到请求打印队列上**。
- 如果打印机空闲，输出进程将从打印队列队首取出一张请求打印表，根据表中的要求将要打印的数据**从输出井传送到内存缓冲区**，再**由打印机进行打印**。
- 打印完后，再取下一张表，直至请求队列为空。此时，**输出进程阻塞**，当再有打印请求时，才将输出进程唤醒。


---
# 7.6  I/O软件的层次结构
I/O软件设计的基本思想是将设备管理软件组织成一种层次结构。其中低层软件与硬件相关，而高层软件则为用户提供一个友好的、清晰而统一的接口。 

I/O设备管理软件一般分为四层：
- 中断处理程序；
- 设备驱动程序；
- 与设备无关的软件（或设备独立性软件）；
- 用户空间的软件。 

## 7.6.1 中断处理程序
设备完成I/O操作时，便发出中断信号，CPU响应中断后便转入中断处理程序。其中断处理过程如下：
- **唤醒**被阻塞的**驱动程序进程**
- **保护**被中断进程的**现场信息**
- 分析中断原因，**转入**相应的**设备中断处理程序**
- 进行**中断处理**
- **恢复**被中断程序的现场信息

##  7.6.2 设备驱动程序
所有与设备相关的代码放在设备驱动程序中。
- 设备驱动程序与设备密切相关，故应为**每一类设备配置一个驱动程序**。
- <b><font color="#FF0000">设备驱动程序(device driver)是I/O进程与设备控制器间的通信程序</font></b>。

设备驱动程序的主要任务是：
- 接收来自上层的与设备无关软件的抽象请求
- 把它**转换成设备控制器可以接收的具体命令**
- 将这些命令**发送给设备控制器**
- 监督命令的执行

磁盘驱动程序功能：
- 计算请求块在磁盘的位置。如将磁盘逻辑块号转换成盘面号、磁道号、扇区号。
- 检查驱动器的电机是否正常运转，磁头是否定位在正确位置。
- **向控制器发送I/O命令**：若设备空闲则启动设备完成I/O操作，否则**将请求块挂在设备等待队列上**。
- **响应**由控制器或通道发来的**中断请求**，并**调用相应的中断处理程序**。若正常则将数据传送到与设备无关的软件层，否则报告错误。

设备驱动程序发出命令后，有两种处理方式：
- 驱动程序阻塞，直到中断信号将其唤醒。
- 设备驱动程序不阻塞，用于操作时间很短的情况如几个毫秒，这时睡眠唤醒开销太大。

## 7.6.3 与设备无关的软件
I/O软件的一部分（如设备驱动程序）与设备相关，其他部分则与设备无关。设备驱动程序与设备无关软件之间的界限随操作系统的不同而异。

**与设备无关软件**的**基本任务**是**实现一般设备都需要的I/O功能**，并向用户层软件**提供一个统一的接口**。

与设备无关软件通常应实现的功能包括：
- 设备命名：与设备无关软件负责**把设备的符号名映射到相应的设备驱动程序上**。
	例如，在UNIX系统中，像/dev/tty00这样的设备名唯一确定了一个特殊文件的 `i` 节点，这个 `i` 节点包含了主设备号和次设备号。主设备号用于**寻找对应的设备驱动程序**，而次设备号**提供了设备驱动程序的有关参数**，用来确定要读写的具体设备。  
- 设备保护：对设备进行必要的保护，防止无授权的应用或用户的非法使用。
例如，在大多数大型计算机系统中，用户进程对I/O设备的直接访问是完全禁止的；在UNIX系统中，使用存取权限来保护系统中的I/O设备。

- 提供与设备无关的逻辑块：不同磁盘可采用不同的扇区尺寸，与设备无关软件**应向高层软件提供大小统一的逻辑块**。
例如，可以将若干扇区合并成一个逻辑块。这样较高层软件只与抽象设备打交道，不考虑物理扇区的尺寸而使用等长的逻辑块。

- 缓冲管理：对于常见的块设备和字符设备，一般都使用缓冲区。
对块设备，硬件一般**一次读写一个完整块**，而用户进程是**按任意单位读写数据的**。如果用户进程只写了半块数据，则操作系统通常将数据保存在内部缓冲区，等到用户进程写完整块数据才将缓冲区的数据写到磁盘上。
对字符设备，当用户进程输出数据的速度**快于**设备输出数据的速度时，**也必须使用缓冲**。 

- 存储设备的空间管理：在创建新文件并向其中写数据时，通常要**为该文件分配新的存储块**。
为完成空间分配工作，操作系统需为每个磁盘设置一张空闲磁盘块表或位示图，因**查找一个空闲块的算法与设备无关**，可以将该算法放在与设备无关的软件层中处理。

- 独占设备的分配与释放：独占设备**在任何时刻只能被单个进程使用**，因此操作系统应对设备的使用请求进行检查，并根据设备状态决定是接收请求还是拒绝请求。
一个简单的处理方法是要求进程直接通过 `OPEN` 打开设备特殊文件来提出请求。若设备不能用，则 `OPEN` 失败。**关闭独占设备的同时释放该设备**。

- 错误处理：**一般出错处理由设备驱动程序完成**。大多数错误与设备相关，因此只有驱动程序知道应如何处理（比如：重试）。
但有些错误不是设备造成的，如因磁盘块受损而不能读，驱动程序将尝试重读一定次数，**若仍有错误则通知与设备无关软件**。
若在读用户文件时出现错误，操作系统会将错误信息报告给调用者。若在读一些关键系统数据时出现错误，比如位示图，操作系统则打印错误信息，并向系统管理员报告相应错误。

## 7.6.4 用户空间的软件
一般来说，大部分I/O软件都在操作系统中，但仍有一小部分**由与用户程序链接在一起的库函数、甚至运行于内核之外的程序**构成。

如函数 `printf` 完成输出及输出信息的格式化，标准I/O库中包含许多涉及I/O的过程，它们是作为用户程序的一部分运行的。

I/O系统的层次结构总结如下：
<img src="https://img-blog.csdnimg.cn/20200529004054741.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70" width="50%">

