@[toc]
### 1. 性能的含义
评价计算机的性能和评价其他事物的性能一样，有很多个角度。其中我们**最关心的是响应时间(执行时间)和吞吐率(带宽)**，执行时间衡量了完成某任务的总时间，吞吐率度量单位时间内完成的任务数量。两台计算机完成同一个程序，首先完成作业的计算机更快；一个数据中心，分别提供多个服务器给许多用户投放作业，一天内完成任务更多的那台计算机更快。

有的改进可能会改善这两者中的一点，如增加多个处理器分别处理独立的任务，可以增加吞吐率，但不会使得单个任务完成得更快；有的改进可能同时改善执行时间和吞吐率，如在处理更多任务，系统需要后续请求排队时，我们需要更换更快的处理器型号。**事实上，吞吐率和执行时间在很大程度上是相互影响的**。`降低响应时间几乎都会增加吞吐率，增加吞吐率有时会降低响应时间`。

这里我们主要考虑响应时间，希望响应时间最小化。

### 2. 性能的度量
性能是执行时间的倒数，提高性能意味着降低响应时间。
- 性能~X~ = 1 / 执行时间~Y~ 

如果两台计算机X和Y，X性能更好，那么：
- 性能~X~ > 性能~Y~
- 1 / 执行时间~X~ > 1 / 执行时间~Y~
- 执行时间~X~ < 执行时间~Y~

计算机X的性能是Y的n倍快，即有：
- 性能~X~ / 性能~Y~ = n
- 执行时间~Y~ / 执行时间~X~ = n

### 3. CPU性能
前面说的响应时间是个总时间，包括等待I/O、硬盘访问、内存访问、操作系统开销和CPU执行时间，为了区分开来运行自己程序的时间和一般的响应时间，我们可以使用CPU执行时间，简称CPU时间，它只表示在CPU上面花费的时间。需要注意的是：`用户感受到的是程序的响应时间，而非CPU时间`。
- CPU执行时间：执行某一任务在CPU上面花费的时间，可以分为用户CPU时间和系统CPU时间；
- 用户CPU时间：在程序本身花费的CPU时间；
- 系统CPU时间：为执行程序而花费在操作系统上的时间。

同时，我们使用系统性能(system performance)来**表示空载系统的响应时间**，而用CPU性能(CPU performance)**表示用户CPU时间**。我们重点关注CPU性能。

与CPU执行时间紧密相关的是计算机硬件完成基本功能的速度，计算机用时钟clock来驱动硬件中的各种事件。
- 时钟间隔的时间称作**时钟周期时间**clock cycle/tick/period，这里的时钟通常指的是处理器时钟；
- 它的**倒数为时钟频率**clock rate；
- 时钟长度是每个时钟周期持续的时间长度。

### 4. CPU性能影响因素和计量
本文的脉络很清晰了，这里**在计算机性能中我们更关注执行时间而非吞吐率，在执行时间中我们更关心CPU时间而非IO时间等，在CPU时间中我们更注意用户CPU时间而非系统CPU时间，重视CPU性能而非系统性能**。

由于我们关注的是CPU性能，那么我们能够发现哪些影响因素呢？
- 由于CPU性能和用户的程序相关，程序显然会影响到CPU性能；
- 同时我们必须关注硬件的实现，CPU性能离不开时钟周期时间/时钟频率；
- 我们可以认为程序影响CPU性能是通过程序运行的时钟周期数多少进行的，同一台计算机上面，运行的周期数越长，该程序的CPU性能越差。

由此我们得到了基本的公式：
- `CPU性能/用户CPU时间/一个程序的CPU执行时间 = 一个程序运行的时钟周期数 x 时钟周期时间`；
- 时钟频率和时钟周期时间互为倒数，那么有：一个程序的CPU执行时间 = 一个程序运行的时钟周期数 / 时钟频率。

这一公式将最基本的尺度(时钟周期时间和时钟周期数)与CPU时间联系起来，表明减少一个程序的CPU时钟周期数或者减少时钟周期时间，就能改进性能。当然，有时也需要权衡，减少时钟周期数可能会让时钟周期时间增加。

> 例题1. 某程序在时钟频率为2GHz的A计算机上面运行需要10s。试设计B计算机，缩短运行时间为6s。方法为提高时钟频率，但是这会使得B运行该程序时需要A的1.2倍的时钟周期数。计算B的时钟频率？

答案为4GHz。你答对了吗？

但是问题是我们如何得到一个程序运行的时钟周期数呢？要知道计算机是通过执行指令来运行程序的，显然指令数目会影响一个程序的CPU执行时间，同一台计算机上，程序的指令数目越多，则CPU执行时间越长。我们引入CPI(clock cycle per instruction)，**表示执行某个程序时每条指令所需的时钟周期数目的平均值**，得到下面的公式：
- 一个程序的CPU时钟周期数 = 程序的指令数 x CPI(每条指令的平均时钟周期数)；
- `CPU性能/用户CPU时间/一个程序的CPU执行时间 = 程序的指令数 x CPI x 时钟周期时间 = 程序的指令数 x CPI / 时钟频率`。

上面的第二条公式就是经典的CPU性能公式，它们把性能分解为三个关键因素，通过比较不同实现方案对三个因素的影响，就可以评估不同的方案。

> 例题2：**相同指令集的两种实现方式**，计算机A的时钟周期为250ps，对某程序的CPI为2；计算机B的时钟周期为500ps，对某程序的CPI为1.2。对于该程序，哪台计算机更快？快多少?

这是道典型的性能公式的应用题。固定程序在相同指令集下有着相同的指令数，但是不同计算机的CPI不同，时钟周期不同，性能就不同。答案是A是B的1.2倍快。

当然还需要注意的是，一个程序由多种指令组成，每种指令的CPI和数目都可能不同。那么该程序的CPU时钟周期数 = ∑CPI~i~ x C~i~，是这些指令时钟周期的加总。程序的CPI = CPU时钟周期数 / 指令数。不同的应用程序具有不同的CPI。

### 5. 小结
通过经典CPU性能公式，我们可以在知道程序的CPU执行时间、指令数目、指令所需的时钟周期数目的平均值、时钟周期时间/时钟频率的四者之三，就可以推出另外的一个。**只用一种因素(如指令数)去评价性能是愚蠢而危险的，比较不同计算机时，必须考虑全部三个因素，它们组合起来才能确定执行时间**。

至于实际如何确定性能公式中这三个因素的值，就是另外一回事了。

