流量控制就是**控制发送方的发送速率**，以保证接收方有时间接收。TCP 流量控制主要是通过**滑动窗口协议**实现的。

站在发送方的角度，滑动窗口可以分为四个部分：
- 发送并确认，此部分已经发送，可以忽略;
- 已发送但未确认，这部分可能在网络中丢失，数据必须保留以便必要时重传；
- 没有发送但可以发送，这部分**接收缓冲区有空间可以保存**，可以发送;
- 未发送且暂不可发送，此部分**已超过接收端缓冲区存储空间**，即使发送也无意义;
- **第2部分和第3部分加起来正好是接收方窗口的大小**，它**指定当前发送方可以发送的最大数据量**。
- 在收到确认回复消息之前，发送方**必须将发送的报文段保存在窗口中**（因为报文段可能在网络中丢失，所以必须将未确认的报文段保存在窗口中，**以便在必要时重传**）。==如果在指定的时间间隔内收到接收方的确认应答报文，这些段将从窗口中清除==。

当发送方收到接收方的确认回复后，清空窗口中的确认消息，窗口向右移动，如下图所示:
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202304081551454.png)
随着双方通信的进行，窗口将不断向右移动，因此被形象地称为滑动窗口（Sliding Window）。

对于 TCP 的接收方，窗口稍微简单点，分为三个部分：
- 已接收
- 未接收。准备接收 (也即接收窗口，再强调一遍，接**收窗口的大小决定发送窗口的大小**)
- 未接收并未准备接收。**由于 ACK 直接由 TCP 协议栈回复，默认无应用延迟**，不存在 “已接收未回复 ACK”
	![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202304081552201.png)

综上，举个例子，假设发送方需要发送的数据总长度为 400 字节，分成 4 个报文段，每个报文段长度是 100 字节:
1）三次握手连接建立时**接收方告诉发送方，我的接收窗口大小(rwnd) 是 300 字节**。此时的接收方滑动窗口如下：
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202304081553322.png)
此时的发送方滑动窗口如下：
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202304081553235.png)
2）发送方发送第一个报文段（序号 1 - 100），还能再发送 200 个字节
3）发送方发送第二个报文段（序号 101 - 200），还能再发送 100 个字节
4）发送方发送第三个报文段（序号 201 - 300），还能再发送 0 个字节
此时，发送方的窗口中存了三个报文段了。此时的发送方滑动窗口如下：
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202304081554562.png)
5）接收方接收到了第一个报文段和第三个报文段，**中间第二个报文段丢失**。此时接收方返回一个报文段 ack = 101, rwnd = 200（假设这里发生流量控制，把窗口大小降到了 200，允许发送方继续发送起始序号为 101，长度为 200 的报文）。
此时的接收方滑动窗口如下（本来窗口右端应该右移，但是这里发生了流量控制，接收方希望缩小窗口大小，所以正好，这里就不需要向右扩展了）：
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202304081556438.png)
![](https://image-1307616428.cos.ap-beijing.myqcloud.com/Obsidian/202304081556438.png)
发送方收到第一个包段的确认，并从窗口中删除第一个包段
此时的发送方滑动窗口如下：

6）发送端没有收到第二个报文段的确认回复，等待超时后重新发送第二个报文段。（序号 101 - 200）
7）接收端成功接收到第二个包段(窗口中有第二个和第三个包段)，并返回一个包段ack = 301, rwnd = 100给发送端(假设这里发生了流控制，将窗口大小减少到100)
此时的接收方滑动窗口如下：（本来窗口右端应该右移，但是这里发生了流量控制，接收方希望缩小窗口大小，所以正好，这里就不需要向右扩展了）

发送方收到了第二个和第三个报文段的确认，从窗口中移除掉这俩报文段
8）发送方发送第四个报文段（序号 301 - 400）
此时的发送方滑动窗口如下：


作者：LeetCode
链接：https://leetcode.cn/leetbook/read/7-day-interview-hou-duan/ddglem/
来源：力扣（LeetCode）
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。