> 本文属于「操作系统学习实践」系列文章之一。这一系列着重于「操作系统知识的学习与实践」。由于文章内容随时可能发生更新变动，欢迎关注和收藏[操作系统系列文章汇总目录](https://memcpy0.blog.csdn.net/article/details/120663693)一文以作备忘。需要特别说明的是，为了透彻理解和全面掌握操作系统，本系列文章中参考了诸多博客、教程、文档、书籍等资料，限于时间精力有限，这里无法一一列出。部分重要资料的不完全参考目录如下所示，在后续学习整理中还会逐渐补充：
> - 计算机操作系统，郑鹏、曾平、金晶编著，武汉大学出版社
> - 计算机操作系统，方敏、王亚平等编著，西安电子科技大学出版社
> - 深入理解计算机系统 *Computer Systems: A Programmer’s Perspective* ，`Randal E.Bryant, David O'Hallaron` 等著，龚弈棋利、雷迎春译，机械工业出版社

@[toc]

![[Pasted image 20220607160443.png]]

所有的计算机系统，都需要长期保存大量信息，而这些信息均以文件的形式存放到外存上。为了管理外存上的文件，操作系统中设置了管理文件的功能模块——文件系统。文件系统是操作系统的重要组成部分，==它负责管理文件，用统一的方式管理用户和系统信息的存储、检索、更新、共享和保护，并为用户提供一整套方便有效的文件使用和操作方法==。

本章介绍文件系统的概念（文件、文件系统、文件分类）、文件结构与存储设备（文件的逻辑结构、物理结构、存取方法、**存储设备**）、**文件存储空间的分配与管理**、文件目录管理、文件的共享与保护（包括文件的转储和恢复）、文件的使用。

---
# 8.1 文件系统的概念
## 8.1.1 文件和文件系统
### 1. 文件
[**文件**](https://en.wikipedia.org/wiki/Computer_file)是 ==**具有符号名**（即**文件名**）的**一组相关信息**的**集合**==。通常，文件由若干记录组成，**记录是一些相关数据项的集合**，而数据项是数据组织中可以命名的最小逻辑单位。例如，每个职工情况记录由姓名、性别、出生年月、工资等数据项组成，一个单位的职工情况记录就组成了一个文件。
### 2. 文件系统
[**文件系统**](https://en.wikipedia.org/wiki/File_system) ` file system` 是指，==操作系统中与管理文件有关的软件和数据的集合==：
- 从系统的角度看，文件系统是「对文件的存储空间进行组织和分配、负责文件的存储、并对存入文件进行保护和检索」的系统。具体来说，文件系统负责为用户建立、撤销、读写、修改和复制文件（即为用户提供接口）。
- 从用户的角度看，文件系统主要实现了**按名存取**。即，当用户要求系统保存一个已命名文件时，文件系统按照一定的格式，将用户的文件存放到文件存储器中适当的地方；当用户需要使用文件时，系统根据用户所给的文件名，能够从文件存储器中找到所需的文件。

文件系统由三部分组成：实施管理文件所需的**数据结构**、相应的**管理软件**和**被管理的文件**。文件系统的层次结构包含四层：
- 基本I/O控制层(`Basic I/O control level`)：又称**设备驱动程序层**，该层**主要由驱动程序组成**，负责**启动设备I/O操作**及**对设备发来的中断信号进行处理**。
- 基本文件系统层(`Basic file system level` )：又称**物理I/O层**，该层负责处理**内存和外存之间的数据块交换**。它关心数据块**在外存**和**在缓冲区**中的位置，无须了解传送数据块的内容或文件结构。
- 基本I/O管理程序层：又称文件组织模块层(`File-organization module level`)，负责**所有文件I/O的初始化和终止**。
该层完成的工作包括选择文件所在的设备、进行**文件逻辑块号到物理块号**的转换、优化磁盘调度的性能、对文件空闲存储空间进行管理等。
- 逻辑文件系统层(`The logical file system level`)：负责**处理文件及记录**的相关操作。如允许用户利用文件名访问文件及其中的记录、实现对文件及记录的保护、实现目录操作等。
- 文件系统接口：位于最上层。
![在这里插入图片描述](https://img-blog.csdnimg.cn/2020052916511259.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)
不同操作系统中，文件系统的组成方法不一样，但**这种组成具有代表性**。

## 8.1.2 文件分类
为了便于管理和控制文件，将文件分为若干类型。不同系统对文件的管理方式不同，因而**对文件的分类方法也有很大差异**。常见的文件分类方法有：

按用途可以将文件分为：
- 系统文件：**系统软件**构成的文件。
- 库文件：**系统提供给用户使用**的各种标准过程、函数和应用程序。
- 用户文件：**用户委托文件系统保存**的文件。

按保护级别可将文件分为：
- 只读文件：允许**所有者或授权用户**对其进行**读**，但不允许写。
- 读写文件：允许**所有者或授权用户**对其进行**读写**，但禁止未核准用户读写。
- 执行文件：允许核准用户**调用执行**，但**不允许**对其进行读写。
- 不保护文件：**不加任何访问限制**的文件。 

按信息流向可以将文件分为：
- 输入文件：来自输入设备的文件，如来自键盘的输入文件。
- 输出文件：写向输出设备的文件，如写向打印机的输出文件。
- 输入输出文件：如磁盘上的文件，**既可以读又可以写**。

按数据形式可以将文件分为：
- 源文件：由**源程序和数据**构成的文件。
- 目标文件：源程序**经过编译程序编译**，但尚未链接成可执行代码的**目标代码文件**。
- 可执行文件：由**链接程序链接后**形成的**可以运行的文件**。

---
# 8.2  文件结构及存储设备
文件结构指**文件的组织形式**，文件有两种形式的结构：
- 逻辑结构：又称**文件组织**，是**从用户观点出发**所看到的文件组织形式。
- 物理结构：又称**文件的存储结构**，是文件**在外存上的存储组织形式**。它与存储设备特性、外存分配方式有关。

## 8.2.1 文件的逻辑结构
文件的逻辑结构可分为两类：
- 记录式文件：是一种**有结构文件**，由**一组相关记录**组成。又分为：
	- 等长记录文件：又称**定长记录**文件，是指文件中所有记录的长度相等。
	- 变长记录文件：是指文件中**各记录长度不相等**。
- 流式文件：是一种**无结构文件**，由**字符序列**构成。

根据用户和系统管理的需要，可以采用**多种方式来组织记录式文件**：
- 顺序文件：一组记录**按关键字的大小顺序排列**所形成的文件。其中的记录通常是**定长**的。
- 索引文件：为文件**设置一个索引表**，文件中的**每个记录**在索引表中**有一个表项**，用于**存放记录的存放地址及长度**。
- 索引顺序文件：是前两者的结合。它将**顺序文件中的所有记录**分成若干组，为顺序文件**建立一张索引表**，为**每组中的第一个记录**建立一个**索引项**，其中含有该记录的键值和指向该记录的指针。

## 8.2.2 文件的物理结构
文件的物理结构与存储介质的存储特性及外存分配方式有关。

**文件存储设备**通常划分为**大小相等的物理块**，物理块是分配及传输信息的**基本单位**。物理块的大小与设备有关，但与逻辑记录的大小无关，因此**一个物理块中可以存放若干个逻辑记录**，**一个逻辑记录也可以存放在若干个物理块中**。

为有效地利用外存设备和便于系统管理，一般也**把文件信息划分为与物理存储块大小相等的逻辑块**。 

常见的**文件物理结构**有以下几种形式：
- 顺序结构：又称连续结构，它将一个**在逻辑上连续**的信息存放**在外存连续**的物理块中。以顺序结构存放的文件称为**顺序文件**或连续文件。
特点：**顺序存取速度较快**；对等长记录文件**支持随机访问**。但因要求连续存放，会**产生碎片**，同时也不利于文件的动态扩充。

- 链接结构：又称串联结构，它将一个逻辑文件的信息存放**在外存不连续的物理块中**，且在每个物理块中**设置一个指向下一个物理块的指针**。采用链接结构存放的文件称为**链接文件**或串联文件。
特点：**可解决碎片问题**，便于文件动态增长。但只能顺序访问，因而**查找效率较低**，指针占用存储空间。

- 索引结构：将一个逻辑文件的信息存放于外存的若干个物理块中，并**为每个文件建立一个索引表**，其中的每个表目存放**文件信息所在**的**逻辑块号和与之对应的物理块号**。采用索引结构存放的文件称为索引文件。
特点：既可以**顺序访问**也可以**随机访问**，但**增加了存储空间开销**，且要**两次访问外存**。

## 8.2.3 文件存取方法
常用的文件存取方法（`Access Methods`）有：
1. 顺序存取法 `Sequential Access`：**按照文件信息的逻辑顺序**依次存取。
在记录式文件中，顺序存取反映为**按记录的排列顺序**来存取；在流式文件中，顺序存取反映为**当前读写指针的变化**。
对定长记录的顺序文件，若知道当前记录地址，则很易确定下一个记录地址。
        $$rptr＝rptr＋L$$
其中 $L$ 为文件记录的长度，$rptr$ 为读写指针。

2. 直接存取法 `Direct Access`：又称随机存取法，允许**按任意顺序存取文件**中的任何一个物理记录。对于定长记录的顺序文件，若知道文件的**起始地址和记录长度**，则第 $i$ 个记录（$i＝0，1，2，…$）的首地址为
        $$rptr＝addr＋i×L$$
其中 $addr$ 是该文件的首地址，$L$ 为记录长度。

3. 按键存取法：实质上也是直接存取法，它根据文件记录中**数据项**（通常称为键），经过**某种方法计算处理**，转换成相应的物理地址后进行存取。


## 8.2.4 文件存储设备-1
文件的存储设备主要有磁带、磁盘、光盘等。**存储设备的特性可以决定文件的存取方法**。下面介绍以磁带为代表的顺序存取设备和以磁盘为代表的直接存取设备。

### 1.磁带Magnetic tape
磁带是一种典型的**顺序存取设备**。由于磁带机的启动和停止**要花费一定的时间**，因此在磁带的相邻物理块之间设计**有一段间隙将它们隔开**，如下所示。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529170014358.png)磁带的存取速度与**信息密度**（字符数/英寸）、**磁带带速**（英寸/秒）和**块间间隙**有关。

如果带速高、信息密度大且所需块间隙（磁头启动和停止时间）小，则磁带**存取速度高**。反之，若磁带带速低、信息密度小且所需块间隙（磁带启动和停止时间）大，则磁带存取速度低。

### 2. 磁盘
磁盘是典型的**直接存取设备**。
- 磁盘一般由**若干磁盘片**组成，可**沿一个固定方向**高速旋转。**每个盘面对应一个磁头**，**磁臂可沿半径方向移动**。
- 磁盘上的一系列同心圆称为磁道（`track`）， 磁道沿径向又分成**大小相等的多个扇区**（`sector`），与盘片中心**有一定距离的所有磁道**组成一个**柱面**（`cylinder`）。 
- 磁盘上的每个物理块可用**柱面号，磁头号和扇区号**表示。

磁盘数据组织和格式示意图：
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529170039181.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)磁盘访问时间由三部分组成：
- 寻道时间（`seek time`）：指将**磁头**从当前位置**移动到指定磁道**所经历的时间。由**启动磁臂时间**和**磁头移动多条磁道**的时间构成。
- 旋转延迟时间（`rotational latency`）：指**扇区移动到磁头下面**所经历的时间。平均旋转延迟时间是每转所需时间的一半。
- 传输时间（`tranfer time`）： 指**从磁盘上读出数据**或**向磁盘写入数据**所经历的时间。

由于这三部分操作**均涉及机械运动**，故磁盘块的访问时间约为 `0.01～0.1s` 之间，其中**寻道时间所占的比例最大**。

### 3. 存储设备、存取方法和物理结构的关系
文件的**物理结构**与**文件存储器的特性**和**存取方法**密切相关。
- 磁带是一种**顺序存取设备**，适合采用**顺序结构存放文件**，相应的存取方法通常是**顺序存取法**。若采用其他文件结构或采用直接存取方式都不太合适a。
- 磁盘属于**直接存取存储设备**，前述的几种物理结构**都可以采用**。存取方法也可以**多种多样**。
- 如果采用顺序存取法则前述的几种文件结构都可以采用。如果采用直接存取法，则索引文件效率最高，顺序文件效率居中，串联文件效率最低。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529172014857.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)
### 4. 磁盘调度算法
磁盘是**可以被多个进程共享**的设备。当有多个进程都请求访问磁盘时，应采用**一种适当的调度算法**，以使各进程对磁盘的**平均访问时间**（**主要是寻道时间**）最短。下面介绍几种磁盘调度（`Disk Scheduling`）算法。
- 先来先服务 `FCFS` ：**按进程请求访问磁盘的先后次序**进行调度。
特点：简单合理，但未对寻道进行优化。
先来先服务算法例子：从 `100` 号磁道开始，磁盘访问请求为：`55、58、39、18、90、160、150、38、184` ，平均寻道长度为：`(45+3+19+21+72+70+10+112+146) / 9 = 55.3` 。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529172244247.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)
- 最短寻道时间优先（`Shortest-Seek-Time-First`）：算法选择**与当前磁头所在磁道距离最近的请求**作为下一次服务的对象。
特点：寻道性能比 `FCFS` 好，但**不能保证平均寻道时间最短**，还可能会**使某些请求总也得不到服务**。
同时，假如从 `100` 号磁道开始，磁盘访问请求为：`55、58、39、18、90、160、150、38、184`，平均寻道长度为：`27.6` 。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529172639704.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)
- 扫描算法 `SCAN` ：`SCAN` 算法**在磁头当前移动方向上**选择**与当前磁头所在磁道距离最近**的请求作为下一次服务的对象。因这种算法中磁头移动规律颇似电梯的运行，故又称为**电梯调度算法**。
特点：具有**较好的寻道性能**，能避免进程饥饿(进程的请求总也得不到服务)，但**不利于两端磁道的请求**。 
同样的请求，从 `100` 号磁道开始，**向磁道号增加方向移动**。磁盘访问请求为：`55、58、39、18、90、160、150、38、184`，平均寻道长度为：`27.8`。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529173043665.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)
- 循环扫描算法 `CSCAN` ：`C(circular)SCAN` 算法是 `SCAN` 算法的改良，它规定**磁头单向移动**。例如，**自里向外移动**，当**磁头移到最外磁道时立即又返回到最里磁道**，如此**循环进行扫描**。
特点：该算法**消除了对两端磁道请求的不公平**。
例子：从 `100` 号磁道开始，**向磁道号增加方向移动**。磁盘访问请求为：`55、58、39、18、90、160、150、38、184` ，平均寻道长度为：`35.8`。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529173321708.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)
- `N-Step-SCAN` ：若多个进程反复请求对某一磁道的访问，则**磁臂可能停留在某处不动**，这一现象称为**磁臂粘着**。
`N-Step-SCAN`算法**将磁盘请求队列分成**若干个长度为 $N$ 的**子队列**，磁盘调度按 `FCFS` 算法**依次处理这些子队列**，而**处理每个队列**时按 `SCAN` 算法进行，一个队列处理完后，再处理其他队列。
- `FSCAN` 算法：是 `N-Step-SCAN` 算法的简化，它**只将磁盘请求队列分成两个子队列**。一个是**当前所有**请求磁盘I/O的进程形成的队列，由磁盘调度按 `SCAN` 算法进行处理，另一个队列则是**在扫描期间新出现**的磁盘请求。

### 5. 磁盘容错技术
容错技术：通过在系统中**设置冗余部件**来**提高系统可靠性**的一种技术。

磁盘容错技术：通过**增加冗余磁盘驱动器**、**磁盘控制器**等方法来**提高磁盘系统可靠性**的一种技术。也称为系统容错技术。系统容错分为三级：
- 第一级容错技术（低级磁盘容错技术）：是**最基本**的一种磁盘容错技术，主要用于**防止因磁盘表面缺陷**所造成的数据丢失。它包含：
	- 双份目录、双份文件分配表：**目录和文件分配表**是文件管理的**重要数据结构**，为防止它们被破坏，可在不同的磁盘上或在磁盘的不同区域中建立**双份目录和文件分配表**，一份称为主目录或主文件分配表，另一份称为**备份文件目录及备份文件分配表**。
	一旦主目录或主文件分配表被破坏，则启用备份文件目录及文件分配表。**系统启动时**也要对两份数据结构进行**检查**，以验证**它们的一致性**。

	- 当磁盘出现**较少缺陷**时，可采用以下两种补救措施：
		- 热修复重定向：将**磁盘中的一部分**作为<ins>热修复重定向区</ins>，用于存放当发现磁盘有缺陷时的**待写数据**，并对**写入该区的所有数据进行登记**，便于以后对数据进行访问。
		- 写后读校验：每次向磁盘中写入一个数据块后**又立即**从磁盘上读出该数据块，与写入数据进行比较，**若相同则写下一块**，否则重写。若重写后仍不一致，则认为该盘块有缺陷，此时便**应将该块数据写入热修复重定向区**。

- 第二级容错技术（中级磁盘容错技术）：第一级容错技术只能用于防止由磁盘表面部分故障造成的数据丢失。若**磁盘驱动器发生故障**，则应采用第二级容错技术。
第二级容错技术主要用于**防止由磁盘驱动器及磁盘控制器故障**所导致的系统不能正常工作。
	- 磁盘镜像 `disk mirroring`：在同一磁盘控制器下，再增**设一个完全相同的磁盘驱动器**。
在每次向主磁盘写入数据后，都采用**写后校验**方式，将数据**再同样写到备份磁盘上**，使两个磁盘上有**完全相同的位像图**。当主磁盘发生故障时，启用备份磁盘并发出警告。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529185645811.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)	- 磁盘双工 `Disk Dupluxing`：将**两台磁盘驱动器**分别接到**两个磁盘控制器**上，同样使这两台磁盘驱动器**镜像成对**。
在磁盘双工时，文件服务器**同时将数据写到**两个处于不同控制器下的磁盘上，使两者有**完全相同的位像图**，如果其中的一台磁盘发生故障，另一台仍然可以工作，同时发出警告。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529185738177.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)

- 第三级容错技术（高级系统容错技术）：第三级系统容错是在提供一、二级容错的基础上，提供**文件服务器镜像功能**。
主服务器与从服务器是**配置完全相同的两台计算机**。每台服务器除了按常规加插网卡外，还需**插入一块镜像服务器接口卡**，然后**用光缆将两块镜像服务器接口卡连接起来**。
主服务器是当前正在为工作站提供网络服务的服务器。系统自动将主服务器的内存和硬盘中的数据复制到从服务器。当主服务器发生故障时，从服务器成为网中的主服务器，使网络不受影响地正常工作。当故障排除后，**两台服务器重新同步**。

---

在并行交叉磁盘存储系统中，有**多台磁盘驱动器**，系统将每一盘块中的数据**分为若干个子盘块的数据**，再把每一子盘块的数据**分别存储到各个不同磁盘中的相同位置**。以后要读写数据时，采取**并行传输方式**，将各个盘块中的子盘块数据同时向内存中传输，从而使传输时间大大减少。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529190000105.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)
独立磁盘冗余阵列（`Redundant Array of Independent Disks`）是利用一台**磁盘阵列控制器**来统一管理和控制**一组磁盘驱动器**，组成一个高速可靠的，快速的大容量磁盘系统。原来称为廉价磁盘冗余阵列。
- 在 `RAID` 中，数据通过**分拆**均匀地写到每一个驱动器上。
- `RAID` 提供了与**磁盘双工及磁盘镜像**类似的冗余。冗余级别取决于 `RAID` 级别。
	- `RAID0` 级：仅提供**并行交叉存取**，它虽能**有效地提高磁盘I/O速度**，但**无冗余校验功能**，致使磁盘系统的可靠性不好。**故很少使用**。
	- `RAID1` 级：具有**磁盘镜像功能**，可利用并行读写特性，将数据分块并同时写入主盘和镜像盘。其速度比传统镜像盘快，但磁盘利用率只有 `50%` 。磁盘镜像的示意图：
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529190153216.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)	
  - `RAID3` 级：具有**并行传输**功能的磁盘阵列。利用**一台奇偶校验盘**来完成容错。比磁盘镜像减少了所需的冗余磁盘数。**常用于科学计算和图像处理**。
  - `RAID2` 级同 `RAID3` 级类似，但是用**编码技术来提供错误检查及恢复**，实施较复杂。在商业环境中**很少使用**。
  - `RAID4` 级同 `RAID3` 级类似，但数据是**按扇区拆分**，在商业环境中也**很少使用**。
  - `RAID5` 级：是一种**具有独立数据传送功能**的磁盘阵列。每个驱动器都**有自己独立的数据通道**，独立地进行读写，纠错信息散布在所有数据盘上。**常用于I/O繁忙的事务处理**。
  - `RAID6` 级：设置了一个**专用的可快速访问的异步校验盘**，该盘具有独立的数据访问通道，比 `RAID3` 、`RAID5` 级性能更好。
  - `RAID7`：这是一种新的 `RAID` 标准，其自身带有**智能化实时操作系统**和用于存储管理的软件工具，可**完全独立于主机运行**，不占用主机CPU资源。



---
# 8.3 文件存储空间的分配及管理

为了实现文件系统，必须解决**文件存储空间**的**分配和回收**问题，还应对文件存储空间进行**有效的管理**。
## 8.3.1 文件存储空间的分配
文件存储空间的分配常采用两种方式：
- 静态分配：在文件建立时**一次分配所需的全部空间**。
- 动态分配：根据需要进行分配。

在分配区域大小上，也可以采用不同方法。可以**为文件分配一个连续区域**，但文件存储空间的分配**通常以块或簇**（几个连续物理块称为簇，一般是固定大小）**为单位**。

常用的外存分配方式有：
- 连续分配
- 链接分配
- 索引分配

### 1. 连续分配 Continuous Allocation
连续分配：为文件分配连续的磁盘空间。在这种分配方法中，用户必须**在分配前说明**待创建文件**所需的存储空间大小**。然后系统查找**空闲区管理表格**，若有就给文件分配所需的存储空间，否则文件不能建立。连续分配示意图：
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529173932829.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70) 
连续分配的特点是：
- **顺序访问容易**且**速度快**，目录中**文件存储位置信息简单**；
- 但**容易产生碎片**，**需要定期**对磁盘空间进行**整理**。

### 2. 链接分配 Linked Allocation
链接分配有两种实现方案：
- 以扇区为单位的链接分配：按文件的要求**分配若干个磁盘扇区**，属于同一文件的各扇区**按文件记录的逻辑次序**用链接指针链接起来。
当文件增长时就为文件分配新的空闲扇区，并**将其链接到文件链上**；同样当文件缩短时将释放的扇区归还给系统。
特点：**消除了碎片**，不需要压缩。但**查找慢**，链接指针的存储及维护有一些开销。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529174039961.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)
- 以区段（或簇）为单位的链接分配：以**区段（或簇）为单位**分配，是**连续分配和非连续分配**的结合，**现广为使用**。区段**由若干个连续扇区组成**，文件所属**各区段可以用链接指针、索引表等方法**来管理。
此策略的优点是对辅存的管理效率较高，并**减少了文件访问的查寻时间**。

文件分配表File Allocation Table
文件分配表FAT是以链接方式存储文件的系统中记录磁盘分配和跟踪空白盘块的数据结构。
该表整个文件系统仅设一张，其结构如下所示。表的序号是物理块号，从0开始直至N－1（N为盘块总数）。
每个表项中的内容为存放文件数据的下一个盘块号。
文件的首地址（第一个盘块号）存放在目录中。因此，从目录中找到文件的首地址后，就能找到文件在磁盘上的所有存放地址。
![在这里插入图片描述](https://img-blog.csdnimg.cn/2020052919073097.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)
文件分配表例1：假定磁盘块的大小为1KB，对于1.2MB的软盘，其文件分配表FAT需要占用多少存储空间？
若硬盘容量为200MB时，FAT需要占用多少空间？

文件分配表例2
软盘大小为1.2MB，磁盘块的大小为1KB，所以该软盘共有盘块：1.2M/1K=1.2K（个）
又   1K＜1.2K＜2K，
故1.2K个盘块号要用11位二进制表示，为了方便存取，每个盘块号用12位二进制描述，即文件分配表的每个表目为1.5个字节。
FAT要占用的存储空间总数为：
    1.5×1.2K=1.8KB

文件分配表例3
若硬盘大小为200MB，硬盘共有盘块：
       200M/1K=200K
又  128K＜200K＜256K，
故200K个盘块号要用18位二进制表示。为方便文件分配表的存取，每个表目用20位二进制表示，即文件分配表的每个表目大小为2.5个字节。
FAT要占用的存储空间总数为：
    2.5×200K=500KB

### 3. 索引分配 indexed allocation 
链接分配方式虽解决了连续分配方式中存在的问题，但又出现了新的问题：
- 不支持随机存取
- 链接指针要占用一定数量的磁盘空间

在索引分配方法中，系统**为每个文件分配一个索引块**，索引块中**存放索引表**，索引表中的每个表项**对应分配给文件的一个物理块**。索引分配示意图如下：
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529190906276.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)

索引分配的特点：索引分配方法支持直接访问，不会产生外部碎片；
但索引块要占用一定的存储空间，存取文件需要两次访问外存。

二级索引和多级索引	
当文件很大，其索引表的大小超过了一个物理块时，可以将索引表本身作为一个文件，再为其建立一个“索引表”，该“索引表”是文件索引的索引，从而构成了二级索引。
第一级索引表的表目指向第二级索引，第二级索引表的表目指向文件信息所在的物理块号。以此类推可再逐级建立索引，进而构成多级索引。
两级索引分配示意图
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529190942916.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)
两级索引分配允许的文件最大长度
在两级索引分配方式下，如果每个盘块的大小为1KB，每个盘块号占4字节，则：
一个索引块中可以存放：
       1KB/4B=256个盘块号
两级索引最多可以存放的盘块数为：
       256×256=64K个盘块号
因此可以允许的最大文件长度为：
         64K×1KB=64MB

混合索引分配方式
混合索引分配方式是将多种索引分配方式相结合而形成的一种分配方式。这种方式已用于UNIX、Linux等系统中。
在UNIX System Ⅴ中，共设有13个地址项，包括10个直接地址项、一个一次间接地址项、一个二次间接地址项和一个三次间接地址项。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529191022265.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)直接地址
为了提高对文件的检索速度，在索引节点中建立了10个直接地址项，每个地址项中存放相应文件所在的盘块号。
假定一个盘块的大小为4KB，当文件长度不大于40KB时，可以直接从索引节点中得到文件存储的所有盘块号。

一次间接地址
一次间接地址项中存放的不是存储文件数据的盘块号，而是先将多个盘块号存放在一个磁盘块中，再将该磁盘块的块号存放在一次间接地址项中。
若盘块大小为4KB，一个盘块号占4字节，则一个盘块中可以存放下：4KB/4B=1K个磁盘块号。
一次间接地址项寻址范围为：1K×4KB=4MB。
多次间接地址
该地址结构中还有二次间接地址和三次间接地址。
二次间接地址的寻址范围是：1K×1K×4KB=4GB。
三次间接地址的寻址范围是：1K×1K×1K×4KB=4TB。


## 8.3.2 空闲存储空间的管理
为了实现文件存储空间的分配，首先应**记住空闲存储空间**的情况。常用的空闲存储空间管理（`Free-Space Management`）方法有：
- 空闲文件目录
- 空闲块链
- 位示图

### 1. 空闲文件目录

文件存储设备上的一个连续空闲区可以看作一个空闲文件，又称空白文件或自由文件。
空闲文件目录方法为所有空闲文件建立一个目录，每个空闲文件在该目录中占一个表目，其中至少包括：空闲区序号、第一个空闲块块号、空闲块数目等信息。
下面给出了一个空闲目录的例子。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529191144853.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)空闲文件目录法的空闲空间管理
当请求分配存储空间时，系统依次扫描空闲文件目录，直到找到一个能满足要求的空闲文件为止。若该文件大小大于申请空间量则还要进行划分。
当回收存储空间时，也需要顺序扫描空闲文件目录，寻找一个空表目，并将释放空间的第一个物理块号以及释放空间的块数填到这个表目中。若释放空间与已有空闲文件邻接，则需进行合并。
显然，只要将动态分区管理方法中的算法稍作修改，即可用于空闲文件目录方法。
特点：仅当文件存储空间中只有少量空闲文件时该方法有比较好的效果，否则空闲目录变大导致其效率下降。该方法仅适用于连续文件。


### 2. 空闲块链
空闲块链方法（Linked Free Space List）将文件存储设备上的所有空闲块链接起来，并设置一个头指针指向空闲块链的第一个物理块。
当申请分配存储空间时，就按需要从链首依次取下几个物理块分配给文件。当回收存储空间时，将回收的空闲块依次链入空闲块链中。
空闲块链的特点及改进
特点：实现简单但工作效率低，因为在空闲块链上增加或移去空闲块时要进行链表操作。
一种改进方法是将空闲块分成若干组，再用指针将组与组链接起来，将这种管理空闲块的方法称为成组链接法。成组链接法在进行空闲块的分配与回收时要比空闲块链方法节省时间。

成组链接法
UNIX系统采用成组链接法对空闲盘块加以组织。
空闲盘块的组织：将若干个空闲盘块划归一组，将每组中的所有盘块号存放在其前一组的第一个空闲盘块号指示的盘块中，而将第一组中的所有空闲盘块号放入超级块的空闲盘块号表中。成组链接法示意图

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529191307693.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)空闲盘块的分配
当要分配一个盘块时，首先将超级块空闲盘块号表中下一个可用盘块分配出去；
如果所分配盘块号是超级块中最后一个可用盘块号，则先将该盘块中的内容读入超级块空闲盘块号表中，然后才将该盘块分配出去。
分配超级块中最后一个盘块号例
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529191333436.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)空闲盘块的回收
在回收空闲盘块时，如果超级块中的空闲盘块号表未满，可直接将回收盘块的编号放入空闲盘块号表中；
若空闲盘块号表已满，需先将空闲盘块号表中的所有盘块号复制到新回收的盘块中，再将新回收盘块的编号放到超级块空闲盘块号表中，此块号就成了表中惟一的盘块号。
超级块已满时回收盘块例
![在这里插入图片描述](https://img-blog.csdnimg.cn/2020052919140229.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)
### 3. 位示图（BitMap）法
位示图是反映**整个存储空间分配情况**的数据结构。在位示图中，**每一个二进制位**都对应**一个物理块**，当某位为 $1$ 时表示该块已分配，当某位为 $0$ 时表示该块空闲。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529191433743.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)盘块的分配
在位示图方法中，盘块分配分为三步：
- 系统顺序扫描位示图，从中找出一个（组）值为0的二进制位。
- 再经过换算得到相应的盘块地址：
	$$\text{盘块号=行号*每行二进制位数+列号}$$
修改位示图，将相应位置1。

盘块的回收
盘块回收分两步：
将回收的盘块号转换成图中的行号、列号。
行号=盘块号 / 每行二进制位数
列号=盘块号 % 每行二进制位数
修改位示图，将相应位清0。：
特点：因位示图比较小，可以保存在主存中，因此空间的分配与回收较快；但需要进行位示图中二进制所在位置与盘块号之间的转换。


---
# 8.4 文件目录管理
计算机系统中的文件种类繁多，数量庞大，为了有效地管理这些文件，方便用户查找所需的文件，应对它们**加以适当的组织**。文件的组织可以**通过目录来实现**。

## 8.4.1 文件目录
从文件管理的角度看，文件由**文件说明**和**文件体**两部分组成。
- 文件体即文件本身，而文件说明是**保存文件属性信息**的**数据结构**，又称为**文件控制块**。
- 文件控制块（`file control block`）包含的具体内容因操作系统而异，但至少应包括以下信息： 
	- 文件名：标识一个文件的符号名。
	- 文件类型：如文本文件。
	- 文件结构：说明文件的**逻辑结构和物理结构**。
	- 文件的物理位置：指示文件在外存上的存储位置。包括设备名、存储地址及文件长度等。
	- 存取控制信息：指示**文件的存取权限**。
	- 管理信息：包括文件建立的日期及时间、上次存取日期及时间、当前文件使用状态信息。
- DOS的文件控制块：文件名及扩展名占 `11` 字节；属性占 `1` 字节，包括**只读、隐藏、系统、卷标、子目录及归档**；上次存取时间及日期各占 `2` 个字节；文件**起始簇号**占 `2` 个字节；文件长度占 `4` 个字节。整个 `FCB` 的长度为 $32$ 字节。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529191931776.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)


文件目录及目录文件
- 目录（`directory`）：**文件控制块的集合**。即文件控制块是一个目录项。
- 目录文件：**文件的内容**为**目录信息**。

目录具有的功能：
- 实现“按名存取”：用户**只需提供文件名**就可以对文件进行操作。这是目录管理的**最基本功能**。
- 提高检索速度
- 允许文件同名：不同目录下的文件可以使用相同名字。
- 允许**文件共享**

常用的文件目录结构有：
- 单级目录结构
- 二级目录结构
- 多级目录 结构

## 8.4.2 单级目录结构
 单级目录结构（`Single-Level Directory Structure`）又称一级目录结构。在这种结构中，**整个文件系统只建立一张目录表**，**每个文件**占据其中的**一个表目**。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529192117514.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)
单级目录结构的操作：
- 建立新文件时，首先应确定该文件名在目录中是否惟一，**若惟一则找出一个空表目**，将新文件的相关信息填入其中。
- 删除文件时，先从目录表中找到文件的目录项，从中**找到该文件的物理地址**，**对其占用空间进行回收**，然后**再清除其所占用的目录项**。

单级目录结构的特点：易于实现，管理简单；但当系统中文件数增多时，查找时间较长，**易发生重名问题**。

## 8.4.3 二级目录结构
二级目录结构（`Two-level Directory Structure`）将文件目录分成：
- 主文件目录（`master file directory`）：记录**用户名**及**相应用户文件目录**所在的存储位置。
- 用户文件目录（`user file directory`）：记录该**用户文件**的有关信息。

二级目录结构示意图：
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529192411279.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)
二级目录结构的操作：
- 当用户想建立文件时，如果是**新用户**，则系统为其**在主目录中分配一个表目**，并为其**分配存放用户文件目录的存储空间**。同时**在用户文件目录中为新文件分配一个表目**，并在表目中**填入有关信息**。
- 文件删除时，只须**在用户文件目录中删除该文件的目录项**。如果删除后该用户目录表为空，则**表明该用户已脱离了系统**，从而可以**将主文件目录表中该用户的对应项删除**。

二级目录结构的特点：
- 二级目录**可以解决文件重名问题**，并可获得较高的查找速度；
- 但二级目录结构缺乏灵活性，特别是无法反映真实世界复杂的文件组织形式。

## 8.4.4 多级目录结构
多级目录结构是二级目录结构层次关系的推广，也称为树型目录结构（`Tree-structured Directories Structure`）。
在多级目录结构中，第一级目录称为**根目录**（树根），目录树中的**非叶节点均为目录文件**（又称**子目录**），**叶结点为文件**。
多级目录结构示意图：
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529192652755.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)
相关的概念有：
- 路径名 `Path Name` ：是一个**字符串**，该字符串由**从根目录出发到所找文件的通路上**所有**各级子目录名和该文件名**用**分隔符连接**起来构成。
- 从根目录出发的路径称为绝对路径（`absolute path`）。
- 当前目录 `current directory`：当目录层次较多时，每次从根目录开始查找文件很费时间，为此引入了当前目录。由用户**在一定时间内指定某个目录为当前目录**，或称工作目录。
进程对各文件的访问**相对于当前目录进行**，此时文件使用的路径名为相对路径（`relative path`），它由**从当前目录出发到所找文件的通路上**的所有**目录名与数据文件名**用**分隔符连接**起来而形成。
下图中，文件 `15` 的绝对路径：`/B/F/J` 。若当前目录为 `/B/F`，文件 `15` 的相对路径为：`J`：
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529192902546.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)
- 有两个特殊目录：`..` 表示给定目录的**父目录**；`.` 表示当前目录。


图形目录结构 `Graph Directory` : 树型目录结构的自然推广就是图形目录结构。它**允许一个文件或目录出现在多个父目录中**。在 `UNIX` 中，这种结构称为**链接**。

![在这里插入图片描述](https://img-blog.csdnimg.cn/2020052919310628.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)

---
# 8.5 文件共享及管理的安全性
文件共享是指**不同用户**可以**共同使用**某文件。文件共享的动机是：
- 用户合作
- 减少磁盘空间的开销
- 减少文件的不一致性

共享语义：是文件系统对**共享文件或目录**冲突访问的处理方法。**不同共享语义**定义了对缓存一致性问题的不同解决方案。

## 8.5.1 文件共享
早期实现文件共享的方法有三种：
绕道法：要求每个用户在当前目录下工作，用户对所有文件的访问都相对于当前目录进行。
用户使用相对路径访问文件。当访问文件不在当前目录下时，用户应从当前目录出发向上返回到与所要共享文件所在路径的交叉点，再顺序向下访问到共享文件。
因绕道法要绕弯路访问多级目录，从而其搜索效率不高。

链接法将一个目录中的链指针直接指向被共享文件所在的目录。
采用链接法实现文件共享时，应在文件说明中增加“连访属性”和“用户计数”两项。前者说明文件物理地址是指向文件还是指向共享文件的目录，后者说明共享文件的用户数目。
若要删除一个共享文件，必须判别是否有多个用户共享该文件，若有则只做减1操作，否则才真正删除此共享文件。链接示意图—虚线表示链接：
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529193240491.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)
基本文件目录表法把所有文件目录的内容分成两部分：
基本文件目录表（BFD）：由文件的属性信息及内部标识符组成。
符号文件目录表（SFD）：由文件符号名和内部标识符组成。

特殊标识符在文件系统中通常规定：
0：基本文件目录标识
1：空闲文件目录标识
2：主目录标识符

基本文件目录示意图
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529193315200.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)
用基本文件目录法可以方便地实现文件共享。若要共享某个文件，只需在相应的目录文件中增加一个目录项，在其中填上符号名及被共享文件的标识符。
如上图中，用户Wang和Gao共享标识符为6的文件，对于系统来说，标识符6指向同一个文件；而对Wang和Gao两个用户来说，则对应于不同的文件名Beta和Alpha。 

基于索引节点的共享方式
当多个用户需要共享文件时，可以将共享文件链接到多个用户的目录中，如右图所示。
图中H的一个文件现在也出现在D的目录下，D称为该共享文件的一个链接。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529193337860.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)文件共享中存在的问题
用链接实现文件共享很方便，但也带来一些问题。
如目录中包含文件的物理地址，则在链接文件时要将文件的物理地址复制到D目录中。但若随后通过D或H往该文件中添加内容，则新数据块将只会出现在进行添加操作的目录中，这种改变对其他目录而言是不可见的，因而新增加的这部分内容不能被共享。

解决办法
为了解决这个问题，可以将文件说明中的文件名和文件属性信息分开。
索引节点：文件属性信息构成的数据结构，又称i节点。
采用这种实现方案，文件目录项仅由文件名和索引节点号构成。

基于索引节点的共享示意图
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200529193428697.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)此时，任何用户对文件的修改都会反映在索引节点中，其他用户可以通过索引节点存取文件。

**磁盘索引节点**：每个文件有一个惟一的索引节点，主要包含：
- 文件主标识：
- 文件类型：正规、目录、特别
- 文件存取权限
- 文件物理地址
- 文件长度
- 文件链接计数：目录树中指向此文件的路径数。
- 文件存取时间

内存索引节点：文件打开时，要将磁盘索引节点拷贝到内存。内存索引节点除包含磁盘索引节点内容外，还应增加：
- 索引节点号
- 状态：索引节点是否上锁、修改
- 访问计数：正在使用此文件的进程数
- 文件所属文件系统的逻辑设备号
- 链接指针：如空闲队列、散列队列

索引节点中的链接计数
在索引节点中有一个链接计数count字段，用于表示链接到本索引节点的目录项的数目。
当count＝2时，表示有两个目录项链接到本文件上。

链接例--C创建一个新文件
当用户C创建一个新文件时，他是该文件的所有者，此时count值为1。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200530013643325.png)

链接例-- B链接到C的文件
当用户B希望共享此文件时，应在用户B的目录中增加一个目录项，并设置指针指向该文件的索引节点，此时文件的所有者仍然是C，但索引节点的链接计数应加1（count＝2）。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200530013618739.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)
链接例--C创建一个新文件
如果以后用户C不再需要该文件，则系统只删除C的目录项，并将count减1。
此时只有B拥有指向该文件的目录项，而该文件的所有者仍然是C。如果系统进行记账，C将继续为该文件付账。
当B不再需要它，count为0，该文作被删除。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200530013559710.png)
硬链接
基于索引节点的文件共享方式是通过在不同目录项中设置相同索引节点号来实现的。
这种文件的链接方式称为硬链接。
硬链接的不足是无法跨越文件系统。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200530013545855.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)

利用符号链接实现文件共享
利用符号链接也可以实现文件共享。
例如，B为了共享C的一个文件f，可以由系统创建一个LINK类型的新文件b1，并把新文件b1添加到B的目录中，以实现B的一个目录b1与文件f的链接。
新文件中只包含被链接文件f的路径名，称这种链接方式为符号链接。也称为软链接。 


符号链接示意图
文件f的内容是：abcde。
文件b1的内容是：/C/f。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200530013503731.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)
文件的访问
当用户B要访问被链接的文件f时，操作系统发现要读的文件b1是LINK类型，则由操作系统根据文件b1中的路径名去读该文件，从而实现了用户B对文件f的共享。


文件的删除：
在利用符号链接实现文件共享时，仅文件所有者拥有指向其索引节点的指针，共享该文件的用户只有其路径名，而没有指向索引节点的指针。
当文件所有者删除文件后，其他用户若试图通过符号链接访问该文件将导致失败，因为系统找不到该文件，于是将符号链删除。

符号链接的特点：
符号链接的不足是需要额外的开销（根据文件路径名逐个分量进行查找，需要多次访问磁盘）。另外，符号链接需要配置索引节点以及一个磁盘块用于存储路径，这也要消耗一些磁盘空间。
符号链接的优点是只要提供一个机器的网络地址以及文件在该机器上的驻留路径，就可以链接全球任何地方的机器上的文件。即可以跨越文件系统。

---
## 8.5.2 文件保护
系统中的文件既存在**保护**问题，又存在**保密**问题。
- 文件保护是指**避免**文件拥有者或其他用户因有意或无意的错误操作使**文件受到破坏**。
- 文件保密是指**文件本身不得被未授权的用户访问**。

这两个问题都**涉及用户对文件的访问权限**，即文件的存取控制（`Access Control`）。下面介绍几种常用的存取控制方法。 

### 1. 常用的存取控制方法
1. 存取控制矩阵
存取控制矩阵是一个**二维矩阵**，其中一维**列出**使用该文件系统的**全部用户**；另一维列出存入系统中的**全部文件**。
矩阵中的**每一个元素**用来表示**某个用户对某个文件的存取权限**。存取权限可以为**读、写、执行**以及它们的**任意组合**。 
存取控制矩阵例子：
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200530012722583.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)
当用户向文件系统**提出存取请求**时，由**存取控制验证模块**利用这个存取控制矩阵将本次请求和该用户对这个文件的**存取权限进行比较**，如果不匹配就拒绝执行。

    存取控制矩阵法的优点是简单、清晰。缺点是不够经济，即当用户和文件较多时，**存取控制矩阵将变得非常庞大**。故它**没有得到普遍应用**。

 2. 存取控制表
存取控制矩阵是一个**稀疏矩阵**，因而在实现时可以**按行列进行划分**。

    存取控制表：按用户对文件的存取权限**将用户分成若干组**，同时规定**每一组用户对文件的存取权限**，**所有用户组存取权限的集合**称为该文件的存取控制表。 存取控制表例子：
![在这里插入图片描述](https://img-blog.csdnimg.cn/2020053001295677.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)
  3. 用户权限表
用户权限表：将**一个用户或用户组**所要存取的**文件集中存放**在一个表中，其中每个表项指明该用户（组）**对相应文件的存取权限**，这种表称为用户权限表。 用户权限表例子：
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200530013023132.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215UmVhbGl6YXRpb24=,size_16,color_FFFFFF,t_70)


### 2. 口令
口令是一种**简单的文件保护**方法。
- 使用口令的方法是文件主为自己的每个文件规定一个口令，一方面进行口令登记，另一方面把口令告诉允许访问该文件的用户。
- 当用户请求访问某文件时，首先要提供该文件的口令，经证实后再进行相应的访问。

口令方法的特点：
- 只需提供少量的保护信息，简单且易于实现。
- 但其保密性不强，不易更改存取权限。

这种方法常用于识别用户。 

### 3. 密码
密码方法对**需要保护的文件**进行加密。
- 文件**写入时进行编码，读出时进行译码**，要求发出存取请求的用户提供一个代码键。
- 一种简单的编码方式是**利用代码键**作为**生成一串随机数的起始码**，编码程序把这些随机数**加到**被编码文件的字节中去；译码时，用**和编码时相同的代码键**启动随机数发生器，并从存入文件的各字节中**依次减去**所产生的随机数。
- 密码方法的特点：**保密性强**、节省存储空间，但编码和译码要花费一定的时间。

## 8.5.3 文件的转储和恢复
为了能在各种意外情况下**减少或避免文件系统遭到破坏时的损失**，常用的方法是定期转储。转储的方法有两种：
- 全量转储 `full backup` ：**定期**将文件存储器中的**所有文件备份转储**到某存储介质上，一旦系统出现故障破坏了文件信息，便可以**将最近一次转储的内容复制到文件系统中去**，使系统恢复到上次转储时的状态。
全量转储的不足：转储期间应停止对文件系统进行其他操作，**转储时间长**。
- 增量转储 `incremental backup` ：将**上次转储以来修改过**的文件和**新增加**的文件**转储到某存储介质上**。增量转储能使系统遭到破坏后，**恢复到数小时前文件系统的状态**，从而**使得所造成的损失减到最小**。
在实际工作中，两种方法要配合使用，根据实际情况，确定全量转储的周期和增量转储的时间间隔。

一旦系统发生故障，文件系统的恢复过程大致如下：
- 从**最近一次全量转储**中装入**全部系统文件**
- **从近到远**从**增量转储盘**上恢复文件。同一个文件**只恢复最近一次转储的副本**。

# 8.6  文件使用
基本文件操作有：
- 建立文件
- 删除文件
- 读文件
- 写文件
- 打开文件
- 关闭文件

建立新文件时系统应：
- 先为新文件**分配必要的外存空间**；
- 在文件系统的目录中**为之建立一个目录项**；
- 在目录项中应**记录新文件的文件名**及其**在外存的地址**等属性。

在删除文件时系统应：
- 先从目录中找到**要删除文件的目录项**并使之**成为空闲目录项**；
- 然后**回收该文件所占用的存储空间**。

在读一个文件时系统应：
- 通过**查找目录**找到**指定文件的目录项**；
- 从目录项中得到**被读文件在外存的地址**；
- 然后**从外存**将数据读入内存。

在写一个文件时，系统应：
- 通过**查找目录**找到**指定文件的目录项**；
- 再利用**目录中的文件指针**将信息写入文件。

文件操作时需要访问目录信息，因此系统**提供了打开文件和关闭文件**命令。
- 打开文件：将待访问文件的目录信息读入内存打开文件表中，建立起用户进程和文件之间的联系。
- 关闭文件：**撤消主存**中有关该文件的**目录信息**，**切断**用户进程与该文件的联系；若在文件打开期间，该文件**作过某种修改**，则应**将其写回辅存**。

